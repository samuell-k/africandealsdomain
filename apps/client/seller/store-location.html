<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Store Location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />
  <style>
    #storeMap, #productMap { height: 300px; }
    .leaflet-container { border-radius: 0.75rem; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-2xl mx-auto py-8 px-4">
    <h1 class="text-2xl font-bold mb-6 text-center">My Store Location</h1>
    <!-- Store Location Picker -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-lg font-semibold mb-2">Set Your Store Location</h2>
      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <input id="storeAddressInput" type="text" placeholder="Search address..." class="flex-1 px-4 py-2 border rounded-lg" />
        <button onclick="useStoreGPS()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
          <i class="fa fa-location-arrow mr-2"></i> Use My GPS
        </button>
      </div>
      <div id="storeMap" class="mb-4"></div>
      <button onclick="saveStoreLocation()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Save Store Location</button>
      <div id="storeSaveStatus" class="mt-2 text-sm"></div>
    </div>

    <!-- Per-Product Location (Optional) -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-lg font-semibold mb-2">Set Product Location (Optional)</h2>
      <div class="flex gap-2 mb-2">
        <input id="productIdInput" type="number" placeholder="Product ID" class="px-2 py-1 border rounded" />
        <input id="productAddressInput" type="text" placeholder="Search address..." class="flex-1 px-4 py-2 border rounded-lg" />
        <button onclick="useProductGPS()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
          <i class="fa fa-location-arrow mr-2"></i> Use GPS
        </button>
      </div>
      <div id="productMap" class="mb-4"></div>
      <button onclick="saveProductLocation()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Save Product Location</button>
      <div id="productSaveStatus" class="mt-2 text-sm"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch/dist/bundle.min.js"></script>
  <script>
    // --- CONFIG ---
    const sellerId = localStorage.getItem('sellerId') || 1; // Replace with real seller ID logic
    const authToken = localStorage.getItem('authToken');
    const apiBase = '/api/location';

    // --- STORE MAP PICKER ---
    let storeMap = L.map('storeMap').setView([0,0], 2), storeMarker, storeLatLng;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(storeMap);
    const storeSearch = new window.GeoSearch.GeoSearchControl({
      provider: new window.GeoSearch.OpenStreetMapProvider(),
      style: 'bar',
      autoComplete: true,
      showMarker: false,
      retainZoomLevel: false,
    });
    storeMap.addControl(storeSearch);
    storeMap.on('geosearch/showlocation', function(e) {
      setStoreMarker(e.location.y, e.location.x);
      document.getElementById('storeAddressInput').value = e.location.label;
    });
    storeMap.on('click', function(e) {
      setStoreMarker(e.latlng.lat, e.latlng.lng);
    });
    function setStoreMarker(lat, lng) {
      storeLatLng = { lat, lng };
      if (storeMarker) storeMap.removeLayer(storeMarker);
      storeMarker = L.marker([lat, lng], { draggable: true }).addTo(storeMap);
      storeMarker.on('dragend', function(e) {
        storeLatLng = storeMarker.getLatLng();
      });
    }
    function useStoreGPS() {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        setStoreMarker(pos.coords.latitude, pos.coords.longitude);
        storeMap.setView([pos.coords.latitude, pos.coords.longitude], 15);
      }, err => alert('Failed to get location: ' + err.message));
    }
    async function saveStoreLocation() {
      if (!storeLatLng) return showStoreStatus('Pick a location on the map first.', 'red');
      const res = await fetch(`${apiBase}/users/${sellerId}/location`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
        body: JSON.stringify({ type: 'store', lat: storeLatLng.lat, lng: storeLatLng.lng })
      });
      if (res.ok) showStoreStatus('Store location saved!', 'green');
      else showStoreStatus('Failed to save location.', 'red');
    }
    function showStoreStatus(msg, color) {
      document.getElementById('storeSaveStatus').innerHTML = `<span class="text-${color}-600">${msg}</span>`;
    }

    // --- PRODUCT MAP PICKER ---
    let productMap = L.map('productMap').setView([0,0], 2), productMarker, productLatLng;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(productMap);
    const productSearch = new window.GeoSearch.GeoSearchControl({
      provider: new window.GeoSearch.OpenStreetMapProvider(),
      style: 'bar',
      autoComplete: true,
      showMarker: false,
      retainZoomLevel: false,
    });
    productMap.addControl(productSearch);
    productMap.on('geosearch/showlocation', function(e) {
      setProductMarker(e.location.y, e.location.x);
      document.getElementById('productAddressInput').value = e.location.label;
    });
    productMap.on('click', function(e) {
      setProductMarker(e.latlng.lat, e.latlng.lng);
    });
    function setProductMarker(lat, lng) {
      productLatLng = { lat, lng };
      if (productMarker) productMap.removeLayer(productMarker);
      productMarker = L.marker([lat, lng], { draggable: true }).addTo(productMap);
      productMarker.on('dragend', function(e) {
        productLatLng = productMarker.getLatLng();
      });
    }
    function useProductGPS() {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        setProductMarker(pos.coords.latitude, pos.coords.longitude);
        productMap.setView([pos.coords.latitude, pos.coords.longitude], 15);
      }, err => alert('Failed to get location: ' + err.message));
    }
    async function saveProductLocation() {
      const productId = document.getElementById('productIdInput').value;
      if (!productId) return showProductStatus('Enter product ID.', 'red');
      if (!productLatLng) return showProductStatus('Pick a location on the map first.', 'red');
      // You must implement this endpoint in your backend!
      const res = await fetch(`/api/products/${productId}/location`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
        body: JSON.stringify({ lat: productLatLng.lat, lng: productLatLng.lng })
      });
      if (res.ok) showProductStatus('Product location saved!', 'green');
      else showProductStatus('Failed to save product location.', 'red');
    }
    function showProductStatus(msg, color) {
      document.getElementById('productSaveStatus').innerHTML = `<span class="text-${color}-600">${msg}</span>`;
    }
  </script>
  <script src="https://kit.fontawesome.com/7b2b2c7e3c.js" crossorigin="anonymous"></script>
</body>
</html>