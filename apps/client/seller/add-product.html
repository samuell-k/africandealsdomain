<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="/shared/auth-utils.js"></script>
  <script>
    // Configure Tailwind for responsive design
    tailwind.config = {
      theme: {
        extend: {
          screens: {
            'xs': '475px',
          }
        }
      }
    }
    
    // Normalize auth storage to avoid mixed-key loops
    (function normalizeAuthStorage(){
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      const userStr = localStorage.getItem('userData') || localStorage.getItem('user');
      if (token) { localStorage.setItem('authToken', token); localStorage.setItem('token', token); }
      if (userStr) { localStorage.setItem('userData', userStr); localStorage.setItem('user', userStr); }
    })();
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/seller/dashboard.html" class="flex items-center space-x-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-8 w-8 rounded-lg shadow">
            <span class="font-bold text-xl text-blue-600">ADD Seller</span>
          </a>
          <div class="hidden md:ml-6 md:flex md:space-x-8">
            <a href="/seller/dashboard.html" class="text-gray-500 hover:text-blue-700 px-3 py-2 text-sm font-medium transition-colors">Dashboard</a>
            <a href="/seller/products.html" class="text-blue-600 border-b-2 border-blue-600 px-3 py-2 text-sm font-medium">Products</a>
            <a href="/seller/orders.html" class="text-gray-500 hover:text-blue-700 px-3 py-2 text-sm font-medium transition-colors">Orders</a>
            <a href="/seller/inventory.html" class="text-gray-500 hover:text-blue-700 px-3 py-2 text-sm font-medium transition-colors">Inventory</a>
            <a href="/seller/analytics.html" class="text-gray-500 hover:text-blue-700 px-3 py-2 text-sm font-medium transition-colors">Analytics</a>
            <a href="/seller/messages.html" class="text-gray-500 hover:text-blue-700 px-3 py-2 text-sm font-medium transition-colors">Messages</a>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Mobile Menu Button -->
          <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          
          <!-- Profile Dropdown -->
          <div class="relative">
            <button id="profile-dropdown-btn" class="flex items-center gap-1 px-3 py-1 rounded hover:bg-gray-50 font-semibold transition-colors">
              <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" class="text-blue-600" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 8-4 8-4s8 0 8 4"/></svg>
              <span id="profile-name">My Store</span>
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="ml-1 text-gray-400 transition-transform" id="dropdown-arrow" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
            </button>
            <div id="profile-dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 hidden z-50">
              <div class="py-2">
                <a href="/seller/profile.html" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-blue-50 transition-colors">
                  <i class="fas fa-user text-blue-600"></i>
                  <span>Profile</span>
                </a>
                <a href="/seller/settings.html" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-blue-50 transition-colors">
                  <i class="fas fa-cog text-blue-600"></i>
                  <span>Settings</span>
                </a>
                <hr class="my-2">
                <button id="logout-btn" class="flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors w-full text-left">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile Navigation Menu -->
    <div id="mobile-menu" class="md:hidden bg-white border-t border-gray-200 hidden">
      <div class="px-4 py-2 space-y-1">
        <a href="/seller/dashboard.html" class="block px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">Dashboard</a>
        <a href="/seller/products.html" class="block px-3 py-2 text-blue-700 bg-blue-50 rounded-lg font-semibold">Products</a>
        <a href="/seller/orders.html" class="block px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">Orders</a>
        <a href="/seller/inventory.html" class="block px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">Inventory</a>
        <a href="/seller/analytics.html" class="block px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">Analytics</a>
        <a href="/seller/messages.html" class="block px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">Messages</a>
      </div>
    </div>
  </nav>

  <main class="pt-6 pb-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Add New Product</h1>
        <p class="text-gray-600">Create a new product listing for your store</p>
      </div>

      <!-- Main Form -->
      <form id="add-product-form" class="bg-white rounded-xl shadow-lg p-4 sm:p-6 lg:p-8 space-y-6 lg:space-y-8" enctype="multipart/form-data">
        
        <!-- Success/Error Messages -->
        <div id="form-message" class="hidden p-4 rounded-lg text-sm font-medium"></div>

        <!-- Basic Information Section -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600" viewBox="0 0 24 24">
              <path d="M12 4v16m8-8H4"/>
            </svg>
            Basic Information
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
            <!-- Product Name -->
            <div class="lg:col-span-2">
              <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
              <input type="text" id="name" name="name" required 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                     placeholder="Enter product name">
            </div>

            <!-- Category -->
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Main Category *</label>
              <select id="category" name="category_id" required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                <option value="">Select main category</option>
              </select>
            </div>

            <!-- Subcategory -->
            <div>
              <label for="sub_category" class="block text-sm font-medium text-gray-700 mb-2">Subcategory</label>
              <select id="sub_category" name="sub_category_id" disabled
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors disabled:bg-gray-100">
                <option value="">Select main category first</option>
              </select>
            </div>

            <!-- Brand -->
            <div>
              <label for="brand" class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
              <input type="text" id="brand" name="brand" 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                     placeholder="Enter brand name">
            </div>

            <!-- Condition -->
            <div>
              <label for="condition" class="block text-sm font-medium text-gray-700 mb-2">Product Condition *</label>
              <select id="condition" name="condition" required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                <option value="">Select condition</option>
                <option value="new">New</option>
                <option value="used">Used</option>
                <option value="refurbished">Refurbished</option>
              </select>
            </div>
          </div>

          <!-- Description -->
          <div class="mt-6">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
            <textarea id="description" name="description" rows="4" required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                      placeholder="Describe your product in detail..."></textarea>
            <div class="text-xs text-gray-500 mt-1">
              <span id="description-count">0</span>/1000 characters
            </div>
          </div>

          <!-- Features -->
          <div class="mt-6">
            <label for="features" class="block text-sm font-medium text-gray-700 mb-2">Key Features</label>
            <textarea id="features" name="features" rows="3"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                      placeholder="List key features (one per line)"></textarea>
          </div>

          <!-- Tags -->
          <div class="mt-6">
            <label for="tags" class="block text-sm font-medium text-gray-700 mb-2">Tags/Keywords</label>
            <input type="text" id="tags" name="tags" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                   placeholder="Enter tags separated by commas">
            <p class="text-xs text-gray-500 mt-1">Separate tags with commas (e.g., electronics, wireless, bluetooth)</p>
          </div>
        </div>

        <!-- Dynamic Category-Specific Fields -->
        <div id="dynamic-fields-section" class="border-b border-gray-200 pb-6 hidden">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-indigo-600" viewBox="0 0 24 24">
              <path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <span id="dynamic-fields-title">Product Specifications</span>
          </h2>
          
          <div id="dynamic-fields-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
            <!-- Dynamic fields will be inserted here -->
          </div>
        </div>

        <!-- Pricing Section -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600" viewBox="0 0 24 24">
              <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Pricing & Inventory
          </h2>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
            <!-- Price -->
            <div class="sm:col-span-2 lg:col-span-1">
              <label for="price" class="block text-sm font-medium text-gray-700 mb-2">Product Price *</label>
              <div class="relative">
                <input type="number" id="price" name="price" required min="0" step="0.01"
                       class="w-full px-4 py-3 pr-20 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                       placeholder="0.00">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <select id="currency" name="currency" 
                          class="text-sm border-0 bg-transparent focus:ring-0 focus:outline-none">
                    <option value="RWF">RWF</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                  </select>
                </div>
              </div>
              <div id="usd-conversion" class="text-xs text-gray-500 mt-1 hidden"></div>
            </div>

            <!-- Stock Quantity -->
            <div>
              <label for="stock_quantity" class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
              <input type="number" id="stock_quantity" name="stock_quantity" required min="0"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                     placeholder="0">
            </div>

            <!-- MOQ -->
            <div>
              <label for="moq" class="block text-sm font-medium text-gray-700 mb-2">Minimum Order Quantity</label>
              <input type="number" id="moq" name="moq" min="1" value="1"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
          </div>
        </div>

        <!-- Images Section -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="M21 15l-5-5L5 21"/>
            </svg>
            Product Images
          </h2>
          
          <!-- Main Image -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Main Image *</label>
            <div id="main-image-upload" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
              <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-gray-400 mb-4" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <p class="text-sm text-gray-600">Click to upload main image</p>
              <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 5MB</p>
              <input type="file" id="main_image" name="main_image" accept="image/*" class="hidden" required>
            </div>
            <div id="main-image-preview" class="hidden mt-4">
              <img id="main-preview" class="w-32 h-32 object-cover rounded-lg border mx-auto sm:mx-0" alt="Main image preview">
              <button type="button" id="remove-main-image" class="mt-2 text-red-600 text-sm hover:text-red-800 block mx-auto sm:mx-0">Remove</button>
            </div>
          </div>

          <!-- Gallery Images -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Gallery Images</label>
            <div id="gallery-upload" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
              <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-gray-400 mb-4" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <p class="text-sm text-gray-600">Click to upload gallery images</p>
              <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 5MB each (max 10 images)</p>
              <input type="file" id="gallery_images" name="gallery_images" accept="image/*" multiple class="hidden">
            </div>
            <div id="gallery-preview" class="hidden mt-4">
              <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>
            </div>
          </div>
        </div>

        <!-- Additional Information Section -->
        <div class="border-b border-gray-200 pb-6">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-orange-600" viewBox="0 0 24 24">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Additional Information
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
            <!-- What's Included -->
            <div>
              <label for="whats_included" class="block text-sm font-medium text-gray-700 mb-2">What's Included</label>
              <textarea id="whats_included" name="whats_included" rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                        placeholder="List what comes with the product"></textarea>
            </div>

            <!-- Usage Instructions -->
            <div>
              <label for="usage_instructions" class="block text-sm font-medium text-gray-700 mb-2">Usage Instructions</label>
              <textarea id="usage_instructions" name="usage_instructions" rows="3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                        placeholder="How to use this product"></textarea>
            </div>

            <!-- Warranty Period -->
            <div>
              <label for="warranty_period" class="block text-sm font-medium text-gray-700 mb-2">Warranty Period</label>
              <input type="text" id="warranty_period" name="warranty_period"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                     placeholder="e.g., 1 year, 6 months">
            </div>

            <!-- Return Policy -->
            <div>
              <label for="return_policy" class="block text-sm font-medium text-gray-700 mb-2">Return Policy</label>
              <input type="text" id="return_policy" name="return_policy"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                     placeholder="e.g., 30 days return, No returns">
            </div>
          </div>

          <!-- Specifications Text -->
          <div class="mt-6">
            <label for="specifications_text" class="block text-sm font-medium text-gray-700 mb-2">Technical Specifications</label>
            <textarea id="specifications_text" name="specifications_text" rows="4"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                      placeholder="Detailed technical specifications"></textarea>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row justify-end gap-4">
          <button type="button" id="save-draft-btn" 
                  class="w-full sm:w-auto bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2 font-semibold">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
              <polyline points="17,21 17,13 7,13 7,21"/>
              <polyline points="7,3 7,8 15,8"/>
            </svg>
            Save as Draft
          </button>
          <button type="submit" id="submit-btn" 
                  class="w-full sm:w-auto bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-semibold">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M12 4v16m8-8H4"/>
            </svg>
            Create Product
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 flex items-center gap-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <span class="text-gray-700">Creating product...</span>
    </div>
  </div>

  <script>
    // --- GLOBAL STATE ---
    let currencyRates = {};
    let selectedCurrency = localStorage.getItem('selectedCurrency') || 'RWF';
    let categories = [];
    let categorySchemas = {};
    let subcategories = [];
    let currentCategorySlug = '';
    let galleryFiles = [];

    // --- AUTHENTICATION CHECK ---
    function checkAuth() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('userData') || localStorage.getItem('user') || '{}');
      
      if (!token || !user.id || user.role !== 'seller') {
        window.location.href = '/auth/auth-seller.html';
        return false;
      }
      return true;
    }

    // --- FETCH CURRENCY RATES ---
    async function fetchCurrencyRates() {
      try {
        const res = await fetch('https://v6.exchangerate-api.com/v6/c5f524e323378439dad2a43f/latest/USD');
        const data = await res.json();
        if (data && data.result === 'success') {
          currencyRates = data.conversion_rates;
          populateCurrencyDropdown();
        }
      } catch (e) {
        console.error('Failed to fetch currency rates:', e);
        currencyRates = { USD: 1, RWF: 1200, EUR: 0.9, KES: 130, NGN: 1500 };
        populateCurrencyDropdown();
      }
    }

    function populateCurrencyDropdown() {
      const currencySelect = document.getElementById('currency');
      const popularCurrencies = ['RWF', 'USD', 'EUR', 'KES', 'NGN', 'TZS', 'UGX'];
      
      currencySelect.innerHTML = popularCurrencies.map(currency => 
        `<option value="${currency}">${currency}</option>`
      ).join('');
      currencySelect.value = selectedCurrency;
    }

    // --- FETCH CATEGORIES ---
    async function fetchCategories() {
      try {
        const res = await fetch('/api/categories/active');
        const data = await res.json();
        
        if (data.success) {
          categories = data.categories;
          populateCategoryDropdown();
          await loadCategorySchemas();
        } else {
          showMessage('Failed to load categories', 'error');
        }
      } catch (error) {
        console.error('Error fetching categories:', error);
        showMessage('Failed to load categories', 'error');
      }
    }

    function populateCategoryDropdown() {
      const categorySelect = document.getElementById('category');
      if (!categorySelect) return;
      
      categorySelect.innerHTML = '<option value="">Select main category</option>';
      
      // Only show top-level categories
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        option.dataset.slug = category.slug;
        categorySelect.appendChild(option);
      });
    }

    // --- LOAD CATEGORY SCHEMAS ---
    async function loadCategorySchemas() {
      try {
        const response = await fetch('/api/categories/schemas/all');
        const data = await response.json();
        
        if (data.success) {
          categorySchemas = data.schemas;
        }
      } catch (error) {
        console.error('Error loading category schemas:', error);
      }
    }

    // --- HANDLE CATEGORY CHANGE ---
    async function handleCategoryChange(event) {
      const selectedOption = event.target.selectedOptions[0];
      const categoryId = event.target.value;
      const categorySlug = selectedOption?.dataset.slug;

      // Clear subcategories and dynamic fields
      clearSubcategories();
      clearDynamicFields();

      if (!categoryId || !categorySlug) {
        return;
      }

      currentCategorySlug = categorySlug;

      try {
        // Load subcategories
        await loadSubcategories(categorySlug);
        
        // Load and display dynamic fields
        displayDynamicFields(categorySlug);
        
      } catch (error) {
        console.error('Error handling category change:', error);
        showMessage('Failed to load category details', 'error');
      }
    }

    // --- LOAD SUBCATEGORIES ---
    async function loadSubcategories(categorySlug) {
      try {
        const response = await fetch(`/api/categories/${categorySlug}/subcategories`);
        const data = await response.json();
        
        if (data.success) {
          subcategories = data.subcategories;
          populateSubcategories(data.subcategories);
        } else {
          clearSubcategories();
        }
      } catch (error) {
        console.error('Error loading subcategories:', error);
        clearSubcategories();
      }
    }

    // --- POPULATE SUBCATEGORIES ---
    function populateSubcategories(subcategories) {
      const select = document.getElementById('sub_category');
      select.innerHTML = '<option value="">Select subcategory (optional)</option>';
      select.disabled = false;
      
      subcategories.forEach(subcategory => {
        const option = document.createElement('option');
        option.value = subcategory.id;
        option.textContent = subcategory.name;
        select.appendChild(option);
      });
    }

    // --- CLEAR SUBCATEGORIES ---
    function clearSubcategories() {
      const select = document.getElementById('sub_category');
      select.innerHTML = '<option value="">Select main category first</option>';
      select.disabled = true;
    }

    // --- CATEGORY-SPECIFIC FIELD DEFINITIONS ---
    const categoryFieldDefinitions = {
      'Electronics': {
        title: 'Electronics Specifications',
        fields: [
          { name: 'brand', label: 'Brand', type: 'text', required: true, placeholder: 'e.g., Apple, Samsung, Sony' },
          { name: 'model', label: 'Model', type: 'text', required: true, placeholder: 'e.g., iPhone 14 Pro, Galaxy S23' },
          { name: 'screen_size', label: 'Screen Size', type: 'text', placeholder: 'e.g., 6.1 inches, 55 inches' },
          { name: 'processor', label: 'Processor/Chipset', type: 'text', placeholder: 'e.g., A16 Bionic, Snapdragon 8 Gen 2' },
          { name: 'ram', label: 'RAM', type: 'text', placeholder: 'e.g., 8GB, 16GB' },
          { name: 'storage', label: 'Storage', type: 'text', placeholder: 'e.g., 128GB, 256GB, 1TB' },
          { name: 'connectivity', label: 'Connectivity', type: 'text', placeholder: 'e.g., WiFi 6, Bluetooth 5.0, 5G' },
          { name: 'operating_system', label: 'Operating System', type: 'text', placeholder: 'e.g., iOS 16, Android 13, Windows 11' },
          { name: 'color_options', label: 'Available Colors', type: 'text', placeholder: 'e.g., Black, White, Blue, Red' }
        ]
      },
      'Smartphones': {
        title: 'Smartphone Specifications',
        fields: [
          { name: 'model', label: 'Model', type: 'text', required: true, placeholder: 'e.g., iPhone 15, Galaxy S24' },
          { name: 'storage', label: 'Storage Capacity', type: 'select', options: ['16GB', '32GB', '64GB', '128GB', '256GB', '512GB', '1TB'], required: true },
          { name: 'ram', label: 'RAM', type: 'select', options: ['2GB', '3GB', '4GB', '6GB', '8GB', '12GB', '16GB'], required: true },
          { name: 'screen_size', label: 'Screen Size', type: 'text', placeholder: 'e.g., 6.1 inches' },
          { name: 'color', label: 'Color', type: 'text', required: true, placeholder: 'e.g., Space Black, Blue, Red' },
          { name: 'network', label: 'Network', type: 'select', options: ['4G LTE', '5G', '3G'], required: false }
        ]
      },
      'Clothing & Fashion': {
        title: 'Clothing & Fashion Details',
        fields: [
          { name: 'size', label: 'Size', type: 'select', options: ['XS', 'S', 'M', 'L', 'XL', 'XXL'], required: true },
          { name: 'color', label: 'Color', type: 'text', required: true, placeholder: 'e.g., Black, Blue, Red' },
          { name: 'material', label: 'Material', type: 'text', required: true, placeholder: 'e.g., Cotton, Polyester, Wool' },
          { name: 'gender', label: 'Gender', type: 'select', options: ['Men', 'Women', 'Unisex'], required: true },
          { name: 'care_instructions', label: 'Care Instructions', type: 'text', placeholder: 'e.g., Machine wash cold, Dry clean only' }
        ]
      },
      'Home & Garden': {
        title: 'Home & Garden Details',
        fields: [
          { name: 'dimensions', label: 'Dimensions (L x W x H)', type: 'text', required: false, placeholder: 'e.g., 30cm x 20cm x 15cm' },
          { name: 'weight', label: 'Weight (kg)', type: 'number', required: false },
          { name: 'material', label: 'Material', type: 'text', required: false, placeholder: 'e.g., Wood, Metal, Plastic' },
          { name: 'color', label: 'Color', type: 'text', required: false }
        ]
      }
    };

    // --- DISPLAY DYNAMIC FIELDS ---
    function displayDynamicFields(categorySlug) {
      const section = document.getElementById('dynamic-fields-section');
      const container = document.getElementById('dynamic-fields-container');
      const title = document.getElementById('dynamic-fields-title');
      
      // Find category by slug
      const category = categories.find(cat => cat.slug === categorySlug);
      if (!category) return;
      
      const categoryName = category.name;
      const fieldDef = categoryFieldDefinitions[categoryName];
      
      if (!fieldDef) {
        section.classList.add('hidden');
        return;
      }
      
      title.textContent = fieldDef.title;
      container.innerHTML = '';
      
      fieldDef.fields.forEach(field => {
        const fieldDiv = document.createElement('div');
        
        let inputHtml = '';
        if (field.type === 'select') {
          inputHtml = `
            <select name="spec_${field.name}" ${field.required ? 'required' : ''} 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
              <option value="">Select ${field.label.toLowerCase()}</option>
              ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
            </select>
          `;
        } else if (field.type === 'textarea') {
          inputHtml = `
            <textarea name="spec_${field.name}" ${field.required ? 'required' : ''} rows="3"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                      placeholder="${field.placeholder || ''}"></textarea>
          `;
        } else {
          inputHtml = `
            <input type="${field.type}" name="spec_${field.name}" ${field.required ? 'required' : ''}
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                   placeholder="${field.placeholder || ''}">
          `;
        }
        
        fieldDiv.innerHTML = `
          <label class="block text-sm font-medium text-gray-700 mb-2">
            ${field.label} ${field.required ? '*' : ''}
          </label>
          ${inputHtml}
        `;
        
        container.appendChild(fieldDiv);
      });
      
      section.classList.remove('hidden');
    }

    // --- CLEAR DYNAMIC FIELDS ---
    function clearDynamicFields() {
      const section = document.getElementById('dynamic-fields-section');
      const container = document.getElementById('dynamic-fields-container');
      section.classList.add('hidden');
      container.innerHTML = '';
    }

    // --- SETUP IMAGE UPLOAD ---
    function setupImageUpload() {
      // Main image upload
      const mainImageUpload = document.getElementById('main-image-upload');
      const mainImageInput = document.getElementById('main_image');
      const mainImagePreview = document.getElementById('main-image-preview');
      const mainPreview = document.getElementById('main-preview');
      const removeMainImage = document.getElementById('remove-main-image');

      mainImageUpload.addEventListener('click', () => mainImageInput.click());
      
      mainImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            showMessage('Image size must be less than 5MB', 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            mainPreview.src = e.target.result;
            mainImagePreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      removeMainImage.addEventListener('click', function() {
        mainImageInput.value = '';
        mainImagePreview.classList.add('hidden');
      });

      // Gallery images upload
      const galleryUpload = document.getElementById('gallery-upload');
      const galleryInput = document.getElementById('gallery_images');
      const galleryPreview = document.getElementById('gallery-preview');
      const galleryGrid = document.getElementById('gallery-grid');

      galleryUpload.addEventListener('click', () => galleryInput.click());
      
      galleryInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        if (files.length > 10) {
          showMessage('Maximum 10 gallery images allowed', 'error');
          return;
        }
        
        galleryFiles = files;
        displayGalleryPreview();
      });

      function displayGalleryPreview() {
        galleryGrid.innerHTML = '';
        
        if (galleryFiles.length === 0) {
          galleryPreview.classList.add('hidden');
          return;
        }
        
        galleryFiles.forEach((file, index) => {
          if (file.size > 5 * 1024 * 1024) {
            showMessage(`Image ${index + 1} size must be less than 5MB`, 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'relative';
            imageDiv.innerHTML = `
              <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg border">
              <button type="button" onclick="removeGalleryImage(${index})" 
                      class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                ×
              </button>
            `;
            galleryGrid.appendChild(imageDiv);
          };
          reader.readAsDataURL(file);
        });
        
        galleryPreview.classList.remove('hidden');
      }

      window.removeGalleryImage = function(index) {
        galleryFiles.splice(index, 1);
        displayGalleryPreview();
        
        // Update file input
        const dt = new DataTransfer();
        galleryFiles.forEach(file => dt.items.add(file));
        galleryInput.files = dt.files;
      };
    }

    // --- CURRENCY CONVERSION ---
    function updateCurrencyConversion() {
      const priceInput = document.getElementById('price');
      const usdConversion = document.getElementById('usd-conversion');
      const currency = document.getElementById('currency').value;
      
      const price = parseFloat(priceInput.value);
      if (price && price > 0 && currency !== 'USD' && currencyRates[currency]) {
        const usdPrice = (price / currencyRates[currency]).toFixed(2);
        usdConversion.textContent = `≈ $${usdPrice} USD`;
        usdConversion.classList.remove('hidden');
      } else {
        usdConversion.classList.add('hidden');
      }
    }

    // --- FORM SUBMISSION ---
    async function handleFormSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const loadingOverlay = document.getElementById('loading-overlay');
      
      // Validate required fields
      const requiredFields = ['name', 'description', 'category_id', 'price', 'stock_quantity', 'main_image'];
      for (const fieldName of requiredFields) {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (!field || !field.value.trim()) {
          showMessage(`Please fill in the ${fieldName.replace('_', ' ')} field`, 'error');
          field?.focus();
          return;
        }
      }

      try {
        submitBtn.disabled = true;
        loadingOverlay.classList.remove('hidden');
        
        const formData = new FormData();
        
        // Add basic fields
        const basicFields = ['name', 'description', 'category_id', 'sub_category_id', 'brand', 'condition', 
                            'price', 'currency', 'stock_quantity', 'moq', 'features', 'tags', 
                            'whats_included', 'usage_instructions', 'warranty_period', 'return_policy', 'specifications_text'];
        
        basicFields.forEach(field => {
          const element = document.querySelector(`[name="${field}"]`);
          if (element && element.value) {
            formData.append(field, element.value);
          }
        });

        // Add main image
        const mainImageFile = document.getElementById('main_image').files[0];
        if (mainImageFile) {
          formData.append('main_image', mainImageFile);
        }

        // Add gallery images
        galleryFiles.forEach(file => {
          formData.append('gallery_images', file);
        });

        // Add dynamic specifications
        const specifications = {};
        document.querySelectorAll('[name^="spec_"]').forEach(input => {
          if (input.value) {
            const specName = input.name.replace('spec_', '');
            specifications[specName] = input.value;
          }
        });
        
        if (Object.keys(specifications).length > 0) {
          formData.append('specifications', JSON.stringify(specifications));
        }

        const response = await fetch('/api/products', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + (localStorage.getItem('authToken') || localStorage.getItem('token'))
          },
          body: formData
        });

        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to create product');
        
        showMessage('Product created successfully!', 'success');
        setTimeout(() => {
          window.location.href = '/seller/products.html';
        }, 1500);
        
      } catch (err) {
        showMessage(err.message, 'error');
      } finally {
        submitBtn.disabled = false;
        loadingOverlay.classList.add('hidden');
      }
    }

    // --- MESSAGE HANDLER ---
    function showMessage(message, type) {
      const msgDiv = document.getElementById('form-message');
      msgDiv.textContent = message;
      msgDiv.className = `p-4 rounded-lg text-sm font-medium ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      msgDiv.classList.remove('hidden');
      
      setTimeout(() => {
        msgDiv.classList.add('hidden');
      }, 5000);
    }

    // --- CHARACTER COUNTER ---
    function setupCharacterCounter() {
      const descriptionTextarea = document.getElementById('description');
      const descriptionCount = document.getElementById('description-count');
      
      descriptionTextarea.addEventListener('input', function() {
        const count = this.value.length;
        descriptionCount.textContent = count;
        
        if (count > 1000) {
          descriptionCount.classList.add('text-red-600');
          this.value = this.value.substring(0, 1000);
          descriptionCount.textContent = '1000';
        } else {
          descriptionCount.classList.remove('text-red-600');
        }
      });
    }

    // --- MOBILE MENU FUNCTIONALITY ---
    function setupMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      
      if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          mobileMenu.classList.toggle('hidden');
          
          const icon = mobileMenuBtn.querySelector('svg');
          if (mobileMenu.classList.contains('hidden')) {
            icon.innerHTML = '<path d="M4 6h16M4 12h16M4 18h16"/>';
          } else {
            icon.innerHTML = '<path d="M6 18L18 6M6 6l12 12"/>';
          }
        });
        
        document.addEventListener('click', function(e) {
          if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target) && !mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.add('hidden');
            const icon = mobileMenuBtn.querySelector('svg');
            icon.innerHTML = '<path d="M4 6h16M4 12h16M4 18h16"/>';
          }
        });
      }
    }

    // --- PROFILE DROPDOWN FUNCTIONALITY ---
    function setupProfileDropdown() {
      const profileBtn = document.getElementById('profile-dropdown-btn');
      const profileMenu = document.getElementById('profile-dropdown-menu');
      const arrow = document.getElementById('dropdown-arrow');
      
      if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          profileMenu.classList.toggle('hidden');
          arrow.classList.toggle('rotate-180');
        });
        
        document.addEventListener('click', function(e) {
          if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
            profileMenu.classList.add('hidden');
            arrow.classList.remove('rotate-180');
          }
        });
      }
      
      // Update profile name
      const user = JSON.parse(localStorage.getItem('userData') || localStorage.getItem('user') || '{}');
      const profileName = document.getElementById('profile-name');
      if (profileName && user.name) {
        profileName.textContent = user.name;
      }
      
      // Setup logout
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          localStorage.removeItem('authToken');
          localStorage.removeItem('token');
          localStorage.removeItem('userData');
          localStorage.removeItem('user');
          window.location.href = '/auth/auth-seller.html';
        });
      }
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication first
      if (!checkAuth()) return;
      
      setupMobileMenu();
      setupProfileDropdown();
      setupCharacterCounter();
      fetchCurrencyRates();
      fetchCategories();
      setupImageUpload();
      
      // Currency conversion on input
      document.getElementById('price').addEventListener('input', updateCurrencyConversion);
      document.getElementById('currency').addEventListener('change', updateCurrencyConversion);
      
      // Category change handler
      document.getElementById('category').addEventListener('change', handleCategoryChange);
      
      // Form submission
      document.getElementById('add-product-form').addEventListener('submit', handleFormSubmit);
    });
  </script>
</body>
</html>