<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Market Orders | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="/shared/auth-utils.js"></script>
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .order-card { transition: all 0.3s ease; }
    .order-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .status-badge { transition: all 0.3s ease; }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-green-50 min-h-screen">

  <!-- Header -->
  <header class="glass shadow-lg sticky top-0 z-40">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo & Navigation -->
        <div class="flex items-center gap-4">
          <a href="/seller/local-market-dashboard.html" class="flex items-center gap-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-12 w-12 rounded-xl shadow-lg" />
          </a>
          <div>
            <h1 class="font-bold text-lg text-green-700">ðŸ›’ Local Market Orders</h1>
            <p class="text-xs text-gray-500">Manage your grocery orders</p>
          </div>
        </div>

        <!-- Navigation Links -->
        <div class="flex items-center gap-4">
          <a href="/seller/local-market-dashboard.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
          </a>
          <a href="/seller/add-local-market-product.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-plus mr-2"></i>Add Product
          </a>
          <a href="/seller/dashboard.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-box mr-2"></i>Physical Products
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-8xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Pending Orders</p>
            <p class="text-3xl font-bold text-orange-600" id="pending-count">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-clock text-orange-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
          <span class="text-orange-600 font-medium">Requires attention</span>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">In Progress</p>
            <p class="text-3xl font-bold text-blue-600" id="progress-count">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-truck text-blue-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
          <span class="text-blue-600 font-medium">Being processed</span>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Completed Today</p>
            <p class="text-3xl font-bold text-green-600" id="completed-count">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
          <span class="text-green-600 font-medium">Successfully delivered</span>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Revenue</p>
            <p class="text-3xl font-bold text-purple-600" id="revenue-amount">0 RWF</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-coins text-purple-600 text-xl"></i>
          </div>
        </div>
        <div class="mt-4 flex items-center text-sm">
          <span class="text-purple-600 font-medium">This month</span>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 fade-in">
      <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
        <div class="flex flex-col sm:flex-row gap-4 flex-1">
          <div class="relative">
            <input type="text" id="search-orders" placeholder="Search orders..." 
                   class="pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent w-full sm:w-64">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
          
          <select id="status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            <option value="">All Status</option>
            <option value="pending">Pending Payment</option>
            <option value="confirmed">Payment Confirmed</option>
            <option value="preparing">Preparing</option>
            <option value="ready_for_pickup">Ready for Pickup</option>
            <option value="out_for_delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>

          <select id="date-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="all">All Time</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button id="refresh-orders" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
          <button id="export-orders" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-colors">
            <i class="fas fa-download mr-2"></i>Export
          </button>
        </div>
      </div>
    </div>

    <!-- Orders List -->
    <div class="space-y-6">
      <!-- Loading State -->
      <div id="orders-loading" class="text-center py-12">
        <i class="fas fa-spinner loading-spinner text-4xl text-green-600 mb-4"></i>
        <p class="text-lg font-semibold text-gray-800">Loading orders...</p>
      </div>

      <!-- No Orders State -->
      <div id="no-orders" class="hidden text-center py-12">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-shopping-cart text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">No orders found</h3>
        <p class="text-gray-600 mb-6">You don't have any orders matching the current filters.</p>
        <a href="/seller/add-local-market-product.html" class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-colors">
          <i class="fas fa-plus mr-2"></i>Add Your First Product
        </a>
      </div>

      <!-- Orders Container -->
      <div id="orders-container" class="space-y-6">
        <!-- Orders will be populated here -->
      </div>
    </div>

    <!-- Load More Button -->
    <div id="load-more-container" class="text-center mt-8 hidden">
      <button id="load-more-btn" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-colors">
        <i class="fas fa-chevron-down mr-2"></i>Load More Orders
      </button>
    </div>
  </main>

  <!-- Order Details Modal -->
  <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-800">Order Details</h2>
        <button id="close-modal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
          <i class="fas fa-times text-gray-600"></i>
        </button>
      </div>
      <div id="modal-content" class="p-6">
        <!-- Modal content will be populated here -->
      </div>
    </div>
  </div>

  <!-- Status Update Modal -->
  <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-md w-full">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Update Order Status</h3>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
          <select id="new-status" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            <option value="confirmed">Confirmed</option>
            <option value="preparing">Preparing</option>
            <option value="ready_for_pickup">Ready for Pickup</option>
            <option value="out_for_delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
          <textarea id="status-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500" placeholder="Add any notes about this status update..."></textarea>
        </div>
        <div class="flex gap-3">
          <button id="cancel-status-update" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button id="confirm-status-update" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-colors">
            Update Status
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let allOrders = [];
    let filteredOrders = [];
    let currentPage = 1;
    const ordersPerPage = 10;
    let selectedOrderId = null;

    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/public/login.html';
        return;
      }

      // Initialize the page
      initializePage();
    });

    function initializePage() {
      loadOrders();
      setupEventListeners();
      setupRealTimeUpdates();
    }

    function loadOrders() {
      showOrdersLoading(true);
      
      const token = localStorage.getItem('token');
      
      fetch('/api/local-market-orders/seller/orders', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        showOrdersLoading(false);
        if (data.success) {
          allOrders = data.orders;
          filteredOrders = allOrders;
          renderOrders();
          updateStats(data.stats);
        } else {
          showNoOrders();
        }
      })
      .catch(error => {
        showOrdersLoading(false);
        console.error('Error loading orders:', error);
        showNoOrders();
      });
    }

    function renderOrders() {
      const container = document.getElementById('orders-container');
      const startIndex = (currentPage - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const ordersToShow = filteredOrders.slice(startIndex, endIndex);

      if (ordersToShow.length === 0) {
        showNoOrders();
        return;
      }

      document.getElementById('no-orders').classList.add('hidden');
      container.classList.remove('hidden');

      if (currentPage === 1) {
        container.innerHTML = '';
      }

      ordersToShow.forEach(order => {
        const orderCard = createOrderCard(order);
        container.appendChild(orderCard);
      });

      updateLoadMoreButton();
    }

    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow-lg p-6 order-card fade-in';
      
      const statusColor = getStatusColor(order.status);
      const statusText = getStatusText(order.status);
      const timeAgo = getTimeAgo(order.created_at);
      
      card.innerHTML = `
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-shopping-bag text-green-600 text-xl"></i>
              </div>
              <div>
                <h3 class="text-lg font-bold text-gray-800">Order #${order.id}</h3>
                <p class="text-sm text-gray-600">${order.buyer_name} â€¢ ${timeAgo}</p>
              </div>
              <div class="ml-auto">
                <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">
                  ${statusText}
                </span>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <p class="text-sm text-gray-600">Items</p>
                <p class="font-semibold">${order.total_items} products</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Total Amount</p>
                <p class="font-semibold text-green-600">${(order.grand_total || order.total_amount || 0).toLocaleString()} RWF</p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Delivery Address</p>
                <p class="font-semibold text-sm">${order.delivery_address || 'Address not provided'}</p>
              </div>
            </div>
            
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <i class="fas fa-map-marker-alt"></i>
              <span>${order.delivery_latitude && order.delivery_longitude ? calculateDistance(order.delivery_latitude, order.delivery_longitude).toFixed(1) + ' km away' : 'Distance unknown'}</span>
              <span class="mx-2">â€¢</span>
              <i class="fas fa-clock"></i>
              <span>Est. ${order.estimated_delivery_time || '30-45'} mins</span>
              ${order.agent_name ? `<span class="mx-2">â€¢</span><i class="fas fa-user"></i><span>Agent: ${order.agent_name}</span>` : ''}
            </div>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-3 lg:ml-6">
            <button onclick="viewOrderDetails(${order.id})" 
                    class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold rounded-lg transition-colors">
              <i class="fas fa-eye mr-2"></i>View Details
            </button>
            ${order.status !== 'delivered' && order.status !== 'cancelled' ? `
              <button onclick="updateOrderStatus(${order.id})" 
                      class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors">
                <i class="fas fa-edit mr-2"></i>Update Status
              </button>
            ` : ''}
            <button onclick="contactBuyer(${order.id})" 
                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition-colors">
              <i class="fas fa-phone mr-2"></i>Contact
            </button>
          </div>
        </div>
      `;
      
      return card;
    }

    function getStatusColor(status) {
      const colors = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'confirmed': 'bg-blue-100 text-blue-800',
        'preparing': 'bg-orange-100 text-orange-800',
        'ready_for_pickup': 'bg-purple-100 text-purple-800',
        'out_for_delivery': 'bg-indigo-100 text-indigo-800',
        'delivered': 'bg-green-100 text-green-800',
        'cancelled': 'bg-red-100 text-red-800'
      };
      return colors[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusText(status) {
      const texts = {
        'pending': 'Pending Payment',
        'confirmed': 'Payment Confirmed',
        'preparing': 'Preparing Order',
        'ready_for_pickup': 'Ready for Pickup',
        'out_for_delivery': 'Out for Delivery',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
      };
      return texts[status] || status;
    }

    function getTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffInMinutes < 1) return 'Just now';
      if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
      if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
      return `${Math.floor(diffInMinutes / 1440)}d ago`;
    }

    function calculateDistance(lat1, lng1) {
      // This would normally use the seller's location
      // For now, using a default location (Kigali)
      const lat2 = -1.9441;
      const lng2 = 30.0619;
      
      const R = 6371; // Radius of the Earth in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateStats(stats = null) {
      if (stats) {
        // Use stats from API
        const pending = (stats.pending_count || 0) + (stats.confirmed_count || 0);
        const inProgress = (stats.preparing_count || 0) + (stats.ready_count || 0) + (stats.out_for_delivery_count || 0);
        const completed = stats.delivered_today_count || 0;
        const revenue = stats.monthly_revenue || 0;

        document.getElementById('pending-count').textContent = pending;
        document.getElementById('progress-count').textContent = inProgress;
        document.getElementById('completed-count').textContent = completed;
        document.getElementById('revenue-amount').textContent = `${revenue.toLocaleString()} RWF`;
      } else {
        // Fallback to calculating from orders
        const pending = allOrders.filter(o => ['pending', 'confirmed'].includes(o.status)).length;
        const inProgress = allOrders.filter(o => ['preparing', 'ready_for_pickup', 'out_for_delivery'].includes(o.status)).length;
        const completed = allOrders.filter(o => o.status === 'delivered' && isToday(o.updated_at)).length;
        const revenue = allOrders
          .filter(o => o.status === 'delivered' && isThisMonth(o.updated_at))
          .reduce((sum, o) => sum + (o.grand_total || o.total_amount || 0), 0);

        document.getElementById('pending-count').textContent = pending;
        document.getElementById('progress-count').textContent = inProgress;
        document.getElementById('completed-count').textContent = completed;
        document.getElementById('revenue-amount').textContent = `${revenue.toLocaleString()} RWF`;
      }
    }

    function isToday(dateString) {
      const date = new Date(dateString);
      const today = new Date();
      return date.toDateString() === today.toDateString();
    }

    function isThisMonth(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
    }

    function showOrdersLoading(show) {
      const loading = document.getElementById('orders-loading');
      const container = document.getElementById('orders-container');
      const noOrders = document.getElementById('no-orders');
      
      if (show) {
        loading.classList.remove('hidden');
        container.classList.add('hidden');
        noOrders.classList.add('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }

    function showNoOrders() {
      document.getElementById('orders-loading').classList.add('hidden');
      document.getElementById('orders-container').classList.add('hidden');
      document.getElementById('no-orders').classList.remove('hidden');
    }

    function updateLoadMoreButton() {
      const container = document.getElementById('load-more-container');
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      
      if (currentPage < totalPages) {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    }

    function setupEventListeners() {
      // Search functionality
      document.getElementById('search-orders').addEventListener('input', debounce(handleSearch, 300));
      
      // Filter functionality
      document.getElementById('status-filter').addEventListener('change', applyFilters);
      document.getElementById('date-filter').addEventListener('change', applyFilters);
      
      // Action buttons
      document.getElementById('refresh-orders').addEventListener('click', loadOrders);
      document.getElementById('export-orders').addEventListener('click', exportOrders);
      document.getElementById('load-more-btn').addEventListener('click', loadMoreOrders);
      
      // Modal controls
      document.getElementById('close-modal').addEventListener('click', closeOrderModal);
      document.getElementById('cancel-status-update').addEventListener('click', closeStatusModal);
      document.getElementById('confirm-status-update').addEventListener('click', confirmStatusUpdate);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function handleSearch(e) {
      const query = e.target.value.toLowerCase().trim();
      applyFilters();
    }

    function applyFilters() {
      const searchQuery = document.getElementById('search-orders').value.toLowerCase().trim();
      const statusFilter = document.getElementById('status-filter').value;
      const dateFilter = document.getElementById('date-filter').value;
      
      filteredOrders = allOrders.filter(order => {
        // Search filter
        if (searchQuery && !order.id.toString().includes(searchQuery) && 
            !order.buyer_name.toLowerCase().includes(searchQuery)) {
          return false;
        }
        
        // Status filter
        if (statusFilter && order.status !== statusFilter) {
          return false;
        }
        
        // Date filter
        if (dateFilter !== 'all') {
          const orderDate = new Date(order.created_at);
          const now = new Date();
          
          switch (dateFilter) {
            case 'today':
              if (!isToday(order.created_at)) return false;
              break;
            case 'yesterday':
              const yesterday = new Date(now);
              yesterday.setDate(yesterday.getDate() - 1);
              if (orderDate.toDateString() !== yesterday.toDateString()) return false;
              break;
            case 'week':
              const weekAgo = new Date(now);
              weekAgo.setDate(weekAgo.getDate() - 7);
              if (orderDate < weekAgo) return false;
              break;
            case 'month':
              if (!isThisMonth(order.created_at)) return false;
              break;
          }
        }
        
        return true;
      });
      
      currentPage = 1;
      renderOrders();
    }

    function loadMoreOrders() {
      currentPage++;
      renderOrders();
    }

    function exportOrders() {
      // Create CSV content
      const headers = ['Order ID', 'Buyer', 'Status', 'Items', 'Total Amount', 'Date', 'Address'];
      const csvContent = [
        headers.join(','),
        ...filteredOrders.map(order => [
          order.id,
          `"${order.buyer_name}"`,
          order.status,
          order.total_items,
          order.total_amount,
          new Date(order.created_at).toLocaleDateString(),
          `"${order.delivery_address}"`
        ].join(','))
      ].join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `local-market-orders-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Global functions for order actions
    window.viewOrderDetails = function(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;
      
      // Load detailed order information
      const token = localStorage.getItem('token');
      
      fetch(`/api/local-market-orders/seller/orders/${orderId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showOrderDetailsModal(data.order);
        }
      })
      .catch(error => {
        console.error('Error loading order details:', error);
        alert('Failed to load order details');
      });
    };

    window.updateOrderStatus = function(orderId) {
      selectedOrderId = orderId;
      document.getElementById('status-modal').classList.remove('hidden');
    };

    window.contactBuyer = function(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;
      
      // This would integrate with the messaging system
      alert(`Contact feature for order #${orderId} - Coming soon`);
    };

    function showOrderDetailsModal(order) {
      const modal = document.getElementById('order-modal');
      const content = document.getElementById('modal-content');
      
      content.innerHTML = `
        <div class="space-y-6">
          <!-- Order Header -->
          <div class="bg-gray-50 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-800">Order #${order.id}</h3>
              <span class="px-3 py-1 text-sm font-semibold rounded-full ${getStatusColor(order.status)}">
                ${getStatusText(order.status)}
              </span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-600">Customer</p>
                <p class="font-semibold">${order.buyer_name}</p>
              </div>
              <div>
                <p class="text-gray-600">Order Date</p>
                <p class="font-semibold">${new Date(order.created_at).toLocaleString()}</p>
              </div>
              <div>
                <p class="text-gray-600">Phone</p>
                <p class="font-semibold">${order.buyer_phone || 'Not provided'}</p>
              </div>
              <div>
                <p class="text-gray-600">Total Amount</p>
                <p class="font-semibold text-green-600">${(order.grand_total || order.total_amount || 0).toLocaleString()} RWF</p>
              </div>
            </div>
          </div>
          
          <!-- Order Items -->
          <div>
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Order Items</h4>
            <div class="space-y-3">
              ${(order.items || []).map(item => `
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                  <div class="w-16 h-16 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-shopping-basket text-green-600 text-xl"></i>
                  </div>
                  <div class="flex-1">
                    <h5 class="font-semibold text-gray-800">${item.product_name}</h5>
                    <p class="text-sm text-gray-600">${item.quantity} Ã— ${(item.unit_price || 0).toLocaleString()} RWF</p>
                    ${item.seller_name ? `<p class="text-xs text-gray-500">Seller: ${item.seller_name}</p>` : ''}
                  </div>
                  <div class="text-right">
                    <p class="font-semibold">${(item.total_price || 0).toLocaleString()} RWF</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Delivery Information -->
          <div>
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Delivery Information</h4>
            <div class="bg-gray-50 rounded-xl p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                  <p class="text-gray-600">Delivery Address</p>
                  <p class="font-semibold">${order.delivery_address || 'Address not provided'}</p>
                </div>
                <div>
                  <p class="text-gray-600">Payment Method</p>
                  <p class="font-semibold">${order.payment_method || 'Mobile Money'}</p>
                </div>
                <div>
                  <p class="text-gray-600">Payment Status</p>
                  <p class="font-semibold ${order.payment_status === 'confirmed' ? 'text-green-600' : 'text-yellow-600'}">${order.payment_status || 'Pending'}</p>
                </div>
                <div>
                  <p class="text-gray-600">Delivery Fee</p>
                  <p class="font-semibold">${(order.delivery_fee || 0).toLocaleString()} RWF</p>
                </div>
                ${order.agent_name ? `
                <div>
                  <p class="text-gray-600">Assigned Agent</p>
                  <p class="font-semibold">${order.agent_name}</p>
                  ${order.agent_phone ? `<p class="text-sm text-gray-500">${order.agent_phone}</p>` : ''}
                </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <!-- Order Timeline -->
          <div>
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Order Timeline</h4>
            <div class="space-y-4">
              ${order.timeline?.map(event => `
                <div class="flex items-start gap-4">
                  <div class="w-3 h-3 bg-green-500 rounded-full mt-2"></div>
                  <div>
                    <p class="font-semibold text-gray-800">${event.status}</p>
                    <p class="text-sm text-gray-600">${new Date(event.timestamp).toLocaleString()}</p>
                    ${event.notes ? `<p class="text-sm text-gray-500 mt-1">${event.notes}</p>` : ''}
                  </div>
                </div>
              `).join('') || '<p class="text-gray-500">No timeline available</p>'}
            </div>
          </div>
        </div>
      `;
      
      modal.classList.remove('hidden');
    }

    function closeOrderModal() {
      document.getElementById('order-modal').classList.add('hidden');
    }

    function closeStatusModal() {
      document.getElementById('status-modal').classList.add('hidden');
      selectedOrderId = null;
    }

    function confirmStatusUpdate() {
      if (!selectedOrderId) return;
      
      const newStatus = document.getElementById('new-status').value;
      const notes = document.getElementById('status-notes').value;
      
      const token = localStorage.getItem('token');
      
      fetch(`/api/local-market-orders/seller/orders/${selectedOrderId}/status`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus, notes })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeStatusModal();
          loadOrders(); // Refresh orders
          alert('Order status updated successfully!');
        } else {
          alert('Failed to update order status: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error updating order status:', error);
        alert('Failed to update order status');
      });
    }

    function setupRealTimeUpdates() {
      // This would integrate with Socket.IO for real-time order updates
      // For now, we'll just refresh every 30 seconds
      setInterval(() => {
        loadOrders();
      }, 30000);
    }
  </script>
</body>
</html>