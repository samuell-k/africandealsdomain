<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Local Market Products | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="/shared/auth-utils.js"></script>
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .product-card { transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .status-toggle { transition: all 0.3s ease; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-green-50 min-h-screen">

  <!-- Header -->
  <header class="glass shadow-lg sticky top-0 z-40">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo & Navigation -->
        <div class="flex items-center gap-4">
          <a href="/seller/local-market-dashboard.html" class="flex items-center gap-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-12 w-12 rounded-xl shadow-lg" />
          </a>
          <div>
            <h1 class="font-bold text-lg text-green-700">ðŸ›’ My Local Market Products</h1>
            <p class="text-xs text-gray-500">Manage your grocery inventory</p>
          </div>
        </div>

        <!-- Navigation Links -->
        <div class="flex items-center gap-4">
          <a href="/seller/local-market-dashboard.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
          </a>
          <a href="/seller/add-local-market-product.html" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-medium transition-colors">
            <i class="fas fa-plus mr-2"></i>Add Product
          </a>
          <a href="/seller/dashboard.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-box mr-2"></i>Physical Products
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-8xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Products</p>
            <p class="text-3xl font-bold text-blue-600" id="total-products">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-shopping-basket text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Active Products</p>
            <p class="text-3xl font-bold text-green-600" id="active-products">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Low Stock</p>
            <p class="text-3xl font-bold text-yellow-600" id="low-stock">0</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Out of Stock</p>
            <p class="text-3xl font-bold text-red-600" id="out-stock">0</p>
          </div>
          <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
            <i class="fas fa-times-circle text-red-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 fade-in">
      <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
        <div class="flex flex-col sm:flex-row gap-4 flex-1">
          <div class="relative">
            <input type="text" id="search-products" placeholder="Search products..." 
                   class="pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent w-full sm:w-64">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
          
          <select id="category-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            <option value="">All Categories</option>
            <option value="vegetables">Vegetables</option>
            <option value="fruits">Fruits</option>
            <option value="dairy">Dairy & Eggs</option>
            <option value="meat">Meat & Poultry</option>
            <option value="grains">Grains & Cereals</option>
            <option value="beverages">Beverages</option>
            <option value="spices">Spices & Herbs</option>
            <option value="other">Other</option>
          </select>

          <select id="status-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="low_stock">Low Stock</option>
            <option value="out_of_stock">Out of Stock</option>
          </select>

          <select id="sort-filter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            <option value="name">Sort by Name</option>
            <option value="price_low">Price: Low to High</option>
            <option value="price_high">Price: High to Low</option>
            <option value="stock">Stock Level</option>
            <option value="newest">Newest First</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button id="bulk-actions-btn" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-colors">
            <i class="fas fa-tasks mr-2"></i>Bulk Actions
          </button>
          <button id="export-products" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-colors">
            <i class="fas fa-download mr-2"></i>Export
          </button>
        </div>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="space-y-6">
      <!-- Loading State -->
      <div id="products-loading" class="text-center py-12">
        <i class="fas fa-spinner loading-spinner text-4xl text-green-600 mb-4"></i>
        <p class="text-lg font-semibold text-gray-800">Loading products...</p>
      </div>

      <!-- No Products State -->
      <div id="no-products" class="hidden text-center py-12">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-shopping-basket text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">No products found</h3>
        <p class="text-gray-600 mb-6">You don't have any products matching the current filters.</p>
        <a href="/seller/add-local-market-product.html" class="inline-flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-colors">
          <i class="fas fa-plus mr-2"></i>Add Your First Product
        </a>
      </div>

      <!-- Products Container -->
      <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Products will be populated here -->
      </div>
    </div>

    <!-- Load More Button -->
    <div id="load-more-container" class="text-center mt-8 hidden">
      <button id="load-more-btn" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-colors">
        <i class="fas fa-chevron-down mr-2"></i>Load More Products
      </button>
    </div>
  </main>

  <!-- Product Edit Modal -->
  <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-800">Edit Product</h2>
        <button id="close-edit-modal" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
          <i class="fas fa-times text-gray-600"></i>
        </button>
      </div>
      <div id="edit-modal-content" class="p-6">
        <!-- Edit form will be populated here -->
      </div>
    </div>
  </div>

  <!-- Bulk Actions Modal -->
  <div id="bulk-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-md w-full">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Bulk Actions</h3>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <button onclick="bulkAction('activate')" class="w-full text-left px-4 py-3 bg-green-50 hover:bg-green-100 text-green-700 rounded-xl transition-colors">
            <i class="fas fa-check-circle mr-3"></i>Activate Selected Products
          </button>
          <button onclick="bulkAction('deactivate')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl transition-colors">
            <i class="fas fa-pause-circle mr-3"></i>Deactivate Selected Products
          </button>
          <button onclick="bulkAction('delete')" class="w-full text-left px-4 py-3 bg-red-50 hover:bg-red-100 text-red-700 rounded-xl transition-colors">
            <i class="fas fa-trash mr-3"></i>Delete Selected Products
          </button>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-200">
          <button id="close-bulk-modal" class="w-full px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let allProducts = [];
    let filteredProducts = [];
    let selectedProducts = new Set();
    let currentPage = 1;
    const productsPerPage = 12;

    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/public/login.html';
        return;
      }

      // Initialize the page
      initializePage();
    });

    function initializePage() {
      loadProducts();
      setupEventListeners();
    }

    function loadProducts() {
      showProductsLoading(true);
      
      const token = localStorage.getItem('token');
      
      fetch('/api/grocery-seller/grocery-products', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        showProductsLoading(false);
        if (data.success) {
          allProducts = data.products;
          filteredProducts = allProducts;
          renderProducts();
          updateStats();
        } else {
          showNoProducts();
        }
      })
      .catch(error => {
        showProductsLoading(false);
        console.error('Error loading products:', error);
        showMockData(); // Show mock data for demonstration
      });
    }

    function showMockData() {
      // Mock data for demonstration
      allProducts = [
        {
          id: 1,
          product_name: 'Fresh Tomatoes',
          description: 'Locally grown organic tomatoes, perfect for cooking and salads',
          category: 'vegetables',
          price_per_unit: 275,
          unit_type: 'kg',
          stock_quantity: 45,
          is_active: 1,
          main_image: '/public/images/tomatoes.jpg',
          created_at: '2024-01-15T10:30:00Z'
        },
        {
          id: 2,
          product_name: 'Organic Milk',
          description: 'Fresh organic milk from local dairy farms',
          category: 'dairy',
          price_per_unit: 1200,
          unit_type: 'liter',
          stock_quantity: 8,
          is_active: 1,
          main_image: '/public/images/milk.jpg',
          created_at: '2024-01-14T15:20:00Z'
        },
        {
          id: 3,
          product_name: 'Irish Potatoes',
          description: 'High quality Irish potatoes from Musanze',
          category: 'vegetables',
          price_per_unit: 450,
          unit_type: 'kg',
          stock_quantity: 0,
          is_active: 1,
          main_image: '/public/images/potatoes.jpg',
          created_at: '2024-01-13T09:15:00Z'
        },
        {
          id: 4,
          product_name: 'Fresh Eggs',
          description: 'Farm fresh eggs from free-range chickens',
          category: 'dairy',
          price_per_unit: 150,
          unit_type: 'piece',
          stock_quantity: 120,
          is_active: 0,
          main_image: '/public/images/eggs.jpg',
          created_at: '2024-01-12T14:45:00Z'
        }
      ];
      
      filteredProducts = allProducts;
      renderProducts();
      updateStats();
    }

    function renderProducts() {
      const container = document.getElementById('products-container');
      const startIndex = (currentPage - 1) * productsPerPage;
      const endIndex = startIndex + productsPerPage;
      const productsToShow = filteredProducts.slice(startIndex, endIndex);

      if (productsToShow.length === 0) {
        showNoProducts();
        return;
      }

      document.getElementById('no-products').classList.add('hidden');
      container.classList.remove('hidden');

      if (currentPage === 1) {
        container.innerHTML = '';
      }

      productsToShow.forEach(product => {
        const productCard = createProductCard(product);
        container.appendChild(productCard);
      });

      updateLoadMoreButton();
    }

    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow-lg overflow-hidden product-card fade-in';
      
      const stockStatus = getStockStatus(product.stock_quantity);
      const statusColor = getStatusColor(product.is_active, product.stock_quantity);
      
      card.innerHTML = `
        <div class="relative">
          <img src="${product.main_image || '/public/images/placeholder-product.jpg'}" 
               alt="${product.product_name}" class="w-full h-48 object-cover">
          <div class="absolute top-4 right-4">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor.bg} ${statusColor.text}">
              ${getStatusText(product.is_active, product.stock_quantity)}
            </span>
          </div>
          <div class="absolute top-4 left-4">
            <input type="checkbox" class="product-checkbox w-4 h-4 text-green-600 rounded" 
                   data-product-id="${product.id}" onchange="toggleProductSelection(${product.id})">
          </div>
        </div>
        
        <div class="p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-2">${product.product_name}</h3>
          <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description}</p>
          
          <div class="flex items-center justify-between mb-4">
            <div>
              <span class="text-xl font-bold text-green-600">${product.price_per_unit.toLocaleString()} RWF</span>
              <span class="text-gray-500 text-sm">/ ${product.unit_type}</span>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-500">Stock</p>
              <p class="font-semibold ${stockStatus.color}">${product.stock_quantity} ${product.unit_type}</p>
            </div>
          </div>
          
          <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
            <span><i class="fas fa-tag mr-1"></i>${product.category}</span>
            <span><i class="fas fa-calendar mr-1"></i>${new Date(product.created_at).toLocaleDateString()}</span>
          </div>
          
          <div class="flex items-center gap-2">
            <button onclick="editProduct(${product.id})" 
                    class="flex-1 px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold rounded-lg transition-colors">
              <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button onclick="toggleProductStatus(${product.id})" 
                    class="flex-1 px-3 py-2 ${product.is_active ? 'bg-yellow-100 hover:bg-yellow-200 text-yellow-700' : 'bg-green-100 hover:bg-green-200 text-green-700'} font-semibold rounded-lg transition-colors">
              <i class="fas fa-${product.is_active ? 'pause' : 'play'} mr-1"></i>${product.is_active ? 'Deactivate' : 'Activate'}
            </button>
            <button onclick="deleteProduct(${product.id})" 
                    class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 font-semibold rounded-lg transition-colors">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      return card;
    }

    function getStockStatus(quantity) {
      if (quantity === 0) return { color: 'text-red-600', text: 'Out of Stock' };
      if (quantity <= 10) return { color: 'text-yellow-600', text: 'Low Stock' };
      return { color: 'text-green-600', text: 'In Stock' };
    }

    function getStatusColor(isActive, stockQuantity) {
      if (!isActive) return { bg: 'bg-gray-100', text: 'text-gray-800' };
      if (stockQuantity === 0) return { bg: 'bg-red-100', text: 'text-red-800' };
      if (stockQuantity <= 10) return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
      return { bg: 'bg-green-100', text: 'text-green-800' };
    }

    function getStatusText(isActive, stockQuantity) {
      if (!isActive) return 'Inactive';
      if (stockQuantity === 0) return 'Out of Stock';
      if (stockQuantity <= 10) return 'Low Stock';
      return 'Active';
    }

    function updateStats() {
      const total = allProducts.length;
      const active = allProducts.filter(p => p.is_active && p.stock_quantity > 0).length;
      const lowStock = allProducts.filter(p => p.stock_quantity > 0 && p.stock_quantity <= 10).length;
      const outOfStock = allProducts.filter(p => p.stock_quantity === 0).length;

      document.getElementById('total-products').textContent = total;
      document.getElementById('active-products').textContent = active;
      document.getElementById('low-stock').textContent = lowStock;
      document.getElementById('out-stock').textContent = outOfStock;
    }

    function showProductsLoading(show) {
      const loading = document.getElementById('products-loading');
      const container = document.getElementById('products-container');
      const noProducts = document.getElementById('no-products');
      
      if (show) {
        loading.classList.remove('hidden');
        container.classList.add('hidden');
        noProducts.classList.add('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }

    function showNoProducts() {
      document.getElementById('products-loading').classList.add('hidden');
      document.getElementById('products-container').classList.add('hidden');
      document.getElementById('no-products').classList.remove('hidden');
    }

    function updateLoadMoreButton() {
      const container = document.getElementById('load-more-container');
      const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
      
      if (currentPage < totalPages) {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    }

    function setupEventListeners() {
      // Search and filter functionality
      document.getElementById('search-products').addEventListener('input', debounce(applyFilters, 300));
      document.getElementById('category-filter').addEventListener('change', applyFilters);
      document.getElementById('status-filter').addEventListener('change', applyFilters);
      document.getElementById('sort-filter').addEventListener('change', applyFilters);
      
      // Action buttons
      document.getElementById('bulk-actions-btn').addEventListener('click', showBulkModal);
      document.getElementById('export-products').addEventListener('click', exportProducts);
      document.getElementById('load-more-btn').addEventListener('click', loadMoreProducts);
      
      // Modal controls
      document.getElementById('close-edit-modal').addEventListener('click', closeEditModal);
      document.getElementById('close-bulk-modal').addEventListener('click', closeBulkModal);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function applyFilters() {
      const searchQuery = document.getElementById('search-products').value.toLowerCase().trim();
      const categoryFilter = document.getElementById('category-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      const sortFilter = document.getElementById('sort-filter').value;
      
      filteredProducts = allProducts.filter(product => {
        // Search filter
        if (searchQuery && !product.product_name.toLowerCase().includes(searchQuery) && 
            !product.description.toLowerCase().includes(searchQuery)) {
          return false;
        }
        
        // Category filter
        if (categoryFilter && product.category !== categoryFilter) {
          return false;
        }
        
        // Status filter
        if (statusFilter) {
          switch (statusFilter) {
            case 'active':
              if (!product.is_active || product.stock_quantity === 0) return false;
              break;
            case 'inactive':
              if (product.is_active) return false;
              break;
            case 'low_stock':
              if (product.stock_quantity > 10 || product.stock_quantity === 0) return false;
              break;
            case 'out_of_stock':
              if (product.stock_quantity > 0) return false;
              break;
          }
        }
        
        return true;
      });
      
      // Apply sorting
      if (sortFilter === 'price_low') {
        filteredProducts.sort((a, b) => a.price_per_unit - b.price_per_unit);
      } else if (sortFilter === 'price_high') {
        filteredProducts.sort((a, b) => b.price_per_unit - a.price_per_unit);
      } else if (sortFilter === 'stock') {
        filteredProducts.sort((a, b) => b.stock_quantity - a.stock_quantity);
      } else if (sortFilter === 'newest') {
        filteredProducts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      } else {
        filteredProducts.sort((a, b) => a.product_name.localeCompare(b.product_name));
      }
      
      currentPage = 1;
      renderProducts();
    }

    function loadMoreProducts() {
      currentPage++;
      renderProducts();
    }

    function exportProducts() {
      const csvContent = generateProductsCSV();
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `local-market-products-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function generateProductsCSV() {
      const headers = ['Product Name', 'Category', 'Price', 'Unit', 'Stock', 'Status', 'Created Date'];
      const csvContent = [
        headers.join(','),
        ...filteredProducts.map(product => [
          `"${product.product_name}"`,
          product.category,
          product.price_per_unit,
          product.unit_type,
          product.stock_quantity,
          product.is_active ? 'Active' : 'Inactive',
          new Date(product.created_at).toLocaleDateString()
        ].join(','))
      ].join('\n');
      
      return csvContent;
    }

    // Global functions for product actions
    window.editProduct = function(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;
      
      showEditModal(product);
    };

    window.toggleProductStatus = function(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;
      
      const newStatus = !product.is_active;
      const token = localStorage.getItem('token');
      
      fetch(`/api/grocery-seller/grocery-products/${productId}/status`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_active: newStatus })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          product.is_active = newStatus;
          renderProducts();
          updateStats();
        } else {
          alert('Failed to update product status: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error updating product status:', error);
        // For demo, update locally
        product.is_active = newStatus;
        renderProducts();
        updateStats();
      });
    };

    window.deleteProduct = function(productId) {
      if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      
      fetch(`/api/grocery-seller/grocery-products/${productId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          allProducts = allProducts.filter(p => p.id !== productId);
          filteredProducts = filteredProducts.filter(p => p.id !== productId);
          renderProducts();
          updateStats();
        } else {
          alert('Failed to delete product: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error deleting product:', error);
        // For demo, delete locally
        allProducts = allProducts.filter(p => p.id !== productId);
        filteredProducts = filteredProducts.filter(p => p.id !== productId);
        renderProducts();
        updateStats();
      });
    };

    window.toggleProductSelection = function(productId) {
      if (selectedProducts.has(productId)) {
        selectedProducts.delete(productId);
      } else {
        selectedProducts.add(productId);
      }
    };

    function showEditModal(product) {
      const modal = document.getElementById('edit-modal');
      const content = document.getElementById('edit-modal-content');
      
      content.innerHTML = `
        <form id="edit-product-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
              <input type="text" id="edit-name" value="${product.product_name}" 
                     class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
              <select id="edit-category" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
                <option value="vegetables" ${product.category === 'vegetables' ? 'selected' : ''}>Vegetables</option>
                <option value="fruits" ${product.category === 'fruits' ? 'selected' : ''}>Fruits</option>
                <option value="dairy" ${product.category === 'dairy' ? 'selected' : ''}>Dairy & Eggs</option>
                <option value="meat" ${product.category === 'meat' ? 'selected' : ''}>Meat & Poultry</option>
                <option value="grains" ${product.category === 'grains' ? 'selected' : ''}>Grains & Cereals</option>
                <option value="beverages" ${product.category === 'beverages' ? 'selected' : ''}>Beverages</option>
                <option value="spices" ${product.category === 'spices' ? 'selected' : ''}>Spices & Herbs</option>
                <option value="other" ${product.category === 'other' ? 'selected' : ''}>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Price per Unit (RWF)</label>
              <input type="number" id="edit-price" value="${product.price_per_unit}" min="1"
                     class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity</label>
              <input type="number" id="edit-stock" value="${product.stock_quantity}" min="0"
                     class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
            <textarea id="edit-description" rows="4" 
                      class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">${product.description}</textarea>
          </div>
          <div class="flex gap-4">
            <button type="button" onclick="closeEditModal()" 
                    class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
              Cancel
            </button>
            <button type="submit" 
                    class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-colors">
              Save Changes
            </button>
          </div>
        </form>
      `;
      
      // Setup form submission
      document.getElementById('edit-product-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProductChanges(product.id);
      });
      
      modal.classList.remove('hidden');
    }

    function saveProductChanges(productId) {
      const formData = {
        product_name: document.getElementById('edit-name').value,
        category: document.getElementById('edit-category').value,
        price_per_unit: parseFloat(document.getElementById('edit-price').value),
        stock_quantity: parseInt(document.getElementById('edit-stock').value),
        description: document.getElementById('edit-description').value
      };
      
      const token = localStorage.getItem('token');
      
      fetch(`/api/grocery-seller/grocery-products/${productId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update local data
          const productIndex = allProducts.findIndex(p => p.id === productId);
          if (productIndex >= 0) {
            allProducts[productIndex] = { ...allProducts[productIndex], ...formData };
          }
          
          closeEditModal();
          applyFilters(); // Re-render with current filters
          updateStats();
          alert('Product updated successfully!');
        } else {
          alert('Failed to update product: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error updating product:', error);
        // For demo, update locally
        const productIndex = allProducts.findIndex(p => p.id === productId);
        if (productIndex >= 0) {
          allProducts[productIndex] = { ...allProducts[productIndex], ...formData };
        }
        closeEditModal();
        applyFilters();
        updateStats();
        alert('Product updated successfully!');
      });
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
    }

    function showBulkModal() {
      if (selectedProducts.size === 0) {
        alert('Please select products first');
        return;
      }
      document.getElementById('bulk-modal').classList.remove('hidden');
    }

    function closeBulkModal() {
      document.getElementById('bulk-modal').classList.add('hidden');
    }

    window.bulkAction = function(action) {
      if (selectedProducts.size === 0) {
        alert('No products selected');
        return;
      }
      
      const productIds = Array.from(selectedProducts);
      let confirmMessage = '';
      
      switch (action) {
        case 'activate':
          confirmMessage = `Activate ${productIds.length} selected products?`;
          break;
        case 'deactivate':
          confirmMessage = `Deactivate ${productIds.length} selected products?`;
          break;
        case 'delete':
          confirmMessage = `Delete ${productIds.length} selected products? This action cannot be undone.`;
          break;
      }
      
      if (!confirm(confirmMessage)) return;
      
      // For demo, perform action locally
      productIds.forEach(id => {
        const product = allProducts.find(p => p.id === id);
        if (product) {
          switch (action) {
            case 'activate':
              product.is_active = 1;
              break;
            case 'deactivate':
              product.is_active = 0;
              break;
            case 'delete':
              allProducts = allProducts.filter(p => p.id !== id);
              filteredProducts = filteredProducts.filter(p => p.id !== id);
              break;
          }
        }
      });
      
      selectedProducts.clear();
      document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
      
      closeBulkModal();
      renderProducts();
      updateStats();
      
      alert(`Bulk ${action} completed successfully!`);
    };
  </script>
</body>
</html>