<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Local Market Product | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/shared/auth-utils.js"></script>
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    #location-map { height: 350px; }
    .drag-drop-area { border: 2px dashed #d1d5db; transition: all 0.3s ease; }
    .drag-drop-area.dragover { border-color: #10b981; background-color: #f0fdf4; }
    .image-preview { position: relative; display: inline-block; }
    .image-preview img { max-width: 150px; max-height: 150px; object-fit: cover; }
    .remove-image { position: absolute; top: -8px; right: -8px; }
  </style>
</head>
<body class="bg-green-50 min-h-screen">

  <!-- Header -->
  <header class="glass shadow-lg sticky top-0 z-40">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo & Navigation -->
        <div class="flex items-center gap-4">
          <a href="/seller/local-market-dashboard.html" class="flex items-center gap-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-12 w-12 rounded-xl shadow-lg" />
          </a>
          <div>
            <h1 class="font-bold text-lg text-green-700">🛒 Add Local Market Product</h1>
            <p class="text-xs text-gray-500">Create a new grocery listing</p>
          </div>
        </div>

        <!-- Navigation Links -->
        <div class="flex items-center gap-4">
          <a href="/seller/local-market-dashboard.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
          </a>
          <a href="/seller/dashboard.html" class="text-gray-600 hover:text-green-700 font-medium transition-colors">
            <i class="fas fa-box mr-2"></i>Physical Products
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Progress Indicator -->
    <div class="mb-8">
      <div class="flex items-center justify-center">
        <div class="flex items-center space-x-4">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
            <span class="ml-2 text-sm font-medium text-green-600">Product Info</span>
          </div>
          <div class="w-16 h-1 bg-green-200"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">2</div>
            <span class="ml-2 text-sm font-medium text-green-600">Location & Images</span>
          </div>
          <div class="w-16 h-1 bg-green-200"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">3</div>
            <span class="ml-2 text-sm font-medium text-green-600">Review & Submit</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Container -->
    <div class="bg-white rounded-2xl shadow-xl p-8 fade-in">
      <form id="add-product-form" class="space-y-8">
        
        <!-- Basic Product Information -->
        <section>
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-info-circle text-green-600 mr-3"></i>
            Basic Product Information
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
              <input type="text" id="product-name" required 
                     class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent"
                     placeholder="e.g., Fresh Organic Tomatoes">
              <p class="text-xs text-gray-500 mt-1">Choose a clear, descriptive name</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
              <select id="product-category" required 
                      class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
                <option value="">Select Category</option>
                <option value="vegetables">🥬 Vegetables</option>
                <option value="fruits">🍎 Fruits</option>
                <option value="dairy">🥛 Dairy & Eggs</option>
                <option value="meat">🥩 Meat & Poultry</option>
                <option value="grains">🌾 Grains & Cereals</option>
                <option value="beverages">🥤 Beverages</option>
                <option value="spices">🌶️ Spices & Herbs</option>
                <option value="other">📦 Other</option>
              </select>
            </div>

            <div class="lg:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Product Description *</label>
              <textarea id="product-description" rows="4" required
                        class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="Describe your product quality, origin, freshness, organic certification, etc."></textarea>
              <p class="text-xs text-gray-500 mt-1">Detailed descriptions help buyers make informed decisions</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Sub-Category</label>
              <select id="product-subcategory" 
                      class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
                <option value="">Select Sub-Category</option>
                <!-- Will be populated based on category selection -->
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Measurement Unit *</label>
              <select id="measurement-type" required 
                      class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
                <option value="">Select Unit</option>
                <option value="kg">⚖️ Kilogram (kg)</option>
                <option value="g">⚖️ Gram (g)</option>
                <option value="l">🥤 Liter (L)</option>
                <option value="ml">🥤 Milliliter (ml)</option>
                <option value="pcs">📦 Pieces (pcs)</option>
                <option value="dozen">📦 Dozen</option>
                <option value="bundle">📦 Bundle</option>
                <option value="bag">📦 Bag</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Pricing & Stock -->
        <section>
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-dollar-sign text-green-600 mr-3"></i>
            Pricing & Stock Information
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Your Base Price per Unit (RWF) *</label>
              <input type="number" id="product-price" required min="1" step="1"
                     class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500"
                     placeholder="e.g., 275">
              <p class="text-xs text-green-600 mt-1">💡 Platform adds 21% automatically - customers see final price with FREE delivery!</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Stock Available *</label>
              <div class="flex gap-2">
                <input type="number" id="stock-quantity" required min="0" step="0.1"
                       class="flex-1 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500"
                       placeholder="e.g., 750">
                <span id="stock-unit" class="flex items-center px-4 bg-gray-100 rounded-xl text-gray-600 font-medium">
                  Unit
                </span>
              </div>
              <p class="text-xs text-gray-500 mt-1">Current available quantity</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Product Status</label>
              <div class="flex items-center space-x-4 p-4 border border-gray-300 rounded-xl">
                <label class="flex items-center">
                  <input type="radio" name="product-status" value="active" checked class="w-4 h-4 text-green-600">
                  <span class="ml-2 text-sm">🟢 Active (Visible to buyers)</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="product-status" value="inactive" class="w-4 h-4 text-gray-600">
                  <span class="ml-2 text-sm">🔴 Inactive (Hidden)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Commission Preview -->
          <div id="commission-preview" class="mt-6"></div>
        </section>

        <!-- Product Images -->
        <section>
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-camera text-green-600 mr-3"></i>
            Product Images
          </h2>
          
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-500 transition-colors drag-drop-area">
            <input type="file" id="product-images" multiple accept="image/*" class="hidden">
            <div id="image-upload-area" class="cursor-pointer" onclick="document.getElementById('product-images').click()">
              <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">Upload Product Images</h3>
              <p class="text-gray-600 mb-2">Click to browse or drag and drop images here</p>
              <p class="text-sm text-gray-500">First image will be the main product image • Max 5 images • JPG, PNG supported</p>
            </div>
            <div id="image-preview" class="mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 hidden"></div>
          </div>
        </section>

        <!-- Product Location -->
        <section>
          <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-map-marker-alt text-green-600 mr-3"></i>
            Product Location
          </h2>
          
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
            <div class="flex items-start gap-3">
              <i class="fas fa-info-circle text-blue-600 mt-1"></i>
              <div>
                <h3 class="font-semibold text-blue-800 mb-1">Why Location Matters</h3>
                <p class="text-sm text-blue-700">
                  The location you set will be used to calculate delivery fees for buyers based on distance. 
                  Make sure to place the marker at your exact product location (farm, store, warehouse, etc.).
                </p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
              <div id="location-map" class="rounded-xl border border-gray-200 mb-4"></div>
              <p class="text-sm text-gray-600">
                <i class="fas fa-mouse-pointer mr-1"></i>
                Click on the map or drag the marker to set your product location
              </p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
                <input type="text" id="location-lat" readonly class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-600">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
                <input type="text" id="location-lng" readonly class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-600">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                <textarea id="location-address" readonly rows="3" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-600"></textarea>
              </div>
              <button type="button" onclick="getCurrentLocation()" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-3 rounded-lg transition-colors">
                <i class="fas fa-crosshairs mr-2"></i>Use My Current Location
              </button>
            </div>
          </div>
        </section>

        <!-- Duplicate Check Warning -->
        <div id="duplicate-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
            <div>
              <h3 class="font-semibold text-yellow-800 mb-1">Potential Duplicate Product</h3>
              <p class="text-sm text-yellow-700">
                A product with a similar name already exists at this location. Please ensure this is a different product or choose a different location.
              </p>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-between items-center pt-8 border-t border-gray-200">
          <button type="button" onclick="resetForm()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
            <i class="fas fa-undo mr-2"></i>Reset Form
          </button>
          
          <div class="flex gap-4">
            <button type="button" onclick="saveDraft()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-colors">
              <i class="fas fa-save mr-2"></i>Save as Draft
            </button>
            <button type="submit" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl transition-colors shadow-lg">
              <i class="fas fa-plus mr-2"></i>Add Product
            </button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 text-center">
      <i class="fas fa-spinner loading-spinner text-4xl text-green-600 mb-4"></i>
      <p class="text-lg font-semibold text-gray-800">Adding Product...</p>
      <p class="text-sm text-gray-600">Please wait while we process your product</p>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check text-2xl text-green-600"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Product Added Successfully!</h2>
      <p class="text-gray-600 mb-6">Your product has been added to the local marketplace and is now visible to buyers.</p>
      
      <div class="flex gap-4">
        <button onclick="addAnotherProduct()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg transition-colors">
          Add Another
        </button>
        <button onclick="goToDashboard()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors">
          View Dashboard
        </button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let map;
    let currentMarker;
    let selectedLocation = null;
    let defaultLocation = { lat: -1.9441, lng: 30.0619 }; // Kigali default
    let existingProducts = [];

    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/public/login.html';
        return;
      }

      // Initialize the page
      initializePage();
    });

    function initializePage() {
      loadUserLocation();
      loadExistingProducts();
      initializeMap();
      setupFormHandlers();
      setupDragAndDrop();
    }

    function loadUserLocation() {
      const token = localStorage.getItem('token');
      
      fetch('/api/auth/profile', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.user.latitude && data.user.longitude) {
          defaultLocation = { lat: data.user.latitude, lng: data.user.longitude };
          selectedLocation = defaultLocation;
          if (map) {
            map.setView([defaultLocation.lat, defaultLocation.lng], 13);
            currentMarker.setLatLng([defaultLocation.lat, defaultLocation.lng]);
            updateLocationDisplay();
          }
        }
      })
      .catch(error => console.error('Error loading user location:', error));
    }

    function loadExistingProducts() {
      const token = localStorage.getItem('token');
      
      fetch('/api/grocery-seller/grocery-products', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          existingProducts = data.products;
        }
      })
      .catch(error => console.error('Error loading existing products:', error));
    }

    function initializeMap() {
      map = L.map('location-map').setView([defaultLocation.lat, defaultLocation.lng], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      
      currentMarker = L.marker([defaultLocation.lat, defaultLocation.lng], { draggable: true })
        .addTo(map)
        .bindPopup('Product location - drag to move or click on map');
      
      selectedLocation = defaultLocation;
      updateLocationDisplay();
      
      currentMarker.on('dragend', function(e) {
        const position = e.target.getLatLng();
        selectedLocation = { lat: position.lat, lng: position.lng };
        updateLocationDisplay();
        checkForDuplicates();
      });
      
      map.on('click', function(e) {
        currentMarker.setLatLng(e.latlng);
        selectedLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
        updateLocationDisplay();
        checkForDuplicates();
      });
    }

    function updateLocationDisplay() {
      if (selectedLocation) {
        document.getElementById('location-lat').value = selectedLocation.lat.toFixed(6);
        document.getElementById('location-lng').value = selectedLocation.lng.toFixed(6);
        
        // Reverse geocoding to get address
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedLocation.lat}&lon=${selectedLocation.lng}`)
          .then(response => response.json())
          .then(data => {
            document.getElementById('location-address').value = data.display_name || 'Address not found';
          })
          .catch(error => {
            console.error('Error getting address:', error);
            document.getElementById('location-address').value = 'Address lookup failed';
          });
      }
    }

    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          selectedLocation = { lat, lng };
          currentMarker.setLatLng([lat, lng]);
          map.setView([lat, lng], 15);
          updateLocationDisplay();
          checkForDuplicates();
        }, function(error) {
          alert('Unable to get your location. Please set the location manually on the map.');
        });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }

    function setupFormHandlers() {
      // Form submission
      document.getElementById('add-product-form').addEventListener('submit', handleFormSubmission);
      
      // Image upload handling
      document.getElementById('product-images').addEventListener('change', handleImageUpload);
      
      // Measurement type change
      document.getElementById('measurement-type').addEventListener('change', function() {
        document.getElementById('stock-unit').textContent = this.value || 'Unit';
      });
      
      // Category change for subcategories
      document.getElementById('product-category').addEventListener('change', updateSubcategories);
      
      // Price and stock change for commission calculation
      document.getElementById('product-price').addEventListener('input', calculateCommission);
      document.getElementById('stock-quantity').addEventListener('input', calculateCommission);
      
      // Product name change for duplicate check
      document.getElementById('product-name').addEventListener('input', checkForDuplicates);
    }

    function setupDragAndDrop() {
      const dropArea = document.querySelector('.drag-drop-area');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight(e) {
        dropArea.classList.add('dragover');
      }
      
      function unhighlight(e) {
        dropArea.classList.remove('dragover');
      }
      
      dropArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        document.getElementById('product-images').files = files;
        handleImageUpload({ target: { files } });
      }
    }

    function handleImageUpload(e) {
      const files = e.target.files;
      const preview = document.getElementById('image-preview');
      
      if (files.length > 0) {
        preview.innerHTML = '';
        preview.classList.remove('hidden');
        
        Array.from(files).slice(0, 5).forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative image-preview';
            div.innerHTML = `
              <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg border-2 border-gray-200">
              <span class="absolute top-2 left-2 bg-green-600 text-white text-xs px-2 py-1 rounded font-semibold">
                ${index === 0 ? 'MAIN' : index + 1}
              </span>
              <button type="button" onclick="removeImage(${index})" class="remove-image w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                <i class="fas fa-times text-xs"></i>
              </button>
            `;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
        
        if (files.length > 5) {
          alert('Maximum 5 images allowed. Only the first 5 images will be used.');
        }
      }
    }

    function removeImage(index) {
      // This is a simplified version - in a real implementation, you'd need to manage the file list
      alert('Image removal - Feature needs enhancement');
    }

    function updateSubcategories() {
      const category = document.getElementById('product-category').value;
      const subcategorySelect = document.getElementById('product-subcategory');
      
      const subcategories = {
        vegetables: ['Leafy Greens', 'Root Vegetables', 'Tomatoes', 'Onions', 'Peppers', 'Cabbage', 'Other'],
        fruits: ['Citrus Fruits', 'Tropical Fruits', 'Berries', 'Stone Fruits', 'Bananas', 'Other'],
        dairy: ['Fresh Milk', 'Cheese', 'Yogurt', 'Eggs', 'Butter', 'Cream', 'Other'],
        meat: ['Beef', 'Chicken', 'Pork', 'Fish', 'Goat', 'Other'],
        grains: ['Rice', 'Wheat', 'Maize', 'Beans', 'Sorghum', 'Other'],
        beverages: ['Fresh Juices', 'Water', 'Soft Drinks', 'Tea/Coffee', 'Energy Drinks', 'Other'],
        spices: ['Local Spices', 'Imported Spices', 'Fresh Herbs', 'Dried Herbs', 'Other'],
        other: ['Miscellaneous Items']
      };
      
      subcategorySelect.innerHTML = '<option value="">Select Sub-Category</option>';
      
      if (category && subcategories[category]) {
        subcategories[category].forEach(sub => {
          const option = document.createElement('option');
          option.value = sub.toLowerCase().replace(/\s+/g, '_');
          option.textContent = sub;
          subcategorySelect.appendChild(option);
        });
      }
    }

    function calculateCommission() {
      const basePrice = parseFloat(document.getElementById('product-price').value) || 0;
      const quantity = parseFloat(document.getElementById('stock-quantity').value) || 0;
      
      if (basePrice > 0 && quantity > 0) {
        const finalPricePerUnit = Math.round(basePrice * 1.21); // Add 21% platform fee
        const totalValueToCustomers = finalPricePerUnit * quantity;
        const totalValueFromSeller = basePrice * quantity;
        const platformFee = totalValueToCustomers - totalValueFromSeller;
        
        document.getElementById('commission-preview').innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-xl p-6">
            <h4 class="font-semibold text-green-800 mb-4 flex items-center">
              <i class="fas fa-calculator mr-2"></i>
              💰 Pricing Preview - FREE Service to Attract Customers!
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="bg-white rounded-lg p-4 text-center">
                <p class="text-gray-600 mb-1">Your Price (What you entered)</p>
                <p class="text-2xl font-bold text-gray-800">${basePrice.toLocaleString()} RWF</p>
                <p class="text-xs text-gray-500">per unit</p>
              </div>
              <div class="bg-white rounded-lg p-4 text-center">
                <p class="text-gray-600 mb-1">Customer Sees (Final Price)</p>
                <p class="text-2xl font-bold text-blue-600">${finalPricePerUnit.toLocaleString()} RWF</p>
                <p class="text-xs text-green-600">✨ All fees included!</p>
              </div>
              <div class="bg-white rounded-lg p-4 text-center">
                <p class="text-gray-600 mb-1">Your Total Earnings</p>
                <p class="text-2xl font-bold text-green-600">${totalValueFromSeller.toLocaleString()} RWF</p>
                <p class="text-xs text-gray-500">for ${quantity} units</p>
              </div>
            </div>
            <div class="bg-white rounded-lg p-4 mt-4">
              <h5 class="font-semibold text-gray-800 mb-2">🎉 What customers see:</h5>
              <div class="flex justify-between items-center text-sm">
                <span>Product Price:</span>
                <span class="font-semibold">${finalPricePerUnit.toLocaleString()} RWF</span>
              </div>
              <div class="flex justify-between items-center text-sm text-green-600">
                <span>🚚 Delivery Fee:</span>
                <span class="font-semibold">FREE</span>
              </div>
              <div class="flex justify-between items-center text-sm text-green-600">
                <span>📦 Packaging Fee:</span>
                <span class="font-semibold">FREE</span>
              </div>
              <div class="flex justify-between items-center text-sm text-green-600">
                <span>🎉 Platform Fee:</span>
                <span class="font-semibold">FREE</span>
              </div>
              <hr class="my-2">
              <div class="flex justify-between items-center font-bold">
                <span>Total:</span>
                <span>${finalPricePerUnit.toLocaleString()} RWF</span>
              </div>
            </div>
            <p class="text-xs text-green-700 mt-4 text-center">
              <i class="fas fa-info-circle mr-1"></i>
              Platform automatically adds 21% to cover all fees. Customers see "FREE" delivery & fees to attract more sales!
            </p>
          </div>
        `;
      } else {
        document.getElementById('commission-preview').innerHTML = '';
      }
    }

    function checkForDuplicates() {
      const productName = document.getElementById('product-name').value.trim().toLowerCase();
      const warningDiv = document.getElementById('duplicate-warning');
      
      if (productName && selectedLocation && existingProducts.length > 0) {
        const isDuplicate = existingProducts.some(product => {
          const nameMatch = product.product_name.toLowerCase().includes(productName) || productName.includes(product.product_name.toLowerCase());
          const locationMatch = Math.abs(product.latitude - selectedLocation.lat) < 0.01 && Math.abs(product.longitude - selectedLocation.lng) < 0.01;
          return nameMatch && locationMatch;
        });
        
        if (isDuplicate) {
          warningDiv.classList.remove('hidden');
        } else {
          warningDiv.classList.add('hidden');
        }
      } else {
        warningDiv.classList.add('hidden');
      }
    }

    function handleFormSubmission(e) {
      e.preventDefault();
      
      // Validate required fields
      if (!selectedLocation) {
        alert('Please select a location on the map');
        return;
      }

      const images = document.getElementById('product-images').files;
      if (images.length === 0) {
        if (!confirm('No images uploaded. Continue without images?')) {
          return;
        }
      }

      showLoading(true);
      
      const formData = new FormData();
      
      // Basic product info
      formData.append('product_name', document.getElementById('product-name').value.trim());
      formData.append('description', document.getElementById('product-description').value.trim());
      formData.append('category', document.getElementById('product-category').value);
      formData.append('subcategory', document.getElementById('product-subcategory').value);
      formData.append('unit_type', document.getElementById('measurement-type').value);
      formData.append('price_per_unit', document.getElementById('product-price').value);
      formData.append('stock_quantity', document.getElementById('stock-quantity').value);
      
      // Product status
      const isActive = document.querySelector('input[name="product-status"]:checked').value === 'active';
      formData.append('is_active', isActive ? 1 : 0);
      
      // Location data
      formData.append('latitude', selectedLocation.lat);
      formData.append('longitude', selectedLocation.lng);
      formData.append('address', document.getElementById('location-address').value);
      
      // Images
      for (let i = 0; i < images.length; i++) {
        formData.append('product_images', images[i]);
      }
      
      const token = localStorage.getItem('token');
      
      fetch('/api/grocery-seller/add-grocery-product', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        showLoading(false);
        if (data.success) {
          showSuccessModal();
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        showLoading(false);
        console.error('Error:', error);
        alert('Failed to add product. Please check your connection and try again.');
      });
    }

    function saveDraft() {
      // Save form data to localStorage for later
      const formData = {
        product_name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        category: document.getElementById('product-category').value,
        subcategory: document.getElementById('product-subcategory').value,
        unit_type: document.getElementById('measurement-type').value,
        price_per_unit: document.getElementById('product-price').value,
        stock_quantity: document.getElementById('stock-quantity').value,
        location: selectedLocation
      };
      
      localStorage.setItem('product_draft', JSON.stringify(formData));
      alert('Draft saved successfully! You can continue editing later.');
    }

    function resetForm() {
      if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('add-product-form').reset();
        document.getElementById('image-preview').innerHTML = '';
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('commission-preview').innerHTML = '';
        document.getElementById('duplicate-warning').classList.add('hidden');
        document.getElementById('stock-unit').textContent = 'Unit';
        
        // Reset location to default
        if (currentMarker && map) {
          currentMarker.setLatLng([defaultLocation.lat, defaultLocation.lng]);
          selectedLocation = defaultLocation;
          updateLocationDisplay();
        }
      }
    }

    function showLoading(show) {
      const overlay = document.getElementById('loading-overlay');
      if (show) {
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    }

    function showSuccessModal() {
      document.getElementById('success-modal').classList.remove('hidden');
    }

    function addAnotherProduct() {
      document.getElementById('success-modal').classList.add('hidden');
      resetForm();
      window.scrollTo(0, 0);
    }

    function goToDashboard() {
      window.location.href = '/seller/local-market-dashboard.html';
    }

    // Load draft on page load
    window.addEventListener('load', function() {
      const draft = localStorage.getItem('product_draft');
      if (draft) {
        const data = JSON.parse(draft);
        if (confirm('Found a saved draft. Would you like to continue editing?')) {
          // Populate form with draft data
          Object.keys(data).forEach(key => {
            if (key === 'location' && data[key]) {
              selectedLocation = data[key];
              if (currentMarker) {
                currentMarker.setLatLng([data[key].lat, data[key].lng]);
                map.setView([data[key].lat, data[key].lng], 13);
                updateLocationDisplay();
              }
            } else if (document.getElementById(key)) {
              document.getElementById(key).value = data[key];
            }
          });
          
          // Trigger dependent updates
          updateSubcategories();
          calculateCommission();
        } else {
          localStorage.removeItem('product_draft');
        }
      }
    });
  </script>
</body>
</html>