<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product List | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <style>
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
    .brand-gradient { background: linear-gradient(135deg, #0e2038 0%, #23325c 50%, #1e3a8a 100%); }
    .country-flag { width: 24px; height: 16px; object-fit: cover; border-radius: 2px; }
    .currency-badge { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .loading-shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50">
  <!-- Header for Unsigned Users -->
  <header class="w-full glass shadow-lg border-b border-blue-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3 md:py-4">
      <a href="/" class="flex items-center gap-3 group">
        <img src="/public/images/logo.png" alt="ADD Physical Product Logo" class="h-12 w-12 rounded-xl shadow-lg group-hover:scale-110 transition-transform duration-300" />
        <span class="font-extrabold text-2xl md:text-3xl bg-gradient-to-r from-[#0e2038] to-[#23325c] bg-clip-text text-transparent">ADD Physical Products</span>
      </a>
      <div class="flex items-center gap-2 md:gap-4">
        <!-- Currency Switcher with Real-time Rates -->
        <div class="relative">
          <select id="currency-switcher" class="px-4 py-2 rounded-lg border-2 border-[#0e2038] text-[#0e2038] font-semibold bg-white/95 shadow-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
            <option value="RWF">ðŸ‡·ðŸ‡¼ RWF</option>
            <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
            <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
            <option value="KES">ðŸ‡°ðŸ‡ª KES</option>
            <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
          </select>
          <div id="currency-rate" class="absolute -bottom-6 left-0 text-xs text-gray-600 bg-white px-2 rounded"></div>
        </div>
        
        <!-- Delivery Picker with Flags -->
        <div class="relative">
          <select id="delivery-country" class="px-4 py-2 rounded-lg border-2 border-[#0e2038] text-[#0e2038] font-semibold bg-white/95 shadow-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
            <!-- Countries will be loaded dynamically -->
          </select>
        </div>
        
        <span id="delivery-notice" class="ml-2 font-semibold text-sm hide-mobile text-[#0e2038] flex items-center gap-1">
          <span id="delivery-flag">ðŸ‡·ðŸ‡¼</span>
          <span>Delivering to: <span id="delivery-country-name">Rwanda</span></span>
        </span>
        
        <!-- Auth Buttons -->
        <div class="flex items-center gap-2">
          <a href="/auth/auth-buyer.html" class="px-4 py-2 rounded-lg font-semibold border-2 border-[#0e2038] text-[#0e2038] bg-white/90 hover:bg-[#0e2038] hover:text-white transition-all duration-300 shadow-md">Sign In</a>
          <a href="/auth/auth-buyer.html" class="px-4 py-2 rounded-lg font-semibold text-white bg-gradient-to-r from-[#0e2038] to-[#23325c] hover:from-[#23325c] hover:to-[#0e2038] transition-all duration-300 shadow-md">Create Account</a>
          <a href="/auth/auth-seller.html" class="px-4 py-2 rounded-lg font-semibold border-2 border-green-600 text-green-600 bg-white/90 hover:bg-green-600 hover:text-white transition-all duration-300 shadow-md">Become a Seller</a>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-8">
    <!-- Search and Filter Section -->
    <section class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
      <div class="flex-1 flex gap-2">
        <input id="search-input" type="text" placeholder="Type to search products (min 2 chars)" onkeyup="handleProductSearch(this.value)" class="flex-1 px-4 py-2 border rounded focus:outline-none focus:ring">
        <button id="search-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition" onclick="showNotification('Feature in development', 'info')">Search</button>
      </div>
      <div class="flex gap-2">
        <select id="category-filter" class="px-4 py-2 border rounded">
          <option value="">All Categories</option>
          <!-- Categories will be loaded dynamically -->
        </select>
        <button id="filter-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition" onclick="showNotification('Feature in development', 'info')">Filter</button>
      </div>
    </section>

    <!-- Products Grid -->
    <section>
      <div id="products-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-6">
        <!-- Products will be loaded dynamically -->
        <div class="loading-shimmer bg-white rounded-lg shadow p-4 h-48"></div>
        <div class="loading-shimmer bg-white rounded-lg shadow p-4 h-48"></div>
        <div class="loading-shimmer bg-white rounded-lg shadow p-4 h-48"></div>
        <div class="loading-shimmer bg-white rounded-lg shadow p-4 h-48"></div>
      </div>
    </section>
  </main>

  <script>
    // Global state
    let products = [];
    let categories = [];
    let currencyRates = {};
    let selectedCurrency = localStorage.getItem('selectedCurrency') || 'RWF';
    let selectedCountry = localStorage.getItem('selectedCountry') || 'Rwanda';
    let countries = [];

    // Load countries
    async function loadCountries() {
      try {
        const response = await fetch('/public/countries.json');
        if (response.ok) {
          countries = await response.json();
        } else {
          // Fallback countries
          countries = [
            {name: "Rwanda", code: "RW", flag: "https://flagcdn.com/rw.svg"},
            {name: "Kenya", code: "KE", flag: "https://flagcdn.com/ke.svg"},
            {name: "Nigeria", code: "NG", flag: "https://flagcdn.com/ng.svg"},
            {name: "South Africa", code: "ZA", flag: "https://flagcdn.com/za.svg"},
            {name: "Ghana", code: "GH", flag: "https://flagcdn.com/gh.svg"},
            {name: "Uganda", code: "UG", flag: "https://flagcdn.com/ug.svg"},
            {name: "Tanzania", code: "TZ", flag: "https://flagcdn.com/tz.svg"}
          ];
        }
        populateCountrySelect();
      } catch (error) {
        console.error('Error loading countries:', error);
        // Fallback countries
        countries = [
          {name: "Rwanda", code: "RW", flag: "https://flagcdn.com/rw.svg"},
          {name: "Kenya", code: "KE", flag: "https://flagcdn.com/ke.svg"},
          {name: "Nigeria", code: "NG", flag: "https://flagcdn.com/ng.svg"},
          {name: "South Africa", code: "ZA", flag: "https://flagcdn.com/za.svg"},
          {name: "Ghana", code: "GH", flag: "https://flagcdn.com/gh.svg"},
          {name: "Uganda", code: "UG", flag: "https://flagcdn.com/ug.svg"},
          {name: "Tanzania", code: "TZ", flag: "https://flagcdn.com/tz.svg"}
        ];
        populateCountrySelect();
      }
    }

    function populateCountrySelect() {
      const select = document.getElementById('delivery-country');
      select.innerHTML = countries.map(country => 
        `<option value="${country.name}" data-flag="${country.flag}">${country.name}</option>`
      ).join('');
      select.value = selectedCountry;
      updateDeliveryNotice();
    }

    function updateDeliveryNotice() {
      const country = countries.find(c => c.name === selectedCountry);
      if (country) {
        document.getElementById('delivery-flag').innerHTML = `<img src="${country.flag}" class="country-flag" alt="${country.name}">`;
        document.getElementById('delivery-country-name').textContent = country.name;
      }
    }

    // Fetch and render products
    async function fetchProducts() {
      try {
        const response = await fetch('/api/products');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        
        if (data.success) {
          products = data.products;
          renderProducts();
          updateCurrencyDisplay();
        }
      } catch (error) {
        console.error('Error fetching products:', error);
        showNotification('Failed to load products. Please try again.', 'error');
        document.getElementById('products-grid').innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Failed to load products</div>';
      }
    }

    function renderProducts() {
      const grid = document.getElementById('products-grid');
      
      if (products.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No products found</div>';
        return;
      }

      grid.innerHTML = products.map(product => `
        <div class="bg-white rounded-lg shadow hover:shadow-xl transition p-4 flex flex-col animate-fade-in">
          <a href="/public/product-detail.html?id=${product.id}">
            <img src="${product.main_image ? `/uploads/${product.main_image}` : '/public/images/placeholder.jpg'}" 
                 alt="${product.name}" 
                 class="h-32 w-full object-cover rounded mb-2"
                 onerror="this.src='/public/images/logo.png'">
            <h3 class="font-bold text-lg mb-1">${product.name}</h3>
          </a>
          <div class="text-gray-700 mb-2">
            <span class="product-price" data-original-price="${product.price}" data-currency="${product.currency || 'USD'}">
              ${product.currency || 'USD'} ${product.price}
            </span>
          </div>
          <div class="mt-auto">
            <button onclick="viewProduct(${product.id})" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">
              View Details
            </button>
          </div>
        </div>
      `).join('');
    }

    // View product function - redirects to public product detail page
    function viewProduct(productId) {
      window.location.href = `/public/product-detail.html?id=${productId}`;
    }

    // Currency conversion
    async function fetchCurrencyRates() {
      try {
        const response = await fetch('https://v6.exchangerate-api.com/v6/c5f524e323378439dad2a43f/latest/USD');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        if (data && data.result === 'success') {
          currencyRates = data.conversion_rates;
          localStorage.setItem('currencyRates', JSON.stringify(currencyRates));
          updateCurrencyDisplay();
        }
      } catch (error) {
        console.error('Error fetching currency rates:', error);
        // Fallback rates
        currencyRates = { USD: 1, RWF: 1200, EUR: 0.9, KES: 130, NGN: 1500 };
        updateCurrencyDisplay();
      }
    }

    function updateCurrencyDisplay() {
      const currencySymbols = { USD: '$', RWF: 'FRw', EUR: 'â‚¬', KES: 'Ksh', NGN: 'â‚¦' };
      
      document.querySelectorAll('.product-price').forEach(priceElement => {
        const originalPrice = parseFloat(priceElement.dataset.originalPrice);
        const originalCurrency = priceElement.dataset.currency || 'USD';
        
        if (currencyRates[selectedCurrency] && currencyRates[originalCurrency]) {
          const convertedPrice = (originalPrice / currencyRates[originalCurrency]) * currencyRates[selectedCurrency];
          const symbol = currencySymbols[selectedCurrency] || selectedCurrency;
          priceElement.textContent = `${symbol} ${convertedPrice.toFixed(2)}`;
        }
      });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      loadCountries();
      fetchProducts();
      fetchCurrencyRates();

      // Currency switcher
      document.getElementById('currency-switcher').addEventListener('change', function(e) {
        selectedCurrency = e.target.value;
        localStorage.setItem('selectedCurrency', selectedCurrency);
        updateCurrencyDisplay();
      });

      // Country switcher
      document.getElementById('delivery-country').addEventListener('change', function(e) {
        selectedCountry = e.target.value;
        localStorage.setItem('selectedCountry', selectedCountry);
        updateDeliveryNotice();
      });

      // Set initial values
      document.getElementById('currency-switcher').value = selectedCurrency;
    });

    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-black' :
        'bg-blue-500 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Generic search handlers
    function handleProductSearch(query) {
      console.log('Searching products:', query);
      if (query.length > 2) {
        showNotification('Searching for: ' + query, 'info');
      }
    }

    function handleSellerSearch(query) {
      console.log('Searching sellers:', query);
      if (query.length > 2) {
        showNotification('Searching sellers: ' + query, 'info');
      }
    }

    function handleAgentSearch(query) {
      console.log('Searching agents:', query);
      if (query.length > 2) {
        showNotification('Searching agents: ' + query, 'info');
      }
    }

    function handleOrderSearch(query) {
      console.log('Searching orders:', query);
      if (query.length > 2) {
        showNotification('Searching orders: ' + query, 'info');
      }
    }

    function handleUserSearch(query) {
      console.log('Searching users:', query);
      if (query.length > 2) {
        showNotification('Searching users: ' + query, 'info');
      }
    }

    // Generic form handlers
    function handleSave() {
      showNotification('Save functionality will be implemented soon', 'info');
    }

    function handleEdit() {
      showNotification('Edit functionality will be implemented soon', 'info');
    }

    function handleDelete() {
      if (confirm('Are you sure you want to delete this item?')) {
        showNotification('Delete functionality will be implemented soon', 'info');
      }
    }

    function handleCancel() {
      if (confirm('Are you sure you want to cancel? Unsaved changes will be lost.')) {
        history.back();
      }
    }
  </script>
</body>
</html>