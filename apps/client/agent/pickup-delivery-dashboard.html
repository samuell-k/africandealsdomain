<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Minimal Navigation System -->
    <script src="/shared/universal-navigation.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickup Delivery Agent Dashboard - ADD Physical Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="/shared/auth-utils.js"></script>
    <script src="/shared/agent-auth-protection.js"></script>
    <script src="/shared/api-config.js"></script>
    <style>
        /* Tab Styles */
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button.active {
            border-color: #3B82F6;
            color: #3B82F6;
            font-weight: 600;
        }
        
        .tab-button:hover {
            color: #3B82F6;
            border-color: #93C5FD;
        }
        
        .tab-content {
            display: block;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .tab-content.hidden {
            display: none;
            opacity: 0;
        }
        
        /* Smooth animations for cards */
        .order-card {
            transition: all 0.2s ease;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Loading animation */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status badges */
        .status-CONFIRMED { @apply bg-blue-100 text-blue-800 border-blue-200; }
        .status-ASSIGNED_TO_PDA { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-PDA_EN_ROUTE_TO_SELLER { @apply bg-orange-100 text-orange-800 border-orange-200; }
        .status-PDA_AT_SELLER { @apply bg-purple-100 text-purple-800 border-purple-200; }
        .status-PICKED_FROM_SELLER { @apply bg-indigo-100 text-indigo-800 border-indigo-200; }
        .status-EN_ROUTE_TO_PSM { @apply bg-blue-100 text-blue-800 border-blue-200; }
        .status-DELIVERED_TO_PSM { @apply bg-green-100 text-green-800 border-green-200; }
        .status-READY_FOR_PICKUP { @apply bg-green-100 text-green-800 border-green-200; }
        .status-COMPLETED { @apply bg-green-200 text-green-900 border-green-300; }
        .status-COLLECTED_BY_BUYER { @apply bg-green-200 text-green-900 border-green-300; }
        .status-CANCELLED { @apply bg-gray-100 text-gray-800 border-gray-200; }
        
        /* Beautiful enhancements */
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-50" data-page-type="agent">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav class="bg-blue-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-truck text-2xl mr-3"></i>
                        <h1 class="text-xl font-bold">Pickup Delivery Agent</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div id="status-indicator" class="w-3 h-3 bg-green-500 rounded-full pulse-dot"></div>
                            <span id="agent-status" class="text-sm">Online</span>
                        </div>
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Agent Info Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl font-bold mr-4">
                            <span id="agent-initials">PD</span>
                        </div>
                        <div>
                            <h2 id="agent-name" class="text-2xl font-bold text-gray-900">Loading...</h2>
                            <p class="text-gray-600">Pickup Delivery Agent - Physical Products</p>
                            <div class="flex items-center mt-1">
                                <i class="fas fa-envelope text-gray-400 text-sm mr-1"></i>
                                <span id="agent-email" class="text-sm text-gray-600">Loading...</span>
                            </div>
                            <div class="flex items-center mt-1">
                                <i class="fas fa-phone text-gray-400 text-sm mr-1"></i>
                                <span id="agent-phone" class="text-sm text-gray-600">Loading...</span>
                            </div>
                            <div class="flex items-center mt-2">
                                <div class="flex items-center">
                                    <i class="fas fa-star text-yellow-400"></i>
                                    <span id="agent-rating" class="ml-1 text-sm text-gray-600">0.0</span>
                                </div>
                                <div class="ml-4 flex items-center">
                                    <i class="fas fa-shield-alt text-blue-500"></i>
                                    <span id="trust-level" class="ml-1 text-sm text-gray-600">Medium</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button onclick="updateLocation()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg mr-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>Update Location
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <i class="fas fa-box text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Today's Orders</p>
                            <p id="today-total" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Completed</p>
                            <p id="today-completed" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Active</p>
                            <p id="active-count" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100">
                            <i class="fas fa-dollar-sign text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Today's Earnings</p>
                            <p id="today-earnings" class="text-2xl font-bold text-gray-900">0 FRW</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-indigo-100">
                            <i class="fas fa-wallet text-indigo-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Available Balance</p>
                            <p id="available-balance" class="text-2xl font-bold text-gray-900">0 FRW</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button id="tab-available" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 active" onclick="switchTab('available')">
                            Available Orders
                        </button>
                        <button id="tab-active" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="switchTab('active')">
                            Active Orders
                        </button>
                        <button id="tab-history" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="switchTab('history')">
                            Order History
                        </button>
                        <button id="tab-earnings" class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="switchTab('earnings')">
                            Earnings & Withdrawals
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Available Orders Tab -->
                    <div id="available-orders-tab" class="tab-content">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-medium text-gray-900">Available Orders for Pickup</h3>
                            <button onclick="refreshAvailableOrders()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        </div>
                        <div id="available-orders-list">
                            <div class="text-center py-8">
                                <div class="loading-spinner"></div>
                                <p class="text-gray-600">Loading available orders...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Active Orders Tab -->
                    <div id="active-orders-tab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-medium text-gray-900">Active Orders</h3>
                            <button onclick="refreshActiveOrders()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        </div>
                        <div id="active-orders-list">
                            <div class="text-center py-8">
                                <div class="loading-spinner"></div>
                                <p class="text-gray-600">Loading active orders...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Order History Tab -->
                    <div id="history-orders-tab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-medium text-gray-900">Order History</h3>
                            <button onclick="refreshOrderHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        </div>
                        <div id="history-orders-list">
                            <div class="text-center py-8">
                                <div class="loading-spinner"></div>
                                <p class="text-gray-600">Loading order history...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Earnings & Withdrawals Tab -->
                    <div id="earnings-tab" class="tab-content hidden">
                        <div class="space-y-6">
                            <!-- Earnings Summary -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-chart-line mr-2"></i>Earnings Summary
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="text-center">
                                        <p class="text-sm text-gray-600">Total Earned</p>
                                        <p id="total-earned" class="text-2xl font-bold text-blue-600">0 FRW</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm text-gray-600">This Week</p>
                                        <p id="week-earned" class="text-2xl font-bold text-green-600">0 FRW</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm text-gray-600">This Month</p>
                                        <p id="month-earned" class="text-2xl font-bold text-purple-600">0 FRW</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm text-gray-600">Available Balance</p>
                                        <p id="earnings-available-balance" class="text-2xl font-bold text-indigo-600">0 FRW</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Withdrawal Section -->
                            <div class="bg-white rounded-lg border p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-money-bill-wave mr-2"></i>Request Withdrawal
                                    </h4>
                                    <button onclick="refreshEarnings()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        <i class="fas fa-refresh mr-1"></i>Refresh
                                    </button>
                                </div>
                                
                                <form id="withdrawal-form" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Withdrawal Amount (FRW)</label>
                                            <input type="number" id="withdrawal-amount" min="1000" step="100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter amount">
                                            <small class="text-gray-500">Minimum: 1,000 FRW</small>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                            <select id="payment-method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="">Select payment method</option>
                                                <option value="momo">Mobile Money (MTN/Airtel)</option>
                                                <option value="bank">Bank Transfer</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="payment-details" class="hidden space-y-4">
                                        <!-- Mobile Money Details -->
                                        <div id="momo-details" class="hidden">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Network</label>
                                                    <select id="momo-network" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        <option value="">Select network</option>
                                                        <option value="mtn">MTN Rwanda</option>
                                                        <option value="airtel">Airtel Rwanda</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                                    <input type="tel" id="momo-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="07XXXXXXXX">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Bank Details -->
                                        <div id="bank-details" class="hidden">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bank Name</label>
                                                    <input type="text" id="bank-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Bank name">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Number</label>
                                                    <input type="text" id="bank-account" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Account number">
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Account Holder Name</label>
                                                <input type="text" id="account-holder" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Account holder name">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                        <textarea id="withdrawal-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Any additional notes..."></textarea>
                                    </div>
                                    
                                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                        <i class="fas fa-paper-plane mr-2"></i>Submit Withdrawal Request
                                    </button>
                                </form>
                            </div>

                            <!-- Withdrawal History -->
                            <div class="bg-white rounded-lg border p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-history mr-2"></i>Withdrawal History
                                    </h4>
                                    <button onclick="refreshWithdrawals()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        <i class="fas fa-refresh mr-1"></i>Refresh
                                    </button>
                                </div>
                                <div id="withdrawal-history">
                                    <div class="text-center py-8">
                                        <div class="loading-spinner"></div>
                                        <p class="text-gray-600">Loading withdrawal history...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'available';
        let dashboardData = {
            available_orders: [],
            active_orders: [],
            order_history: [],
            stats: {},
            earnings: {},
            withdrawals: []
        };

        // Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = 'fixed top-4 right-4 z-50 max-w-sm w-full';
            
            const typeClasses = {
                'success': 'bg-green-50 border-green-200 text-green-800',
                'error': 'bg-red-50 border-red-200 text-red-800',
                'warning': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                'info': 'bg-blue-50 border-blue-200 text-blue-800'
            };
            
            const iconClasses = {
                'success': 'fas fa-check-circle text-green-500',
                'error': 'fas fa-exclamation-circle text-red-500',
                'warning': 'fas fa-exclamation-triangle text-yellow-500',
                'info': 'fas fa-info-circle text-blue-500'
            };

            notification.innerHTML = `
                <div class="border rounded-lg shadow-lg p-4 ${typeClasses[type] || typeClasses.info}">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="${iconClasses[type] || iconClasses.info}"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.closest('#notification').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            if (duration > 0) {
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }
        }

        // Tab Management
        function switchTab(tabName) {
            console.log(`[PDA] Switching to tab: ${tabName}`);
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            let targetContent;
            if (tabName === 'available') {
                targetContent = document.getElementById('available-orders-tab');
            } else if (tabName === 'active') {
                targetContent = document.getElementById('active-orders-tab');
            } else if (tabName === 'history') {
                targetContent = document.getElementById('history-orders-tab');
            } else if (tabName === 'earnings') {
                targetContent = document.getElementById('earnings-tab');
            }
            
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
            
            currentTab = tabName;
            
            // Load data for the selected tab
            if (tabName === 'available') {
                refreshAvailableOrders();
            } else if (tabName === 'active') {
                refreshActiveOrders();
            } else if (tabName === 'history') {
                refreshOrderHistory();
            } else if (tabName === 'earnings') {
                refreshEarnings();
                refreshWithdrawals();
            }
        }

        // API Helper Function
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                const options = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE_URL}/api/pickup-delivery-agent${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`[PDA] API call failed for ${endpoint}:`, error);
                throw error;
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const data = await apiCall('/stats');
                dashboardData.stats = data.stats;
                updateStatsDisplay();
            } catch (error) {
                console.error('[PDA] Error loading stats:', error);
                showNotification('Failed to load statistics', 'error');
            }
        }

        // Update Stats Display
        function updateStatsDisplay() {
            const stats = dashboardData.stats;
            if (stats) {
                document.getElementById('today-total').textContent = stats.today?.total || 0;
                document.getElementById('today-completed').textContent = stats.today?.completed || 0;
                document.getElementById('active-count').textContent = stats.active?.count || 0;
                document.getElementById('today-earnings').textContent = `${(stats.today?.earnings || 0).toLocaleString()} FRW`;
            }
        }

        // Load Available Orders
        async function refreshAvailableOrders() {
            console.log('[PDA] Refreshing available orders...');
            showLoadingState('available-orders-list');
            
            try {
                const data = await apiCall('/available-orders');
                dashboardData.available_orders = data.orders || [];
                renderAvailableOrders(dashboardData.available_orders);
            } catch (error) {
                console.error('[PDA] Error loading available orders:', error);
                showNotification('Failed to load available orders', 'error');
                renderAvailableOrders([]);
            }
        }

        // Load Active Orders
        async function refreshActiveOrders() {
            console.log('[PDA] Refreshing active orders...');
            showLoadingState('active-orders-list');
            
            try {
                const data = await apiCall('/active-orders');
                dashboardData.active_orders = data.orders || [];
                renderActiveOrders(dashboardData.active_orders);
            } catch (error) {
                console.error('[PDA] Error loading active orders:', error);
                showNotification('Failed to load active orders', 'error');
                renderActiveOrders([]);
            }
        }

        // Load Order History
        async function refreshOrderHistory() {
            console.log('[PDA] Refreshing order history...');
            showLoadingState('history-orders-list');
            
            try {
                const data = await apiCall('/order-history');
                dashboardData.order_history = data.orders || [];
                renderOrderHistory(dashboardData.order_history);
            } catch (error) {
                console.error('[PDA] Error loading order history:', error);
                showNotification('Failed to load order history', 'error');
                renderOrderHistory([]);
            }
        }

        // Load Earnings
        async function refreshEarnings() {
            try {
                const data = await apiCall('/earnings');
                dashboardData.earnings = data.earnings;
                updateEarningsDisplay();
            } catch (error) {
                console.error('[PDA] Error loading earnings:', error);
                showNotification('Failed to load earnings', 'error');
            }
        }

        // Load Withdrawals
        async function refreshWithdrawals() {
            try {
                const data = await apiCall('/withdrawals');
                dashboardData.withdrawals = data.withdrawals || [];
                renderWithdrawals(dashboardData.withdrawals);
            } catch (error) {
                console.error('[PDA] Error loading withdrawals:', error);
                showNotification('Failed to load withdrawal history', 'error');
                renderWithdrawals([]);
            }
        }

        // Update Earnings Display
        function updateEarningsDisplay() {
            const earnings = dashboardData.earnings;
            if (earnings) {
                document.getElementById('total-earned').textContent = `${(earnings.total_earned || 0).toLocaleString()} FRW`;
                document.getElementById('week-earned').textContent = `${(earnings.week_earned || 0).toLocaleString()} FRW`;
                document.getElementById('month-earned').textContent = `${(earnings.month_earned || 0).toLocaleString()} FRW`;
                document.getElementById('earnings-available-balance').textContent = `${(earnings.available_balance || 0).toLocaleString()} FRW`;
                document.getElementById('available-balance').textContent = `${(earnings.available_balance || 0).toLocaleString()} FRW`;
            }
        }

        // Show Loading State
        function showLoadingState(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="loading-spinner"></div>
                        <p class="text-gray-600">Loading...</p>
                    </div>
                `;
            }
        }

        // Render Available Orders
        function renderAvailableOrders(orders) {
            const container = document.getElementById('available-orders-list');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600 text-lg">No available orders</p>
                        <p class="text-gray-500 text-sm">New orders will appear here when they're ready for pickup</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card bg-white border rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">Order #${order.id}</h4>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-user mr-1"></i>${order.buyer_name || 'Unknown Buyer'}
                            </p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-phone mr-1"></i>${order.buyer_phone || 'No phone'}
                            </p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-${order.status}">
                                ${order.status}
                            </span>
                            <p class="text-lg font-bold text-green-600 mt-1">${(order.total_amount || 0).toLocaleString()} FRW</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <strong>Delivery Address:</strong> ${order.delivery_address || 'Not specified'}
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-box mr-1"></i>
                            <strong>Items:</strong> ${order.items_summary || 'No items listed'}
                        </p>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-gray-500">
                            Created: ${new Date(order.created_at).toLocaleString()}
                        </p>
                        <button onclick="acceptOrder(${order.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-check mr-2"></i>Accept Order
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render Active Orders
        function renderActiveOrders(orders) {
            const container = document.getElementById('active-orders-list');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-truck text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600 text-lg">No active orders</p>
                        <p class="text-gray-500 text-sm">Orders you accept will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card bg-white border rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">Order #${order.id}</h4>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-user mr-1"></i>${order.buyer_name || 'Unknown Buyer'}
                            </p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-phone mr-1"></i>${order.buyer_phone || 'No phone'}
                            </p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-${order.status}">
                                ${order.status}
                            </span>
                            <p class="text-lg font-bold text-green-600 mt-1">${(order.total_amount || 0).toLocaleString()} FRW</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <strong>Delivery Address:</strong> ${order.delivery_address || 'Not specified'}
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-box mr-1"></i>
                            <strong>Items:</strong> ${order.items_summary || 'No items listed'}
                        </p>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-gray-500">
                            Assigned: ${new Date(order.agent_assigned_at || order.created_at).toLocaleString()}
                        </p>
                        <div class="space-x-2">
                            <button onclick="sendMessage(${order.id}, 'buyer')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-comment mr-1"></i>Message Buyer
                            </button>
                            <button onclick="updateOrderStatus(${order.id})" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-edit mr-1"></i>Update Status
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Order History
        function renderOrderHistory(orders) {
            const container = document.getElementById('history-orders-list');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-history text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600 text-lg">No order history</p>
                        <p class="text-gray-500 text-sm">Completed orders will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="order-card bg-white border rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900">Order #${order.id}</h4>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-user mr-1"></i>${order.buyer_name || 'Unknown Buyer'}
                            </p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-${order.status}">
                                ${order.status}
                            </span>
                            <p class="text-lg font-bold text-green-600 mt-1">${(order.total_amount || 0).toLocaleString()} FRW</p>
                            ${order.agent_commission ? `<p class="text-sm text-blue-600">Commission: ${(order.agent_commission || 0).toLocaleString()} FRW</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <strong>Delivery Address:</strong> ${order.delivery_address || 'Not specified'}
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-box mr-1"></i>
                            <strong>Items:</strong> ${order.items_summary || 'No items listed'}
                        </p>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-gray-500">
                            Completed: ${new Date(order.updated_at).toLocaleString()}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Render Withdrawals
        function renderWithdrawals(withdrawals) {
            const container = document.getElementById('withdrawal-history');
            
            if (withdrawals.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-receipt text-gray-400 text-3xl mb-4"></i>
                        <p class="text-gray-600">No withdrawal history</p>
                        <p class="text-gray-500 text-sm">Your withdrawal requests will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = withdrawals.map(withdrawal => {
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'processing': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                };
                
                return `
                    <div class="border rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-900">${withdrawal.amount.toLocaleString()} FRW</p>
                                <p class="text-sm text-gray-600">${withdrawal.payment_method.toUpperCase()}</p>
                                <p class="text-xs text-gray-500">${new Date(withdrawal.created_at).toLocaleString()}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[withdrawal.status] || statusColors.pending}">
                                ${withdrawal.status.toUpperCase()}
                            </span>
                        </div>
                        ${withdrawal.admin_notes ? `<p class="text-sm text-gray-600 mt-2"><strong>Admin Notes:</strong> ${withdrawal.admin_notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Accept Order
        async function acceptOrder(orderId) {
            try {
                const data = await apiCall(`/orders/${orderId}/accept`, 'POST');
                showNotification('Order accepted successfully!', 'success');
                refreshAvailableOrders();
                refreshActiveOrders();
                loadStats();
            } catch (error) {
                console.error('[PDA] Error accepting order:', error);
                showNotification('Failed to accept order', 'error');
            }
        }

        // Send Message
        async function sendMessage(orderId, recipientType) {
            const message = prompt(`Enter message to send to ${recipientType}:`);
            if (!message) return;
            
            try {
                await apiCall('/send-message', 'POST', {
                    order_id: orderId,
                    recipient_type: recipientType,
                    message: message,
                    message_type: 'text'
                });
                showNotification('Message sent successfully!', 'success');
            } catch (error) {
                console.error('[PDA] Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        }

        // Update Order Status
        function updateOrderStatus(orderId) {
            // This would open a modal or form to update order status
            showNotification('Status update feature coming soon', 'info');
        }

        // Update Location
        async function updateLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by this browser', 'error');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(async (position) => {
                try {
                    await apiCall('/update-location', 'POST', {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    });
                    showNotification('Location updated successfully!', 'success');
                } catch (error) {
                    console.error('[PDA] Error updating location:', error);
                    showNotification('Failed to update location', 'error');
                }
            }, (error) => {
                console.error('[PDA] Geolocation error:', error);
                showNotification('Failed to get current location', 'error');
            });
        }

        // Withdrawal Form Handling
        document.getElementById('payment-method').addEventListener('change', function() {
            const paymentDetails = document.getElementById('payment-details');
            const momoDetails = document.getElementById('momo-details');
            const bankDetails = document.getElementById('bank-details');
            
            if (this.value === 'momo') {
                paymentDetails.classList.remove('hidden');
                momoDetails.classList.remove('hidden');
                bankDetails.classList.add('hidden');
            } else if (this.value === 'bank') {
                paymentDetails.classList.remove('hidden');
                bankDetails.classList.remove('hidden');
                momoDetails.classList.add('hidden');
            } else {
                paymentDetails.classList.add('hidden');
                momoDetails.classList.add('hidden');
                bankDetails.classList.add('hidden');
            }
        });

        document.getElementById('withdrawal-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const paymentMethod = document.getElementById('payment-method').value;
            const notes = document.getElementById('withdrawal-notes').value;
            
            if (!amount || amount < 1000) {
                showNotification('Minimum withdrawal amount is 1,000 FRW', 'error');
                return;
            }
            
            if (!paymentMethod) {
                showNotification('Please select a payment method', 'error');
                return;
            }
            
            let paymentDetails = {};
            
            if (paymentMethod === 'momo') {
                const network = document.getElementById('momo-network').value;
                const phone = document.getElementById('momo-phone').value;
                
                if (!network || !phone) {
                    showNotification('Please fill in all mobile money details', 'error');
                    return;
                }
                
                paymentDetails = { network, phone };
            } else if (paymentMethod === 'bank') {
                const bankName = document.getElementById('bank-name').value;
                const accountNumber = document.getElementById('bank-account').value;
                const accountHolder = document.getElementById('account-holder').value;
                
                if (!bankName || !accountNumber || !accountHolder) {
                    showNotification('Please fill in all bank details', 'error');
                    return;
                }
                
                paymentDetails = { bank_name: bankName, account_number: accountNumber, account_holder: accountHolder };
            }
            
            try {
                const response = await apiCall('/withdraw', 'POST', {
                    amount,
                    payment_method: paymentMethod,
                    payment_details: paymentDetails,
                    notes
                });
                
                showNotification(response.message || 'Withdrawal request submitted successfully!', 'success');
                document.getElementById('withdrawal-form').reset();
                document.getElementById('payment-details').classList.add('hidden');
                refreshEarnings();
                refreshWithdrawals();
            } catch (error) {
                console.error('[PDA] Error submitting withdrawal:', error);
                
                // Handle different types of errors
                let errorMessage = 'Failed to submit withdrawal request. Please try again.';
                
                if (error.message.includes('400')) {
                    // Try to extract error details from the response
                    try {
                        const errorData = JSON.parse(error.message.split('Response: ')[1]);
                        errorMessage = errorData.error || errorMessage;
                        
                        if (errorData.available_balance !== undefined) {
                            errorMessage += ` Available balance: ${errorData.available_balance.toLocaleString()} FRW`;
                        }
                    } catch (parseError) {
                        // If parsing fails, use the original error message
                        if (error.message.includes('Insufficient balance')) {
                            errorMessage = 'Insufficient balance for withdrawal';
                        } else if (error.message.includes('Minimum withdrawal')) {
                            errorMessage = 'Minimum withdrawal amount is 1,000 FRW';
                        }
                    }
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server error. Please try again later.';
                }
                
                showNotification(errorMessage, 'error');
            }
        });

        // New order notification functions
        function showNewOrderNotification(count) {
            const message = count === 1 
                ? 'New order available! Payment has been approved and order is ready for pickup.' 
                : `${count} new orders available! Payments have been approved and orders are ready for pickup.`;
            showNotification(message, 'success');
        }
        
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('Could not play notification sound:', error);
            }
        }

        // Load Agent Profile
        async function loadAgentProfile() {
            try {
                const data = await apiCall('/profile');
                if (data.success && data.agent) {
                    const agent = data.agent;
                    document.getElementById('agent-name').textContent = agent.name || 'Unknown Agent';
                    document.getElementById('agent-email').textContent = agent.email || 'No email';
                    document.getElementById('agent-phone').textContent = agent.phone || 'No phone';
                    document.getElementById('agent-rating').textContent = agent.average_rating || '0.0';
                    document.getElementById('trust-level').textContent = agent.trust_level || 'Medium';
                    
                    // Set initials
                    const initials = (agent.name || 'PD').split(' ').map(n => n[0]).join('').toUpperCase();
                    document.getElementById('agent-initials').textContent = initials;
                }
            } catch (error) {
                console.error('[PDA] Error loading agent profile:', error);
            }
        }

        // Initialize Dashboard
        async function initializeDashboard() {
            console.log('[PDA] Initializing dashboard...');
            
            try {
                await loadAgentProfile();
                await loadStats();
                await refreshAvailableOrders(); // Load initial tab
                
                // Set up auto-refresh with new order notifications
                let lastAvailableOrderCount = 0;
                
                setInterval(async () => {
                    try {
                        // Load stats first to check for new orders
                        const statsData = await apiCall('/stats');
                        if (statsData.success && statsData.stats) {
                            const currentAvailableCount = statsData.stats.available_orders || 0;
                            
                            // Check for new available orders (payment approved)
                            if (currentAvailableCount > lastAvailableOrderCount && lastAvailableOrderCount > 0) {
                                const newOrdersCount = currentAvailableCount - lastAvailableOrderCount;
                                showNewOrderNotification(newOrdersCount);
                                playNotificationSound();
                            }
                            
                            lastAvailableOrderCount = currentAvailableCount;
                        }
                        
                        // Continue with regular refresh
                        loadStats();
                        if (currentTab === 'available') {
                            refreshAvailableOrders();
                        } else if (currentTab === 'active') {
                            refreshActiveOrders();
                        }
                    } catch (error) {
                        console.error('[PDA] Error in auto-refresh:', error);
                        // Continue with regular refresh even if stats fail
                        loadStats();
                        if (currentTab === 'available') {
                            refreshAvailableOrders();
                        } else if (currentTab === 'active') {
                            refreshActiveOrders();
                        }
                    }
                }, 30000); // Refresh every 30 seconds
                
                // Initialize the counter
                try {
                    const initialStats = await apiCall('/stats');
                    if (initialStats.success && initialStats.stats) {
                        lastAvailableOrderCount = initialStats.stats.available_orders || 0;
                    }
                } catch (error) {
                    console.error('[PDA] Error loading initial stats:', error);
                }
                
                console.log('[PDA] Dashboard initialized successfully');
            } catch (error) {
                console.error('[PDA] Error initializing dashboard:', error);
                showNotification('Failed to initialize dashboard', 'error');
            }
        }

        // Listen for cross-tab payment approval notifications
        window.addEventListener('storage', function(e) {
            if (e.key === 'payment_approval_notification' && e.newValue) {
                try {
                    const notification = JSON.parse(e.newValue);
                    if (notification.type === 'payment_approved' && notification.approvalType === 'MANUAL_PAYMENT') {
                        // Show immediate notification
                        showNotification('New order available! Payment has been approved and order is ready for pickup.', 'success');
                        playNotificationSound();
                        
                        // Refresh dashboard immediately
                        setTimeout(() => {
                            loadStats();
                            if (currentTab === 'available') {
                                refreshAvailableOrders();
                            }
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error processing cross-tab notification:', error);
                }
            }
        });

        // Start the dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>