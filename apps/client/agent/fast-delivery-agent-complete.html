<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Delivery Agent Dashboard - Local Market | African Deals Domain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../public/js/auth-utils.js"></script>
    <style>
        .map-container { height: 400px; border-radius: 12px; overflow: hidden; }
        .order-card { transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .status-pending { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-assigned { @apply bg-blue-100 text-blue-800 border-blue-200; }
        .status-arrived_at_seller { @apply bg-purple-100 text-purple-800 border-purple-200; }
        .status-picked_from_seller { @apply bg-indigo-100 text-indigo-800 border-indigo-200; }
        .status-en_route { @apply bg-orange-100 text-orange-800 border-orange-200; }
        .status-arrived_at_buyer { @apply bg-cyan-100 text-cyan-800 border-cyan-200; }
        .status-delivered { @apply bg-green-100 text-green-800 border-green-200; }
        .status-issue_at_pickup { @apply bg-red-100 text-red-800 border-red-200; }
        .status-delivery_failed { @apply bg-red-100 text-red-800 border-red-200; }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .tab-button.active { 
            border-color: #3B82F6; 
            color: #3B82F6; 
        }
        .tab-content { display: block; }
        .tab-content.hidden { display: none; }
        
        .order-workflow {
            display: flex;
            align-items: center;
            margin: 1rem 0;
        }
        .workflow-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #E5E7EB;
            z-index: 1;
        }
        .workflow-step.completed::after {
            background: #10B981;
        }
        .workflow-step.active::after {
            background: #3B82F6;
        }
        .workflow-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            position: relative;
            z-index: 2;
        }
        .workflow-step.completed .workflow-icon {
            background: #10B981;
            color: white;
        }
        .workflow-step.active .workflow-icon {
            background: #3B82F6;
            color: white;
        }
        .workflow-step.pending .workflow-icon {
            background: #E5E7EB;
            color: #6B7280;
        }
        
        .distance-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .earnings-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .commission-info {
            background: #F3F4F6;
            border-left: 4px solid #10B981;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-green-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-motorcycle text-2xl mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold">Fast Delivery Agent</h1>
                        <p class="text-xs text-green-200">🛒 Local Market Orders Only</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div id="status-indicator" class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>
                        <span id="agent-status" class="text-sm">Offline</span>
                    </div>
                    <button id="toggle-status" class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded-lg text-sm" onclick="showNotification('Feature in development', 'info')">
                        Go Online
                    </button>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Agent Info Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="agent-name" class="text-2xl font-bold text-gray-900">Loading...</h2>
                    <p class="text-gray-600">Fast Delivery Agent - Local Market Orders</p>
                    <div class="flex items-center mt-2">
                        <div class="flex items-center">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span id="agent-rating" class="ml-1 text-sm text-gray-600">0.0</span>
                        </div>
                        <div class="ml-4 flex items-center">
                            <i class="fas fa-map-marker-alt text-blue-500"></i>
                            <span id="location-status" class="ml-1 text-sm text-gray-600">Location disabled</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <button id="enable-location-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" onclick="showNotification('Feature in development', 'info')">
                        <i class="fas fa-map-marker-alt mr-2"></i>Enable Location
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                        <i class="fas fa-shopping-bag text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Today's Orders</p>
                        <p id="total-orders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Completed</p>
                        <p id="completed-orders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Active Orders</p>
                        <p id="active-orders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100">
                        <i class="fas fa-dollar-sign text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Today's Earnings</p>
                        <p id="today-earnings" class="text-2xl font-bold text-gray-900">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Available Orders -->
            <div class="lg:col-span-2">
                <!-- Tab Navigation -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 px-6">
                            <button id="tab-available" class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" onclick="showNotification('Feature in development', 'info')">
                                Available Orders
                            </button>
                            <button id="tab-active" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" onclick="showNotification('Feature in development', 'info')">
                                Active Orders (<span id="active-count">0</span>)
                            </button>
                            <button id="tab-history" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" onclick="showNotification('Feature in development', 'info')">
                                Order History
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Available Orders Tab -->
                <div id="available-orders-tab" class="tab-content">
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Available Local Market Orders</h3>
                                <div class="flex items-center space-x-3">
                                    <select id="radius-filter" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                        <option value="5">Within 5km</option>
                                        <option value="10">Within 10km</option>
                                        <option value="20">Within 20km</option>
                                        <option value="50">All orders</option>
                                    </select>
                                    <button id="refresh-orders" class="text-blue-600 hover:text-blue-700" onclick="showNotification('Feature in development', 'info')">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="available-orders-list" class="p-6">
                            <div class="text-center py-8">
                                <i class="fas fa-shopping-cart text-gray-400 text-3xl mb-4"></i>
                                <p class="text-gray-600">No available orders</p>
                                <p class="text-sm text-gray-500 mt-2">Enable location to see nearby orders</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Orders Tab -->
                <div id="active-orders-tab" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">My Active Orders</h3>
                        </div>
                        <div id="active-orders-list" class="p-6">
                            <div class="text-center py-8">
                                <i class="fas fa-clipboard-list text-gray-400 text-3xl mb-4"></i>
                                <p class="text-gray-600">No active orders</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order History Tab -->
                <div id="history-orders-tab" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Order History</h3>
                                <div class="flex items-center space-x-3">
                                    <select id="history-period" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="all">All Time</option>
                                    </select>
                                    <select id="history-status" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                        <option value="">All Status</option>
                                        <option value="delivered">Delivered</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="issue_reported">Issues</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="history-orders-list" class="p-6">
                            <div class="text-center py-8">
                                <i class="fas fa-history text-gray-400 text-3xl mb-4"></i>
                                <p class="text-gray-600">No order history</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map and Location -->
            <div class="space-y-6">
                <!-- Live Map -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Live Location & Orders</h3>
                    <div id="delivery-map" class="map-container bg-gray-100 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-map text-gray-400 text-2xl mb-2"></i>
                            <p class="text-gray-600 text-sm">Enable location to view map</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button id="emergency-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700" onclick="showNotification('Feature in development', 'info')">
                            i class="fas fa-exclamation-triangle mr-2"></i>Emergency
                        </button>
                        <button id="break-btn" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700" onclick="showNotification('Feature in development', 'info')">
                            i class="fas fa-pause mr-2"></i>Take Break
                        </button>
                        <button id="support-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700" onclick="showNotification('Feature in development', 'info')">
                            i class="fas fa-headset mr-2"></i>Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Order Details</h3>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-600" onclick="showNotification('Feature in development', 'info')">
                            i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="order-modal-content" class="p-6">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Update Order Status</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
                            <select id="status-select" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="arrived_at_seller">Arrived at Seller</option>
                                <option value="picked_from_seller">Picked from Seller</option>
                                <option value="en_route">En Route to Buyer</option>
                                <option value="arrived_at_buyer">Arrived at Buyer</option>
                                <option value="delivered">Delivered to Buyer</option>
                                <option value="issue_at_pickup">Issue at Pickup</option>
                                <option value="delivery_failed">Delivery Failed</option>
                            </select>
                        </div>
                        <div id="issue-fields" class="hidden space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Issue Type</label>
                                <select id="issue-type" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="missing_items">Missing Items</option>
                                    <option value="damaged_items">Damaged Items</option>
                                    <option value="wrong_items">Wrong Items</option>
                                    <option value="seller_unavailable">Seller Unavailable</option>
                                    <option value="buyer_unavailable">Buyer Unavailable</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                            <textarea id="status-notes" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="3" placeholder="Add notes about this status update..."></textarea>
                        </div>
                        <div id="location-status" class="text-sm text-gray-600">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <span>Getting location...</span>
                        </div>
                        <div class="flex space-x-3">
                            <button id="confirm-status-update" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700" onclick="showNotification('Feature in development', 'info')">
                                Update Status
                            /button>
                            <button id="cancel-status-update" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400" onclick="handleCancel()">
                                Cancel
                            /button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Confirmation Modal -->
    <div id="delivery-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Confirm Delivery</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Code</label>
                            <input type="text" id="delivery-code-input" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Enter delivery code">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="buyer-present" class="rounded">
                            <label for="buyer-present" class="text-sm text-gray-700">Buyer was present and confirmed delivery</label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Notes</label>
                            <textarea id="delivery-notes" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="3" placeholder="Any additional notes about the delivery..."></textarea>
                        </div>
                        <div class="flex space-x-3">
                            <button id="confirm-delivery" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700" onclick="showNotification('Feature in development', 'info')">
                                Confirm Delivery
                            /button>
                            <button id="cancel-delivery-confirmation" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400" onclick="handleCancel()">
                                Cancel
                            /button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Report Modal -->
    <div id="issue-report-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Report Issue</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Issue Type</label>
                            <select id="report-issue-type" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="missing_items">Missing Items</option>
                                <option value="damaged_items">Damaged Items</option>
                                <option value="wrong_items">Wrong Items</option>
                                <option value="seller_issue">Seller Issue</option>
                                <option value="buyer_issue">Buyer Issue</option>
                                <option value="payment_issue">Payment Issue</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="issue-description" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="4" placeholder="Describe the issue in detail..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Photos (Optional)</label>
                            <input type="file" id="issue-photos" multiple accept="image/*" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        </div>
                        <div class="flex space-x-3">
                            <button id="submit-issue-report" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700" onclick="showNotification('Feature in development', 'info')">
                                Report Issue
                            /button>
                            <button id="cancel-issue-report" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400" onclick="handleCancel()">
                                Cancel
                            /button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FDA Seller Pickup Code Modal -->
    <div id="fda-seller-pickup-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Seller Pickup Confirmation</h3>
                </div>
                <div class="p-6">
                    <div id="fda-seller-pickup-content" class="space-y-4">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FDA Buyer Delivery Code Modal -->
    <div id="fda-buyer-delivery-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Buyer Delivery Confirmation</h3>
                </div>
                <div class="p-6">
                    <div id="fda-buyer-delivery-content" class="space-y-4">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class FastDeliveryAgentDashboard {
            constructor() {
                this.currentLocation = null;
                this.map = null;
                this.agentMarker = null;
                this.orderMarkers = [];
                this.isOnline = false;
                this.currentOrderId = null;
                this.watchId = null;
                this.activeTab = 'available';
                this.socket = null;
                this.orderHistory = [];
                this.currentRadius = 5;
                
                this.init();
            }

            async init() {
                // Initialize authentication first
                const authValid = await window.authUtils.initializeDashboard('agent', 'fast_delivery');
                if (!authValid) {
                    return; // AuthUtils will handle redirect
                }
                
                this.setupEventListeners();
                this.setupSocketConnection();
                await this.loadAgentInfo();
                await this.loadStats();
                await this.loadAvailableOrders();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    this.loadStats();
                    if (this.activeTab === 'available') {
                        this.loadAvailableOrders();
                    } else if (this.activeTab === 'active') {
                        this.loadActiveOrders();
                    }
                }, 30000);
            }

            setupSocketConnection() {
                // Initialize Socket.IO connection for real-time updates with error handling
                this.socket = io({
                    timeout: 5000,
                    reconnection: true,
                    reconnectionAttempts: 3,
                    reconnectionDelay: 2000
                });
                
                this.socket.on('connect', () => {
                    console.log('Connected to server');
                    this.connectionRetries = 0; // Reset retry counter
                    const user = window.authUtils.getCurrentUser();
                    if (user) {
                        this.socket.emit('user:login', user);
                    }
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.connectionRetries = (this.connectionRetries || 0) + 1;
                    if (this.connectionRetries >= 3) {
                        console.log('Max connection retries reached, stopping reconnection');
                        this.socket.disconnect();
                    }
                });

                this.socket.on('disconnect', (reason) => {
                    console.log('Disconnected from server:', reason);
                });

                this.socket.on('new_order_assigned', (data) => {
                    if (data && data.orderDetails) {
                        this.showNotification(`New order assigned: ${data.orderDetails.order_number}`, 'success');
                        this.loadActiveOrders();
                        this.loadStats();
                    }
                });

                this.socket.on('tracking_update', (data) => {
                    if (data && data.orderId) {
                        this.showNotification(`Order ${data.orderId} status updated`, 'info');
                        this.loadActiveOrders();
                    }
                });

                this.socket.on('order_cancelled', (data) => {
                    if (data && data.orderId) {
                        this.showNotification(`Order ${data.orderId} has been cancelled`, 'warning');
                        this.loadActiveOrders();
                        this.loadAvailableOrders();
                    }
                });
            }

            setupEventListeners() {
                // Tab navigation
                document.getElementById('tab-available').addEventListener('click', () => {
                    this.switchTab('available');
                });
                document.getElementById('tab-active').addEventListener('click', () => {
                    this.switchTab('active');
                });
                document.getElementById('tab-history').addEventListener('click', () => {
                    this.switchTab('history');
                });

                // Status toggle
                document.getElementById('toggle-status').addEventListener('click', () => {
                    this.toggleOnlineStatus();
                });

                // Enable location
                document.getElementById('enable-location-btn').addEventListener('click', () => {
                    this.enableLocation();
                });

                // Refresh orders
                document.getElementById('refresh-orders').addEventListener('click', () => {
                    this.loadOrders();
                });

                // Radius filter
                document.getElementById('radius-filter').addEventListener('change', (e) => {
                    this.currentRadius = parseInt(e.target.value);
                    this.loadAvailableOrders();
                });

                // History filters
                document.getElementById('history-period').addEventListener('change', () => {
                    this.loadOrderHistory();
                });
                document.getElementById('history-status').addEventListener('change', () => {
                    this.loadOrderHistory();
                });

                // Status update modal
                document.getElementById('status-select').addEventListener('change', (e) => {
                    const issueFields = document.getElementById('issue-fields');
                    if (e.target.value === 'issue_at_pickup' || e.target.value === 'delivery_failed') {
                        issueFields.classList.remove('hidden');
                    } else {
                        issueFields.classList.add('hidden');
                    }
                });

                // Modal controls
                document.getElementById('close-modal').addEventListener('click', () => {
                    // Clean up map if it exists
                    if (this.orderDetailMap) {
                        this.orderDetailMap.remove();
                        this.orderDetailMap = null;
                    }
                    document.getElementById('order-modal').classList.add('hidden');
                });

                document.getElementById('cancel-status-update').addEventListener('click', () => {
                    document.getElementById('status-modal').classList.add('hidden');
                });

                document.getElementById('confirm-status-update').addEventListener('click', () => {
                    this.confirmStatusUpdate();
                });

                // Delivery confirmation modal
                document.getElementById('confirm-delivery').addEventListener('click', () => {
                    this.confirmDelivery();
                });

                document.getElementById('cancel-delivery-confirmation').addEventListener('click', () => {
                    document.getElementById('delivery-confirmation-modal').classList.add('hidden');
                });

                // Issue report modal
                document.getElementById('submit-issue-report').addEventListener('click', () => {
                    this.submitIssueReport();
                });

                document.getElementById('cancel-issue-report').addEventListener('click', () => {
                    document.getElementById('issue-report-modal').classList.add('hidden');
                });

                // Quick actions
                document.getElementById('emergency-btn').addEventListener('click', () => {
                    this.handleEmergency();
                });

                document.getElementById('break-btn').addEventListener('click', () => {
                    this.toggleBreak();
                });

                document.getElementById('support-btn').addEventListener('click', () => {
                    this.contactSupport();
                });
            }

            async loadAgentInfo() {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest('/api/agents/profile');
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        document.getElementById('agent-name').textContent = data.agent?.name || window.authUtils.getCurrentUser()?.name || 'Agent';
                        document.getElementById('agent-rating').textContent = data.agent?.rating || '0.0';
                    }
                } catch (error) {
                    console.error('Failed to load agent info:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            async loadStats() {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest('/api/fast-delivery-agent/stats');

                    if (response && response.ok) {
                        const data = await response.json();
                        this.updateStatsDisplay(data.stats);
                    }
                } catch (error) {
                    console.error('Failed to load stats:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            updateStatsDisplay(stats) {
                document.getElementById('total-orders').textContent = stats.today?.total || 0;
                document.getElementById('completed-orders').textContent = stats.today?.completed || 0;
                document.getElementById('active-orders').textContent = stats.active?.count || 0;
                document.getElementById('today-earnings').textContent = `$${(stats.today?.earnings || 0).toFixed(2)}`;
            }

            async loadOrders() {
                await Promise.all([
                    this.loadAvailableOrders(),
                    this.loadActiveOrders()
                ]);
            }

            switchTab(tabName) {
                // Update active tab
                this.activeTab = tabName;
                
                // Update tab buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-500', 'text-blue-600');
                document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
                
                // Show/hide tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                document.getElementById(`${tabName}-orders-tab`).classList.remove('hidden');
                
                // Load appropriate data
                if (tabName === 'available') {
                    this.loadAvailableOrders();
                } else if (tabName === 'active') {
                    this.loadActiveOrders();
                } else if (tabName === 'history') {
                    this.loadOrderHistory();
                }
            }

            async loadAvailableOrders() {
                try {
                    // First try FDA local market orders API for available orders
                    const response = await window.authUtils.makeAuthenticatedRequest('/api/fda-local-market/orders');

                    if (response && response.ok) {
                        const data = await response.json();
                        // Filter for available orders (newly assigned to FDA)
                        const availableOrders = data.orders.filter(order => 
                            ['ASSIGNED_TO_FDA', 'confirmed'].includes(order.status)
                        );
                        this.displayAvailableOrders(availableOrders);
                        this.updateMapMarkers(availableOrders, 'available');
                        console.log('✅ Loaded FDA available orders:', availableOrders.length);
                    }
                } catch (error) {
                    console.error('Failed to load FDA available orders, trying fallback:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    // Fallback to original API
                    try {
                        const fallbackResponse = await window.authUtils.makeAuthenticatedRequest(
                            `/api/fast-delivery-agent/available-orders?radius=${this.currentRadius}&limit=20`
                        );
                        if (fallbackResponse && fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            this.displayAvailableOrders(fallbackData.orders);
                            this.updateMapMarkers(fallbackData.orders, 'available');
                            console.log('⚠️  Using fallback API for available orders');
                        }
                    } catch (fallbackError) {
                        console.error('Both APIs failed for available orders:', fallbackError);
                
                // Enhanced error reporting
                if (fallbackError) {
                    const errorDetails = {
                        message: fallbackError.message || 'Unknown error',
                        stack: fallbackError.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        fallbackError.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                        this.displayAvailableOrders([]); // Show empty state
                    }
                }
            }

            async loadActiveOrders() {
                try {
                    // First try FDA local market orders API
                    const response = await window.authUtils.makeAuthenticatedRequest('/api/fda-local-market/orders');

                    if (response && response.ok) {
                        const data = await response.json();
                        // Filter for active orders (not delivered/completed)
                        const activeOrders = data.orders.filter(order => 
                            !['DELIVERED', 'COMPLETED', 'CANCELLED'].includes(order.status)
                        );
                        this.displayActiveOrders(activeOrders);
                        this.updateMapMarkers(activeOrders, 'active');
                        console.log('✅ Loaded FDA local market orders:', activeOrders.length);
                    }
                } catch (error) {
                    console.error('Failed to load FDA orders, trying fallback:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    // Fallback to original API
                    try {
                        const fallbackResponse = await window.authUtils.makeAuthenticatedRequest('/api/fast-delivery-agent/active-orders');
                        if (fallbackResponse && fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            this.displayActiveOrders(fallbackData.orders);
                            this.updateMapMarkers(fallbackData.orders, 'active');
                            console.log('⚠️  Using fallback API for orders');
                        }
                    } catch (fallbackError) {
                        console.error('Both APIs failed:', fallbackError);
                
                // Enhanced error reporting
                if (fallbackError) {
                    const errorDetails = {
                        message: fallbackError.message || 'Unknown error',
                        stack: fallbackError.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        fallbackError.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    }
                }
            }

            displayAvailableOrders(orders) {
                const container = document.getElementById('available-orders-list');
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-shopping-cart text-gray-400 text-3xl mb-4"></i>
                            <p class="text-gray-600">No available orders</p>
                            <p class="text-sm text-gray-500 mt-2">Orders will appear here when customers place them nearby</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => {
                    // Safely handle commission - ensure it's always a number
                    const commission = parseFloat(order.agent_commission) || 0;
                    const commissionDisplay = isNaN(commission) ? '0.00' : commission.toFixed(2);
                    
                    const itemCount = order.items ? order.items.length : 0;
                    const totalItems = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 1), 0) : 0;
                    
                    // Handle order type display
                    const orderTypeLabel = order.order_type === 'grocery' ? 'Grocery Order' : 'Regular Order';
                    const orderTypeBadge = order.order_type === 'grocery' ? 
                        '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Grocery</span>' :
                        '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Regular</span>';
                    
                    return `
                        <div class="order-card bg-white rounded-lg p-6 mb-4 border border-gray-200 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-shopping-bag text-green-600"></i>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <h4 class="font-semibold text-gray-900">${order.order_number}</h4>
                                            ${orderTypeBadge}
                                        </div>
                                        <p class="text-sm text-gray-600">Order Value: ${parseFloat(order.total_amount || 0).toFixed(2)}</p>
                                        <p class="text-xs text-green-600 font-medium">Your Commission: ${commissionDisplay}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    ${order.distance ? `<span class="distance-badge">${order.distance}km away</span>` : ''}
                                    <p class="text-xs text-gray-500 mt-1">${order.estimated_time || 'N/A'} min delivery</p>
                                </div>
                            </div>
                            
                            <!-- Buyer Details -->
                            <div class="bg-blue-50 rounded-lg p-3 mb-3">
                                <h5 class="font-medium text-blue-900 mb-2">
                                    <i class="fas fa-user mr-2"></i>Buyer Details
                                </h5>
                                <p class="text-sm text-blue-800">
                                    <strong>Name:</strong> ${order.buyer_name || 'Customer'}
                                </p>
                                <p class="text-sm text-blue-800">
                                    <strong>Phone:</strong> ${order.buyer_phone || 'Not provided'}
                                </p>
                                <p class="text-sm text-blue-800">
                                    <strong>Address:</strong> ${order.delivery_address || 'Address not specified'}
                                </p>
                            </div>
                            
                            <!-- Order Items -->
                            <div class="bg-gray-50 rounded-lg p-3 mb-3">
                                <h5 class="font-medium text-gray-900 mb-2">
                                    <i class="fas fa-list mr-2"></i>Order Items (${itemCount} types, ${totalItems} items)
                                </h5>
                                <div class="space-y-1">
                                    ${order.items ? order.items.slice(0, 3).map(item => `
                                        <div class="flex justify-between text-sm">
                                            <span>${item.product_name || item.name || 'Product'}</span>
                                            <span>x${item.quantity || 1} - ${parseFloat(item.price || 0).toFixed(2)}</span>
                                        </div>
                                    `).join('') : '<p class="text-sm text-gray-600">Items not available</p>'}
                                    ${itemCount > 3 ? `<p class="text-xs text-gray-500">... and ${itemCount - 3} more items</p>` : ''}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex space-x-3 mt-4">
                                <button onclick="dashboard.acceptOrder(${order.id}, '${order.order_type || 'regular'}')" 
                                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    <i class="fas fa-check mr-2"></i>Accept Order
                                </button>
                                <button onclick="dashboard.viewOrderDetails(${order.id})" 
                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-eye mr-1"></i>Details
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            displayActiveOrders(orders) {
                const container = document.getElementById('active-orders-list');
                
                // Update active count in tab
                document.getElementById('active-count').textContent = orders.length;
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-clipboard-list text-gray-400 text-3xl mb-4"></i>
                            <p class="text-gray-600">No active orders</p>
                            <p class="text-sm text-gray-500 mt-2">Accepted orders will appear here</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => {
                    const commission = parseFloat(order.agent_commission) || 0;
                    const commissionDisplay = isNaN(commission) ? '0.00' : commission.toFixed(2);
                    const itemCount = order.items ? order.items.length : 0;
                    
                    return `
                        <div class="order-card bg-white rounded-lg p-6 mb-4 border border-gray-200 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-motorcycle text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${order.order_number}</h4>
                                        <p class="text-sm text-gray-600">Order Value: $${parseFloat(order.total_amount || 0).toFixed(2)}</p>
                                        <p class="text-xs text-green-600 font-medium">Your Commission: $${commissionDisplay}</p>
                                        <p class="text-xs text-gray-500">Delivery Code: <strong>${order.delivery_code || 'N/A'}</strong></p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${this.getStatusClass(order.status)}">
                                        ${this.formatStatus(order.status)}
                                    </span>
                                    <p class="text-xs text-gray-500 mt-1">${this.getTimeElapsed(order.agent_assigned_at)}</p>
                                </div>
                            </div>
                            
                            <!-- Workflow Progress -->
                            <div class="order-workflow mb-4">
                                ${this.renderWorkflowSteps(order.status, order.order_type)}
                            </div>
                            
                            <!-- Buyer & Seller Info -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- Seller Info -->
                                <div class="bg-orange-50 rounded-lg p-3">
                                    <h5 class="font-medium text-orange-900 mb-2">
                                        <i class="fas fa-store mr-2"></i>Pickup from Seller
                                    </h5>
                                    <p class="text-sm text-orange-800"><strong>Name:</strong> ${order.seller_name || 'Seller'}</p>
                                    <p class="text-sm text-orange-800"><strong>Phone:</strong> ${order.seller_phone || 'N/A'}</p>
                                    <p class="text-sm text-orange-800"><strong>Address:</strong> ${order.pickup_address || 'N/A'}</p>
                                    ${order.pickup_lat && order.pickup_lng ? 
                                        `<button onclick="dashboard.navigateToLocation(${order.pickup_lat}, ${order.pickup_lng}, 'seller')" 
                                                class="mt-2 text-orange-600 hover:text-orange-700 text-xs">
                                            <i class="fas fa-directions mr-1"></i>Get Directions
                                        </button>` : ''
                                    }
                                </div>
                                
                                <!-- Buyer Info -->
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <h5 class="font-medium text-blue-900 mb-2">
                                        <i class="fas fa-user mr-2"></i>Deliver to Buyer
                                    </h5>
                                    <p class="text-sm text-blue-800"><strong>Name:</strong> ${order.buyer_name || 'Customer'}</p>
                                    <p class="text-sm text-blue-800"><strong>Phone:</strong> ${order.buyer_phone || 'N/A'}</p>
                                    <p class="text-sm text-blue-800"><strong>Address:</strong> ${order.delivery_address || 'N/A'}</p>
                                    ${order.delivery_lat && order.delivery_lng ? 
                                        `<button onclick="dashboard.navigateToLocation(${order.delivery_lat}, ${order.delivery_lng}, 'buyer')" 
                                                class="mt-2 text-blue-600 hover:text-blue-700 text-xs">
                                            <i class="fas fa-directions mr-1"></i>Get Directions
                                        </button>` : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- Order Items Summary -->
                            <div class="bg-gray-50 rounded-lg p-3 mb-4">
                                <h5 class="font-medium text-gray-900 mb-2">
                                    <i class="fas fa-list mr-2"></i>Items (${itemCount} types)
                                </h5>
                                <div class="text-sm text-gray-700">
                                    ${order.items ? order.items.slice(0, 2).map(item => 
                                        `<p>• ${item.product_name} x${item.quantity}</p>`
                                    ).join('') : '<p>Loading items...</p>'}
                                    ${order.items && order.items.length > 2 ? `<p class="text-blue-600">+${order.items.length - 2} more items</p>` : ''}
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-center justify-between">
                                <div class="flex space-x-2">
                                    <button onclick="dashboard.viewOrderDetails(${order.id})" 
                                            class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                        <i class="fas fa-eye mr-1"></i>Full Details
                                    </button>
                                    <button onclick="dashboard.callBuyer('${order.buyer_phone}')" 
                                            class="text-green-600 hover:text-green-700 text-sm font-medium">
                                        <i class="fas fa-phone mr-1"></i>Call Buyer
                                    </button>
                                </div>
                                <div class="flex space-x-2">
                                    ${this.getActionButtons(order)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Helper methods for status handling
            getStatusClass(status) {
                const classes = {
                    'processing': 'bg-blue-100 text-blue-800',
                    'confirmed': 'bg-blue-100 text-blue-800',
                    'preparing': 'bg-purple-100 text-purple-800',
                    'ready_for_pickup': 'bg-indigo-100 text-indigo-800',
                    'picked_up': 'bg-orange-100 text-orange-800',
                    'in_transit': 'bg-orange-100 text-orange-800',
                    'shipped': 'bg-cyan-100 text-cyan-800',
                    'delivered': 'bg-green-100 text-green-800'
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            }

            getStatusBorderClass(status) {
                const classes = {
                    'assigned': 'border-blue-500',
                    'arrived_at_seller': 'border-purple-500',
                    'picked_from_seller': 'border-indigo-500',
                    'en_route': 'border-orange-500',
                    'arrived_at_buyer': 'border-cyan-500',
                    'delivered': 'border-green-500',
                    'issue_at_pickup': 'border-red-500',
                    'delivery_failed': 'border-red-500'
                };
                return classes[status] || 'border-gray-500';
            }

            getStatusIconClass(status) {
                const classes = {
                    'assigned': 'bg-blue-500',
                    'arrived_at_seller': 'bg-purple-500',
                    'picked_from_seller': 'bg-indigo-500',
                    'en_route': 'bg-orange-500',
                    'arrived_at_buyer': 'bg-cyan-500',
                    'delivered': 'bg-green-500',
                    'issue_at_pickup': 'bg-red-500',
                    'delivery_failed': 'bg-red-500'
                };
                return classes[status] || 'bg-gray-500';
            }

            getStatusIcon(status) {
                const icons = {
                    'assigned': 'fa-clipboard-check',
                    'arrived_at_seller': 'fa-map-marker-alt',
                    'picked_from_seller': 'fa-box',
                    'en_route': 'fa-truck',
                    'arrived_at_buyer': 'fa-home',
                    'delivered': 'fa-check-circle',
                    'issue_at_pickup': 'fa-exclamation-triangle',
                    'delivery_failed': 'fa-times-circle'
                };
                return icons[status] || 'fa-question';
            }

            formatStatus(status) {
                const formatted = {
                    'processing': 'Assigned to Agent',
                    'confirmed': 'Confirmed',
                    'preparing': 'Preparing',
                    'ready_for_pickup': 'Ready for Pickup',
                    'picked_up': 'Picked Up',
                    'in_transit': 'In Transit',
                    'shipped': 'Shipped',
                    'delivered': 'Delivered'
                };
                return formatted[status] || status.replace('_', ' ').toUpperCase();
            }

            renderWorkflowSteps(currentStatus, orderType = 'regular') {
                let steps, statusOrder;
                
                if (orderType === 'grocery') {
                    // Local Market Grocery Workflow
                    steps = [
                        { key: 'confirmed', label: 'Assigned', icon: 'fa-clipboard-check' },
                        { key: 'preparing', label: 'Preparing', icon: 'fa-clock' },
                        { key: 'ready_for_pickup', label: 'Ready', icon: 'fa-check' },
                        { key: 'picked_up', label: 'Verified & Picked', icon: 'fa-box' },
                        { key: 'in_transit', label: 'In Transit', icon: 'fa-motorcycle' },
                        { key: 'delivered', label: 'Delivered', icon: 'fa-check-circle' }
                    ];
                    statusOrder = ['confirmed', 'preparing', 'ready_for_pickup', 'picked_up', 'in_transit', 'delivered'];
                } else {
                    // Regular Order Workflow (Simplified)
                    steps = [
                        { key: 'processing', label: 'Assigned', icon: 'fa-clipboard-check' },
                        { key: 'shipped', label: 'In Transit', icon: 'fa-truck' },
                        { key: 'delivered', label: 'Delivered', icon: 'fa-check-circle' }
                    ];
                    statusOrder = ['processing', 'shipped', 'delivered'];
                }
                
                const currentIndex = statusOrder.indexOf(currentStatus);

                return steps.map((step, index) => {
                    let stepClass = 'pending';
                    if (index < currentIndex) stepClass = 'completed';
                    else if (index === currentIndex) stepClass = 'active';

                    return `
                        <div class="workflow-step ${stepClass}">
                            <div class="workflow-icon">
                                <i class="fas ${step.icon}"></i>
                            </div>
                            <p class="text-xs font-medium">${step.label}</p>
                        </div>
                    `;
                }).join('');
            }

            getActionButtons(order) {
                const status = order.status;
                const orderType = order.order_type || 'regular';
                
                // FDA Local Market Workflow for Grocery Orders with Confirmation System
                if (orderType === 'grocery') {
                    // FDA workflow statuses: ASSIGNED_TO_FDA -> FDA_EN_ROUTE_TO_SELLER -> FDA_AT_SELLER -> PICKED_FROM_SELLER -> FDA_EN_ROUTE_TO_BUYER -> DELIVERED
                    
                    if (status === 'ASSIGNED_TO_FDA' || status === 'confirmed') {
                        return `
                            <button onclick="dashboard.startRouteToSeller(${order.id})" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                <i class="fas fa-route mr-1"></i>Start Route to Seller
                            </button>
                        `;
                    } else if (status === 'FDA_EN_ROUTE_TO_SELLER') {
                        return `
                            <button onclick="dashboard.arrivedAtSeller(${order.id})" 
                                    class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                                <i class="fas fa-map-marker-alt mr-1"></i>I'm at Seller Location
                            </button>
                        `;
                    } else if (status === 'FDA_AT_SELLER') {
                        return `
                            <button onclick="dashboard.generateSellerPickupCode(${order.id})" 
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                <i class="fas fa-key mr-1"></i>Generate Pickup Code
                            </button>
                        `;
                    } else if (status === 'PICKED_FROM_SELLER') {
                        if (order.fda_seller_pickup_code) {
                            return `
                                <div class="space-y-2">
                                    <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-mono">
                                        ✅ Pickup Code: ${order.fda_seller_pickup_code}
                                    </div>
                                    <button onclick="dashboard.startRouteTobuyer(${order.id})" 
                                            class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 w-full">
                                        <i class="fas fa-motorcycle mr-1"></i>Route to Buyer
                                    </button>
                                </div>
                            `;
                        } else {
                            return `<span class="text-orange-600 text-xs">Processing pickup...</span>`;
                        }
                    } else if (status === 'FDA_EN_ROUTE_TO_BUYER') {
                        return `
                            <button onclick="dashboard.generateBuyerDeliveryCode(${order.id})" 
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                <i class="fas fa-truck mr-1"></i>Generate Delivery Code
                            </button>
                        `;
                    }
                } else {
                    // Regular Order Workflow (Simplified)
                    if (status === 'processing') {
                        return `
                            <button onclick="dashboard.updateOrderStatus(${order.id}, 'shipped', '${orderType}')" 
                                    class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                                <i class="fas fa-truck mr-1"></i>Start Delivery
                            </button>
                        `;
                    } else if (status === 'shipped') {
                        return `
                            <button onclick="dashboard.updateOrderStatus(${order.id}, 'delivered', '${orderType}')" 
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                <i class="fas fa-check-circle mr-1"></i>Mark Delivered
                            </button>
                        `;
                    }
                }
                
                if (status === 'delivered') {
                    return `
                        <span class="text-green-600 text-sm font-medium">
                            <i class="fas fa-check-circle mr-1"></i>Completed
                        </span>
                    `;
                }
                
                return `
                    <button onclick="dashboard.updateOrderStatus(${order.id}, '', '${orderType}')" 
                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        Update Status
                    </button>
                `;
            }

            getTimeElapsed(timestamp) {
                if (!timestamp) return '';
                const now = new Date();
                const time = new Date(timestamp);
                const diff = Math.floor((now - time) / 1000 / 60); // minutes
                
                if (diff < 60) return `${diff}m ago`;
                if (diff < 1440) return `${Math.floor(diff / 60)}h ago`;
                return `${Math.floor(diff / 1440)}d ago`;
            }

            // Order History Loading
            async loadOrderHistory() {
                try {
                    const period = document.getElementById('history-period').value;
                    const status = document.getElementById('history-status').value;
                    
                    let url = '/api/fast-delivery-agent/order-history?page=1&limit=50';
                    if (period && period !== 'all') url += `&period=${period}`;
                    if (status) url += `&status=${status}`;
                    
                    const response = await window.authUtils.makeAuthenticatedRequest(url);
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        this.displayOrderHistory(data.orders);
                    }
                } catch (error) {
                    console.error('Failed to load order history:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            displayOrderHistory(orders) {
                const container = document.getElementById('history-orders-list');
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-history text-gray-400 text-3xl mb-4"></i>
                            <p class="text-gray-600">No order history</p>
                            <p class="text-sm text-gray-500 mt-2">Completed orders will appear here</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orders.map(order => {
                    const commission = parseFloat(order.agent_commission) || ((parseFloat(order.total_amount) * 15) / 100);
                    
                    return `
                        <div class="order-card bg-white rounded-lg p-4 mb-3 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 ${this.getStatusIconClass(order.status)} rounded-full flex items-center justify-center">
                                        <i class="fas ${this.getStatusIcon(order.status)} text-white text-xs"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900">${order.order_number}</h4>
                                        <p class="text-sm text-gray-600">${order.buyer_name || 'Customer'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-900">$${commissionDisplay}</p>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${this.getStatusClass(order.status)}">
                                        ${this.formatStatus(order.status)}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-600">
                                <span><i class="fas fa-calendar mr-1"></i>${new Date(order.created_at).toLocaleDateString()}</span>
                                <span>$${order.total_amount} total</span>
                                <button onclick="dashboard.viewOrderDetails(${order.id})" 
                                        class="text-blue-600 hover:text-blue-700">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async acceptOrder(orderId, orderType = 'regular') {
                try {
                    const acceptButton = document.querySelector(`button[onclick="dashboard.acceptOrder(${orderId}, '${orderType}')"], button[onclick="dashboard.acceptOrder(${orderId})"]`);
                    if (acceptButton) {
                        acceptButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Accepting...';
                        acceptButton.disabled = true;
                    }

                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fast-delivery-agent/accept-order/${orderId}`, 
                        {
                            method: 'POST',
                            body: JSON.stringify({ orderType: orderType })
                        }
                    );

                    if (response && response.ok) {
                        const data = await response.json();
                        
                        this.showNotification(`Order ${data.orderNumber || orderId} accepted successfully!`, 'success');
                        
                        // Refresh orders
                        await this.loadAvailableOrders();
                        await this.loadActiveOrders();
                        await this.loadStats();
                        
                        // Switch to active orders tab
                        this.switchTab('active');
                        
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(errorData.error || 'Failed to accept order');
                    }

                } catch (error) {
                    console.error('Failed to accept order:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.showNotification(`Failed to accept order: ${error.message}`, 'error');
                    
                    // Reset button state
                    const acceptButton = document.querySelector(`button[onclick="dashboard.acceptOrder(${orderId}, '${orderType}')"], button[onclick="dashboard.acceptOrder(${orderId})"]`);
                    if (acceptButton) {
                        acceptButton.innerHTML = '<i class="fas fa-check mr-1"></i>Accept Order';
                        acceptButton.disabled = false;
                    }
                }
            }

            async viewOrderDetails(orderId) {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(`/api/fast-delivery-agent/order/${orderId}`);

                    if (response && response.ok) {
                        const data = await response.json();
                        this.displayOrderModal(data.order);
                    }
                } catch (error) {
                    console.error('Failed to load order details:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            displayOrderModal(order) {
                const modalContent = document.getElementById('order-modal-content');
                const commission = parseFloat(order.agent_commission) || ((parseFloat(order.total_amount) * 15) / 100);
                const commissionDisplay = isNaN(commission) ? '0.00' : commission.toFixed(2);
                const itemCount = order.items ? order.items.length : 0;
                const totalItems = order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
                
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <!-- Order Header -->
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold">${order.order_number}</h3>
                                    <p class="text-blue-100">Order Value: $${order.total_amount}</p>
                                    <p class="text-blue-100">Your Commission: $${commissionDisplay}</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-white text-blue-600">
                                        ${this.formatStatus(order.status)}
                                    </span>
                                    ${order.delivery_code ? `<p class="text-blue-100 mt-2">Code: <strong>${order.delivery_code}</strong></p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Workflow Progress -->
                        <div class="order-workflow">
                            ${this.renderWorkflowSteps(order.status, order.order_type)}
                        </div>

                        <!-- Buyer and Seller Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Seller Information -->
                            <div class="bg-orange-50 rounded-lg p-4">
                                <h4 class="font-semibold text-orange-900 mb-3 flex items-center">
                                    <i class="fas fa-store mr-2"></i>Pickup from Seller
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Name:</strong> ${order.seller_name || 'Seller'}</p>
                                    <p><strong>Phone:</strong> ${order.seller_phone || 'Not provided'}</p>
                                    <p><strong>Address:</strong> ${order.pickup_address || 'Not specified'}</p>
                                    ${order.pickup_notes ? `<p><strong>Notes:</strong> ${order.pickup_notes}</p>` : ''}
                                </div>
                                ${order.pickup_lat && order.pickup_lng ? `
                                    <button onclick="dashboard.navigateToLocation(${order.pickup_lat}, ${order.pickup_lng}, 'seller')" 
                                            class="mt-3 bg-orange-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-700">
                                        <i class="fas fa-directions mr-1"></i>Get Directions
                                    </button>
                                ` : ''}
                            </div>

                            <!-- Buyer Information -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-900 mb-3 flex items-center">
                                    <i class="fas fa-user mr-2"></i>Deliver to Buyer
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Name:</strong> ${order.buyer_name || 'Customer'}</p>
                                    <p><strong>Phone:</strong> ${order.buyer_phone || 'Not provided'}</p>
                                    <p><strong>Address:</strong> ${order.delivery_address || 'Not specified'}</p>
                                    ${order.special_notes ? `<p><strong>Special Notes:</strong> ${order.special_notes}</p>` : ''}
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    ${order.delivery_lat && order.delivery_lng ? `
                                        <button onclick="dashboard.navigateToLocation(${order.delivery_lat}, ${order.delivery_lng}, 'buyer')" 
                                                class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                            <i class="fas fa-directions mr-1"></i>Get Directions
                                        </button>
                                    ` : ''}
                                    ${order.buyer_phone && order.buyer_phone !== 'Not provided' ? `
                                        <button onclick="dashboard.callBuyer('${order.buyer_phone}')" 
                                                class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                            <i class="fas fa-phone mr-1"></i>Call Buyer
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-list mr-2"></i>Order Items (${itemCount} types, ${totalItems} total items)
                            </h4>
                            <div class="space-y-3">
                                ${order.items ? order.items.map(item => `
                                    <div class="flex items-center justify-between bg-white rounded-lg p-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-box text-gray-600"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-900">${item.product_name || item.name}</p>
                                                <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
                                                ${item.notes ? `<p class="text-xs text-gray-500">${item.notes}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium text-gray-900">$${(item.price * item.quantity).toFixed(2)}</p>
                                            <p class="text-sm text-gray-600">$${item.price} each</p>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-600">No items loaded</p>'}
                            </div>
                        </div>

                        <!-- Payment & Delivery Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-green-50 rounded-lg p-4">
                                <h4 class="font-semibold text-green-900 mb-3 flex items-center">
                                    <i class="fas fa-credit-card mr-2"></i>Payment Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Method:</strong> ${order.payment_method || 'Manual Payment'}</p>
                                    <p><strong>Status:</strong> ${order.payment_status || 'Pending'}</p>
                                    <p><strong>Total Amount:</strong> $${order.total_amount}</p>
                                    <p><strong>Agent Commission:</strong> $${commissionDisplay} (70% of platform commission)</p>
                                </div>
                            </div>

                            <div class="bg-purple-50 rounded-lg p-4">
                                <h4 class="font-semibold text-purple-900 mb-3 flex items-center">
                                    <i class="fas fa-clock mr-2"></i>Timing Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Ordered:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                                    <p><strong>Delivery Window:</strong> ${order.delivery_time_window || 'ASAP'}</p>
                                    ${order.agent_assigned_at ? `<p><strong>Assigned:</strong> ${new Date(order.agent_assigned_at).toLocaleString()}</p>` : ''}
                                    ${order.actual_pickup_time ? `<p><strong>Picked Up:</strong> ${new Date(order.actual_pickup_time).toLocaleString()}</p>` : ''}
                                    ${order.actual_delivery_time ? `<p><strong>Delivered:</strong> ${new Date(order.actual_delivery_time).toLocaleString()}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Commission Information -->
                        <div class="commission-info rounded-lg">
                            <h4 class="font-medium text-green-700 mb-2">
                                <i class="fas fa-dollar-sign mr-2"></i>Commission Details
                            </h4>
                            <p class="text-sm text-green-600">
                                • You earn $${commissionDisplay} (15% of order value)<br>
                                • Seller payment released after pickup confirmation<br>
                                • Your commission approved after buyer confirmation + grace period<br>
                                • Payment processed via mobile money or bank transfer
                            </p>
                        </div>

                        <!-- Location Map -->
                        ${order.pickup_lat && order.pickup_lng ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                    <i class="fas fa-map-marker-alt mr-2"></i>Pickup & Delivery Locations
                                </h4>
                                <div id="order-detail-map" class="map-container mb-3"></div>
                                <div class="flex space-x-2">
                                    <button onclick="dashboard.navigateToLocation(${order.pickup_lat}, ${order.pickup_lng}, 'seller')" 
                                            class="bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700">
                                        <i class="fas fa-directions mr-1"></i>Navigate to Seller
                                    </button>
                                    ${order.delivery_lat && order.delivery_lng ? `
                                        <button onclick="dashboard.navigateToLocation(${order.delivery_lat}, ${order.delivery_lng}, 'buyer')" 
                                                class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                            <i class="fas fa-directions mr-1"></i>Navigate to Buyer
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        ${order.status !== 'delivered' && order.agent_id ? `
                            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                <button onclick="dashboard.reportIssue(${order.id})" 
                                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>Report Issue
                                </button>
                                <div class="flex space-x-3">
                                    ${this.getActionButtons(order)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('order-modal').classList.remove('hidden');
                
                // Initialize map if location data is available
                if (order.pickup_lat && order.pickup_lng) {
                    setTimeout(() => {
                        this.initializeOrderDetailMap(order);
                    }, 100);
                }
            }

            initializeOrderDetailMap(order) {
                try {
                    const mapContainer = document.getElementById('order-detail-map');
                    if (!mapContainer) return;

                    // Initialize map centered on pickup location
                    const map = L.map('order-detail-map').setView([order.pickup_lat, order.pickup_lng], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    // Add pickup marker (seller)
                    const pickupMarker = L.marker([order.pickup_lat, order.pickup_lng])
                        .addTo(map)
                        .bindPopup(`
                            <div class="text-center">
                                <strong>📍 Pickup Location</strong><br>
                                <strong>${order.seller_name || 'Local Market Seller'}</strong><br>
                                ${order.pickup_address || 'Pickup location'}<br>
                                <small>Phone: ${order.seller_phone || 'Not provided'}</small>
                            </div>
                        `);

                    // Add delivery marker if available
                    if (order.delivery_lat && order.delivery_lng) {
                        const deliveryMarker = L.marker([order.delivery_lat, order.delivery_lng])
                            .addTo(map)
                            .bindPopup(`
                                <div class="text-center">
                                    <strong>🏠 Delivery Location</strong><br>
                                    <strong>${order.buyer_name || 'Customer'}</strong><br>
                                    ${order.delivery_address || 'Delivery location'}<br>
                                    <small>Phone: ${order.buyer_phone || 'Not provided'}</small>
                                </div>
                            `);

                        // Fit map to show both locations
                        const group = new L.featureGroup([pickupMarker, deliveryMarker]);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }

                    // Store map reference for cleanup
                    this.orderDetailMap = map;
                } catch (error) {
                    console.error('Failed to initialize order detail map:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            // Navigation and communication functions
            navigateToLocation(lat, lng, type) {
                const destination = `${lat},${lng}`;
                const label = type === 'seller' ? 'Pickup Location' : 'Delivery Location';
                
                // Try to open in Google Maps app first, fallback to web
                const googleMapsApp = `comgooglemaps://?daddr=${destination}&directionsmode=driving`;
                const googleMapsWeb = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
                
                // For mobile devices, try app first
                if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    window.location.href = googleMapsApp;
                    // Fallback to web version after a short delay
                    setTimeout(() => {
                        window.open(googleMapsWeb, '_blank');
                    }, 1000);
                } else {
                    window.open(googleMapsWeb, '_blank');
                }
            }

            callBuyer(phoneNumber) {
                if (phoneNumber && phoneNumber !== 'Not provided') {
                    window.location.href = `tel:${phoneNumber}`;
                } else {
                    alert('Phone number not available');
                }
            }

            async acceptOrder(orderId) {
                try {
                    // Show loading state
                    const acceptButton = document.querySelector(`button[onclick="dashboard.acceptOrder(${orderId})"]`);
                    if (acceptButton) {
                        acceptButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Accepting...';
                        acceptButton.disabled = true;
                    }

                    // Get current location for GPS verification
                    let location = null;
                    try {
                        location = await this.getCurrentLocationPromise();
                    } catch (locationError) {
                        console.warn('Could not get location:', locationError);
                    }

                    const requestBody = {
                        orderId: orderId,
                        location: location
                    };

                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fast-delivery-agent/accept-order/${orderId}`, 
                        {
                            method: 'POST',
                            body: JSON.stringify({ location: location })
                        }
                    );

                    if (response && response.ok) {
                        const data = await response.json();
                        
                        // Show success notification
                        this.showNotification(`Order ${data.orderNumber} accepted successfully!`, 'success');
                        
                        // Refresh orders
                        await this.loadAvailableOrders();
                        await this.loadActiveOrders();
                        await this.loadStats();
                        
                        // Switch to active orders tab
                        this.switchTab('active');
                        
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to accept order');
                    }

                } catch (error) {
                    console.error('Failed to accept order:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.showNotification(`Failed to accept order: ${error.message}`, 'error');
                    
                    // Reset button state
                    const acceptButton = document.querySelector(`button[onclick="dashboard.acceptOrder(${orderId})"]`);
                    if (acceptButton) {
                        acceptButton.innerHTML = '<i class="fas fa-check mr-1"></i>Accept Order';
                        acceptButton.disabled = false;
                    }
                }
            }

            // Enhanced order status update with GPS verification
            updateOrderStatus(orderId, newStatus = null, orderType = 'regular') {
                this.currentOrderId = orderId;
                this.currentOrderType = orderType;
                
                if (newStatus) {
                    // Direct status update with GPS verification
                    this.performStatusUpdate(orderId, newStatus, '', '', orderType);
                } else {
                    // Show modal for manual status selection
                    document.getElementById('status-modal').classList.remove('hidden');
                    this.getCurrentLocation();
                }
            }

            async performStatusUpdate(orderId, status, notes = '', issueType = '', orderType = 'regular') {
                try {
                    // Get current location for GPS verification
                    const location = await this.getCurrentLocationPromise();
                    
                    const requestBody = {
                        status,
                        notes,
                        orderType,
                        location: location ? {
                            latitude: location.latitude,
                            longitude: location.longitude,
                            accuracy: location.accuracy
                        } : null
                    };

                    if (issueType) {
                        requestBody.issue_type = issueType;
                        requestBody.issue_description = notes;
                    }

                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fast-delivery-agent/update-status/${orderId}`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        }
                    );

                    if (response && response.ok) {
                        const result = await response.json();
                        this.showNotification('Status updated successfully!', 'success');
                        
                        // Handle specific status updates
                        if (status === 'picked_from_seller') {
                            this.showNotification('Seller payment will be released automatically', 'info');
                        } else if (status === 'delivered') {
                            this.showDeliveryConfirmationModal(orderId);
                            return; // Don't close modal yet
                        }
                        
                        this.loadActiveOrders();
                        this.loadStats();
                        
                        // Close any open modals
                        document.getElementById('status-modal').classList.add('hidden');
                    } else if (response) {
                        const error = await response.json();
                        this.showNotification(error.error || 'Failed to update status', 'error');
                    }
                } catch (error) {
                    console.error('Failed to update status:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.showNotification('Failed to update status', 'error');
                }
            }

            async confirmStatusUpdate() {
                const status = document.getElementById('status-select').value;
                const notes = document.getElementById('status-notes').value;
                const issueType = document.getElementById('issue-type').value;

                await this.performStatusUpdate(this.currentOrderId, status, notes, issueType);
            }

            // GPS and Location Methods
            getCurrentLocation() {
                const statusElement = document.getElementById('location-status');
                
                if (navigator.geolocation) {
                    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i><span>Getting location...</span>';
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.currentLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            statusElement.innerHTML = '<i class="fas fa-map-marker-alt text-green-600 mr-1"></i><span class="text-green-600">Location ready</span>';
                        },
                        (error) => {
                            console.error('Location error:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-1"></i><span class="text-red-600">Location unavailable</span>';
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                    );
                } else {
                    statusElement.innerHTML = '<i class="fas fa-times text-red-600 mr-1"></i><span class="text-red-600">GPS not supported</span>';
                }
            }

            getCurrentLocationPromise() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        resolve(null);
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            });
                        },
                        (error) => {
                            console.warn('Location error:', error);
                            resolve(null); // Continue without location
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                    );
                });
            }

            // Navigation and Communication
            navigateToLocation(lat, lng, type) {
                const destination = `${lat},${lng}`;
                const label = type === 'seller' ? 'Pickup Location' : 'Delivery Location';
                
                // Try Google Maps first, fallback to Apple Maps on iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    window.open(`maps://maps.google.com/maps?daddr=${destination}&amp;ll=`);
                } else {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`);
                }
            }

            callBuyer(phoneNumber) {
                if (phoneNumber && phoneNumber !== 'N/A') {
                    window.open(`tel:${phoneNumber}`);
                } else {
                    this.showNotification('Phone number not available', 'warning');
                }
            }

            // Issue Reporting
            reportIssue(orderId) {
                this.currentOrderId = orderId;
                document.getElementById('issue-report-modal').classList.remove('hidden');
            }

            async submitIssueReport() {
                const issueType = document.getElementById('report-issue-type').value;
                const description = document.getElementById('issue-description').value;
                const photos = document.getElementById('issue-photos').files;

                if (!description.trim()) {
                    this.showNotification('Please provide a description of the issue', 'warning');
                    return;
                }

                try {
                    // Handle photo uploads if any
                    let photoUrls = [];
                    if (photos.length > 0) {
                        // In a real implementation, you'd upload photos to a server
                        // For now, we'll just note that photos were provided
                        photoUrls = Array.from(photos).map(file => file.name);
                    }

                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fast-delivery-agent/report-issue/${this.currentOrderId}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                issue_type: issueType,
                                description: description,
                                photos: photoUrls
                            })
                        }
                    );

                    if (response && response.ok) {
                        this.showNotification('Issue reported successfully. Admin will review it.', 'success');
                        document.getElementById('issue-report-modal').classList.add('hidden');
                        this.loadActiveOrders();
                    } else if (response) {
                        const error = await response.json();
                        this.showNotification(error.error || 'Failed to report issue', 'error');
                    }
                } catch (error) {
                    console.error('Failed to report issue:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.showNotification('Failed to report issue', 'error');
                }
            }

            // Delivery Confirmation
            showDeliveryConfirmationModal(orderId) {
                this.currentOrderId = orderId;
                document.getElementById('delivery-confirmation-modal').classList.remove('hidden');
            }

            async confirmDelivery() {
                const deliveryCode = document.getElementById('delivery-code-input').value;
                const buyerPresent = document.getElementById('buyer-present').checked;
                const deliveryNotes = document.getElementById('delivery-notes').value;

                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fast-delivery-agent/confirm-delivery/${this.currentOrderId}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                delivery_code: deliveryCode,
                                confirmed_by_buyer: buyerPresent,
                                delivery_notes: deliveryNotes
                            })
                        }
                    );

                    if (response && response.ok) {
                        const result = await response.json();
                        this.showNotification('Delivery confirmed! Commission will be approved after grace period.', 'success');
                        document.getElementById('delivery-confirmation-modal').classList.add('hidden');
                        this.loadActiveOrders();
                        this.loadStats();
                    } else if (response) {
                        const error = await response.json();
                        this.showNotification(error.error || 'Failed to confirm delivery', 'error');
                    }
                } catch (error) {
                    console.error('Failed to confirm delivery:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.showNotification('Failed to confirm delivery', 'error');
                }
            }

            async toggleOnlineStatus() {
                if (!this.isOnline) {
                    if (!this.currentLocation) {
                        this.showNotification('Please enable location services first', 'warning');
                        return;
                    }
                    await this.goOnline();
                } else {
                    await this.goOffline();
                }
            }

            async goOnline() {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest('/api/fast-delivery-agent/go-online', {
                        method: 'POST',
                        body: JSON.stringify({
                            location: this.currentLocation
                        })
                    });

                    if (response && response.ok) {
                        this.isOnline = true;
                        this.updateStatusDisplay('online');
                        this.startLocationTracking();
                        this.showNotification('You are now online and available for orders!', 'success');
                    }
                } catch (error) {
                    console.error('Failed to go online:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    this.showNotification('Failed to go online', 'error');
                }
            }

            async goOffline() {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest('/api/fast-delivery-agent/go-offline', {
                        method: 'POST'
                    });

                    if (response && response.ok) {
                        this.isOnline = false;
                        this.updateStatusDisplay('offline');
                        this.stopLocationTracking();
                        this.showNotification('You are now offline', 'info');
                    }
                } catch (error) {
                    console.error('Failed to go offline:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            enableLocation() {
                if (!navigator.geolocation) {
                    this.showNotification('Geolocation is not supported by this browser', 'error');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        this.updateLocationDisplay();
                        this.initializeMap();
                        this.showNotification('Location enabled successfully!', 'success');
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                        this.showNotification('Failed to get your location', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            }

            startLocationTracking() {
                if (!navigator.geolocation) return;

                this.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };

                        this.updateLocationDisplay();
                        this.updateMapLocation();
                        this.sendLocationUpdate();
                    },
                    (error) => {
                        console.error('Location tracking error:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    },
                    { enableHighAccuracy: true, timeout: 30000, maximumAge: 10000 }
                );
            }

            stopLocationTracking() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
            }

            async sendLocationUpdate() {
                if (!this.currentLocation) return;

                try {
                    await window.authUtils.makeAuthenticatedRequest('/api/fast-delivery-agent/update-location', {
                        method: 'POST',
                        body: JSON.stringify(this.currentLocation)
                    });
                } catch (error) {
                    console.error('Failed to update location:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                }
            }

            initializeMap() {
                if (!this.currentLocation) return;

                const mapContainer = document.getElementById('delivery-map');
                mapContainer.innerHTML = '';

                this.map = L.map('delivery-map').setView(
                    [this.currentLocation.latitude, this.currentLocation.longitude], 
                    15
                );

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.map);

                this.agentMarker = L.marker([this.currentLocation.latitude, this.currentLocation.longitude])
                    .addTo(this.map)
                    .bindPopup('Your Location');
            }

            updateMapLocation() {
                if (!this.map || !this.agentMarker || !this.currentLocation) return;

                const newLatLng = [this.currentLocation.latitude, this.currentLocation.longitude];
                this.agentMarker.setLatLng(newLatLng);
                this.map.setView(newLatLng);
            }

            updateMapMarkers(orders, type) {
                if (!this.map) return;

                // Clear existing order markers
                this.orderMarkers.forEach(marker => this.map.removeLayer(marker));
                this.orderMarkers = [];

                // Add new markers
                orders.forEach(order => {
                    if (order.delivery_lat && order.delivery_lng) {
                        const icon = type === 'available' ? 'green' : 'blue';
                        const marker = L.marker([order.delivery_lat, order.delivery_lng])
                            .addTo(this.map)
                            .bindPopup(`
                                <div>
                                    <strong>${order.order_number}</strong><br>
                                    Customer: ${order.buyer_name || 'Customer'}<br>
                                    Amount: $${order.total_amount}<br>
                                    Status: ${order.status || 'Available'}
                                </div>
                            `);
                        
                        this.orderMarkers.push(marker);
                    }
                });
            }

            updateStatusDisplay(status) {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('agent-status');
                const toggleBtn = document.getElementById('toggle-status');

                if (status === 'online') {
                    statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                    statusText.textContent = 'Online';
                    toggleBtn.textContent = 'Go Offline';
                    toggleBtn.className = 'bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm';
                } else {
                    statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full pulse-dot';
                    statusText.textContent = 'Offline';
                    toggleBtn.textContent = 'Go Online';
                    toggleBtn.className = 'bg-green-700 hover:bg-green-800 px-4 py-2 rounded-lg text-sm';
                }
            }

            updateLocationDisplay() {
                if (this.currentLocation) {
                    document.getElementById('location-status').textContent = 'Location enabled';
                    document.getElementById('enable-location-btn').innerHTML = '<i class="fas fa-check mr-2"></i>Location Active';
                    document.getElementById('enable-location-btn').className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg';
                }
            }

            getStatusClass(status) {
                const classes = {
                    'pending': 'status-pending',
                    'assigned': 'status-assigned',
                    'picked_from_seller': 'status-picked',
                    'en_route': 'status-enroute',
                    'delivered': 'status-delivered'
                };
                return classes[status] || 'status-pending';
            }

            handleEmergency() {
                // Implement emergency functionality
                this.showNotification('Emergency alert sent to support team', 'warning');
            }

            toggleBreak() {
                // Implement break functionality
                this.showNotification('Break status toggled', 'info');
            }

            contactSupport() {
                // Implement support contact
                this.showNotification('Connecting to support...', 'info');
            }

            showNotification(message, type = 'info') {
                // Prevent notification spam - limit to 1 notification per second
                const now = Date.now();
                if (this.lastNotificationTime && (now - this.lastNotificationTime) < 1000) {
                    console.log('Notification throttled:', message);
                    return;
                }
                this.lastNotificationTime = now;

                // Remove any existing notifications to prevent stacking
                const existingNotifications = document.querySelectorAll('.notification-toast');
                existingNotifications.forEach(notif => {
                    if (notif.parentNode) {
                        notif.parentNode.removeChild(notif);
                    }
                });

                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification-toast fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                notification.textContent = message;

                document.body.appendChild(notification);

                // Remove after 3 seconds (reduced from 5)
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // ==================== FDA CONFIRMATION SYSTEM ====================
            
            // Start route to seller
            async startRouteToSeller(orderId) {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fda-local-market/orders/${orderId}/update-status`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'FDA_EN_ROUTE_TO_SELLER' })
                        }
                    );
                    
                    if (response && response.ok) {
                        this.showNotification('Route to seller started!', 'success');
                        this.loadActiveOrders();
                    }
                } catch (error) {
                    this.showNotification('Failed to update status: ' + error.message, 'error');
                }
            }

            // Arrived at seller location
            async arrivedAtSeller(orderId) {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fda-local-market/orders/${orderId}/update-status`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'FDA_AT_SELLER' })
                        }
                    );
                    
                    if (response && response.ok) {
                        this.showNotification('Marked as arrived at seller!', 'success');
                        this.loadActiveOrders();
                    }
                } catch (error) {
                    this.showNotification('Failed to update status: ' + error.message, 'error');
                }
            }

            // Generate seller pickup code
            async generateSellerPickupCode(orderId) {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fda-local-market/generate-seller-pickup-code/${orderId}`,
                        { method: 'POST' }
                    );
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        this.showSellerPickupModal(orderId, data);
                    }
                } catch (error) {
                    this.showNotification('Failed to generate pickup code: ' + error.message, 'error');
                }
            }

            // Show seller pickup modal
            showSellerPickupModal(orderId, data) {
                document.getElementById('fda-seller-pickup-content').innerHTML = `
                    <div class="text-center">
                        <div class="mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Pickup Code Generated</h4>
                            <p class="text-gray-600 mb-4">Share this code with the seller for verification:</p>
                            <div class="bg-green-100 text-green-800 px-4 py-3 rounded-lg font-mono text-2xl font-bold mb-4">
                                ${data.pickupCode}
                            </div>
                            <p class="text-sm text-gray-600">Expires: ${new Date(data.expiresAt).toLocaleString()}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Enter seller's confirmation code:</label>
                                <input type="text" id="sellerConfirmationCode" 
                                       class="w-full border border-gray-300 rounded-md p-2 text-center font-mono text-lg" 
                                       placeholder="000000" maxlength="6">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Additional notes:</label>
                                <textarea id="sellerConfirmationNotes" 
                                         class="w-full border border-gray-300 rounded-md p-2" 
                                         rows="2" placeholder="Package condition, items verified, etc."></textarea>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="dashboard.confirmSellerPickup(${orderId})" 
                                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                                    <i class="fas fa-check mr-1"></i> Confirm Pickup
                                </button>
                                <button onclick="dashboard.closeFDASellerModal()" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('fda-seller-pickup-modal').classList.remove('hidden');
                this.showNotification('Pickup code generated successfully!', 'success');
            }

            // Confirm seller pickup
            async confirmSellerPickup(orderId) {
                try {
                    const pickupCode = document.getElementById('sellerConfirmationCode').value;
                    const notes = document.getElementById('sellerConfirmationNotes').value;
                    
                    if (!pickupCode || pickupCode.length !== 6) {
                        this.showNotification('Please enter a valid 6-digit confirmation code', 'error');
                        return;
                    }
                    
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fda-local-market/verify-seller-pickup/${orderId}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pickupCode: pickupCode,
                                sellerConfirmation: notes
                            })
                        }
                    );
                    
                    if (response && response.ok) {
                        this.closeFDASellerModal();
                        this.showNotification('✅ Seller pickup confirmed! Seller payout ready for release after delivery.', 'success');
                        this.loadActiveOrders();
                    }
                } catch (error) {
                    this.showNotification('Failed to confirm pickup: ' + error.message, 'error');
                }
            }

            // Start route to buyer
            async startRouteTobuyer(orderId) {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fda-local-market/orders/${orderId}/update-status`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'FDA_EN_ROUTE_TO_BUYER' })
                        }
                    );
                    
                    if (response && response.ok) {
                        this.showNotification('Route to buyer started!', 'success');
                        this.loadActiveOrders();
                    }
                } catch (error) {
                    this.showNotification('Failed to update status: ' + error.message, 'error');
                }
            }

            // Generate buyer delivery code
            async generateBuyerDeliveryCode(orderId) {
                try {
                    const response = await window.authUtils.makeAuthenticatedRequest(
                        `/api/fda-local-market/generate-buyer-delivery-code/${orderId}`,
                        { method: 'POST' }
                    );
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        this.showBuyerDeliveryModal(orderId, data);
                    }
                } catch (error) {
                    this.showNotification('Failed to generate delivery code: ' + error.message, 'error');
                }
            }

            // Show buyer delivery modal
            showBuyerDeliveryModal(orderId, data) {
                document.getElementById('fda-buyer-delivery-content').innerHTML = `
                    <div class="text-center">
                        <div class="mb-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Delivery Code Generated</h4>
                            <p class="text-gray-600 mb-4">Show this code to buyer for delivery confirmation:</p>
                            <div class="bg-red-100 text-red-800 px-4 py-3 rounded-lg font-mono text-2xl font-bold mb-4">
                                ${data.deliveryCode}
                            </div>
                            <p class="text-sm text-gray-600">Expires: ${new Date(data.expiresAt).toLocaleString()}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery confirmation code:</label>
                                <input type="text" id="buyerConfirmationCode" value="${data.deliveryCode}"
                                       class="w-full border border-gray-300 rounded-md p-2 text-center font-mono text-lg" 
                                       readonly>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery notes:</label>
                                <textarea id="buyerConfirmationNotes" 
                                         class="w-full border border-gray-300 rounded-md p-2" 
                                         rows="2" placeholder="Package delivered successfully, buyer satisfied, etc."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery photo (optional):</label>
                                <input type="file" id="deliveryPhotoInput" accept="image/*" capture="camera"
                                       class="w-full border border-gray-300 rounded-md p-2">
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="dashboard.confirmBuyerDelivery(${orderId})" 
                                        class="flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">
                                    <i class="fas fa-truck mr-1"></i> Confirm Delivery
                                </button>
                                <button onclick="dashboard.closeFDABuyerModal()" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-sm text-yellow-800">
                            <strong>⚠️  Important:</strong> Confirming delivery will immediately release seller payout and your commission.
                        </div>
                    </div>
                `;
                
                document.getElementById('fda-buyer-delivery-modal').classList.remove('hidden');
                this.showNotification('Delivery code generated successfully!', 'success');
            }

            // Confirm buyer delivery
            async confirmBuyerDelivery(orderId) {
                try {
                    const deliveryCode = document.getElementById('buyerConfirmationCode').value;
                    const notes = document.getElementById('buyerConfirmationNotes').value;
                    const photoInput = document.getElementById('deliveryPhotoInput');
                    
                    const formData = new FormData();
                    formData.append('deliveryCode', deliveryCode);
                    formData.append('buyerConfirmation', notes);
                    
                    if (photoInput.files[0]) {
                        formData.append('deliveryPhoto', photoInput.files[0]);
                    }
                    
                    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                    const response = await fetch(`/api/fda-local-market/confirm-buyer-delivery/${orderId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.closeFDABuyerModal();
                        this.showNotification('🎉 Delivery confirmed! Seller payout and your commission have been released.', 'success');
                        this.loadActiveOrders();
                        this.loadStats(); // Refresh earnings
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Delivery confirmation failed');
                    }
                } catch (error) {
                    this.showNotification('Failed to confirm delivery: ' + error.message, 'error');
                }
            }

            // Close FDA modals
            closeFDASellerModal() {
                document.getElementById('fda-seller-pickup-modal').classList.add('hidden');
            }

            closeFDABuyerModal() {
                document.getElementById('fda-buyer-delivery-modal').classList.add('hidden');
            }
        }

        // Global functions
        function logout() {
            window.authUtils.logout();
        }

        // Initialize dashboard
        const dashboard = new FastDeliveryAgentDashboard();
    </script>

<script>
// Utility Functions for Enhanced Functionality
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-black' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Generic search handlers
function handleProductSearch(query) {
    console.log('Searching products:', query);
    if (query.length > 2) {
        // Implement product search logic
        showNotification('Searching for: ' + query, 'info');
    }
}

function handleSellerSearch(query) {
    console.log('Searching sellers:', query);
    if (query.length > 2) {
        showNotification('Searching sellers: ' + query, 'info');
    }
}

function handleAgentSearch(query) {
    console.log('Searching agents:', query);
    if (query.length > 2) {
        showNotification('Searching agents: ' + query, 'info');
    }
}

function handleOrderSearch(query) {
    console.log('Searching orders:', query);
    if (query.length > 2) {
        showNotification('Searching orders: ' + query, 'info');
    }
}

function handleUserSearch(query) {
    console.log('Searching users:', query);
    if (query.length > 2) {
        showNotification('Searching users: ' + query, 'info');
    }
}

// Generic form handlers
function handleSave() {
    showNotification('Save functionality will be implemented soon', 'info');
}

function handleEdit() {
    showNotification('Edit functionality will be implemented soon', 'info');
}

function handleDelete() {
    if (confirm('Are you sure you want to delete this item?')) {
        showNotification('Delete functionality will be implemented soon', 'info');
    }
}

function handleCancel() {
    if (confirm('Are you sure you want to cancel? Unsaved changes will be lost.')) {
        history.back();
    }
}
</script>
</body>
</html>