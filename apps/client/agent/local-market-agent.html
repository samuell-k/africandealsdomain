<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Market Agent Dashboard - African Deals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-badge {
            @apply px-3 py-1 rounded-full text-xs font-semibold;
        }
        
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-assigned { @apply bg-blue-100 text-blue-800; }
        .status-picked-up { @apply bg-orange-100 text-orange-800; }
        .status-in-delivery { @apply bg-purple-100 text-purple-800; }
        .status-delivered { @apply bg-green-100 text-green-800; }
        .status-completed { @apply bg-gray-100 text-gray-800; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-900 via-green-800 to-green-700 min-h-screen">
    <!-- Navigation -->
    <nav class="glass-morphism p-4 mb-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-motorcycle text-white text-2xl"></i>
                <h1 class="text-white text-xl font-bold">Local Market Agent</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="agent-name" class="text-white"></span>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Stats -->
    <div class="container mx-auto px-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="glass-morphism p-4 rounded-xl text-center">
                <i class="fas fa-clipboard-list text-blue-400 text-3xl mb-2"></i>
                <div class="text-white text-2xl font-bold" id="assigned-orders">0</div>
                <div class="text-white/70 text-sm">Assigned Orders</div>
            </div>
            <div class="glass-morphism p-4 rounded-xl text-center">
                <i class="fas fa-box text-orange-400 text-3xl mb-2"></i>
                <div class="text-white text-2xl font-bold" id="pickup-pending">0</div>
                <div class="text-white/70 text-sm">Pending Pickup</div>
            </div>
            <div class="glass-morphism p-4 rounded-xl text-center">
                <i class="fas fa-truck text-purple-400 text-3xl mb-2"></i>
                <div class="text-white text-2xl font-bold" id="in-delivery">0</div>
                <div class="text-white/70 text-sm">In Delivery</div>
            </div>
            <div class="glass-morphism p-4 rounded-xl text-center">
                <i class="fas fa-check-circle text-green-400 text-3xl mb-2"></i>
                <div class="text-white text-2xl font-bold" id="completed-today">0</div>
                <div class="text-white/70 text-sm">Completed Today</div>
            </div>
        </div>
    </div>

    <!-- Orders List -->
    <div class="container mx-auto px-4">
        <div class="glass-morphism rounded-xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-white text-xl font-bold">My Orders</h2>
                <button onclick="refreshOrders()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-refresh mr-2"></i>Refresh
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex space-x-2 mb-6">
                <button onclick="filterOrders('all')" class="filter-tab active bg-white/20 text-white px-4 py-2 rounded-lg">
                    All Orders
                </button>
                <button onclick="filterOrders('agent_assigned')" class="filter-tab bg-white/10 text-white/70 px-4 py-2 rounded-lg">
                    Assigned
                </button>
                <button onclick="filterOrders('picked_up')" class="filter-tab bg-white/10 text-white/70 px-4 py-2 rounded-lg">
                    Picked Up
                </button>
                <button onclick="filterOrders('in_delivery')" class="filter-tab bg-white/10 text-white/70 px-4 py-2 rounded-lg">
                    In Delivery
                </button>
                <button onclick="filterOrders('delivered')" class="filter-tab bg-white/10 text-white/70 px-4 py-2 rounded-lg">
                    Delivered
                </button>
            </div>

            <!-- Orders Container -->
            <div id="orders-container" class="space-y-4">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                    <p class="text-white/70">Loading orders...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Order Details</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="order-details-content">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Global variables
        let currentOrders = [];
        let currentFilter = 'all';
        let agentId = null;

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/auth-agent.html';
                return false;
            }
            return true;
        }

        // Make authenticated request
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/auth-agent.html';
                throw new Error('No authentication token');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            const response = await fetch(url, mergedOptions);
            
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/auth/auth-agent.html';
                throw new Error('Authentication failed');
            }

            return response;
        }

        // Load agent profile
        async function loadAgentProfile() {
            try {
                const response = await makeAuthenticatedRequest('/api/auth/profile');
                const data = await response.json();
                
                if (data.success && data.user) {
                    document.getElementById('agent-name').textContent = data.user.name;
                    agentId = data.user.id;
                } else {
                    throw new Error('Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile', 'error');
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await makeAuthenticatedRequest('/api/local-market/agent/orders');
                const data = await response.json();
                
                if (data.success) {
                    currentOrders = data.orders || [];
                    updateStats();
                    renderOrders();
                } else {
                    throw new Error(data.message || 'Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Failed to load orders', 'error');
                document.getElementById('orders-container').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <p class="text-white/70">Failed to load orders</p>
                        <button onclick="loadOrders()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Update dashboard stats
        function updateStats() {
            const stats = {
                assigned: currentOrders.filter(o => o.status === 'agent_assigned').length,
                pickupPending: currentOrders.filter(o => o.status === 'agent_assigned').length,
                inDelivery: currentOrders.filter(o => o.status === 'in_delivery').length,
                completedToday: currentOrders.filter(o => {
                    return o.status === 'completed' && 
                           new Date(o.completed_at).toDateString() === new Date().toDateString();
                }).length
            };

            document.getElementById('assigned-orders').textContent = stats.assigned;
            document.getElementById('pickup-pending').textContent = stats.pickupPending;
            document.getElementById('in-delivery').textContent = stats.inDelivery;
            document.getElementById('completed-today').textContent = stats.completedToday;
        }

        // Render orders
        function renderOrders() {
            const container = document.getElementById('orders-container');
            
            let filteredOrders = currentOrders;
            if (currentFilter !== 'all') {
                filteredOrders = currentOrders.filter(order => order.status === currentFilter);
            }

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-white/50 text-4xl mb-4"></i>
                        <p class="text-white/70">No orders found</p>
                    </div>
                `;
                return;
            }

            const ordersHTML = filteredOrders.map(order => `
                <div class="bg-white/10 rounded-lg p-4 hover:bg-white/20 transition-colors">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-white font-semibold">Order #${order.order_number}</h3>
                            <p class="text-white/70 text-sm">${order.buyer_name}</p>
                        </div>
                        <span class="status-badge status-${order.status.replace('_', '-')}">
                            ${formatStatus(order.status)}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                        <div>
                            <span class="text-white/70">Amount:</span>
                            <span class="text-white font-medium">${order.total_amount?.toLocaleString()} RWF</span>
                        </div>
                        <div>
                            <span class="text-white/70">Created:</span>
                            <span class="text-white">${new Date(order.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <span class="text-white/70 text-sm">Delivery Address:</span>
                        <p class="text-white text-sm">${order.delivery_address || 'Not specified'}</p>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="viewOrderDetails(${order.id})" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-eye mr-1"></i>View Details
                        </button>
                        ${getActionButton(order)}
                    </div>
                </div>
            `).join('');

            container.innerHTML = ordersHTML;
        }

        // Get action button based on order status
        function getActionButton(order) {
            switch (order.status) {
                case 'agent_assigned':
                    return `
                        <button onclick="confirmPickup(${order.id})" 
                                class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-box mr-1"></i>Confirm Pickup
                        </button>
                    `;
                case 'picked_up':
                    return `
                        <button onclick="startDelivery(${order.id})" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-truck mr-1"></i>Start Delivery
                        </button>
                    `;
                case 'in_delivery':
                    return `
                        <button onclick="confirmDelivery(${order.id})" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-check mr-1"></i>Confirm Delivery
                        </button>
                    `;
                default:
                    return '';
            }
        }

        // Format status for display
        function formatStatus(status) {
            const statusMap = {
                'agent_assigned': 'Assigned',
                'picked_up': 'Picked Up',
                'in_delivery': 'In Delivery',
                'delivered': 'Delivered',
                'completed': 'Completed'
            };
            return statusMap[status] || status;
        }

        // Filter orders
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update tab appearance
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-white/20');
                tab.classList.add('bg-white/10', 'text-white/70');
            });
            
            event.target.classList.add('active', 'bg-white/20');
            event.target.classList.remove('bg-white/10', 'text-white/70');
            event.target.classList.add('text-white');
            
            renderOrders();
        }

        // Confirm pickup
        async function confirmPickup(orderId) {
            try {
                const notes = prompt('Enter pickup notes (optional):');
                const pickupCode = prompt('Enter pickup code if provided:');
                
                showNotification('Confirming pickup...', 'info');
                
                const response = await makeAuthenticatedRequest(`/api/local-market/${orderId}/agent-confirm-pickup`, {
                    method: 'POST',
                    body: JSON.stringify({
                        notes: notes || 'Items picked up successfully',
                        pickupCode: pickupCode
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Pickup confirmed successfully!', 'success');
                    loadOrders();
                } else {
                    throw new Error(data.message || 'Failed to confirm pickup');
                }
            } catch (error) {
                console.error('Error confirming pickup:', error);
                showNotification('Failed to confirm pickup: ' + error.message, 'error');
            }
        }

        // Start delivery
        async function startDelivery(orderId) {
            try {
                const estimatedTime = prompt('Estimated delivery time (e.g., "30 minutes"):');
                const currentLocation = prompt('Current location (optional):');
                
                showNotification('Starting delivery...', 'info');
                
                const response = await makeAuthenticatedRequest(`/api/local-market/${orderId}/agent-start-delivery`, {
                    method: 'POST',
                    body: JSON.stringify({
                        estimatedDeliveryTime: estimatedTime,
                        currentLocation: currentLocation
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Delivery started successfully!', 'success');
                    loadOrders();
                } else {
                    throw new Error(data.message || 'Failed to start delivery');
                }
            } catch (error) {
                console.error('Error starting delivery:', error);
                showNotification('Failed to start delivery: ' + error.message, 'error');
            }
        }

        // Confirm delivery
        async function confirmDelivery(orderId) {
            try {
                const deliveryCode = prompt('Enter delivery code if provided:');
                const notes = prompt('Enter delivery notes:');
                
                showNotification('Confirming delivery...', 'info');
                
                const response = await makeAuthenticatedRequest(`/api/local-market/${orderId}/agent-confirm-delivery`, {
                    method: 'POST',
                    body: JSON.stringify({
                        deliveryCode: deliveryCode,
                        notes: notes || 'Order delivered successfully'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Delivery confirmed! Awaiting buyer confirmation.', 'success');
                    loadOrders();
                } else {
                    throw new Error(data.message || 'Failed to confirm delivery');
                }
            } catch (error) {
                console.error('Error confirming delivery:', error);
                showNotification('Failed to confirm delivery: ' + error.message, 'error');
            }
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const response = await makeAuthenticatedRequest(`/api/local-market/${orderId}`);
                const data = await response.json();
                
                if (data.success && data.order) {
                    displayOrderDetails(data.order);
                    document.getElementById('order-modal').classList.remove('hidden');
                    document.getElementById('order-modal').classList.add('flex');
                } else {
                    throw new Error(data.message || 'Failed to load order details');
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                showNotification('Failed to load order details', 'error');
            }
        }

        // Display order details in modal
        function displayOrderDetails(order) {
            const content = document.getElementById('order-details-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Order Number</label>
                            <p class="text-lg font-semibold">${order.order_number}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <span class="status-badge status-${order.status.replace('_', '-')}">${formatStatus(order.status)}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Buyer</label>
                            <p>${order.buyer_name}</p>
                            <p class="text-sm text-gray-600">${order.buyer_phone || 'No phone'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Total Amount</label>
                            <p class="text-lg font-semibold">${order.total_amount?.toLocaleString()} RWF</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Delivery Address</label>
                        <p>${order.delivery_address || 'Not specified'}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Order Items</label>
                        <div class="bg-gray-50 rounded-lg p-3">
                            ${JSON.parse(order.order_details || '[]').map(item => `
                                <div class="flex justify-between items-center py-1">
                                    <span>${item.name}</span>
                                    <span>${item.quantity}x ${item.price?.toLocaleString()} RWF</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${order.pickup_notes ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Pickup Notes</label>
                            <p class="bg-gray-50 rounded-lg p-3">${order.pickup_notes}</p>
                        </div>
                    ` : ''}
                    
                    ${order.delivery_notes ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Delivery Notes</label>
                            <p class="bg-gray-50 rounded-lg p-3">${order.delivery_notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex space-x-2 pt-4">
                        ${getActionButton(order)}
                        <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                            Close
                        </button>
                    </div>
                </div>
            `;
        }

        // Close modal
        function closeModal() {
            document.getElementById('order-modal').classList.add('hidden');
            document.getElementById('order-modal').classList.remove('flex');
        }

        // Refresh orders
        function refreshOrders() {
            loadOrders();
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-2 rounded-lg mb-2 shadow-lg`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/auth/auth-agent.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                loadAgentProfile();
                loadOrders();
                
                // Set up periodic refresh
                setInterval(loadOrders, 30000); // Refresh every 30 seconds
            }
        });
    </script>
</body>
</html>