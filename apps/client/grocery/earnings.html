<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Earnings | Fast Delivery Agent - African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" href="/public/images/logo.png">
  <script src="/public/js/auth-utils.js"></script>
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .earnings-card { transition: all 0.3s ease; }
    .earnings-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .tab-button.active { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .commission-badge {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-green-50">

  <!-- Header -->
  <header class="glass shadow-lg sticky top-0 z-40">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo & Back Button -->
        <div class="flex items-center gap-4">
          <button onclick="goBack()" class="flex items-center gap-2 text-gray-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 transition-colors">
            <i class="fas fa-arrow-left"></i>
            <span class="hidden md:block">Back</span>
          </button>
          <div class="flex items-center gap-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-10 w-10 rounded-xl shadow-lg" />
            <div>
              <h1 class="font-bold text-lg text-green-700">💰 My Earnings</h1>
              <p class="text-xs text-gray-500">Fast Delivery Agent</p>
            </div>
          </div>
        </div>

        <!-- User Info -->
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-green-600 text-sm"></i>
          </div>
          <span id="user-name" class="hidden md:block font-medium text-gray-700">Loading...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <i class="fas fa-spinner loading-spinner text-4xl text-green-600 mb-4"></i>
      <p class="text-gray-600">Loading your earnings data...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden space-y-8">
      
      <!-- Period Selector -->
      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <h2 class="text-2xl font-bold text-gray-800">Earnings Overview</h2>
          <div class="flex gap-2">
            <button onclick="loadEarnings('today')" class="tab-button px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-green-50 transition-colors">
              Today
            </button>
            <button onclick="loadEarnings('week')" class="tab-button active px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-green-50 transition-colors">
              This Week
            </button>
            <button onclick="loadEarnings('month')" class="tab-button px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-green-50 transition-colors">
              This Month
            </button>
          </div>
        </div>
      </div>

      <!-- Earnings Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Total Earnings -->
        <div class="earnings-card bg-white rounded-2xl shadow-lg p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Earnings</p>
              <p id="total-earnings" class="text-3xl font-bold text-green-600">0 RWF</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <i class="fas fa-coins text-green-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4">
            <span class="commission-badge">Commission Based</span>
          </div>
        </div>

        <!-- Total Deliveries -->
        <div class="earnings-card bg-white rounded-2xl shadow-lg p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Deliveries</p>
              <p id="total-deliveries" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-truck text-blue-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4">
            <p class="text-sm text-gray-500">Orders completed</p>
          </div>
        </div>

        <!-- Average Commission -->
        <div class="earnings-card bg-white rounded-2xl shadow-lg p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Average Commission</p>
              <p id="average-commission" class="text-3xl font-bold text-purple-600">0 RWF</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-chart-line text-purple-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4">
            <p class="text-sm text-gray-500">Per delivery</p>
          </div>
        </div>

        <!-- Best Commission -->
        <div class="earnings-card bg-white rounded-2xl shadow-lg p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Best Commission</p>
              <p id="max-commission" class="text-3xl font-bold text-orange-600">0 RWF</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
              <i class="fas fa-trophy text-orange-600 text-xl"></i>
            </div>
          </div>
          <div class="mt-4">
            <p class="text-sm text-gray-500">Single delivery</p>
          </div>
        </div>

      </div>

      <!-- Earnings by Order Type -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Order Type Breakdown -->
        <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
          <h3 class="text-xl font-bold text-gray-800 mb-6">Earnings by Order Type</h3>
          <div class="space-y-4">
            
            <!-- Grocery Orders -->
            <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-shopping-basket text-green-600"></i>
                </div>
                <div>
                  <p class="font-semibold text-gray-800">Grocery Orders</p>
                  <p class="text-sm text-gray-600">15% of order total</p>
                </div>
              </div>
              <div class="text-right">
                <p id="grocery-earnings" class="font-bold text-green-600">0 RWF</p>
                <p id="grocery-deliveries" class="text-sm text-gray-500">0 deliveries</p>
              </div>
            </div>

            <!-- Local Market Orders -->
            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-store text-blue-600"></i>
                </div>
                <div>
                  <p class="font-semibold text-gray-800">Local Market Orders</p>
                  <p class="text-sm text-gray-600">Max of 70% delivery fee or 15% total</p>
                </div>
              </div>
              <div class="text-right">
                <p id="local-market-earnings" class="font-bold text-blue-600">0 RWF</p>
                <p id="local-market-deliveries" class="text-sm text-gray-500">0 deliveries</p>
              </div>
            </div>

          </div>
        </div>

        <!-- Earnings Chart -->
        <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
          <h3 class="text-xl font-bold text-gray-800 mb-6">Daily Earnings Trend</h3>
          <div class="relative h-64">
            <canvas id="earnings-chart"></canvas>
          </div>
        </div>

      </div>

      <!-- Daily Breakdown -->
      <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <h3 class="text-xl font-bold text-gray-800 mb-6">Daily Breakdown</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="text-left py-3 px-4 font-semibold text-gray-700">Date</th>
                <th class="text-left py-3 px-4 font-semibold text-gray-700">Deliveries</th>
                <th class="text-left py-3 px-4 font-semibold text-gray-700">Order Types</th>
                <th class="text-right py-3 px-4 font-semibold text-gray-700">Earnings</th>
              </tr>
            </thead>
            <tbody id="daily-breakdown">
              <!-- Daily breakdown will be populated here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Commission Information -->
      <div class="bg-gradient-to-r from-green-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white fade-in">
        <h3 class="text-xl font-bold mb-4">💡 How Your Commission Works</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold mb-2">🛒 Grocery Orders</h4>
            <p class="text-green-100">You earn 15% of the total order value as commission. Simple and straightforward!</p>
          </div>
          <div>
            <h4 class="font-semibold mb-2">🏪 Local Market Orders</h4>
            <p class="text-blue-100">You earn the higher amount between 70% of delivery fee or 15% of order total. We ensure you get the best deal!</p>
          </div>
        </div>
        <div class="mt-4 p-4 bg-white bg-opacity-20 rounded-xl">
          <p class="text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            Commissions are calculated automatically when you complete deliveries and are pending approval for 5 minutes to allow for any disputes.
          </p>
        </div>
      </div>

    </div>

  </main>

  <script>
    let currentPeriod = 'week';
    let earningsChart = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadUserInfo();
      loadEarnings('week');
    });

    function checkAuth() {
      if (!isAuthenticated()) {
        window.location.href = '/public/login.html';
        return;
      }
    }

    async function loadUserInfo() {
      try {
        const response = await fetch('/api/auth/profile', {
          headers: {
            'Authorization': `Bearer ${getAuthToken()}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('user-name').textContent = data.user.username || 'Agent';
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    async function loadEarnings(period) {
      try {
        // Update active tab
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        event?.target?.classList.add('active') || document.querySelector(`[onclick="loadEarnings('${period}')"]`).classList.add('active');
        
        currentPeriod = period;
        
        // Show loading state
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');

        const response = await fetch(`/api/fast-delivery-agent/earnings?period=${period}`, {
          headers: {
            'Authorization': `Bearer ${getAuthToken()}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load earnings data');
        }

        const data = await response.json();
        
        // Hide loading state
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // Update summary cards
        updateSummaryCards(data.earnings.summary);
        
        // Update order type breakdown
        updateOrderTypeBreakdown(data.earnings.breakdown_by_type);
        
        // Update daily breakdown table
        updateDailyBreakdown(data.earnings.breakdown);
        
        // Update chart
        updateEarningsChart(data.earnings.breakdown);

      } catch (error) {
        console.error('Error loading earnings:', error);
        showNotification('Failed to load earnings data', 'error');
        
        // Hide loading state
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
      }
    }

    function updateSummaryCards(summary) {
      document.getElementById('total-earnings').textContent = `${formatCurrency(summary.total_earnings)} RWF`;
      document.getElementById('total-deliveries').textContent = summary.total_deliveries;
      document.getElementById('average-commission').textContent = `${formatCurrency(summary.average_commission)} RWF`;
      document.getElementById('max-commission').textContent = `${formatCurrency(summary.max_commission)} RWF`;
    }

    function updateOrderTypeBreakdown(breakdownByType) {
      // Grocery orders
      document.getElementById('grocery-earnings').textContent = `${formatCurrency(breakdownByType.grocery.total_earnings)} RWF`;
      document.getElementById('grocery-deliveries').textContent = `${breakdownByType.grocery.total_deliveries} deliveries`;
      
      // Local market orders
      document.getElementById('local-market-earnings').textContent = `${formatCurrency(breakdownByType.local_market.total_earnings)} RWF`;
      document.getElementById('local-market-deliveries').textContent = `${breakdownByType.local_market.total_deliveries} deliveries`;
    }

    function updateDailyBreakdown(breakdown) {
      const tbody = document.getElementById('daily-breakdown');
      tbody.innerHTML = '';

      if (breakdown.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-8 text-gray-500">
              <i class="fas fa-inbox text-4xl mb-2"></i>
              <p>No earnings data for this period</p>
            </td>
          </tr>
        `;
        return;
      }

      breakdown.forEach(day => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gray-50';
        
        const orderTypeBadges = day.order_types.map(type => {
          const color = type === 'grocery' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
          const icon = type === 'grocery' ? 'fas fa-shopping-basket' : 'fas fa-store';
          return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${color}">
            <i class="${icon}"></i> ${type}
          </span>`;
        }).join(' ');

        row.innerHTML = `
          <td class="py-3 px-4">${formatDate(day.date)}</td>
          <td class="py-3 px-4">
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-sm font-medium">
              <i class="fas fa-truck"></i> ${day.deliveries}
            </span>
          </td>
          <td class="py-3 px-4">${orderTypeBadges}</td>
          <td class="py-3 px-4 text-right font-semibold text-green-600">${formatCurrency(day.earnings)} RWF</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function updateEarningsChart(breakdown) {
      const ctx = document.getElementById('earnings-chart').getContext('2d');
      
      // Destroy existing chart
      if (earningsChart) {
        earningsChart.destroy();
      }

      const labels = breakdown.map(day => formatDate(day.date, true));
      const earnings = breakdown.map(day => day.earnings);

      earningsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Daily Earnings (RWF)',
            data: earnings,
            borderColor: 'rgb(16, 185, 129)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgb(16, 185, 129)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatCurrency(value) + ' RWF';
                }
              }
            }
          },
          elements: {
            point: {
              hoverRadius: 8
            }
          }
        }
      });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US').format(Math.round(amount || 0));
    }

    function formatDate(dateString, short = false) {
      const date = new Date(dateString);
      if (short) {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function goBack() {
      window.history.back();
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'success' ? 'bg-green-500 text-white' : 
        'bg-blue-500 text-white'
      }`;
      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove after 5 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Auth utilities (inline to avoid external file errors)
    function getAuthToken() {
      return localStorage.getItem('authToken') || localStorage.getItem('token');
    }
    
    function isAuthenticated() {
      const token = getAuthToken();
      return token && token !== 'null' && token !== 'undefined';
    }
  </script>

</body>
</html>