<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Analytics | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        :root {
            --primary-color: #080b3b;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--accent-color);
        }
        
        .stat-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: scale(1.02);
        }
        
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid var(--accent-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .trend-up {
            color: #10b981;
        }
        
        .trend-down {
            color: #ef4444;
        }
        
        .trend-neutral {
            color: #6b7280;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="escrow-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-lock"></i>
                    <span>Escrow Management</span>
                </a>
                <a href="payment-analytics.html" class="nav-item active flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-line"></i>
                    <span>Payment Analytics</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="analytics.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
            
            <div class="mt-auto pt-6">
                <button onclick="logout()" class="w-full flex items-center space-x-3 p-3 rounded-lg text-white hover:bg-red-500/20 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8 overflow-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">Payment Analytics</h1>
                    <p class="text-gray-300">Comprehensive payment insights and trends</p>
                </div>
                <div class="flex space-x-4">
                    <select id="timeRangeSelect" class="glass-morphism px-4 py-2 rounded-lg text-white bg-transparent border-none">
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                        <option value="1y">Last Year</option>
                    </select>
                    <button onclick="refreshAnalytics()" class="glass-morphism px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="exportReport()" class="glass-morphism px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-morphism p-6 rounded-xl metric-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Total Revenue</p>
                            <p class="text-2xl font-bold text-white" id="totalRevenue">$0.00</p>
                            <div class="flex items-center mt-2">
                                <span id="revenueTrend" class="text-sm"></span>
                            </div>
                        </div>
                        <div class="bg-green-500/20 p-3 rounded-lg">
                            <i class="fas fa-dollar-sign text-green-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="glass-morphism p-6 rounded-xl metric-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Total Transactions</p>
                            <p class="text-2xl font-bold text-white" id="totalTransactions">0</p>
                            <div class="flex items-center mt-2">
                                <span id="transactionsTrend" class="text-sm"></span>
                            </div>
                        </div>
                        <div class="bg-blue-500/20 p-3 rounded-lg">
                            <i class="fas fa-exchange-alt text-blue-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="glass-morphism p-6 rounded-xl metric-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Success Rate</p>
                            <p class="text-2xl font-bold text-white" id="successRate">0%</p>
                            <div class="flex items-center mt-2">
                                <span id="successRateTrend" class="text-sm"></span>
                            </div>
                        </div>
                        <div class="bg-purple-500/20 p-3 rounded-lg">
                            <i class="fas fa-check-circle text-purple-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="glass-morphism p-6 rounded-xl metric-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Avg Transaction</p>
                            <p class="text-2xl font-bold text-white" id="avgTransaction">$0.00</p>
                            <div class="flex items-center mt-2">
                                <span id="avgTransactionTrend" class="text-sm"></span>
                            </div>
                        </div>
                        <div class="bg-yellow-500/20 p-3 rounded-lg">
                            <i class="fas fa-calculator text-yellow-400 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Revenue Trend Chart -->
                <div class="glass-morphism p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-white">Revenue Trend</h3>
                        <div class="flex space-x-2">
                            <button onclick="changeChartType('revenue', 'line')" class="text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button onclick="changeChartType('revenue', 'bar')" class="text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Payment Methods Distribution -->
                <div class="glass-morphism p-6 rounded-xl">
                    <h3 class="text-xl font-semibold text-white mb-4">Payment Methods</h3>
                    <div class="chart-container">
                        <canvas id="paymentMethodsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Transaction Status Distribution -->
                <div class="glass-morphism p-6 rounded-xl">
                    <h3 class="text-xl font-semibold text-white mb-4">Transaction Status</h3>
                    <div class="chart-container">
                        <canvas id="transactionStatusChart"></canvas>
                    </div>
                </div>

                <!-- Hourly Transaction Volume -->
                <div class="glass-morphism p-6 rounded-xl">
                    <h3 class="text-xl font-semibold text-white mb-4">Hourly Volume</h3>
                    <div class="chart-container">
                        <canvas id="hourlyVolumeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Payment Method Performance -->
            <div class="glass-morphism p-6 rounded-xl mb-8">
                <h3 class="text-xl font-semibold text-white mb-6">Payment Method Performance</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-black/20">
                            <tr>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Payment Method</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Transactions</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Volume</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Success Rate</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Avg Amount</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Trend</th>
                            </tr>
                        </thead>
                        <tbody id="paymentMethodsTable" class="divide-y divide-white/10">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Failed Transactions -->
            <div class="glass-morphism p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-white">Recent Failed Transactions</h3>
                    <button onclick="viewAllFailedTransactions()" class="text-blue-400 hover:text-blue-300 transition-colors">
                        View All <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-black/20">
                            <tr>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Transaction ID</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">User</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Amount</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Method</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Error</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Time</th>
                                <th class="px-6 py-4 text-left text-gray-300 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="failedTransactionsTable" class="divide-y divide-white/10">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="glass-morphism p-8 rounded-xl text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white">Loading analytics data...</p>
        </div>
    </div>

    <script>
        let charts = {};
        let currentTimeRange = '30d';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadAnalyticsData();
        });

        function setupEventListeners() {
            document.getElementById('timeRangeSelect').addEventListener('change', function() {
                currentTimeRange = this.value;
                loadAnalyticsData();
            });
        }

        async function loadAnalyticsData() {
            try {
                showLoading();
                
                const response = await fetch(`/api/admin/payment-analytics?timeRange=${currentTimeRange}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load analytics data');
                }

                const data = await response.json();
                
                if (data.success) {
                    updateMetrics(data.metrics);
                    updateCharts(data.charts);
                    updatePaymentMethodsTable(data.paymentMethods);
                    updateFailedTransactionsTable(data.failedTransactions);
                } else {
                    throw new Error(data.message || 'Failed to load analytics data');
                }
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showError('Failed to load analytics data: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function updateMetrics(metrics) {
            if (!metrics) return;

            // Update metric values
            document.getElementById('totalRevenue').textContent = formatCurrency(metrics.totalRevenue || 0);
            document.getElementById('totalTransactions').textContent = formatNumber(metrics.totalTransactions || 0);
            document.getElementById('successRate').textContent = formatPercentage(metrics.successRate || 0);
            document.getElementById('avgTransaction').textContent = formatCurrency(metrics.avgTransaction || 0);

            // Update trends
            updateTrend('revenueTrend', metrics.revenueTrend);
            updateTrend('transactionsTrend', metrics.transactionsTrend);
            updateTrend('successRateTrend', metrics.successRateTrend);
            updateTrend('avgTransactionTrend', metrics.avgTransactionTrend);
        }

        function updateTrend(elementId, trend) {
            const element = document.getElementById(elementId);
            if (!trend) return;

            const isPositive = trend.change > 0;
            const isNegative = trend.change < 0;
            
            element.className = `text-sm ${isPositive ? 'trend-up' : isNegative ? 'trend-down' : 'trend-neutral'}`;
            element.innerHTML = `
                <i class="fas fa-arrow-${isPositive ? 'up' : isNegative ? 'down' : 'right'} mr-1"></i>
                ${Math.abs(trend.change).toFixed(1)}% vs ${trend.period}
            `;
        }

        function updateCharts(chartData) {
            if (!chartData) return;

            // Revenue Trend Chart
            updateRevenueChart(chartData.revenue);
            
            // Payment Methods Chart
            updatePaymentMethodsChart(chartData.paymentMethods);
            
            // Transaction Status Chart
            updateTransactionStatusChart(chartData.transactionStatus);
            
            // Hourly Volume Chart
            updateHourlyVolumeChart(chartData.hourlyVolume);
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Revenue',
                        data: data.values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updatePaymentMethodsChart(data) {
            const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
            
            if (charts.paymentMethods) {
                charts.paymentMethods.destroy();
            }

            charts.paymentMethods = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6',
                            '#06b6d4'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function updateTransactionStatusChart(data) {
            const ctx = document.getElementById('transactionStatusChart').getContext('2d');
            
            if (charts.transactionStatus) {
                charts.transactionStatus.destroy();
            }

            charts.transactionStatus = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            '#10b981', // Success
                            '#ef4444', // Failed
                            '#f59e0b', // Pending
                            '#6b7280'  // Cancelled
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function updateHourlyVolumeChart(data) {
            const ctx = document.getElementById('hourlyVolumeChart').getContext('2d');
            
            if (charts.hourlyVolume) {
                charts.hourlyVolume.destroy();
            }

            charts.hourlyVolume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Transactions',
                        data: data.values,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updatePaymentMethodsTable(methods) {
            const tbody = document.getElementById('paymentMethodsTable');
            
            if (!methods || methods.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No payment method data available</td></tr>';
                return;
            }

            tbody.innerHTML = methods.map(method => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <i class="fas fa-${getPaymentMethodIcon(method.name)} mr-3 text-blue-400"></i>
                            <span class="text-white font-medium">${method.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-white">${formatNumber(method.transactions)}</td>
                    <td class="px-6 py-4 text-white">${formatCurrency(method.volume)}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-700 rounded-full h-2 mr-3">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${method.successRate}%"></div>
                            </div>
                            <span class="text-white">${method.successRate.toFixed(1)}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-white">${formatCurrency(method.avgAmount)}</td>
                    <td class="px-6 py-4">
                        <span class="text-sm ${method.trend > 0 ? 'trend-up' : method.trend < 0 ? 'trend-down' : 'trend-neutral'}">
                            <i class="fas fa-arrow-${method.trend > 0 ? 'up' : method.trend < 0 ? 'down' : 'right'} mr-1"></i>
                            ${Math.abs(method.trend).toFixed(1)}%
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateFailedTransactionsTable(transactions) {
            const tbody = document.getElementById('failedTransactionsTable');
            
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-400">No failed transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(transaction => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <span class="text-white font-mono">${transaction.id}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-white">${transaction.user_name}</div>
                        <div class="text-gray-400 text-sm">${transaction.user_email}</div>
                    </td>
                    <td class="px-6 py-4 text-white">${formatCurrency(transaction.amount)}</td>
                    <td class="px-6 py-4">
                        <span class="text-gray-300">${transaction.payment_method}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-red-400 text-sm">${transaction.error_message}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-white">${formatDate(transaction.created_at)}</div>
                        <div class="text-gray-400 text-sm">${formatTime(transaction.created_at)}</div>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="retryTransaction('${transaction.id}')" class="text-blue-400 hover:text-blue-300 transition-colors mr-2" title="Retry Transaction">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button onclick="viewTransactionDetails('${transaction.id}')" class="text-gray-400 hover:text-gray-300 transition-colors" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getPaymentMethodIcon(method) {
            const icons = {
                'Credit Card': 'credit-card',
                'Debit Card': 'credit-card',
                'PayPal': 'paypal',
                'Bank Transfer': 'university',
                'Mobile Money': 'mobile-alt',
                'Cash': 'money-bill-wave'
            };
            return icons[method] || 'credit-card';
        }

        function changeChartType(chartName, type) {
            if (charts[chartName]) {
                charts[chartName].config.type = type;
                charts[chartName].update();
            }
        }

        function refreshAnalytics() {
            loadAnalyticsData();
        }

        async function exportReport() {
            try {
                const response = await fetch(`/api/admin/payment-analytics/export?timeRange=${currentTimeRange}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `payment-analytics-${currentTimeRange}-${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showSuccess('Report exported successfully');
                } else {
                    throw new Error('Failed to export report');
                }
                
            } catch (error) {
                console.error('Error exporting report:', error);
                showError('Failed to export report: ' + error.message);
            }
        }

        function viewAllFailedTransactions() {
            window.location.href = 'failed-transactions.html';
        }

        async function retryTransaction(transactionId) {
            try {
                const response = await fetch(`/api/admin/transactions/${transactionId}/retry`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Transaction retry initiated');
                    loadAnalyticsData(); // Refresh data
                } else {
                    throw new Error(data.message || 'Failed to retry transaction');
                }
                
            } catch (error) {
                console.error('Error retrying transaction:', error);
                showError('Failed to retry transaction: ' + error.message);
            }
        }

        function viewTransactionDetails(transactionId) {
            window.open(`transaction-details.html?id=${transactionId}`, '_blank');
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('en-US').format(number);
        }

        function formatPercentage(percentage) {
            return percentage.toFixed(1) + '%';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString();
        }

        function showSuccess(message) {
            // Implementation depends on your notification system
            console.log('Success:', message);
        }

        function showError(message) {
            // Implementation depends on your notification system
            console.error('Error:', message);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/auth/auth-admin.html';
        }
    </script>
</body>
</html>