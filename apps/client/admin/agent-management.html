<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Management | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <!-- Add AdminAPI class directly -->
    <script>
        // AdminAPI class for backend communication
        class AdminAPI {
            constructor() {
                this.baseUrl = window.location.origin;
            }

            getAuthToken() {
                return localStorage.getItem('adminToken') || 
                       localStorage.getItem('token') || 
                       localStorage.getItem('authToken');
            }

            async request(endpoint, options = {}) {
                const token = this.getAuthToken();
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const url = endpoint.startsWith('http') ? endpoint : this.baseUrl + endpoint;
                const config = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    },
                    ...options
                };

                const response = await fetch(url, config);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired or invalid
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('token');
                        localStorage.removeItem('authToken');
                        window.location.href = '/auth/auth-admin.html';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            }
        }

        // Initialize AdminAPI
        window.adminAPI = new AdminAPI();

        // Utility functions
        function showLoading(show) {
            const loadingState = document.getElementById('loading-state');
            if (loadingState) {
                loadingState.style.display = show ? 'block' : 'none';
            }
        }

        function showError(message) {
            console.error('Error:', message);
            showNotification(message, 'error');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full`;
            
            // Set background color based on type
            const bgColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.classList.add(bgColors[type] || bgColors.info);
            notification.innerHTML = `
                <div class="flex items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to DOM
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            localStorage.removeItem('userData');
            window.location.href = '/auth/auth-admin.html';
        }
    </script>
    <style>
        :root {
            --primary-color: #080b3b;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            backdrop-filter: blur(10px);
        }
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #3b82f6;
            outline: none;
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .stat-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
    
        
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="payment-credentials.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-wallet"></i>
                    <span>Payment Credentials</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agent-management.html" class="nav-item active flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
    
    <!-- Main Content -->
    <div class="flex-1 p-8 overflow-auto">
        
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Agent Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="notificationBtn" class="p-2 text-gray-400 hover:text-gray-500" onclick="showNotification('Feature in development', 'info')">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button class="tab-button active py-2 px-1 border-b-2 border-transparent font-medium text-sm" data-tab="pending-registrations" onclick="switchTab('pending-registrations')">
                    <i class="fas fa-user-clock mr-2"></i>Pending Registrations
                    <span id="pendingCount" class="ml-2 bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
                </button>
                <button class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="create-agent" onclick="switchTab('create-agent')">
                    <i class="fas fa-user-plus mr-2"></i>Create Agent
                </button>
                <button class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="agent-types" onclick="switchTab('agent-types')">
                    <i class="fas fa-cogs mr-2"></i>Agent Types Configuration
                </button>
                <button class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="commission-rules" onclick="switchTab('commission-rules')">
                    <i class="fas fa-percentage mr-2"></i>Commission Rules
                </button>
                <button class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="training-modules" onclick="switchTab('training-modules')">
                    <i class="fas fa-graduation-cap mr-2"></i>Training Modules
                </button>
                <button class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="agent-performance" onclick="switchTab('agent-performance')">
                    <i class="fas fa-chart-line mr-2"></i>Performance Analytics
                </button>
            </nav>
        </div>

        <!-- Pending Registrations Tab -->
        <div id="pending-registrations" class="tab-content active">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Pending Agent Registrations</h3>
                    <p class="mt-1 text-sm text-gray-500">Review and approve new agent applications</p>
                </div>
                
                <!-- Filters -->
                <div class="px-6 py-4 bg-gray-50 border-b">
                    <div class="flex flex-wrap gap-4">
                        <select id="statusFilter" class="rounded-md border-gray-300 text-sm">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="under_review">Under Review</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <select id="agentTypeFilter" class="rounded-md border-gray-300 text-sm">
                            <option value="">All Agent Types</option>
                            <option value="fast_delivery">Fast Delivery</option>
                            <option value="pickup_delivery">Pickup Delivery</option>
                            <option value="pickup_site">Pickup Site Manager</option>
                        </select>
                        <input type="date" id="dateFilter" class="rounded-md border-gray-300 text-sm" placeholder="Filter by date">
                        <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                            Apply Filters
                        </button>
                    </div>
                </div>

                <!-- Registrations Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="registrationsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create Agent Tab -->
        <div id="create-agent" class="tab-content">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Create New Agent</h3>
                        <p class="mt-1 text-sm text-gray-500">Create and configure a new agent account with specific type and permissions</p>
                    </div>
                </div>

                <div class="p-6">
                    <form id="createAgentForm" class="space-y-6" method="POST" action="#">
                        <!-- Basic Information -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Basic Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="firstName" class="block text-sm font-medium text-gray-700">First Name *</label>
                                    <input type="text" id="firstName" name="first_name" required pattern="[A-Za-z\s]{2,50}" title="Name must be 2-50 characters, letters and spaces only" 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name *</label>
                                    <input type="text" id="lastName" name="last_name" required pattern="[A-Za-z\s]{2,50}" title="Name must be 2-50 characters, letters and spaces only" 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address *</label>
                                    <input type="email" id="email" name="email" required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" title="Please enter a valid email address" 
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number *</label>
                                    <input type="tel" id="phone" name="phone" required pattern="[+]?[0-9]{10,15}" title="Please enter a valid phone number (10-15 digits)" placeholder="+250788910639"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="password" class="block text-sm font-medium text-gray-700">Password *</label>
                                    <input type="password" id="password" name="password" required pattern=".{8,}" title="Password must be at least 8 characters long" minlength="8"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <p class="mt-1 text-xs text-gray-500">Minimum 8 characters</p>
                                </div>
                                <div>
                                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password *</label>
                                    <input type="password" id="confirmPassword" name="confirm_password" required pattern=".{8,}" title="Password must be at least 8 characters long" minlength="8"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Agent Type Selection -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Agent Type Selection *</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="agent-type-option" data-type="fast_delivery">
                                    <input type="radio" id="fastDelivery" name="agent_type" value="fast_delivery" class="sr-only">
                                    <label for="fastDelivery" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 transition-colors">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-motorcycle text-green-500 text-2xl"></i>
                                        </div>
                                        <h5 class="font-medium text-center text-gray-900">Fast Delivery Agent</h5>
                                        <p class="text-sm text-gray-600 text-center mt-1">Grocery & Local Market Delivery</p>
                                    </label>
                                </div>
                                <div class="agent-type-option" data-type="pickup_delivery">
                                    <input type="radio" id="pickupDelivery" name="agent_type" value="pickup_delivery" class="sr-only">
                                    <label for="pickupDelivery" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 transition-colors">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-truck text-blue-500 text-2xl"></i>
                                        </div>
                                        <h5 class="font-medium text-center text-gray-900">Pickup Delivery Agent</h5>
                                        <p class="text-sm text-gray-600 text-center mt-1">Physical Products Collection & Delivery</p>
                                    </label>
                                </div>
                                <div class="agent-type-option" data-type="pickup_site_manager">
                                    <input type="radio" id="siteManager" name="agent_type" value="pickup_site_manager" class="sr-only">
                                    <label for="siteManager" class="block p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 transition-colors">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-store text-purple-500 text-2xl"></i>
                                        </div>
                                        <h5 class="font-medium text-center text-gray-900">Pickup Site Manager</h5>
                                        <p class="text-sm text-gray-600 text-center mt-1">Smart Assistant & Community Agent</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Type-Specific Configuration -->
                        <div id="typeSpecificConfig" class="bg-yellow-50 p-4 rounded-lg hidden">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Type-Specific Configuration</h4>
                            
                            <!-- Fast Delivery Config -->
                            <div id="fastDeliveryConfig" class="type-config hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="workZone" class="block text-sm font-medium text-gray-700">Work Zone</label>
                                        <input type="text" id="workZone" name="work_zone" placeholder="e.g., Kigali City Center"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="maxDistance" class="block text-sm font-medium text-gray-700">Max Delivery Distance (km)</label>
                                        <input type="number" id="maxDistance" name="max_delivery_distance" min="1" max="50" value="10"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Available Days</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="monday" checked class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Monday</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="tuesday" checked class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Tuesday</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="wednesday" checked class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Wednesday</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="thursday" checked class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Thursday</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="friday" checked class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Friday</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="saturday" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Saturday</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" name="available_days" value="sunday" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                            <span class="ml-2 text-sm text-gray-700">Sunday</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Pickup Delivery Config -->
                            <div id="pickupDeliveryConfig" class="type-config hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="maxOrders" class="block text-sm font-medium text-gray-700">Max Orders Per Trip</label>
                                        <input type="number" id="maxOrders" name="max_orders_per_trip" min="1" max="20" value="5"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>

                            <!-- Site Manager Config -->
                            <div id="siteManagerConfig" class="type-config hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="siteName" class="block text-sm font-medium text-gray-700">Site Name</label>
                                        <input type="text" id="siteName" name="site_name" placeholder="e.g., Kigali Central Pickup Point"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="siteType" class="block text-sm font-medium text-gray-700">Site Type</label>
                                        <select id="siteType" name="site_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                            <option value="pickup_point">Pickup Point</option>
                                            <option value="service_center">Service Center</option>
                                            <option value="community_hub">Community Hub</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="siteAddress" class="block text-sm font-medium text-gray-700">Site Address</label>
                                        <textarea id="siteAddress" name="site_address" rows="2" placeholder="Full address of the pickup site"
                                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div>
                                        <label for="siteCapacity" class="block text-sm font-medium text-gray-700">Site Capacity (packages/day)</label>
                                        <input type="number" id="siteCapacity" name="site_capacity" min="10" max="1000" value="50"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Information -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Location Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="district" class="block text-sm font-medium text-gray-700">District</label>
                                    <select id="district" name="district" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">Select District</option>
                                        <option value="Gasabo">Gasabo</option>
                                        <option value="Kicukiro">Kicukiro</option>
                                        <option value="Nyarugenge">Nyarugenge</option>
                                        <option value="Bugesera">Bugesera</option>
                                        <option value="Gatsibo">Gatsibo</option>
                                        <option value="Kayonza">Kayonza</option>
                                        <option value="Kirehe">Kirehe</option>
                                        <option value="Ngoma">Ngoma</option>
                                        <option value="Nyagatare">Nyagatare</option>
                                        <option value="Rwamagana">Rwamagana</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                                    <input type="number" id="latitude" name="latitude" step="0.000001" placeholder="-1.9441"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                                    <input type="number" id="longitude" name="longitude" step="0.000001" placeholder="30.0619"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                            <button type="button" onclick="resetCreateAgentForm()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Reset Form
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-user-plus mr-2"></i>Create Agent
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Agent Types Configuration Tab -->
        <div id="agent-types" class="tab-content">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Agent Types Configuration</h3>
                        <p class="mt-1 text-sm text-gray-500">Manage agent types, commission rates, and requirements</p>
                    </div>
                    <button onclick="openAgentTypeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Agent Type
                    </button>
                </div>

                <div id="agentTypesContainer" class="p-6">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Commission Rules Tab -->
        <div id="commission-rules" class="tab-content">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Commission Rules</h3>
                        <p class="mt-1 text-sm text-gray-500">Configure commission rates and bonus structures</p>
                    </div>
                    <button onclick="openCommissionRuleModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Commission Rule
                    </button>
                </div>

                <div id="commissionRulesContainer" class="p-6">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Training Modules Tab -->
        <div id="training-modules" class="tab-content">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Training Modules</h3>
                        <p class="mt-1 text-sm text-gray-500">Manage training requirements for each agent type</p>
                    </div>
                    <button onclick="openTrainingModuleModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Training Module
                    </button>
                </div>

                <div id="trainingModulesContainer" class="p-6">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Performance Analytics Tab -->
        <div id="agent-performance" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Performance Overview -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Performance Overview</h3>
                    <div id="performanceOverview">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Top Performers</h3>
                    <div id="topPerformers">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Registration Review Modal -->
    <div id="registrationModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Agent Registration Review</h3>
                <button onclick="closeRegistrationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="registrationModalContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Agent Type Configuration Modal -->
    <div id="agentTypeModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Agent Type Configuration</h3>
                <button onclick="closeAgentTypeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="agentTypeForm" class="space-y-4" method="POST" action="#">
                <input type="hidden" id="agentTypeId" name="id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type Code</label>
                        <input type="text" id="typeCode" name="type_code" required pattern=".{1,}" title="This field is required"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type Name</label>
                        <input type="text" id="typeName" name="type_name" required pattern="[A-Za-z\s]{2,50}" title="Name must be 2-50 characters, letters and spaces only"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="typeDescription" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Commission Rate (%)</label>
                        <input type="number" id="commissionRate" name="commission_rate" step="0.01" min="0" max="100" required pattern=".{1,}" title="This field is required"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Marketplace Type</label>
                        <select id="marketplaceType" name="marketplace_type" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="grocery">Grocery</option>
                            <option value="physical">Physical</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Requirements (JSON)</label>
                    <textarea id="requirements" name="requirements" rows="4" placeholder='{"vehicle": true, "smartphone": true}'
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Benefits (JSON)</label>
                    <textarea id="benefits" name="benefits" rows="4" placeholder='{"features": ["Feature 1", "Feature 2"]}'
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="isActive" name="is_active" class="mr-2">
                    <label for="isActive" class="text-sm font-medium text-gray-700">Active</label>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAgentTypeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                        Save Agent Type
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentRegistrations = [];
        let currentAgentTypes = [];
        let currentCommissionRules = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Agent Management page initializing...');
            
            // Check authentication first
            checkAuthentication();
            
            // Load data and setup
            setupTabNavigation();
            loadPendingRegistrations();
            loadNotifications();
        });

        // Check authentication and prevent redirect loops
        function checkAuthentication() {
            const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
            const userRole = localStorage.getItem('userRole');
            
            if (!token) {
                console.log('❌ No authentication token found, redirecting to login');
                window.location.href = '/auth/login.html';
                return false;
            }
            
            if (userRole !== 'admin') {
                console.log('❌ Insufficient permissions, user role:', userRole);
                showNotification('Access denied. Admin privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/login.html';
                }, 2000);
                return false;
            }
            
            console.log('✅ Authentication verified for admin user');
            return true;
        }
        // Setup tab navigation
        function setupTabNavigation() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update button states
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update content visibility
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load tab-specific data
                    loadTabData(tabId);
                });
            });
        }
        // Load tab-specific data
        function loadTabData(tabId) {
            switch(tabId) {
                case 'pending-registrations':
                    loadPendingRegistrations();
                    break;
                case 'create-agent':
                    setupCreateAgentForm();
                    break;
                case 'agent-types':
                    loadAgentTypes();
                    break;
                case 'commission-rules':
                    loadCommissionRules();
                    break;
                case 'training-modules':
                    loadTrainingModules();
                    break;
                case 'agent-performance':
                    loadPerformanceAnalytics();
                    break;
            }
        }
        // Load pending registrations
        async function loadPendingRegistrations() {
            try {
                showLoading(true);
                const response = await adminAPI.request('/api/admin/agent-registrations');
                
                if (response.success) {
                    currentRegistrations = response.data;
                    displayRegistrations(currentRegistrations);
                    updatePendingCount();
                    showNotification('Agent registrations loaded successfully', 'success');
                } else {
                    throw new Error(response.message || 'Failed to load registrations');
                }
            } catch (error) {
                console.error('Error loading registrations:', error);
                showError('Failed to load agent registrations: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        // Display registrations in table
        function displayRegistrations(registrations) {
            const tbody = document.getElementById('registrationsTableBody');
            
            if (registrations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No registrations found
                        </td>
                    </tr>
                `;
                return;
            }
            tbody.innerHTML = registrations.map(registration => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                    <i class="fas fa-user text-gray-600"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">
                                    ${registration.first_name} ${registration.last_name}
                                </div>
                                <div class="text-sm text-gray-500">${registration.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${registration.agent_type.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge status-${registration.verification_status}">
                            ${registration.verification_status.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(registration.submitted_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="reviewRegistration(${registration.id})" 
                                class="text-blue-600 hover:text-blue-900 mr-3">
                            Review
                        </button>
                        ${registration.verification_status === 'pending' ? `
                            <button onclick="quickApprove(${registration.id})" 
                                    class="text-green-600 hover:text-green-900 mr-3">
                                Quick Approve
                            </button>
                            <button onclick="quickReject(${registration.id})" 
                                    class="text-red-600 hover:text-red-900">
                                Reject
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        // Update pending count
        function updatePendingCount() {
            const pendingCount = currentRegistrations.filter(r => r.verification_status === 'pending').length;
            document.getElementById('pendingCount').textContent = pendingCount;
        }
        // Review registration
        async function reviewRegistration(registrationId) {
            try {
                const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/admin/agent-registration/${registrationId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
        console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                    showNotification(error.message || 'An error occurred. Please try again.', 'error');
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                alert('Error loading registration details');
            }
        }
        // Display registration modal
        function displayRegistrationModal(registration) {
            const modal = document.getElementById('registrationModal');
            const content = document.getElementById('registrationModalContent');
            
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Personal Information -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-900">Personal Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><strong>Name:</strong> ${registration.first_name} ${registration.last_name}</p>
                            <p><strong>Email:</strong> ${registration.email}</p>
                            <p><strong>Phone:</strong> ${registration.phone}</p>
                            <p><strong>Date of Birth:</strong> ${registration.date_of_birth || 'N/A'}</p>
                            <p><strong>Gender:</strong> ${registration.gender || 'N/A'}</p>
                            <p><strong>Emergency Contact:</strong> ${registration.emergency_contact || 'N/A'}</p>
                        </div>
                        
                        <h4 class="text-md font-semibold text-gray-900">Address</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><strong>Street:</strong> ${registration.street_address || 'N/A'}</p>
                            <p><strong>City:</strong> ${registration.city || 'N/A'}</p>
                            <p><strong>State:</strong> ${registration.state || 'N/A'}</p>
                            <p><strong>Country:</strong> ${registration.country || 'N/A'}</p>
                            <p><strong>Coordinates:</strong> ${registration.latitude || 'N/A'}, ${registration.longitude || 'N/A'}</p>
                        </div>
                        
                        <h4 class="text-md font-semibold text-gray-900">Banking Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><strong>Bank:</strong> ${registration.bank_name || 'N/A'}</p>
                            <p><strong>Account Number:</strong> ${registration.account_number || 'N/A'}</p>
                            <p><strong>Account Holder:</strong> ${registration.account_holder || 'N/A'}</p>
                            <p><strong>Mobile Money:</strong> ${registration.mobile_money || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <!-- Documents -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-900">Uploaded Documents</h4>
                        
                        ${registration.profile_photo ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-medium mb-2">Profile Photo</h5>
                                <img src="/uploads/agent-verification/${registration.profile_photo}" 
                                     alt="Profile Photo" class="document-preview">
                            </div>
                        ` : ''}
                        ${registration.id_front ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-medium mb-2">ID Document (Front)</h5>
                                <img src="/uploads/agent-verification/${registration.id_front}" 
                                     alt="ID Front" class="document-preview">
                            </div>
                        ` : ''}
                        ${registration.id_back ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-medium mb-2">ID Document (Back)</h5>
                                <img src="/uploads/agent-verification/${registration.id_back}" 
                                     alt="ID Back" class="document-preview">
                            </div>
                        ` : ''}
                        ${registration.vehicle_registration ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-medium mb-2">Vehicle Registration</h5>
                                <img src="/uploads/agent-verification/${registration.vehicle_registration}" 
                                     alt="Vehicle Registration" class="document-preview">
                            </div>
                        ` : ''}
                        ${registration.drivers_license ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-medium mb-2">Driver's License</h5>
                                <img src="/uploads/agent-verification/${registration.drivers_license}" 
                                     alt="Driver's License" class="document-preview">
                            </div>
                        ` : ''}
                        ${registration.business_license ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h5 class="font-medium mb-2">Business License</h5>
                                <img src="/uploads/agent-verification/${registration.business_license}" 
                                     alt="Business License" class="document-preview">
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Admin Actions -->
                <div class="mt-6 border-t pt-6">
                    <h4 class="text-md font-semibold text-gray-900 mb-4">Admin Actions</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes</label>
                            <textarea id="adminNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                      placeholder="Add notes about this registration...">${registration.admin_notes || ''}</textarea>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="updateRegistrationStatus(${registration.id}, 'approved')" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Approve
                            </button>
                            <button onclick="updateRegistrationStatus(${registration.id}, 'rejected')" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                <i class="fas fa-times mr-2"></i>Reject
                            </button>
                            <button onclick="updateRegistrationStatus(${registration.id}, 'requires_resubmission')" 
                                    class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700">
                                <i class="fas fa-redo mr-2"></i>Request Resubmission
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        // Update registration status
        async function updateRegistrationStatus(registrationId, status) {
            const adminNotes = document.getElementById('adminNotes').value;
            
            try {
                const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/admin/agent-registration/${registrationId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
        console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed.Please try again.', 'error');
                    throw error;
                }}`
                    },
                    body: JSON.stringify({
                        status: status,
                        admin_notes: adminNotes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Registration ${status} successfully`);
                    closeRegistrationModal();
                    loadPendingRegistrations();
                } else {
                    alert('Failed to update registration status');
                } catch (error) {
        console.error('Error updating registration status:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                alert('Error updating registration status');
            }
        }
        // Close registration modal
        function closeRegistrationModal() {
            document.getElementById('registrationModal').classList.remove('active');
        }
        // Load agent types
        async function loadAgentTypes() {
            try {
                const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/admin/agent-types', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
        console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                    showNotification(error.message || 'Unknown error' && stack: result.error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        result.error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                } catch (error) {
        console.error('Error loading agent types:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
            }
        }
        // Display agent types
        function displayAgentTypes(agentTypes) {
            const container = document.getElementById('agentTypesContainer');
            
            container.innerHTML = agentTypes.map(agentType => `
                <div class="border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${agentType.type_name}</h4>
                            <p class="text-gray-600 mt-1">${agentType.description}</p>
                            
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Commission Rate</span>
                                    <p class="text-lg font-semibold text-green-600">${agentType.commission_rate}%</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Marketplace</span>
                                    <p class="text-sm text-gray-900">${agentType.marketplace_type}</p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Status</span>
                                    <p class="text-sm ${agentType.is_active ? 'text-green-600' : 'text-red-600'}">
                                        ${agentType.is_active ? 'Active' : 'Inactive'}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="editAgentType(${agentType.id})" 
                                    class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleAgentTypeStatus(${agentType.id}, ${!agentType.is_active})" 
                                    class="text-${agentType.is_active ? 'red' : 'green'}-600 hover:text-${agentType.is_active ? 'red' : 'green'}-900">
                                <i class="fas fa-${agentType.is_active ? 'pause' : 'play'}"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        // Open agent type modal
        function openAgentTypeModal(agentType = null) {
            const modal = document.getElementById('agentTypeModal');
            const form = document.getElementById('agentTypeForm');
            
            if (agentType) {
                // Edit mode
                document.getElementById('agentTypeId').value = agentType.id;
                document.getElementById('typeCode').value = agentType.type_code;
                document.getElementById('typeName').value = agentType.type_name;
                document.getElementById('typeDescription').value = agentType.description;
                document.getElementById('commissionRate').value = agentType.commission_rate;
                document.getElementById('marketplaceType').value = agentType.marketplace_type;
                document.getElementById('requirements').value = JSON.stringify(agentType.requirements && null, 2);
                document.getElementById('benefits').value = JSON.stringify(agentType.benefits, null, 2);
                document.getElementById('isActive').checked = agentType.is_active;
            } else {
                // Add mode
                form.reset();
                document.getElementById('isActive').checked = true;
            }
            modal.classList.add('active');
        }
        // Close agent type modal
        function closeAgentTypeModal() {
            document.getElementById('agentTypeModal').classList.remove('active');
        }
        // Load notifications
        async function loadNotifications() {
            try {
                const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/admin/notifications', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
        console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                    showNotification(error.message || 'An error occurred. Please try again.', 'error');
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
            }
        }
        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const agentTypeFilter = document.getElementById('agentTypeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filteredRegistrations = [...currentRegistrations];
            
            if (statusFilter) {
                filteredRegistrations = filteredRegistrations.filter(r => r.verification_status === statusFilter);
            }
            if (agentTypeFilter) {
                filteredRegistrations = filteredRegistrations.filter(r => r.agent_type === agentTypeFilter);
            }
            if (dateFilter) {
                filteredRegistrations = filteredRegistrations.filter(r => 
                    new Date(r.submitted_at).toDateString() === new Date(dateFilter).toDateString()
                );
            }
            displayRegistrations(filteredRegistrations);
        }
        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/auth/auth-admin.html';
        }
        // Placeholder functions for other features
        function loadCommissionRules() {
            console.log('Loading commission rules...');
        }
        function loadTrainingModules() {
            console.log('Loading training modules...');
        }
        function loadPerformanceAnalytics() {
            console.log('Loading performance analytics...');
        }
        function quickApprove(id) {
            updateRegistrationStatus(id && 'approved');
        }
        function quickReject(id) {
            if (confirm('Are you sure you want to reject this registration?')) {
                updateRegistrationStatus(id && 'rejected');
            }
        }
        function editAgentType(id) {
            const agentType = currentAgentTypes.find(at => at.id === id);
            if (agentType) {
                openAgentTypeModal(agentType);
            }
        }
        function toggleAgentTypeStatus(id && newStatus) {
            console.log(`Toggle agent type ${id} to ${newStatus}`);
        }
        function openCommissionRuleModal() {
            console.log('Open commission rule modal');
        }
        function openTrainingModuleModal() {
            console.log('Open training module modal');
        }
        // ===== CREATE AGENT FUNCTIONALITY =====

        // Setup create agent form
        function setupCreateAgentForm() {
            console.log('Setting up create agent form...');
            
            // Setup agent type selection
            setupAgentTypeSelection();
            
            // Setup form submission
            const form = document.getElementById('createAgentForm');
            if (form) {
                form.addEventListener('submit' && handleCreateAgentSubmit);
            }
            // Setup password confirmation validation
            const password = document.getElementById('password');
            const confirmPassword = document.getElementById('confirmPassword');
            
            if (password && confirmPassword) {
                confirmPassword.addEventListener('input' && function() {
                    if (this.value !== password.value) {
                        this.setCustomValidity('Passwords do not match');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }
        }
        // Setup agent type selection
        function setupAgentTypeSelection() {
            const agentTypeOptions = document.querySelectorAll('.agent-type-option');
            const typeSpecificConfig = document.getElementById('typeSpecificConfig');
            
            agentTypeOptions.forEach(option => {
                option.addEventListener('click' && function() {
                    const agentType = this.dataset.type;
                    const radioInput = this.querySelector('input[type="radio"]');
                    
                    // Update visual selection
                    agentTypeOptions.forEach(opt => {
                        opt.querySelector('label').classList.remove('border-blue-500', 'bg-blue-50');
                        opt.querySelector('label').classList.add('border-gray-200');
                    });
                    
                    this.querySelector('label').classList.remove('border-gray-200');
                    this.querySelector('label').classList.add('border-blue-500', 'bg-blue-50');
                    
                    // Check the radio button
                    radioInput.checked = true;
                    
                    // Show type-specific configuration
                    showTypeSpecificConfig(agentType);
                });
            });
        }
        // Show type-specific configuration
        function showTypeSpecificConfig(agentType) {
            const typeSpecificConfig = document.getElementById('typeSpecificConfig');
            const allConfigs = document.querySelectorAll('.type-config');
            
            // Hide all configs
            allConfigs.forEach(config => config.classList.add('hidden'));
            
            // Show the selected config
            const selectedConfig = document.getElementById(`${agentType}Config`);
            if (selectedConfig) {
                selectedConfig.classList.remove('hidden');
                typeSpecificConfig.classList.remove('hidden');
            } else {
                typeSpecificConfig.classList.add('hidden');
            }
        }
        // Handle create agent form submission
        async function handleCreateAgentSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Disable submit button
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Agent...';
            
            try {
                // Collect form data
                const agentData = {
                    first_name: formData.get('first_name') && last_name: formData.get('last_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    password: formData.get('password'),
                    agent_type: formData.get('agent_type'),
                    district: formData.get('district'),
                    latitude: formData.get('latitude') || null,
                    longitude: formData.get('longitude') || null
                };

                // Add type-specific data
                const agentType = agentData.agent_type;
                if (agentType === 'fast_delivery') {
                    agentData.work_zone = formData.get('work_zone');
                    agentData.max_delivery_distance = formData.get('max_delivery_distance');
                    
                    // Collect available days
                    const availableDays = [];
                    formData.getAll('available_days').forEach(day => {
                        availableDays.push(day);
                    });
                    agentData.available_days = availableDays;
                    
                } else if (agentType === 'pickup_delivery') {
                    agentData.max_orders_per_trip = formData.get('max_orders_per_trip');
                    
                } else if (agentType === 'pickup_site_manager') {
                    agentData.site_name = formData.get('site_name');
                    agentData.site_type = formData.get('site_type');
                    agentData.site_address = formData.get('site_address');
                    agentData.site_capacity = formData.get('site_capacity');
                }
                console.log('Creating agent with data:' && agentData);

                // Submit to API
                const response = await fetch('${API_BASE_URL}/admin/create-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(agentData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Agent created successfully!' && 'success');
                    console.log('Agent created:', result.agent);
                    
                    // Reset form
                    resetCreateAgentForm();
                    
                    // Optionally switch to pending registrations tab to see the new agent
                    // switchToTab('pending-registrations');
                    
                } else {
                    showNotification(result.error || 'Failed to create agent', 'error');
                    console.error('Failed to create agent:', result);
                
                // Enhanced error reporting
                if (result) {
                    const errorDetails = {
                    message: error.message || 'Unknown error',
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred.Please try again.',
                        'error'
                    );
                }
                showNotification('Network error.Please try again.', 'error');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Create Agent';
            }
        }
        // Reset create agent form
        function resetCreateAgentForm() {
            const form = document.getElementById('createAgentForm');
            if (form) {
                form.reset();
                
                // Reset agent type selection
                const agentTypeOptions = document.querySelectorAll('.agent-type-option');
                agentTypeOptions.forEach(option => {
                    option.querySelector('label').classList.remove('border-blue-500' && 'bg-blue-50');
                    option.querySelector('label').classList.add('border-gray-200');
                });
                
                // Hide type-specific config
                document.getElementById('typeSpecificConfig').classList.add('hidden');
                document.querySelectorAll('.type-config').forEach(config => {
                    config.classList.add('hidden');
                });
            }
        }
        // Switch to a specific tab
        function switchToTab(tabId) {
            const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabButton) {
                tabButton.click();
            }
        }
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${
                        type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-circle' :
                        type === 'warning' ? 'exclamation-triangle' :
                        'info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Handle token expiry
        function handleTokenExpiry() {
            console.log('🔒 Token expired, redirecting to login');
            localStorage.removeItem('adminToken');
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userInfo');
            showNotification('Session expired. Please login again.', 'error');
            setTimeout(() => {
                window.location.href = '/auth/login.html';
            }, 2000);
        }
    
    // Error handling utilities
    function showError(message) {
        console.error('Error:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'error');
        } else {
            alert('Error: ' + message);
        }
    }

    function showSuccess(message) {
        console.log('Success:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'success');
        }
    }

    function showLoading(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-white/70">${message}</p>
                </div>
            `;
        }
    }
</script>

    </div>
</div>

<script>
// Unified Admin API Integration for agent-management.html
class AdminAPI {
    constructor() {
        this.baseUrl = '/api/admin';
        this.token = localStorage.getItem('adminToken');
    }
    
    async request(endpoint, options = {}) {
        const url = this.baseUrl + endpoint;
        const config = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + this.token,
                ...options.headers
            },
            ...options
        };
        
        try {
            showLoading(true);
            const response = await fetch(url, config);
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            showLoading(false);
            return data;
        } catch (error) {
            showLoading(false);
            showError('API Error: ' + error.message);
            throw error;
        }
    }
    
    // Page-specific methods
    
    async getData() {
        return await this.request('/data');
    }
}

// Initialize API
const adminAPI = new AdminAPI();

// Load data when page loads
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadPageData();
    } catch (error) {
        console.error('Failed to load page data:', error);
        showError('Failed to load data. Please refresh the page.');
    }
});

// Agent Management JavaScript Functions

let currentTab = 'pending-registrations';
let agentRegistrations = [];

// Tab Management
function switchTab(tabId) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.classList.add('hidden');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById(tabId);
    if (selectedContent) {
        selectedContent.classList.remove('hidden');
        selectedContent.classList.add('active');
    }
    
    // Activate selected tab button
    const selectedButton = document.querySelector(`[data-tab="${tabId}"]`);
    if (selectedButton) {
        selectedButton.classList.add('active', 'border-blue-500', 'text-blue-600');
        selectedButton.classList.remove('border-transparent', 'text-gray-500');
    }
    
    currentTab = tabId;
    loadTabData(tabId);
}

// Load data for specific tab
async function loadTabData(tabId) {
    switch (tabId) {
        case 'pending-registrations':
            await loadAgentRegistrations();
            break;
        case 'create-agent':
            loadAgentTypes();
            break;
        case 'agent-types':
            await loadAgentTypesConfig();
            break;
        case 'agent-performance':
            await loadPerformanceAnalytics();
            break;
        default:
            console.log(`Loading data for ${tabId}...`);
    }
}

// Load agent registrations
async function loadAgentRegistrations() {
    try {
        showLoading(true);
        const response = await adminAPI.request('/api/admin/agent-registrations?status=pending');
        
        if (response.success) {
            agentRegistrations = response.data || [];
            updateRegistrationsTable();
            updatePendingCount();
        } else {
            showError('Failed to load agent registrations');
        }
    } catch (error) {
        console.error('Error loading agent registrations:', error);
        showError('Failed to load agent registrations');
    } finally {
        showLoading(false);
    }
}

// Update registrations table
function updateRegistrationsTable() {
    const tbody = document.getElementById('registrationsTableBody');
    if (!tbody) return;
    
    if (agentRegistrations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    No pending registrations found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = agentRegistrations.map(registration => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div>
                        <div class="text-sm font-medium text-gray-900">
                            ${registration.first_name} ${registration.last_name}
                        </div>
                        <div class="text-sm text-gray-500">${registration.email}</div>
                        <div class="text-sm text-gray-500">${registration.phone}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                    ${registration.agent_type.replace('_', ' ')}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(registration.verification_status)}">
                    ${registration.verification_status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${new Date(registration.submitted_at).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button onclick="reviewRegistration(${registration.id})" class="text-blue-600 hover:text-blue-900">
                    Review
                </button>
                <button onclick="approveRegistration(${registration.id})" class="text-green-600 hover:text-green-900">
                    Approve
                </button>
                <button onclick="rejectRegistration(${registration.id})" class="text-red-600 hover:text-red-900">
                    Reject
                </button>
            </td>
        </tr>
    `).join('');
}

// Get status badge class
function getStatusBadgeClass(status) {
    const classes = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'under_review': 'bg-blue-100 text-blue-800',
        'approved': 'bg-green-100 text-green-800',
        'rejected': 'bg-red-100 text-red-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

// Update pending count
function updatePendingCount() {
    const count = agentRegistrations.filter(reg => reg.verification_status === 'pending').length;
    const countElement = document.getElementById('pendingCount');
    if (countElement) {
        countElement.textContent = count;
        countElement.style.display = count > 0 ? 'inline' : 'none';
    }
}

// Load agent types for create form
async function loadAgentTypes() {
    try {
        const response = await adminAPI.request('/api/admin/agent-types');
        
        if (response.agentTypes) {
            populateAgentTypeSelect(response.agentTypes);
        }
    } catch (error) {
        console.error('Error loading agent types:', error);
        showError('Failed to load agent types');
    }
}

// Populate agent type select
function populateAgentTypeSelect(agentTypes) {
    const select = document.getElementById('createAgentType');
    if (select) {
        select.innerHTML = '<option value="">Select Agent Type</option>' +
            agentTypes.map(type => `
                <option value="${type.type_code}">${type.type_name}</option>
            `).join('');
    }
}

// Apply filters
function applyFilters() {
    const status = document.getElementById('statusFilter')?.value || '';
    const agentType = document.getElementById('agentTypeFilter')?.value || '';
    const date = document.getElementById('dateFilter')?.value || '';
    
    let filteredRegistrations = [...agentRegistrations];
    
    if (status) {
        filteredRegistrations = filteredRegistrations.filter(reg => reg.verification_status === status);
    }
    
    if (agentType) {
        filteredRegistrations = filteredRegistrations.filter(reg => reg.agent_type === agentType);
    }
    
    if (date) {
        filteredRegistrations = filteredRegistrations.filter(reg => 
            new Date(reg.submitted_at).toDateString() === new Date(date).toDateString()
        );
    }
    
    // Update table with filtered data
    const tbody = document.getElementById('registrationsTableBody');
    if (tbody) {
        tbody.innerHTML = filteredRegistrations.map(registration => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div>
                            <div class="text-sm font-medium text-gray-900">
                                ${registration.first_name} ${registration.last_name}
                            </div>
                            <div class="text-sm text-gray-500">${registration.email}</div>
                            <div class="text-sm text-gray-500">${registration.phone}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${registration.agent_type.replace('_', ' ')}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(registration.verification_status)}">
                        ${registration.verification_status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(registration.submitted_at).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button onclick="reviewRegistration(${registration.id})" class="text-blue-600 hover:text-blue-900">
                        Review
                    </button>
                    <button onclick="approveRegistration(${registration.id})" class="text-green-600 hover:text-green-900">
                        Approve
                    </button>
                    <button onclick="rejectRegistration(${registration.id})" class="text-red-600 hover:text-red-900">
                        Reject
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

// Review registration
async function reviewRegistration(registrationId) {
    try {
        const response = await adminAPI.request(`/api/admin/agent-registration/${registrationId}`);
        
        if (response.success) {
            // Show registration details in a modal
            showRegistrationModal(response.data);
        }
    } catch (error) {
        console.error('Error fetching registration details:', error);
        showError('Failed to load registration details');
    }
}

// Approve registration
async function approveRegistration(registrationId) {
    if (!confirm('Are you sure you want to approve this agent registration?')) {
        return;
    }
    
    try {
        showLoading(true);
        const response = await adminAPI.request(`/api/admin/agent-registration/${registrationId}/status`, {
            method: 'PUT',
            body: JSON.stringify({
                status: 'approved',
                admin_notes: 'Registration approved by admin'
            })
        });
        
        if (response.success) {
            showNotification('Agent registration approved successfully', 'success');
            await loadAgentRegistrations(); // Reload data
        } else {
            showError('Failed to approve registration');
        }
    } catch (error) {
        console.error('Error approving registration:', error);
        showError('Failed to approve registration');
    } finally {
        showLoading(false);
    }
}

// Reject registration
async function rejectRegistration(registrationId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (!reason) return;
    
    try {
        showLoading(true);
        const response = await adminAPI.request(`/api/admin/agent-registration/${registrationId}/status`, {
            method: 'PUT',
            body: JSON.stringify({
                status: 'rejected',
                admin_notes: reason,
                rejection_reason: reason
            })
        });
        
        if (response.success) {
            showNotification('Agent registration rejected', 'warning');
            await loadAgentRegistrations(); // Reload data
        } else {
            showError('Failed to reject registration');
        }
    } catch (error) {
        console.error('Error rejecting registration:', error);
        showError('Failed to reject registration');
    } finally {
        showLoading(false);
    }
}

// Load page data
async function loadPageData() {
    console.log('Loading agent management data...');
    
    // Load data for the current tab
    await loadTabData(currentTab);
}

function refreshData() {
    loadPageData();
}

// Missing function implementations

// Load agent types configuration
async function loadAgentTypesConfig() {
    try {
        const response = await adminAPI.request('/api/admin/agent-types');
        
        if (response.agentTypes) {
            console.log('Agent types loaded:', response.agentTypes);
            // Update agent types management UI here
        }
    } catch (error) {
        console.error('Error loading agent types config:', error);
        showError('Failed to load agent types configuration');
    }
}

// Load performance analytics
async function loadPerformanceAnalytics() {
    try {
        console.log('Loading performance analytics...');
        // Implement analytics loading here
        showNotification('Performance analytics loaded', 'info');
    } catch (error) {
        console.error('Error loading performance analytics:', error);
        showError('Failed to load performance analytics');
    }
}

// Show registration details modal
function showRegistrationModal(registration) {
    // Create modal with registration details
    const modalHtml = `
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" id="registrationModal">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex items-center justify-between pb-3">
                    <h3 class="text-lg font-bold text-gray-900">Agent Registration Details</h3>
                    <button onclick="closeRegistrationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-700">Personal Information</h4>
                            <p><strong>Name:</strong> ${registration.first_name} ${registration.last_name}</p>
                            <p><strong>Email:</strong> ${registration.email}</p>
                            <p><strong>Phone:</strong> ${registration.phone}</p>
                            <p><strong>Agent Type:</strong> ${registration.agent_type}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700">Application Status</h4>
                            <p><strong>Status:</strong> ${registration.verification_status}</p>
                            <p><strong>Submitted:</strong> ${new Date(registration.submitted_at).toLocaleDateString()}</p>
                            <p><strong>Application Ref:</strong> ${registration.application_ref}</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="approveRegistration(${registration.id})" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Approve
                        </button>
                        <button onclick="rejectRegistration(${registration.id})" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Reject
                        </button>
                        <button onclick="closeRegistrationModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Close registration modal
function closeRegistrationModal() {
    const modal = document.getElementById('registrationModal');
    if (modal) {
        modal.remove();
    }
}
</script>
</body>
</html>