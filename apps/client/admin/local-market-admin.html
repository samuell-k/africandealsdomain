<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Market Admin | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            backdrop-filter: blur(10px);
        }
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #3b82f6;
            outline: none;
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .stat-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
    
        
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
    
    <!-- Main Content -->
    <div class="flex-1 p-8 overflow-auto">
        
  <!-- Navigation -->
  <nav class="glass border-b border-green-100 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo and Brand -->
        <div class="flex items-center space-x-4">
          <img src="/public/images/logo.png" alt="ADD" class="h-10 w-10 rounded-xl shadow-lg">
          <div>
            <h1 class="text-xl font-bold text-gray-900">Local Market Admin</h1>
            <p class="text-xs text-green-600">Control Panel</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- User Menu -->
          <div class="relative">
            <button id="user-menu-button" class="flex items-center space-x-2 text-gray-700 hover:text-green-600 transition-colors" onclick="showNotification('Feature in development', 'info')">
              <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <span id="admin-name" class="hidden lg:inline text-sm font-medium">Admin</span>
            </button>
            <!-- User Dropdown Menu -->
            <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-lg border border-gray-200 z-50 hidden">
              <!-- Dropdown content will be populated by auth-utils.js -->
            </div>
            <!-- User Dropdown -->
            <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
              <a href="/admin/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
              <a href="/admin/settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
              <hr class="my-2">
              <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Sign Out</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <!-- Main Dashboard -->
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 admin-card transition-all duration-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Orders Today</p>
            <p id="total-orders" class="text-3xl font-bold text-green-600">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-6 admin-card transition-all duration-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Platform Revenue</p>
            <p id="platform-revenue" class="text-3xl font-bold text-blue-600">0 RWF</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-6 admin-card transition-all duration-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Active Agents</p>
            <p id="active-agents" class="text-3xl font-bold text-orange-600">0</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-6 admin-card transition-all duration-300">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Avg Delivery Time</p>
            <p id="avg-delivery-time" class="text-3xl font-bold text-purple-600">0m</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>
    <!-- Tab Navigation -->
    <div class="bg-white rounded-2xl shadow-lg mb-8">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6">
          <button class="tab-button tab-active py-4 px-2 border-b-2 border-green-500 font-medium text-sm" data-tab="overview" onclick="showNotification('Feature in development', 'info')">
            📊 Overview
          /button>
          <button class="tab-button tab-inactive py-4 px-2 border-b-2 border-transparent font-medium text-sm" data-tab="settings" onclick="showNotification('Feature in development', 'info')">
            ⚙️ Settings
          /button>
          <button class="tab-button tab-inactive py-4 px-2 border-b-2 border-transparent font-medium text-sm" data-tab="agents" onclick="showNotification('Feature in development', 'info')">
            👥 Agents
          /button>
          <button class="tab-button tab-inactive py-4 px-2 border-b-2 border-transparent font-medium text-sm" data-tab="orders" onclick="showNotification('Feature in development', 'info')">
            📦 Orders
          /button>
          <button class="tab-button tab-inactive py-4 px-2 border-b-2 border-transparent font-medium text-sm" data-tab="analytics" onclick="showNotification('Feature in development', 'info')">
            📈 Analytics
          /button>
        </nav>
      </div>
      <!-- Tab Content -->
      <div class="p-6">
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Orders -->
            <div>
              <h3 class="text-lg font-bold text-gray-900 mb-4">📋 Recent Orders</h3>
              <div id="recent-orders" class="space-y-3">
                <!-- Recent orders will be loaded here -->
                <div class="text-center py-8 text-gray-500">Loading...</div>
              </div>
            </div>
            <!-- System Status -->
            <div>
              <h3 class="text-lg font-bold text-gray-900 mb-4">🔧 System Status</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl">
                  <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="font-medium">Order Processing</span>
                  </div>
                  <span class="text-green-600 text-sm">Online</span>
                </div>
                <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl">
                  <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="font-medium">Agent Tracking</span>
                  </div>
                  <span class="text-green-600 text-sm">Active</span>
                </div>
                <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl">
                  <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="font-medium">Payment System</span>
                  </div>
                  <span class="text-green-600 text-sm">Operational</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Commission & Fees -->
            <div class="bg-gray-50 rounded-xl p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">💰 Commission & Fees</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Platform Commission (%)</label>
                  <input type="number" id="platform-commission" step="0.1" min="0" max="10" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Packaging Fee (RWF)</label>
                  <input type="number" id="packaging-fee" min="0" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Agent Base Earning (RWF)</label>
                  <input type="number" id="agent-base-earning" min="0" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Agent Per KM Bonus (RWF)</label>
                  <input type="number" id="agent-km-bonus" min="0" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <button id="save-fees" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-medium transition-colors" onclick="handleSave()">
                  Save Changes
                /button>
              </div>
            </div>
            <!-- Delivery Settings -->
            <div class="bg-gray-50 rounded-xl p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">🚚 Delivery Settings</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Max Delivery Distance (km)</label>
                  <input type="number" id="max-delivery-distance" min="1" max="50" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Min Order Amount (RWF)</label>
                  <input type="number" id="min-order-amount" min="0" 
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Auto Agent Assignment</label>
                  <select id="auto-agent-assignment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                  </select>
                </div>
                <button id="save-delivery" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-colors" onclick="handleSave()">
                  Save Changes
                /button>
              </div>
            </div>
          </div>
        </div>
        <!-- Agents Tab -->
        <div id="agents-tab" class="tab-content hidden">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-gray-900">👥 Agent Management</h3>
            <div class="flex space-x-3">
              <button id="refresh-agents" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" onclick="showNotification('Feature in development', 'info')">
                Refresh
              /button>
              <button id="assign-bonus" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" onclick="showNotification('Feature in development', 'info')">
                Assign Bonus
              /button>
            </div>
          </div>
          <div id="agents-list" class="space-y-4">
            <!-- Agents will be loaded here -->
            <div class="text-center py-8 text-gray-500">Loading agents...</div>
          </div>
        </div>
        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content hidden">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-gray-900">📦 Order Management</h3>
            <div class="flex space-x-3">
              <select id="order-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="">All Orders</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="in_transit">In Transit</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
              <button id="refresh-orders" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" onclick="showNotification('Feature in development', 'info')">
                Refresh
              /button>
            </div>
          </div>
          <div id="orders-list" class="space-y-4">
            <!-- Orders will be loaded here -->
            <div class="text-center py-8 text-gray-500">Loading orders...</div>
          </div>
        </div>
        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-gray-50 rounded-xl p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">📈 Order Trends</h3>
              <canvas id="orders-chart" width="400" height="200"></canvas>
            </div>
            <div class="bg-gray-50 rounded-xl p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">💰 Revenue Trends</h3>
              <canvas id="revenue-chart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Bonus Assignment Modal -->
  <div id="bonus-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-gray-900 mb-4">💰 Assign Agent Bonus</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Agent</label>
          <select id="bonus-agent-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
            <option value="">Choose an agent...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Bonus Amount (RWF)</label>
          <input type="number" id="bonus-amount" min="0" placeholder="Enter bonus amount"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
          <textarea id="bonus-reason" rows="3" placeholder="Reason for bonus..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
        </div>
        <div class="flex gap-3">
          <button id="assign-bonus-confirm" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-medium transition-colors" onclick="showNotification('Feature in development', 'info')">
            Assign Bonus
          /button>
          <button id="close-bonus-modal" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition-colors" onclick="handleCancel()">
            Cancel
          /button>
        </div>
      </div>
    </div>
  </div>
  <!-- Scripts -->
  <script>
    // Initialize Local Market Admin Dashboard
    class LocalMarketAdminDashboard {
      constructor() {
        this.currentTab = 'overview';
        this.init();
      }
      init() {
        this.loadAdminData();
        this.setupEventListeners();
        this.loadDashboardData();
        this.loadSettings();
      }
      loadAdminData() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if ((user && (user && (user && user.name || '') || '') || '')) {
          document.getElementById('admin-name').textContent = (user && (user && (user && user.name || '') || '') || '');
        }
      }
      setupEventListeners() {
        // Tab navigation
        document.querySelectorAll('.tab-button').forEach(button => {
          button.addEventListener('click', (e) => {
            this.switchTab(e.target.dataset.tab);
          });
        });
        // Settings
        document.getElementById('save-fees').addEventListener('click', () => {
          this.saveFeeSettings();
        });
        document.getElementById('save-delivery').addEventListener('click', () => {
          this.saveDeliverySettings();
        });
        // Agents
        document.getElementById('refresh-agents').addEventListener('click', () => {
          this.loadAgents();
        });
        document.getElementById('assign-bonus').addEventListener('click', () => {
          this.showBonusModal();
        });
        // Orders
        document.getElementById('refresh-orders').addEventListener('click', () => {
          this.loadOrders();
        });
        document.getElementById('order-status-filter').addEventListener('change', () => {
          this.loadOrders();
        });
        // Bonus modal
        document.getElementById('close-bonus-modal').addEventListener('click', () => {
          document.getElementById('bonus-modal').classList.add('hidden');
        });
        document.getElementById('assign-bonus-confirm').addEventListener('click', () => {
          this.assignBonus();
        });
        // User menu
        document.getElementById('user-menu-button').addEventListener('click', () => {
          document.getElementById('user-menu').classList.toggle('hidden');
        });
        // Mode switcher
        });
      }
      switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
          if (button.dataset.tab === tabName) {
            button.className = 'tab-button tab-active py-4 px-2 border-b-2 border-green-500 font-medium text-sm';
          } else {
            button.className = 'tab-button tab-inactive py-4 px-2 border-b-2 border-transparent font-medium text-sm';
          }
        });
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        this.currentTab = tabName;
        // Load tab-specific data
        switch (tabName) {
          case 'agents':
            this.loadAgents();
            break;
          case 'orders':
            this.loadOrders();
            break;
          case 'analytics':
            this.loadAnalytics();
            break;
        }
      }
      async loadDashboardData() {
        try {
          const response = await fetch('/api/admin/local-market-stats', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          const data = await response.json();
          if (data.success) {
            document.getElementById('total-orders').textContent = data.stats.totalOrders || 0;
            document.getElementById('platform-revenue').textContent = `${data.stats.platformRevenue || 0} RWF`;
            document.getElementById('active-agents').textContent = data.stats.activeAgents || 0;
            document.getElementById('avg-delivery-time').textContent = `${data.stats.avgDeliveryTime || 0}m`;
            this.loadRecentOrders(data.recentOrders || []);
          }
        } catch (error) {
          console.error('Error loading dashboard data:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        }
      }
      loadRecentOrders(orders) {
        const container = document.getElementById('recent-orders');
        if (orders.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-500">No recent orders</div>';
          return;
        }
        container.innerHTML = orders.slice(0, 5).map(order => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
            <div>
              <p class="font-medium text-gray-900">#${order.order_number}</p>
              <p class="text-sm text-gray-600">${order.buyer_name} • ${order.total_amount} RWF</p>
            </div>
            <div class="text-right">
              <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${this.getStatusColor(order.status)}">
                ${order.status}
              </span>
              <p class="text-xs text-gray-500 mt-1">${this.formatTime(order.created_at)}</p>
            </div>
          </div>
        `).join('');
      }
      async loadSettings() {
        try {
          const response = await fetch('/api/admin/local-market-settings', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          const data = await response.json();
          if (data.success) {
            const settings = data.settings;
            document.getElementById('platform-commission').value = settings.platform_commission_rate || 1.0;
            document.getElementById('packaging-fee').value = settings.default_packaging_fee || 200;
            document.getElementById('agent-base-earning').value = settings.agent_base_earning || 1000;
            document.getElementById('agent-km-bonus').value = settings.agent_per_km_bonus || 100;
            document.getElementById('max-delivery-distance').value = settings.max_delivery_distance_km || 30;
            document.getElementById('min-order-amount').value = settings.min_order_amount || 2000;
            document.getElementById('auto-agent-assignment').value = settings.auto_agent_assignment || 'true';
          }
        } catch (error) {
          console.error('Error loading settings:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        }
      }
      async saveFeeSettings() {
        try {
          const settings = {
            platform_commission_rate: document.getElementById('platform-commission').value,
            default_packaging_fee: document.getElementById('packaging-fee').value,
            agent_base_earning: document.getElementById('agent-base-earning').value,
            agent_per_km_bonus: document.getElementById('agent-km-bonus').value
          };
          const response = await fetch('/api/admin/local-market-settings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(settings)
          });
          const data = await response.json();
          if (data.success) {
            this.showNotification('Fee settings saved successfully!', 'success');
          } else {
            this.showNotification(data.message || 'Failed to save settings', 'error');
          }
        } catch (error) {
          console.error('Error saving fee settings:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
          this.showNotification('Failed to save settings', 'error');
        }
      }
      async saveDeliverySettings() {
        try {
          const settings = {
            max_delivery_distance_km: document.getElementById('max-delivery-distance').value,
            min_order_amount: document.getElementById('min-order-amount').value,
            auto_agent_assignment: document.getElementById('auto-agent-assignment').value
          };
          const response = await fetch('/api/admin/local-market-settings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(settings)
          });
          const data = await response.json();
          if (data.success) {
            this.showNotification('Delivery settings saved successfully!', 'success');
          } else {
            this.showNotification(data.message || 'Failed to save settings', 'error');
          }
        } catch (error) {
          console.error('Error saving delivery settings:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
          this.showNotification('Failed to save settings', 'error');
        }
      }
      async loadAgents() {
        try {
          const response = await fetch('/api/admin/local-market-agents', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          const data = await response.json();
          if (data.success) {
            this.renderAgents(data.agents);
            this.populateBonusAgentSelect(data.agents);
          }
        } catch (error) {
          console.error('Error loading agents:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        }
      }
      renderAgents(agents) {
        const container = document.getElementById('agents-list');
        if (agents.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-500">No agents found</div>';
          return;
        }
        container.innerHTML = agents.map(agent => `
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900">${agent.name}</h4>
                  <p class="text-sm text-gray-600">${agent.email}</p>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <div class="text-right">
                  <p class="text-sm font-medium text-gray-900">${agent.total_deliveries || 0} deliveries</p>
                  <p class="text-sm text-gray-600">Rating: ${agent.rating || 'N/A'}</p>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="inline-block w-3 h-3 rounded-full ${agent.status === 'online' ? 'bg-green-500' : 'bg-gray-400'}"></span>
                  <span class="text-sm text-gray-600">${agent.status || 'offline'}</span>
                </div>
                <button onclick="viewAgentDetails(${agent.id})" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm transition-colors">
                  View Details
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }
      populateBonusAgentSelect(agents) {
        const select = document.getElementById('bonus-agent-select');
        select.innerHTML = '<option value="">Choose an agent...</option>' + 
          agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
      }
      showBonusModal() {
        document.getElementById('bonus-modal').classList.remove('hidden');
      }
      async assignBonus() {
        const agentId = document.getElementById('bonus-agent-select').value;
        const amount = document.getElementById('bonus-amount').value;
        const reason = document.getElementById('bonus-reason').value;
        if (!agentId || !amount) {
          this.showNotification('Please select an agent and enter bonus amount', 'error');
          return;
        }
        try {
          const response = await fetch('/api/admin/assign-agent-bonus', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              agent_id: agentId,
              amount: parseFloat(amount),
              reason: reason
            })
          });
          const data = await response.json();
          if (data.success) {
            this.showNotification('Bonus assigned successfully!', 'success');
            document.getElementById('bonus-modal').classList.add('hidden');
            // Reset form
            document.getElementById('bonus-agent-select').value = '';
            document.getElementById('bonus-amount').value = '';
            document.getElementById('bonus-reason').value = '';
          } else {
            this.showNotification(data.message || 'Failed to assign bonus', 'error');
          }
        } catch (error) {
          console.error('Error assigning bonus:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
          this.showNotification('Failed to assign bonus', 'error');
        }
      }
      async loadOrders() {
        const status = document.getElementById('order-status-filter').value;
        try {
          const params = new URLSearchParams();
          if (status) params.append('status', status);
          const response = await fetch(`/api/admin/local-market-orders?${params}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          const data = await response.json();
          if (data.success) {
            this.renderOrders(data.orders);
          }
        } catch (error) {
          console.error('Error loading orders:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        }
      }
      renderOrders(orders) {
        const container = document.getElementById('orders-list');
        if (orders.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-500">No orders found</div>';
          return;
        }
        container.innerHTML = orders.map(order => `
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-semibold text-gray-900">#${order.order_number}</h4>
                <p class="text-sm text-gray-600">${order.buyer_name} → ${order.agent_name || 'Unassigned'}</p>
                <p class="text-sm text-gray-600">${order.total_amount} RWF • ${order.item_count} items</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="text-right">
                  <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${this.getStatusColor(order.status)}">
                    ${order.status}
                  </span>
                  <p class="text-xs text-gray-500 mt-1">${this.formatTime(order.created_at)}</p>
                </div>
                <button onclick="viewOrderDetails(${order.id})" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm transition-colors">
                  View Details
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }
      loadAnalytics() {
        // Load and render charts
        this.renderOrdersChart();
        this.renderRevenueChart();
      }
      renderOrdersChart() {
        const ctx = document.getElementById('orders-chart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Orders',
              data: [12, 19, 3, 5, 2, 3, 9],
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
      renderRevenueChart() {
        const ctx = document.getElementById('revenue-chart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Revenue (RWF)',
              data: [1200, 1900, 300, 500, 200, 300, 900],
              backgroundColor: '#3b82f6'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
      getStatusColor(status) {
        const colors = {
          'pending': 'bg-yellow-100 text-yellow-800',
          'confirmed': 'bg-blue-100 text-blue-800',
          'in_transit': 'bg-orange-100 text-orange-800',
          'delivered': 'bg-green-100 text-green-800',
          'cancelled': 'bg-red-100 text-red-800'
        };
        return colors[status] || 'bg-gray-100 text-gray-800';
      }
      formatTime(timestamp) {
        return new Date(timestamp).toLocaleString();
      }
      showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-xl text-white font-medium ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    }
    // Global functions
    function viewAgentDetails(agentId) {
      // Implement agent details view
      console.log('View agent details:', agentId);
    }
    function viewOrderDetails(orderId) {
      // Implement order details view
      console.log('View order details:', orderId);
    }
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/auth/auth-admin.html';
    }
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      new LocalMarketAdminDashboard();
    });
  </script>
<script>
// Utility Functions for Enhanced Functionality
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-black' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Generic search handlers
function handleProductSearch(query) {
    console.log('Searching products:', query);
    if (query.length > 2) {
        // Implement product search logic
        showNotification('Searching for: ' + query, 'info');
    }
}

function handleSellerSearch(query) {
    console.log('Searching sellers:', query);
    if (query.length > 2) {
        showNotification('Searching sellers: ' + query, 'info');
    }
}

function handleAgentSearch(query) {
    console.log('Searching agents:', query);
    if (query.length > 2) {
        showNotification('Searching agents: ' + query, 'info');
    }
}

function handleOrderSearch(query) {
    console.log('Searching orders:', query);
    if (query.length > 2) {
        showNotification('Searching orders: ' + query, 'info');
    }
}

function handleUserSearch(query) {
    console.log('Searching users:', query);
    if (query.length > 2) {
        showNotification('Searching users: ' + query, 'info');
    }
}

// Generic form handlers
function handleSave() {
    showNotification('Save functionality will be implemented soon', 'info');
}

function handleEdit() {
    showNotification('Edit functionality will be implemented soon', 'info');
}

function handleDelete() {
    if (confirm('Are you sure you want to delete this item?')) {
        showNotification('Delete functionality will be implemented soon', 'info');
    }
}

function handleCancel() {
    if (confirm('Are you sure you want to cancel? Unsaved changes will be lost.')) {
        history.back();
    }
}

    // Error handling utilities
    function showError(message) {
        console.error('Error:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'error');
        } else {
            alert('Error: ' + message);
        }
    }

    function showSuccess(message) {
        console.log('Success:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'success');
        }
    }

    function showLoading(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-white/70">${message}</p>
                </div>
            `;
        }
    }
</script>

    </div>
</div>

<script>
// Unified Admin API Integration for local-market-admin.html
class AdminAPI {
    constructor() {
        this.baseUrl = '/api/admin';
        this.token = localStorage.getItem('adminToken');
    }
    
    async request(endpoint, options = {}) {
        const url = this.baseUrl + endpoint;
        const config = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + this.token,
                ...options.headers
            },
            ...options
        };
        
        try {
            showLoading(true);
            const response = await fetch(url, config);
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            showLoading(false);
            return data;
        } catch (error) {
            showLoading(false);
            showError('API Error: ' + error.message);
            throw error;
        }
    }
    
    // Page-specific methods
    
    async getData() {
        return await this.request('/data');
    }
}

// Initialize API
const adminAPI = new AdminAPI();

// Load data when page loads
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadPageData();
    } catch (error) {
        console.error('Failed to load page data:', error);
        showError('Failed to load data. Please refresh the page.');
    }
});

async function loadPageData() {
    // Implement page-specific data loading
    console.log('Loading data for local-market-admin.html...');
    
    
    // Generic data loading
    console.log('Loading data for local-market-admin.html...');
}

function refreshData() {
    loadPageData();
}
</script>
</body>
</html>