<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        :root {
            --primary-color: #080b3b;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            backdrop-filter: blur(10px);
        }
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #3b82f6;
            outline: none;
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .agent-type-section {
            display: none;
        }
        .agent-type-section.show {
            display: block;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item active flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="payment-credentials.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-wallet"></i>
                    <span>Payment Credentials</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-auto">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">User Management</h1>
                    <p class="text-white/70">Manage all platform users and their roles</p>
                </div>
                <button onclick="openAddUserModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg flex items-center justify-center space-x-2 w-full sm:w-auto">
                    <i class="fas fa-plus"></i>
                    <span class="hidden sm:inline">Add New User</span>
                    <span class="sm:hidden">Add User</span>
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-morphism p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/70 text-sm">Total Users</p>
                            <p class="text-2xl font-bold text-white" id="total-users">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-400 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-morphism p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/70 text-sm">Buyers</p>
                            <p class="text-2xl font-bold text-white" id="total-buyers">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-green-400 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-morphism p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/70 text-sm">Sellers</p>
                            <p class="text-2xl font-bold text-white" id="total-sellers">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-store text-purple-400 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-morphism p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/70 text-sm">Agents</p>
                            <p class="text-2xl font-bold text-white" id="total-agents">0</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user-tie text-yellow-400 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass-morphism p-4 sm:p-6 rounded-xl mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="sm:col-span-2 lg:col-span-1">
                        <label class="block text-white/70 text-sm mb-2">Search Users</label>
                        <input type="text" id="search-input" placeholder="Search by name, email..." 
                               class="w-full p-3 rounded-lg form-input text-sm">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Filter by Role</label>
                        <select id="role-filter" class="w-full p-3 rounded-lg form-input text-sm">
                            <option value="">All Roles</option>
                            <option value="buyer">Buyers</option>
                            <option value="seller">Sellers</option>
                            <option value="agent">Agents</option>
                            <option value="admin">Admins</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Filter by Status</label>
                        <select id="status-filter" class="w-full p-3 rounded-lg form-input text-sm">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="flex items-end sm:col-span-2 lg:col-span-1">
                        <button onclick="loadUsers()" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg text-sm font-medium">
                            <i class="fas fa-search mr-2"></i>Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="glass-morphism rounded-xl overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-white/10">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-3 sm:space-y-0">
                        <h3 class="text-lg sm:text-xl font-bold text-white">Users List</h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button onclick="exportUsers()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm flex items-center justify-center">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                            <button onclick="loadUsers()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg text-sm flex items-center justify-center">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div id="users-table-container" class="overflow-x-auto">
                    <div class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white/70">Loading users...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination-container" class="p-6 border-t border-white/10">
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black/50 modal hidden items-center justify-center z-50">
        <div class="glass-morphism p-8 rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-white">Add New User</h2>
                <button onclick="closeUserModal()" class="text-white/70 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="user-form" class="space-y-6">
                <input type="hidden" id="user-id" name="user_id">
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/70 text-sm mb-2">First Name *</label>
                        <input type="text" id="first-name" name="first_name" required 
                               class="w-full p-3 rounded-lg form-input" placeholder="Enter first name">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Last Name *</label>
                        <input type="text" id="last-name" name="last_name" required 
                               class="w-full p-3 rounded-lg form-input" placeholder="Enter last name">
                    </div>
                </div>

                <div>
                    <label class="block text-white/70 text-sm mb-2">Username *</label>
                    <input type="text" id="username" name="username" required 
                           class="w-full p-3 rounded-lg form-input" placeholder="Enter username">
                </div>

                <div>
                    <label class="block text-white/70 text-sm mb-2">Email *</label>
                    <input type="email" id="email" name="email" required 
                           class="w-full p-3 rounded-lg form-input" placeholder="Enter email address">
                </div>

                <div>
                    <label class="block text-white/70 text-sm mb-2">Phone</label>
                    <input type="tel" id="phone" name="phone" 
                           class="w-full p-3 rounded-lg form-input" placeholder="Enter phone number">
                </div>

                <div id="password-section">
                    <label class="block text-white/70 text-sm mb-2">Password *</label>
                    <input type="password" id="password" name="password" required 
                           class="w-full p-3 rounded-lg form-input" placeholder="Enter password">
                </div>

                <!-- Role Selection -->
                <div>
                    <label class="block text-white/70 text-sm mb-2">User Role *</label>
                    <select id="user-role" name="role" required onchange="toggleAgentTypeSection()" 
                            class="w-full p-3 rounded-lg form-input">
                        <option value="">Select Role</option>
                        <option value="buyer">Buyer</option>
                        <option value="seller">Seller</option>
                        <option value="agent">Agent</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <!-- Agent Type Section (only shown for agents) -->
                <div id="agent-type-section" class="agent-type-section">
                    <label class="block text-white/70 text-sm mb-2">Agent Type (optional)</label>
                    <select id="agent-type" name="agent_type" class="w-full p-3 rounded-lg form-input">
                        <option value="">Select Agent Type</option>
                        <option value="fast_delivery">Fast Delivery Agent</option>
                        <option value="pickup_delivery">Pickup Delivery Agent</option>
                        <option value="pickup_site_manager">Pickup Site Manager</option>
                    </select>
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-white/70 text-sm mb-2">Status</label>
                    <select id="user-status" name="is_active" class="w-full p-3 rounded-lg form-input">
                        <option value="1">Active</option>
                        <option value="0">Inactive</option>
                    </select>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 pt-6">
                    <button type="button" onclick="closeUserModal()" 
                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" id="submit-btn" 
                            class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUsers = [];
        let currentPage = 1;
        let totalPages = 1;
        let isEditing = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ User Management page initializing...');
            
            // Check authentication first
            checkAuthentication();
            
            // Load data
            loadUsers();
            setupEventListeners();
        });

        // Check authentication and prevent redirect loops
        function checkAuthentication() {
            const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
            const userRole = localStorage.getItem('userRole');
            
            if (!token) {
                console.log('‚ùå No authentication token found, redirecting to login');
                window.location.href = '/auth/auth-admin.html';
                return false;
            }
            
            if (userRole !== 'admin') {
                console.log('‚ùå Insufficient permissions, user role:', userRole);
                showToast('Access denied. Admin privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = '/auth/auth-admin.html';
                }, 2000);
                return false;
            }
            
            console.log('‚úÖ Authentication verified for admin user');
            return true;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(loadUsers, 500));
            }

            // Filter changes
            const roleFilter = document.getElementById('role-filter');
            const statusFilter = document.getElementById('status-filter');
            
            if (roleFilter) roleFilter.addEventListener('change', loadUsers);
            if (statusFilter) statusFilter.addEventListener('change', loadUsers);

            // Form submission
            const userForm = document.getElementById('user-form');
            if (userForm) {
                userForm.addEventListener('submit', handleUserSubmit);
            }
        }

        // Load users from API
        async function loadUsers(page = 1) {
            try {
                console.log('üìä Loading users...');
                
                const searchTerm = document.getElementById('search-input')?.value || '';
                const roleFilter = document.getElementById('role-filter')?.value || '';
                const statusFilter = document.getElementById('status-filter')?.value || '';

                const params = new URLSearchParams({
                    page: page,
                    limit: 20,
                    search: searchTerm,
                    role: roleFilter,
                    status: statusFilter
                });

                const response = await makeAuthenticatedRequest(
                    `/api/admin/users?${params.toString()}`
                );

                if (response.success) {
                    currentUsers = response.users;
                    currentPage = response.pagination.current_page;
                    totalPages = response.pagination.total_pages;
                    
                    updateUserStats(response.statistics);
                    renderUsersTable(response.users);
                    renderPagination(response.pagination);
                    
                    console.log('‚úÖ Users loaded successfully');
                } else {
                    throw new Error(response.message || 'Failed to load users');
                }

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                document.getElementById('users-table-container').innerHTML = 
                    createErrorState(error.message, 'loadUsers()');
                showToast('Failed to load users: ' + error.message, 'error');
            }
        }

        // Update user statistics
        function updateUserStats(statistics) {
            if (statistics) {
                document.getElementById('total-users').textContent = statistics.total_users || 0;
                document.getElementById('total-buyers').textContent = statistics.total_buyers || 0;
                document.getElementById('total-sellers').textContent = statistics.total_sellers || 0;
                document.getElementById('total-agents').textContent = statistics.total_agents || 0;
            }
        }

        // Render users table (mobile-first responsive)
        function renderUsersTable(users) {
            const container = document.getElementById('users-table-container');
            
            if (!users || users.length === 0) {
                container.innerHTML = createEmptyState(
                    'users', 
                    'No Users Found', 
                    'No users match your current filters.',
                    '<button onclick="openAddUserModal()" class="mt-4 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Add First User</button>'
                );
                return;
            }

            // Mobile-first: Cards on mobile, table on desktop
            const mobileCardsHTML = `
                <div class="block lg:hidden space-y-3">
                    ${users.map(user => `
                        <div class="bg-white/5 rounded-lg p-4 hover:bg-white/10 transition-colors">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-400"></i>
                                    </div>
                                    <div>
                                        <div class="text-white font-semibold">${(user.first_name || '') + ' ' + (user.last_name || '')}</div>
                                        <div class="text-white/50 text-sm">${user.email}</div>
                                        <div class="text-white/50 text-xs">@${user.username}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${getRoleColor(user.role)}">
                                        ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-4">
                                    <div>
                                        <span class="text-white/50 text-xs block">Status</span>
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.is_active ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                            ${user.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                    <div>
                                        <span class="text-white/50 text-xs block">Joined</span>
                                        <span class="text-white/70 text-xs">${formatDate(user.created_at)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <button onclick="editUser(${user.id})" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm flex items-center justify-center">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="toggleUserStatus(${user.id}, ${user.is_active ? 0 : 1})" 
                                        class="bg-${user.is_active ? 'red' : 'green'}-500 hover:bg-${user.is_active ? 'red' : 'green'}-600 text-white px-3 py-2 rounded text-sm flex items-center justify-center">
                                    <i class="fas fa-${user.is_active ? 'ban' : 'check'} mr-1"></i>${user.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Desktop table
            const desktopTableHTML = `
                <div class="hidden lg:block">
                    <table class="w-full">
                        <thead class="bg-white/5">
                            <tr>
                                <th class="text-left p-4 text-white/70 font-semibold">User</th>
                                <th class="text-left p-4 text-white/70 font-semibold">Role</th>
                                <th class="text-left p-4 text-white/70 font-semibold">Status</th>
                                <th class="text-left p-4 text-white/70 font-semibold">Created</th>
                                <th class="text-left p-4 text-white/70 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr class="border-t border-white/10 hover:bg-white/5">
                                    <td class="p-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center">
                                                <i class="fas fa-user text-blue-400"></i>
                                            </div>
                                            <div>
                                                <div class="text-white font-semibold">${(user.first_name || '') + ' ' + (user.last_name || '')}</div>
                                                <div class="text-white/50 text-sm">${user.email}</div>
                                                <div class="text-white/50 text-xs">@${user.username}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-4">
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getRoleColor(user.role)}">
                                            ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                                        </span>
                                    </td>
                                    <td class="p-4">
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${user.is_active ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                            ${user.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td class="p-4 text-white/70 text-sm">
                                        ${formatDate(user.created_at)}
                                    </td>
                                    <td class="p-4">
                                        <div class="flex space-x-2">
                                            <button onclick="editUser(${user.id})" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>
                                            <button onclick="toggleUserStatus(${user.id}, ${user.is_active ? 0 : 1})" 
                                                    class="bg-${user.is_active ? 'red' : 'green'}-500 hover:bg-${user.is_active ? 'red' : 'green'}-600 text-white px-3 py-1 rounded text-xs">
                                                <i class="fas fa-${user.is_active ? 'ban' : 'check'} mr-1"></i>${user.is_active ? 'Deactivate' : 'Activate'}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = mobileCardsHTML + desktopTableHTML;
        }

        // Get role color class
        function getRoleColor(role) {
            const colors = {
                'buyer': 'bg-green-500/20 text-green-400',
                'seller': 'bg-purple-500/20 text-purple-400',
                'agent': 'bg-yellow-500/20 text-yellow-400',
                'admin': 'bg-red-500/20 text-red-400'
            };
            return colors[role] || 'bg-gray-500/20 text-gray-400';
        }

        // Format agent type
        function formatAgentType(agentType) {
            const types = {
                'fast_delivery_agent': 'Fast Delivery Agent',
                'pickup_delivery_agent': 'Pickup Delivery Agent',
                'pickup_site_manager': 'Pickup Site Manager'
            };
            return types[agentType] || agentType;
        }

        // Render pagination
        function renderPagination(pagination) {
            const container = document.getElementById('pagination-container');
            
            if (pagination.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            const paginationHTML = `
                <div class="flex justify-between items-center">
                    <div class="text-white/70 text-sm">
                        Showing ${((pagination.current_page - 1) * pagination.per_page) + 1} to 
                        ${Math.min(pagination.current_page * pagination.per_page, pagination.total)} 
                        of ${pagination.total} users
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="loadUsers(${pagination.current_page - 1})" 
                                ${pagination.current_page <= 1 ? 'disabled' : ''} 
                                class="px-3 py-1 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded">
                            Previous
                        </button>
                        <span class="px-3 py-1 text-white">
                            Page ${pagination.current_page} of ${pagination.total_pages}
                        </span>
                        <button onclick="loadUsers(${pagination.current_page + 1})" 
                                ${pagination.current_page >= pagination.total_pages ? 'disabled' : ''} 
                                class="px-3 py-1 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded">
                            Next
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = paginationHTML;
        }

        // Open add user modal
        function openAddUserModal() {
            isEditing = false;
            document.getElementById('modal-title').textContent = 'Add New User';
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('password-section').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Save User';
            
            toggleAgentTypeSection();
            document.getElementById('user-modal').classList.remove('hidden');
            document.getElementById('user-modal').classList.add('flex');
        }

        // Edit user
        async function editUser(userId) {
            try {
                console.log('‚úèÔ∏è Loading user for editing:', userId);
                
                const response = await makeAuthenticatedRequest(`/api/admin/users/${userId}`);
                
                if (response.success) {
                    const user = response.user;
                    
                    isEditing = true;
                    document.getElementById('modal-title').textContent = 'Edit User';
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('first-name').value = user.first_name || '';
                    document.getElementById('last-name').value = user.last_name || '';
                    document.getElementById('username').value = user.username || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = user.phone || '';
                    document.getElementById('user-role').value = user.role || '';
                    document.getElementById('user-status').value = user.is_active ? '1' : '0';
                    
                    // Hide password field for editing
                    document.getElementById('password-section').style.display = 'none';
                    document.getElementById('password').required = false;
                    
                    // Set agent type if applicable
                    if (user.role === 'agent' && user.agent_type) {
                        document.getElementById('agent-type').value = user.agent_type;
                    }
                    
                    toggleAgentTypeSection();
                    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i>Update User';
                    
                    document.getElementById('user-modal').classList.remove('hidden');
                    document.getElementById('user-modal').classList.add('flex');
                    
                    console.log('‚úÖ User loaded for editing');
                } else {
                    throw new Error(response.message || 'Failed to load user');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading user for editing:', error);
                showToast('Failed to load user: ' + error.message, 'error');
            }
        }

        // Close user modal
        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('user-modal').classList.remove('flex');
            document.getElementById('user-form').reset();
        }

        // Toggle agent type section
        function toggleAgentTypeSection() {
            const roleSelect = document.getElementById('user-role');
            const agentTypeSection = document.getElementById('agent-type-section');
            const agentTypeSelect = document.getElementById('agent-type');
            
            if (roleSelect.value === 'agent') {
                agentTypeSection.classList.add('show');
                agentTypeSelect.required = true;
            } else {
                agentTypeSection.classList.remove('show');
                agentTypeSelect.required = false;
                agentTypeSelect.value = '';
            }
        }

        // Handle user form submission
        async function handleUserSubmit(event) {
            event.preventDefault();
            
            try {
                console.log('üíæ Submitting user form...');
                
                const formData = new FormData(event.target);
                const userData = Object.fromEntries(formData.entries());
                
                // Validate required fields
                if (!userData.first_name || !userData.last_name || !userData.username || !userData.email || !userData.role) {
                    throw new Error('Please fill in all required fields');
                }
                
                // Validate agent type for agents
                if (userData.role === 'agent' && !userData.agent_type) {
                    throw new Error('Please select an agent type');
                }
                
                // Validate email format
                if (!isValidEmail(userData.email)) {
                    throw new Error('Please enter a valid email address');
                }
                
                // Validate password for new users
                if (!isEditing && !userData.password) {
                    throw new Error('Password is required for new users');
                }
                
                const url = isEditing ? `/api/admin/users/${userData.user_id}` : '/api/admin/users';
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await makeAuthenticatedRequest(url, {
                    method: method,
                    body: JSON.stringify(userData)
                });
                
                if (response.success) {
                    showToast(
                        isEditing ? 'User updated successfully!' : 'User created successfully!', 
                        'success'
                    );
                    closeUserModal();
                    loadUsers(currentPage);
                    console.log('‚úÖ User saved successfully');
                } else {
                    throw new Error(response.message || 'Failed to save user');
                }
                
            } catch (error) {
                console.error('‚ùå Error saving user:', error);
                showToast('Failed to save user: ' + error.message, 'error');
            }
        }

        // Toggle user status
        async function toggleUserStatus(userId, newStatus) {
            try {
                const action = newStatus ? 'activate' : 'deactivate';
                const confirmed = confirm(`Are you sure you want to ${action} this user?`);
                
                if (!confirmed) return;
                
                console.log(`üîÑ ${action.charAt(0).toUpperCase() + action.slice(1)}ing user:`, userId);
                
                const response = await makeAuthenticatedRequest(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: newStatus ? 'active' : 'inactive',
                        reason: `User ${action}d by admin`
                    })
                });
                
                if (response.success) {
                    showToast(`User ${action}d successfully!`, 'success');
                    loadUsers(currentPage);
                    console.log(`‚úÖ User ${action}d successfully`);
                } else {
                    throw new Error(response.message || `Failed to ${action} user`);
                }
                
            } catch (error) {
                console.error(`‚ùå Error toggling user status:`, error);
                showToast('Failed to update user status: ' + error.message, 'error');
            }
        }

        // Export users
        function exportUsers() {
            if (!currentUsers || currentUsers.length === 0) {
                showToast('No users to export', 'warning');
                return;
            }
            
            const exportData = currentUsers.map(user => ({
                'First Name': user.first_name || '',
                'Last Name': user.last_name || '',
                'Username': user.username,
                'Email': user.email,
                'Phone': user.phone || '',
                'Role': user.role,
                'Agent Type': user.agent_type || '',
                'Status': user.is_active ? 'Active' : 'Inactive',
                'Created': new Date(user.created_at).toLocaleDateString()
            }));
            
            exportToCSV(exportData, `users_export_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Make functions globally available
        window.loadUsers = loadUsers;
        window.openAddUserModal = openAddUserModal;
        window.editUser = editUser;
        window.closeUserModal = closeUserModal;
        window.toggleAgentTypeSection = toggleAgentTypeSection;
        window.toggleUserStatus = toggleUserStatus;
        window.exportUsers = exportUsers;

        // Utility functions
        function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('token') || localStorage.getItem('authToken');
            
            if (!token) {
                throw new Error('No authentication token available');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const finalOptions = { ...defaultOptions, ...options };
            
            return fetch(url, finalOptions).then(async response => {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = '/apps/client/public/auth-admin.html';
                    throw new Error('Authentication failed');
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                return response.json();
            });
        }

        function showToast(message, type = 'info', duration = 3000) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full`;
            
            // Set background color based on type
            const bgColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.classList.add(bgColors[type] || bgColors.info);
            toast.textContent = message;
            
            // Add to DOM
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after duration
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Handle token expiry
        function handleTokenExpiry() {
            console.log('üîí Token expired, redirecting to login');
            localStorage.removeItem('adminToken');
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userInfo');
            showToast('Session expired. Please login again.', 'error');
            setTimeout(() => {
                window.location.href = '/auth/auth-admin.html';
            }, 2000);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function createErrorState(message, retryFunction) {
            return `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">Error Loading Data</h3>
                    <p class="text-white/70 mb-4">${message}</p>
                    <button onclick="${retryFunction}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-refresh mr-2"></i>Try Again
                    </button>
                </div>
            `;
        }

        function createEmptyState(icon, title, description, actionButton = '') {
            return `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-${icon} text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">${title}</h3>
                    <p class="text-white/70 mb-4">${description}</p>
                    ${actionButton}
                </div>
            `;
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header];
                    // Escape commas and quotes in CSV
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Data exported successfully!', 'success');
            }
        }

        console.log('‚úÖ User Management Enhanced initialized');
    </script>
</body>
</html>