<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Templates Management | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        :root {
            --primary-color: #080b3b;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .template-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .template-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .template-card.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-color);
        }
        .status-badge {
            @apply px-3 py-1 rounded-full text-xs font-medium;
        }
        .status-active { @apply bg-green-500/20 text-green-400; }
        .status-draft { @apply bg-yellow-500/20 text-yellow-400; }
        .status-inactive { @apply bg-gray-500/20 text-gray-400; }
        .template-type-badge {
            @apply px-2 py-1 rounded text-xs font-medium;
        }
        .type-transactional { @apply bg-blue-500/20 text-blue-400; }
        .type-marketing { @apply bg-green-500/20 text-green-400; }
        .type-system { @apply bg-purple-500/20 text-purple-400; }
        .type-notification { @apply bg-orange-500/20 text-orange-400; }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .template-tab {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .template-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .template-tab.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-color);
        }
        .live-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            display: inline-block;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .real-time-badge {
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-weight: 600;
        }
        /* Quill Editor Customization */
        .ql-toolbar.ql-snow {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            background: rgba(255, 255, 255, 0.05) !important;
        }
        .ql-container.ql-snow {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            background: rgba(255, 255, 255, 0.05) !important;
            color: white !important;
            font-family: inherit !important;
        }
        .ql-editor {
            color: white !important;
            min-height: 200px;
        }
        .ql-editor.ql-blank::before {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        .variable-tag {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .variable-tag:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }
        .preview-modal {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
        }
        .email-preview {
            background: white;
            color: #1f2937;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .template-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .quick-action-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .quick-action-btn:hover {
            transform: scale(1.1);
        }
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>

<body class="gradient-bg min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar w-64 lg:w-80 flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6 border-b border-white/10">
                <h2 class="text-xl font-bold text-white">Admin Panel</h2>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="payment-credentials.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-wallet"></i>
                    <span>Payment Credentials</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="order-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="categories.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tags"></i>
                    <span>Categories</span>
                </a>
                <a href="brands.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-trademark"></i>
                    <span>Brands</span>
                </a>
                <a href="reviews.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-star"></i>
                    <span>Reviews</span>
                </a>
                <a href="sellers.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-store"></i>
                    <span>Sellers</span>
                </a>
                <a href="support-tickets.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Support Tickets</span>
                </a>
                <a href="logs.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-file-alt"></i>
                    <span>System Logs</span>
                </a>
                <a href="promotions.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tags"></i>
                    <span>Promotions</span>
                </a>
                <a href="cms-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-edit"></i>
                    <span>CMS Management</span>
                </a>
                <a href="notification-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </a>
                <a href="backup-restore.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-database"></i>
                    <span>Backup & Restore</span>
                </a>
                <a href="security-api.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shield-alt"></i>
                    <span>Security & API</span>
                </a>
                <a href="performance-analytics.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-line"></i>
                    <span>Performance & Analytics</span>
                </a>
                <a href="system-integrations.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-plug"></i>
                    <span>System Integrations</span>
                </a>
                <a href="file-manager.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-folder-open"></i>
                    <span>File Manager</span>
                </a>
                <a href="email-templates.html" class="nav-item active flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-envelope-open-text"></i>
                    <span>Email Templates</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-auto">
            
            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2 flex items-center">
                        Email Templates Management
                        <span class="live-indicator ml-3"></span>
                        <span class="real-time-badge ml-2">Live</span>
                    </h1>
                    <p class="text-white/70">Create, manage, and customize email templates for automated communications</p>
                </div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button onclick="openTemplateModal()" class="bg-green-500 hover:bg-green-600 text-white px-3 sm:px-4 py-2 rounded-lg transition text-sm flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>New Template
                    </button>
                    <button onclick="importTemplates()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg transition text-sm flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>Import
                    </button>
                    <button onclick="refreshTemplates()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 sm:px-4 py-2 rounded-lg transition text-sm flex items-center justify-center">
                        <i class="fas fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Email Statistics -->
            <div class="template-stats mb-6">
                <div class="glass-morphism rounded-xl p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-white/70 text-sm">Total Templates</h3>
                        <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-envelope text-blue-400"></i>
                        </div>
                    </div>
                    <p class="text-white text-2xl font-bold" id="total-templates">24</p>
                    <p class="text-white/60 text-xs">+3 this week</p>
                </div>
                
                <div class="glass-morphism rounded-xl p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-white/70 text-sm">Active Templates</h3>
                        <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-400"></i>
                        </div>
                    </div>
                    <p class="text-white text-2xl font-bold" id="active-templates">18</p>
                    <p class="text-white/60 text-xs">75% active rate</p>
                </div>
                
                <div class="glass-morphism rounded-xl p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-white/70 text-sm">Emails Sent</h3>
                        <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-paper-plane text-purple-400"></i>
                        </div>
                    </div>
                    <p class="text-white text-2xl font-bold" id="emails-sent">12.4K</p>
                    <p class="text-white/60 text-xs">This month</p>
                </div>
                
                <div class="glass-morphism rounded-xl p-4 sm:p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-white/70 text-sm">Open Rate</h3>
                        <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-eye text-yellow-400"></i>
                        </div>
                    </div>
                    <p class="text-white text-2xl font-bold" id="open-rate">68.5%</p>
                    <p class="text-white/60 text-xs">+5.2% vs last month</p>
                </div>
            </div>

            <!-- Template Categories Tabs -->
            <div class="flex flex-wrap gap-2 mb-6">
                <div class="template-tab active" data-tab="all" onclick="switchTemplateTab('all')">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-list"></i>
                        <span class="text-white font-medium">All Templates</span>
                        <span id="all-count" class="text-white/50 text-sm">(24)</span>
                    </div>
                </div>
                <div class="template-tab" data-tab="transactional" onclick="switchTemplateTab('transactional')">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-receipt"></i>
                        <span class="text-white font-medium">Transactional</span>
                        <span id="transactional-count" class="text-white/50 text-sm">(12)</span>
                    </div>
                </div>
                <div class="template-tab" data-tab="marketing" onclick="switchTemplateTab('marketing')">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-bullhorn"></i>
                        <span class="text-white font-medium">Marketing</span>
                        <span id="marketing-count" class="text-white/50 text-sm">(8)</span>
                    </div>
                </div>
                <div class="template-tab" data-tab="system" onclick="switchTemplateTab('system')">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-cog"></i>
                        <span class="text-white font-medium">System</span>
                        <span id="system-count" class="text-white/50 text-sm">(4)</span>
                    </div>
                </div>
            </div>

            <!-- Templates Grid -->
            <div class="glass-morphism rounded-xl overflow-hidden">
                
                <!-- Search and Filter Bar -->
                <div class="p-4 sm:p-6 border-b border-white/10">
                    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center space-y-4 lg:space-y-0">
                        <!-- Search -->
                        <div class="relative flex-1 max-w-md">
                            <input type="text" id="template-search" 
                                   class="form-input pl-10 pr-4 py-3 rounded-lg w-full" 
                                   placeholder="Search email templates...">
                            <i class="fas fa-search absolute left-3 top-4 text-white/50"></i>
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex flex-wrap gap-2">
                            <div class="quick-action-btn bg-blue-500/20 text-blue-400" onclick="filterByType('transactional')" title="Transactional">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="quick-action-btn bg-green-500/20 text-green-400" onclick="filterByType('marketing')" title="Marketing">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="quick-action-btn bg-purple-500/20 text-purple-400" onclick="filterByType('system')" title="System">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div class="quick-action-btn bg-orange-500/20 text-orange-400" onclick="filterByType('notification')" title="Notifications">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="quick-action-btn bg-yellow-500/20 text-yellow-400" onclick="filterByStatus('active')" title="Active Only">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="quick-action-btn bg-gray-500/20 text-gray-400" onclick="clearFilters()" title="Clear Filters">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Templates Container -->
                <div id="templates-container" class="p-6">
                    <div class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white/70">Loading email templates...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="glass-morphism p-6 sm:p-8 rounded-xl max-w-6xl w-full mx-4 max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-white" id="modal-title">Create Email Template</h2>
                <button onclick="closeTemplateModal()" class="text-white/70 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="template-form" class="space-y-6">
                <!-- Template Basic Info -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Template Name *</label>
                        <input type="text" id="template-name" required 
                               class="w-full p-3 rounded-lg form-input" 
                               placeholder="e.g., Welcome Email">
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm mb-2">Template Type *</label>
                        <select id="template-type" required class="w-full p-3 rounded-lg form-input">
                            <option value="">Select Type</option>
                            <option value="transactional">Transactional</option>
                            <option value="marketing">Marketing</option>
                            <option value="system">System</option>
                            <option value="notification">Notification</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Subject Line *</label>
                        <input type="text" id="template-subject" required 
                               class="w-full p-3 rounded-lg form-input" 
                               placeholder="Email subject with {{variables}}">
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm mb-2">From Email</label>
                        <input type="email" id="template-from" 
                               class="w-full p-3 rounded-lg form-input" 
                               placeholder="noreply@yoursite.com">
                    </div>
                </div>

                <!-- Variable Tags -->
                <div>
                    <label class="block text-white/70 text-sm mb-3">Available Variables (Click to insert)</label>
                    <div class="flex flex-wrap gap-2 mb-4" id="variable-tags">
                        <span class="variable-tag" onclick="insertVariable('{{user_name}}')">{{user_name}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{user_email}}')">{{user_email}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{order_id}}')">{{order_id}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{order_total}}')">{{order_total}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{product_name}}')">{{product_name}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{site_name}}')">{{site_name}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{current_date}}')">{{current_date}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{verification_link}}')">{{verification_link}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{reset_link}}')">{{reset_link}}</span>
                        <span class="variable-tag" onclick="insertVariable('{{unsubscribe_link}}')">{{unsubscribe_link}}</span>
                    </div>
                </div>

                <!-- Email Content Editor -->
                <div>
                    <label class="block text-white/70 text-sm mb-2">Email Content *</label>
                    <div id="email-editor" style="height: 300px;"></div>
                    <input type="hidden" id="template-content">
                </div>

                <!-- Template Settings -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Status</label>
                        <select id="template-status" class="w-full p-3 rounded-lg form-input">
                            <option value="active">Active</option>
                            <option value="draft">Draft</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm mb-2">Language</label>
                        <select id="template-language" class="w-full p-3 rounded-lg form-input">
                            <option value="en">English</option>
                            <option value="fr">French</option>
                            <option value="rw">Kinyarwanda</option>
                            <option value="sw">Kiswahili</option>
                            <option value="ar">Arabic</option>
                            <option value="ha">Hausa</option>
                            <option value="yo">Yoruba</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-white/70 text-sm mb-2">Priority</label>
                        <select id="template-priority" class="w-full p-3 rounded-lg form-input">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 pt-6 border-t border-white/10">
                    <button type="submit" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Template
                    </button>
                    <button type="button" onclick="previewTemplate()" 
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        <i class="fas fa-eye mr-2"></i>Preview
                    </button>
                    <button type="button" onclick="testTemplate()" 
                            class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg">
                        <i class="fas fa-vial mr-2"></i>Test Send
                    </button>
                    <button type="button" onclick="closeTemplateModal()" 
                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 preview-modal hidden items-center justify-center z-50">
        <div class="relative max-w-4xl max-h-[90vh] w-full mx-4">
            <!-- Close Button -->
            <button onclick="closePreviewModal()" 
                    class="absolute -top-12 right-0 text-white/70 hover:text-white text-2xl z-10">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Preview Content -->
            <div class="email-preview p-8 max-h-[90vh] overflow-y-auto">
                <div class="border-b pb-4 mb-4">
                    <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                        <span>From: <span id="preview-from">noreply@yoursite.com</span></span>
                        <span id="preview-date">Today, 10:30 AM</span>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900" id="preview-subject">Email Subject</h2>
                </div>
                <div id="preview-content" class="prose max-w-none">
                    <!-- Email content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

<script>
    // Global variables
    let currentTab = 'all';
    let templatesData = [];
    let filteredTemplates = [];
    let emailEditor = null;
    let currentTemplateId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        console.log('✉️ Email Templates Management initializing...');
        
        // Check authentication first
        if (!checkAuthentication()) return;
        
        // Initialize rich text editor
        initializeEditor();
        
        // Load templates
        loadEmailTemplates();
        setupEventListeners();
        
        console.log('✅ Email Templates Management initialized');
    });

    // Check authentication
    function checkAuthentication() {
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');
        
        if (!token) {
            console.log('❌ No authentication token found');
            window.location.href = '/auth/auth-admin.html';
            return false;
        }
        
        if (userRole !== 'admin') {
            console.log('❌ Insufficient permissions');
            window.location.href = '/auth/auth-admin.html';
            return false;
        }
        
        console.log('✅ Authentication verified');
        return true;
    }

    // Initialize rich text editor
    function initializeEditor() {
        emailEditor = new Quill('#email-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['clean'],
                    ['link', 'image']
                ]
            },
            placeholder: 'Write your email content here...'
        });
    }

    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        document.getElementById('template-search').addEventListener('input', handleSearch);
        
        // Form submission
        document.getElementById('template-form').addEventListener('submit', handleTemplateSubmit);
    }

    // Load email templates
    async function loadEmailTemplates() {
        try {
            console.log('📧 Loading email templates...');
            
            // Mock email templates data
            const mockTemplates = [
                {
                    id: 1,
                    name: 'Welcome Email',
                    type: 'transactional',
                    subject: 'Welcome to {{site_name}}, {{user_name}}!',
                    content: '<h2>Welcome {{user_name}}!</h2><p>Thank you for joining {{site_name}}. We are excited to have you on board.</p>',
                    status: 'active',
                    language: 'en',
                    priority: 'normal',
                    from_email: 'welcome@africandeals.com',
                    created_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
                    updated_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                    usage_count: 1250,
                    open_rate: 75.5
                },
                {
                    id: 2,
                    name: 'Order Confirmation',
                    type: 'transactional',
                    subject: 'Order #{{order_id}} Confirmed - {{site_name}}',
                    content: '<h2>Order Confirmation</h2><p>Dear {{user_name}},</p><p>Your order #{{order_id}} for ${{order_total}} has been confirmed.</p>',
                    status: 'active',
                    language: 'en',
                    priority: 'high',
                    from_email: 'orders@africandeals.com',
                    created_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
                    updated_at: new Date(Date.now() - 2 * 60 * 60 * 1000),
                    usage_count: 3456,
                    open_rate: 89.2
                },
                {
                    id: 3,
                    name: 'Password Reset',
                    type: 'system',
                    subject: 'Reset Your Password - {{site_name}}',
                    content: '<h2>Password Reset Request</h2><p>Hi {{user_name}},</p><p>Click <a href="{{reset_link}}">here</a> to reset your password.</p>',
                    status: 'active',
                    language: 'en',
                    priority: 'urgent',
                    from_email: 'security@africandeals.com',
                    created_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000),
                    updated_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                    usage_count: 567,
                    open_rate: 92.3
                },
                {
                    id: 4,
                    name: 'Newsletter Signup',
                    type: 'marketing',
                    subject: 'Thank You for Subscribing!',
                    content: '<h2>Welcome to Our Newsletter</h2><p>Hi {{user_name}},</p><p>You will receive our weekly updates about new products and deals.</p>',
                    status: 'active',
                    language: 'en',
                    priority: 'normal',
                    from_email: 'newsletter@africandeals.com',
                    created_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000),
                    updated_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
                    usage_count: 890,
                    open_rate: 68.7
                },
                {
                    id: 5,
                    name: 'Shipping Notification',
                    type: 'notification',
                    subject: 'Your Order Has Shipped - {{order_id}}',
                    content: '<h2>Your Order is On The Way!</h2><p>Dear {{user_name}},</p><p>Your order #{{order_id}} has been shipped and is on its way to you.</p>',
                    status: 'active',
                    language: 'en',
                    priority: 'high',
                    from_email: 'shipping@africandeals.com',
                    created_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
                    updated_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                    usage_count: 2341,
                    open_rate: 85.1
                },
                {
                    id: 6,
                    name: 'Promotional Campaign',
                    type: 'marketing',
                    subject: 'Special Offer: 25% Off Everything!',
                    content: '<h2>Limited Time Offer</h2><p>Hi {{user_name}},</p><p>Get 25% off all products this weekend. Use code: SAVE25</p>',
                    status: 'draft',
                    language: 'en',
                    priority: 'normal',
                    from_email: 'promotions@africandeals.com',
                    created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                    updated_at: new Date(Date.now() - 1 * 60 * 60 * 1000),
                    usage_count: 0,
                    open_rate: 0
                }
            ];

            templatesData = mockTemplates;
            filteredTemplates = [...templatesData];
            
            renderTemplates();
            updateStatistics();
            
            console.log('✅ Email templates loaded successfully');

        } catch (error) {
            console.error('❌ Error loading email templates:', error);
            document.getElementById('templates-container').innerHTML = createErrorState(error.message, 'loadEmailTemplates()');
        }
    }

    // Render templates
    function renderTemplates() {
        const container = document.getElementById('templates-container');
        
        if (!filteredTemplates || filteredTemplates.length === 0) {
            container.innerHTML = createEmptyState(
                'templates', 
                'No Email Templates Found', 
                'Create your first email template to get started with automated communications.',
                `<button onclick="openTemplateModal()" class="mt-4 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>Create Template
                </button>`
            );
            return;
        }

        const templatesHTML = `
            <div class="template-grid">
                ${filteredTemplates.map(template => `
                    <div class="template-card glass-morphism rounded-lg p-6" data-template-id="${template.id}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="text-white font-semibold text-lg">${template.name}</h3>
                                    <span class="template-type-badge type-${template.type}">${formatTemplateType(template.type)}</span>
                                </div>
                                <p class="text-white/60 text-sm truncate" title="${template.subject}">${template.subject}</p>
                            </div>
                            <span class="status-badge status-${template.status}">${formatStatus(template.status)}</span>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-white/50">Language:</span>
                                    <span class="text-white ml-2">${template.language.toUpperCase()}</span>
                                </div>
                                <div>
                                    <span class="text-white/50">Priority:</span>
                                    <span class="text-white ml-2">${formatPriority(template.priority)}</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-white/50">Sent:</span>
                                    <span class="text-white ml-2">${template.usage_count.toLocaleString()}</span>
                                </div>
                                <div>
                                    <span class="text-white/50">Open Rate:</span>
                                    <span class="text-${template.open_rate > 70 ? 'green' : template.open_rate > 40 ? 'yellow' : 'red'}-400 ml-2">${template.open_rate}%</span>
                                </div>
                            </div>
                            
                            <div class="text-xs text-white/50">
                                Updated: ${formatTimeAgo(template.updated_at)}
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button onclick="editTemplate(${template.id})" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="previewTemplateById(${template.id})" 
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-eye mr-1"></i>Preview
                            </button>
                            <button onclick="duplicateTemplate(${template.id})" 
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteTemplate(${template.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        container.innerHTML = templatesHTML;
    }

    // Update statistics
    function updateStatistics() {
        document.getElementById('total-templates').textContent = templatesData.length;
        document.getElementById('active-templates').textContent = templatesData.filter(t => t.status === 'active').length;
        
        // Calculate total emails sent and average open rate
        const totalSent = templatesData.reduce((sum, t) => sum + t.usage_count, 0);
        const avgOpenRate = templatesData.reduce((sum, t) => sum + t.open_rate, 0) / templatesData.length;
        
        document.getElementById('emails-sent').textContent = totalSent > 1000 ? `${(totalSent / 1000).toFixed(1)}K` : totalSent;
        document.getElementById('open-rate').textContent = `${avgOpenRate.toFixed(1)}%`;
        
        // Update tab counts
        document.getElementById('all-count').textContent = `(${templatesData.length})`;
        document.getElementById('transactional-count').textContent = `(${templatesData.filter(t => t.type === 'transactional').length})`;
        document.getElementById('marketing-count').textContent = `(${templatesData.filter(t => t.type === 'marketing').length})`;
        document.getElementById('system-count').textContent = `(${templatesData.filter(t => t.type === 'system').length})`;
    }

    // Switch template tab
    function switchTemplateTab(tab) {
        currentTab = tab;
        
        // Update active tab
        document.querySelectorAll('.template-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
        
        // Filter templates
        if (tab === 'all') {
            filteredTemplates = [...templatesData];
        } else {
            filteredTemplates = templatesData.filter(template => template.type === tab);
        }
        
        renderTemplates();
    }

    // Search and filter functions
    function handleSearch() {
        const query = document.getElementById('template-search').value.toLowerCase();
        
        if (!query) {
            if (currentTab === 'all') {
                filteredTemplates = [...templatesData];
            } else {
                filteredTemplates = templatesData.filter(template => template.type === currentTab);
            }
        } else {
            let searchBase = currentTab === 'all' ? templatesData : templatesData.filter(t => t.type === currentTab);
            
            filteredTemplates = searchBase.filter(template => 
                template.name.toLowerCase().includes(query) ||
                template.subject.toLowerCase().includes(query) ||
                template.type.toLowerCase().includes(query)
            );
        }
        
        renderTemplates();
    }

    function filterByType(type) {
        switchTemplateTab(type);
        // Highlight active filter
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-white/30');
        });
        event.currentTarget.classList.add('ring-2', 'ring-white/30');
    }

    function filterByStatus(status) {
        filteredTemplates = templatesData.filter(template => template.status === status);
        renderTemplates();
        // Highlight active filter
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-white/30');
        });
        event.currentTarget.classList.add('ring-2', 'ring-white/30');
    }

    function clearFilters() {
        document.getElementById('template-search').value = '';
        switchTemplateTab('all');
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-white/30');
        });
    }

    // Template operations
    function openTemplateModal(templateId = null) {
        currentTemplateId = templateId;
        const modal = document.getElementById('template-modal');
        const title = document.getElementById('modal-title');
        
        if (templateId) {
            const template = templatesData.find(t => t.id === templateId);
            title.textContent = 'Edit Email Template';
            populateForm(template);
        } else {
            title.textContent = 'Create Email Template';
            clearForm();
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeTemplateModal() {
        document.getElementById('template-modal').classList.add('hidden');
        document.getElementById('template-modal').classList.remove('flex');
        clearForm();
        currentTemplateId = null;
    }

    function populateForm(template) {
        document.getElementById('template-name').value = template.name;
        document.getElementById('template-type').value = template.type;
        document.getElementById('template-subject').value = template.subject;
        document.getElementById('template-from').value = template.from_email;
        document.getElementById('template-status').value = template.status;
        document.getElementById('template-language').value = template.language;
        document.getElementById('template-priority').value = template.priority;
        
        // Set editor content
        emailEditor.root.innerHTML = template.content;
    }

    function clearForm() {
        document.getElementById('template-form').reset();
        emailEditor.root.innerHTML = '';
    }

    function insertVariable(variable) {
        const range = emailEditor.getSelection();
        if (range) {
            emailEditor.insertText(range.index, variable);
        } else {
            const length = emailEditor.getLength();
            emailEditor.insertText(length - 1, ' ' + variable + ' ');
        }
    }

    // Handle form submission
    async function handleTemplateSubmit(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('template-name').value,
            type: document.getElementById('template-type').value,
            subject: document.getElementById('template-subject').value,
            from_email: document.getElementById('template-from').value,
            content: emailEditor.root.innerHTML,
            status: document.getElementById('template-status').value,
            language: document.getElementById('template-language').value,
            priority: document.getElementById('template-priority').value
        };
        
        try {
            if (currentTemplateId) {
                showToast('Template updated successfully', 'success');
                console.log('Updating template:', currentTemplateId, formData);
            } else {
                showToast('Template created successfully', 'success');
                console.log('Creating template:', formData);
            }
            
            closeTemplateModal();
            loadEmailTemplates();
            
        } catch (error) {
            console.error('❌ Error saving template:', error);
            showToast('Error saving template: ' + error.message, 'error');
        }
    }

    // Preview functions
    function previewTemplate() {
        const subject = document.getElementById('template-subject').value || 'Email Subject';
        const fromEmail = document.getElementById('template-from').value || 'noreply@africandeals.com';
        const content = emailEditor.root.innerHTML;
        
        showPreview(subject, fromEmail, content);
    }

    function previewTemplateById(templateId) {
        const template = templatesData.find(t => t.id === templateId);
        if (template) {
            showPreview(template.subject, template.from_email, template.content);
        }
    }

    function showPreview(subject, fromEmail, content) {
        // Replace variables with sample data
        const sampleData = {
            '{{user_name}}': 'John Doe',
            '{{user_email}}': 'john@example.com',
            '{{order_id}}': '#12345',
            '{{order_total}}': '$125.99',
            '{{product_name}}': 'Sample Product',
            '{{site_name}}': 'African Deals',
            '{{current_date}}': new Date().toLocaleDateString(),
            '{{verification_link}}': 'https://africandeals.com/verify?token=sample',
            '{{reset_link}}': 'https://africandeals.com/reset?token=sample',
            '{{unsubscribe_link}}': 'https://africandeals.com/unsubscribe?token=sample'
        };
        
        let previewSubject = subject;
        let previewContent = content;
        
        Object.keys(sampleData).forEach(variable => {
            previewSubject = previewSubject.replace(new RegExp(variable, 'g'), sampleData[variable]);
            previewContent = previewContent.replace(new RegExp(variable, 'g'), sampleData[variable]);
        });
        
        document.getElementById('preview-from').textContent = fromEmail;
        document.getElementById('preview-subject').textContent = previewSubject;
        document.getElementById('preview-content').innerHTML = previewContent;
        document.getElementById('preview-date').textContent = new Date().toLocaleString();
        
        document.getElementById('preview-modal').classList.remove('hidden');
        document.getElementById('preview-modal').classList.add('flex');
    }

    function closePreviewModal() {
        document.getElementById('preview-modal').classList.add('hidden');
        document.getElementById('preview-modal').classList.remove('flex');
    }

    // Template operations
    function editTemplate(templateId) {
        openTemplateModal(templateId);
    }

    function duplicateTemplate(templateId) {
        const template = templatesData.find(t => t.id === templateId);
        if (template) {
            const newTemplate = {
                ...template,
                id: Date.now(),
                name: template.name + ' (Copy)',
                status: 'draft',
                usage_count: 0,
                open_rate: 0,
                created_at: new Date(),
                updated_at: new Date()
            };
            
            templatesData.unshift(newTemplate);
            filteredTemplates = [...templatesData];
            renderTemplates();
            updateStatistics();
            
            showToast('Template duplicated successfully', 'success');
        }
    }

    async function deleteTemplate(templateId) {
        if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
            return;
        }
        
        try {
            templatesData = templatesData.filter(t => t.id !== templateId);
            filteredTemplates = filteredTemplates.filter(t => t.id !== templateId);
            
            renderTemplates();
            updateStatistics();
            
            showToast('Template deleted successfully', 'success');
            
        } catch (error) {
            console.error('❌ Error deleting template:', error);
            showToast('Error deleting template: ' + error.message, 'error');
        }
    }

    function testTemplate() {
        const testEmail = prompt('Enter email address to send test email:');
        if (testEmail && testEmail.includes('@')) {
            showToast(`Test email sent to ${testEmail}`, 'success');
        }
    }

    function importTemplates() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const templates = JSON.parse(e.target.result);
                        console.log('Importing templates:', templates);
                        showToast(`Imported ${templates.length} templates successfully`, 'success');
                        loadEmailTemplates();
                    } catch (error) {
                        showToast('Error importing templates: Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // Utility functions
    function formatTemplateType(type) {
        const typeMap = {
            'transactional': 'Transactional',
            'marketing': 'Marketing',
            'system': 'System',
            'notification': 'Notification'
        };
        return typeMap[type] || type;
    }

    function formatStatus(status) {
        const statusMap = {
            'active': 'Active',
            'draft': 'Draft',
            'inactive': 'Inactive'
        };
        return statusMap[status] || status;
    }

    function formatPriority(priority) {
        const priorityMap = {
            'normal': 'Normal',
            'high': 'High',
            'urgent': 'Urgent'
        };
        return priorityMap[priority] || priority;
    }

    function formatTimeAgo(dateString) {
        if (!dateString) return 'Unknown';
        
        const now = new Date();
        const date = new Date(dateString);
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
        return date.toLocaleDateString();
    }

    function createEmptyState(type, title, description, actions = '') {
        return `
            <div class="text-center py-12">
                <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-envelope-open-text text-white/30 text-3xl"></i>
                </div>
                <h3 class="text-white text-xl font-semibold mb-2">${title}</h3>
                <p class="text-white/60 mb-6 max-w-md mx-auto">${description}</p>
                ${actions}
            </div>
        `;
    }

    function createErrorState(message, retry = null) {
        return `
            <div class="text-center py-12">
                <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-3xl"></i>
                </div>
                <h3 class="text-white text-xl font-semibold mb-2">Error Loading Templates</h3>
                <p class="text-white/60 mb-6 max-w-md mx-auto">${message}</p>
                ${retry ? `<button onclick="${retry}" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg"><i class="fas fa-refresh mr-2"></i>Try Again</button>` : ''}
            </div>
        `;
    }

    function showToast(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg text-white ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 
            type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
        }`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Make functions globally available
    window.switchTemplateTab = switchTemplateTab;
    window.filterByType = filterByType;
    window.filterByStatus = filterByStatus;
    window.clearFilters = clearFilters;
    window.openTemplateModal = openTemplateModal;
    window.closeTemplateModal = closeTemplateModal;
    window.closePreviewModal = closePreviewModal;
    window.editTemplate = editTemplate;
    window.previewTemplateById = previewTemplateById;
    window.duplicateTemplate = duplicateTemplate;
    window.deleteTemplate = deleteTemplate;
    window.previewTemplate = previewTemplate;
    window.testTemplate = testTemplate;
    window.importTemplates = importTemplates;
    window.insertVariable = insertVariable;
    window.refreshTemplates = loadEmailTemplates;

</script>

</body>
</html>