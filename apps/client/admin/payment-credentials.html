<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Credentials | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <style>
        :root {
            --primary-color: #080b3b;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--accent-color);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .credential-card {
            transition: all 0.3s ease;
        }
        
        .credential-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-enabled {
            background-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        .status-disabled {
            background-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approvals</span>
                </a>
                <a href="payment-credentials.html" class="nav-item active flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-wallet"></i>
                    <span>Payment Credentials</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="order-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="delivery-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-truck-loading"></i>
                    <span>Delivery Management</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                
                <!-- Logout -->
                <div class="mt-6 pt-6 border-t border-white/20">
                    <button onclick="logout()" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white w-full text-left hover:bg-red-500/20">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-auto">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">Payment Credentials</h1>
                    <p class="text-white/70">Manage mobile money and bank transfer payment credentials</p>
                </div>
                <div class="flex space-x-3">
                    <button id="testCredentialsBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-vial mr-2"></i>Test Credentials
                    </button>
                    <button id="saveCredentialsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </div>



            <!-- Loading State -->
            <div id="loadingState" class="glass-morphism rounded-xl p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"></div>
                <p class="text-white/70 mt-2">Loading payment credentials...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden glass-morphism rounded-xl p-6 mb-6 border-red-500/20">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-400 mr-3"></i>
                    <div>
                        <h3 class="text-red-300 font-medium">Error Loading Credentials</h3>
                        <p id="errorMessage" class="text-red-400 mt-1"></p>
                    </div>
                </div>
                <button id="retryBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-redo mr-2"></i>Retry
                </button>
            </div>

            <!-- Main Content -->
            <div id="mainContent" class="hidden space-y-6">
                <!-- Mobile Money Section -->
                <div class="glass-morphism rounded-xl">
                    <div class="px-6 py-4 border-b border-white/10">
                        <h3 class="text-lg font-medium text-white">
                            <i class="fas fa-mobile-alt text-green-400 mr-2"></i>
                            Mobile Money Credentials
                        </h3>
                        <p class="text-white/70 text-sm mt-1">Configure mobile money payment options</p>
                    </div>
                    <div class="p-6">
                        <div id="mobileMoneyCredentials" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Mobile money credentials will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Bank Transfer Section -->
                <div class="glass-morphism rounded-xl">
                    <div class="px-6 py-4 border-b border-white/10">
                        <h3 class="text-lg font-medium text-white">
                            <i class="fas fa-university text-blue-400 mr-2"></i>
                            Bank Transfer Credentials
                        </h3>
                        <p class="text-white/70 text-sm mt-1">Configure bank transfer payment options</p>
                    </div>
                    <div class="p-6">
                        <div id="bankTransferCredentials" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Bank transfer credentials will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage">Success!</span>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="hidden fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorToastMessage">Error!</span>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="testResultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-vial text-yellow-600 mr-2"></i>
                        Credential Test Results
                    </h3>
                    <button id="closeTestModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="testResultsContent" class="p-6">
                <!-- Test results will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        class PaymentCredentialsManager {
            constructor() {
                this.credentials = {};
                this.originalCredentials = {};
                this.hasChanges = false;
                this.init();
            }

            async init() {
                console.log('🔧 Initializing Payment Credentials Manager...');
                
                // Check authentication (use global AdminAuth if available)
                if (window.AdminAuth) {
                    const ok = window.AdminAuth.checkAuth();
                    if (!ok) return; // AdminAuth handles redirection
                } else {
                    if (!this.checkAuth()) {
                        const currentUrl = encodeURIComponent(window.location.href);
                        window.location.href = `/auth/auth-admin.html?redirect=${currentUrl}`;
                        return;
                    }
                }

                this.setupEventListeners();
                await this.loadCredentials();
            }

            checkAuth() {
                // Accept both legacy and unified storage keys
                const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
                const userStr = localStorage.getItem('user') || localStorage.getItem('userData') || localStorage.getItem('adminUser');
                
                if (!token || !userStr) {
                    console.log('❌ Authentication failed - missing token or user data');
                    return false;
                }
                
                try {
                    const userData = JSON.parse(userStr);
                    if (!userData || userData.role !== 'admin') {
                        console.log('❌ Insufficient permissions - not an admin');
                        return false;
                    }
                } catch (error) {
                    console.log('❌ Invalid user data format');
                    return false;
                }
                
                return true;
            }

            setupEventListeners() {
                // Save credentials button
                const saveBtn = document.getElementById('saveCredentialsBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.saveCredentials();
                    });
                }

                // Test credentials button
                const testBtn = document.getElementById('testCredentialsBtn');
                if (testBtn) {
                    testBtn.addEventListener('click', () => {
                        this.testCredentials();
                        // Also verify token in background (non-blocking)
                        try {
                            const t = localStorage.getItem('adminToken') || localStorage.getItem('token');
                            if (t && window.AdminAuth && window.AdminAuth.verifyToken) window.AdminAuth.verifyToken(t);
                        } catch (e) {}
                    });
                }

                // Retry button
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => {
                        this.loadCredentials();
                    });
                }

                // Close test modal
                const closeModalBtn = document.getElementById('closeTestModal');
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', () => {
                        const modal = document.getElementById('testResultsModal');
                        if (modal) {
                            modal.classList.add('hidden');
                        }
                    });
                }

                // Close modal on backdrop click
                const testModal = document.getElementById('testResultsModal');
                if (testModal) {
                    testModal.addEventListener('click', (e) => {
                        if (e.target.id === 'testResultsModal') {
                            testModal.classList.add('hidden');
                        }
                    });
                }
            }

            async loadCredentials() {
                try {
                    console.log('📡 Loading payment credentials...');
                    
                    this.showLoading();
                    this.hideError();

                    const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
                    const response = await fetch('/api/admin/payment-credentials', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to load credentials');
                    }

                    this.credentials = data.credentials;
                    this.originalCredentials = JSON.parse(JSON.stringify(data.credentials));
                    
                    console.log('✅ Payment credentials loaded:', this.credentials);
                    
                    this.renderCredentials();
                    this.showMainContent();

                } catch (error) {
                    console.error('❌ Error loading credentials:', error);
                    // If unauthorized, redirect to auth
                    if (error && (String(error.message).includes('401') || String(error.message).includes('403'))) {
                        this.handleAuthFailure?.() || (function(){
                            const currentUrl = encodeURIComponent(window.location.href);
                            window.location.href = `/auth/auth-admin.html?redirect=${currentUrl}`;
                        })();
                        return;
                    }
                    this.showError(error.message);
                }
            }

            renderCredentials() {
                this.renderMobileMoneyCredentials();
                this.renderBankTransferCredentials();
            }

            renderMobileMoneyCredentials() {
                const container = document.getElementById('mobileMoneyCredentials');
                if (!container) {
                    console.error('Mobile money credentials container not found');
                    return;
                }
                container.innerHTML = '';

                const mobileMoneyProviders = ['mtn', 'airtel', 'tigo'];
                
                mobileMoneyProviders.forEach(provider => {
                    const credential = this.credentials.mobile_money?.[provider] || {
                        phone: '',
                        account_name: '',
                        ussd_code: '',
                        enabled: false
                    };

                    const card = this.createMobileMoneyCard(provider, credential);
                    container.appendChild(card);
                });
            }

            createMobileMoneyCard(provider, credential) {
                const card = document.createElement('div');
                card.className = 'credential-card bg-gray-50 border border-gray-200 rounded-lg p-4';
                
                const providerName = provider.toUpperCase();
                const providerColors = {
                    mtn: 'text-yellow-600',
                    airtel: 'text-red-600',
                    tigo: 'text-blue-600'
                };

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-medium ${providerColors[provider]}">${providerName}</h4>
                        <label class="flex items-center">
                            <input type="checkbox" ${credential.enabled ? 'checked' : ''} 
                                   onchange="paymentManager.toggleCredential('mobile_money', '${provider}', this.checked)"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600">Enabled</span>
                        </label>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="text" value="${credential.phone || ''}" 
                                   onchange="paymentManager.updateCredentialField('mobile_money', '${provider}', 'phone', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="+250 XXX XXX XXX">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Name</label>
                            <input type="text" value="${credential.account_name || ''}" 
                                   onchange="paymentManager.updateCredentialField('mobile_money', '${provider}', 'account_name', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Account holder name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">USSD Code</label>
                            <input type="text" value="${credential.ussd_code || ''}" 
                                   onchange="paymentManager.updateCredentialField('mobile_money', '${provider}', 'ussd_code', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="*XXX#">
                        </div>
                    </div>
                `;

                return card;
            }

            renderBankTransferCredentials() {
                const container = document.getElementById('bankTransferCredentials');
                if (!container) {
                    console.error('Bank transfer credentials container not found');
                    return;
                }
                container.innerHTML = '';

                const bankProviders = ['primary', 'secondary'];
                
                bankProviders.forEach(provider => {
                    const credential = this.credentials.bank_transfer?.[provider] || {
                        bank_name: '',
                        account_name: '',
                        account_number: '',
                        swift_code: '',
                        branch: '',
                        enabled: false
                    };

                    const card = this.createBankTransferCard(provider, credential);
                    container.appendChild(card);
                });
            }

            createBankTransferCard(provider, credential) {
                const card = document.createElement('div');
                card.className = 'credential-card bg-gray-50 border border-gray-200 rounded-lg p-4';
                
                const providerName = provider === 'primary' ? 'Primary Bank' : 'Secondary Bank';

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-medium text-blue-600">${providerName}</h4>
                        <label class="flex items-center">
                            <input type="checkbox" ${credential.enabled ? 'checked' : ''} 
                                   onchange="paymentManager.toggleCredential('bank_transfer', '${provider}', this.checked)"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600">Enabled</span>
                        </label>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                            <input type="text" value="${credential.bank_name || ''}" 
                                   onchange="paymentManager.updateCredentialField('bank_transfer', '${provider}', 'bank_name', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Bank name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Name</label>
                            <input type="text" value="${credential.account_name || ''}" 
                                   onchange="paymentManager.updateCredentialField('bank_transfer', '${provider}', 'account_name', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Account holder name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                            <input type="text" value="${credential.account_number || ''}" 
                                   onchange="paymentManager.updateCredentialField('bank_transfer', '${provider}', 'account_number', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Account number">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">SWIFT Code</label>
                            <input type="text" value="${credential.swift_code || ''}" 
                                   onchange="paymentManager.updateCredentialField('bank_transfer', '${provider}', 'swift_code', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="SWIFT/BIC code">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                            <input type="text" value="${credential.branch || ''}" 
                                   onchange="paymentManager.updateCredentialField('bank_transfer', '${provider}', 'branch', this.value)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Branch name">
                        </div>
                    </div>
                `;

                return card;
            }

            toggleCredential(type, provider, enabled) {
                if (!this.credentials[type]) {
                    this.credentials[type] = {};
                }
                if (!this.credentials[type][provider]) {
                    this.credentials[type][provider] = {};
                }
                
                this.credentials[type][provider].enabled = enabled;
                this.markAsChanged();
                
                console.log(`🔄 Toggled ${type}/${provider}: ${enabled}`);
            }

            updateCredentialField(type, provider, field, value) {
                if (!this.credentials[type]) {
                    this.credentials[type] = {};
                }
                if (!this.credentials[type][provider]) {
                    this.credentials[type][provider] = {};
                }
                
                this.credentials[type][provider][field] = value;
                this.markAsChanged();
                
                console.log(`🔄 Updated ${type}/${provider}/${field}: ${value}`);
            }

            markAsChanged() {
                this.hasChanges = true;
                const saveBtn = document.getElementById('saveCredentialsBtn');
                if (saveBtn) {
                    saveBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                    saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Save Changes';
                }
            }

            handleAuthFailure() {
                console.warn('🔒 Authorization failed, redirecting to admin login...');
                try {
                    if (window.AdminAuth && window.AdminAuth.logout) {
                        window.AdminAuth.logout();
                        return;
                    }
                } catch (e) {}
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = `/auth/auth-admin.html?redirect=${currentUrl}`;
            }

            async saveCredentials() {
                try {
                    console.log('💾 Saving payment credentials...');
                    
                    const saveBtn = document.getElementById('saveCredentialsBtn');
                    if (!saveBtn) {
                        console.error('Save button not found');
                        return;
                    }
                    const originalContent = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    saveBtn.disabled = true;

                    const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
                    const response = await fetch('/api/admin/payment-credentials', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            credentials: this.credentials
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            this.handleAuthFailure();
                            return;
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to save credentials');
                    }

                    this.originalCredentials = JSON.parse(JSON.stringify(this.credentials));
                    this.hasChanges = false;
                    
                    // Reset save button
                    saveBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
                    saveBtn.disabled = false;
                    
                    setTimeout(() => {
                        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
                    }, 2000);

                    this.showSuccessToast('Payment credentials saved successfully!');
                    console.log('✅ Payment credentials saved successfully');

                } catch (error) {
                    console.error('❌ Error saving credentials:', error);
                    
                    const saveBtn = document.getElementById('saveCredentialsBtn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
                        saveBtn.disabled = false;
                    }
                    
                    this.showErrorToast(error.message);
                }
            }

            async testCredentials() {
                try {
                    console.log('🧪 Testing payment credentials...');
                    
                    const testBtn = document.getElementById('testCredentialsBtn');
                    if (!testBtn) {
                        console.error('Test button not found');
                        return;
                    }
                    const originalContent = testBtn.innerHTML;
                    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
                    testBtn.disabled = true;

                    const token = localStorage.getItem('adminToken') || localStorage.getItem('token');
                    const response = await fetch('/api/admin/payment-credentials/test', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            this.handleAuthFailure();
                            return;
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to test credentials');
                    }

                    this.showTestResults(data.results);
                    console.log('✅ Credential test completed:', data.results);

                } catch (error) {
                    console.error('❌ Error testing credentials:', error);
                    this.showErrorToast(error.message);
                } finally {
                    const testBtn = document.getElementById('testCredentialsBtn');
                    if (testBtn) {
                        testBtn.innerHTML = '<i class="fas fa-vial mr-2"></i>Test Credentials';
                        testBtn.disabled = false;
                    }
                }
            }

            showTestResults(results) {
                const modal = document.getElementById('testResultsModal');
                const content = document.getElementById('testResultsContent');
                
                if (!modal || !content) {
                    console.error('Test results modal or content not found');
                    return;
                }
                
                let html = `
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <h4 class="text-lg font-medium text-gray-900">Test Summary</h4>
                            <div class="flex space-x-4">
                                <span class="text-green-600 font-medium">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    ${results.summary.passed} Passed
                                </span>
                                <span class="text-red-600 font-medium">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    ${results.summary.failed} Failed
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                // Mobile Money Results
                if (results.mobile_money && Object.keys(results.mobile_money).length > 0) {
                    html += `
                        <div class="mb-6">
                            <h5 class="text-md font-medium text-gray-800 mb-3">
                                <i class="fas fa-mobile-alt text-green-600 mr-2"></i>
                                Mobile Money Results
                            </h5>
                            <div class="space-y-3">
                    `;
                    
                    Object.entries(results.mobile_money).forEach(([provider, result]) => {
                        const statusClass = result.status === 'passed' ? 'text-green-600' : 'text-red-600';
                        const statusIcon = result.status === 'passed' ? 'fa-check-circle' : 'fa-times-circle';
                        
                        html += `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-900">${provider.toUpperCase()}</span>
                                    <span class="${statusClass}">
                                        <i class="fas ${statusIcon} mr-1"></i>
                                        ${result.status.toUpperCase()}
                                    </span>
                                </div>
                                <p class="text-gray-600 text-sm">${result.message}</p>
                                ${result.checks && result.checks.length > 0 ? `
                                    <ul class="mt-2 text-sm text-red-600">
                                        ${result.checks.map(check => `<li>• ${check}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }

                // Bank Transfer Results
                if (results.bank_transfer && Object.keys(results.bank_transfer).length > 0) {
                    html += `
                        <div class="mb-6">
                            <h5 class="text-md font-medium text-gray-800 mb-3">
                                <i class="fas fa-university text-blue-600 mr-2"></i>
                                Bank Transfer Results
                            </h5>
                            <div class="space-y-3">
                    `;
                    
                    Object.entries(results.bank_transfer).forEach(([provider, result]) => {
                        const statusClass = result.status === 'passed' ? 'text-green-600' : 'text-red-600';
                        const statusIcon = result.status === 'passed' ? 'fa-check-circle' : 'fa-times-circle';
                        const providerName = provider === 'primary' ? 'Primary Bank' : 'Secondary Bank';
                        
                        html += `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-900">${providerName}</span>
                                    <span class="${statusClass}">
                                        <i class="fas ${statusIcon} mr-1"></i>
                                        ${result.status.toUpperCase()}
                                    </span>
                                </div>
                                <p class="text-gray-600 text-sm">${result.message}</p>
                                ${result.checks && result.checks.length > 0 ? `
                                    <ul class="mt-2 text-sm text-red-600">
                                        ${result.checks.map(check => `<li>• ${check}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }

                content.innerHTML = html;
                modal.classList.remove('hidden');
            }

            showLoading() {
                const loadingState = document.getElementById('loadingState');
                const mainContent = document.getElementById('mainContent');
                const errorState = document.getElementById('errorState');
                
                if (loadingState) loadingState.classList.remove('hidden');
                if (mainContent) mainContent.classList.add('hidden');
                if (errorState) errorState.classList.add('hidden');
            }

            showMainContent() {
                const loadingState = document.getElementById('loadingState');
                const mainContent = document.getElementById('mainContent');
                const errorState = document.getElementById('errorState');
                
                if (loadingState) loadingState.classList.add('hidden');
                if (mainContent) mainContent.classList.remove('hidden');
                if (errorState) errorState.classList.add('hidden');
            }

            showError(message) {
                const loadingState = document.getElementById('loadingState');
                const mainContent = document.getElementById('mainContent');
                const errorState = document.getElementById('errorState');
                const errorMessage = document.getElementById('errorMessage');
                
                if (loadingState) loadingState.classList.add('hidden');
                if (mainContent) mainContent.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
                if (errorMessage) errorMessage.textContent = message;
            }

            hideError() {
                const errorState = document.getElementById('errorState');
                if (errorState) errorState.classList.add('hidden');
            }

            showSuccessToast(message) {
                const toast = document.getElementById('successToast');
                const successMessage = document.getElementById('successMessage');
                
                if (toast && successMessage) {
                    successMessage.textContent = message;
                    toast.classList.remove('hidden');
                    
                    setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 3000);
                }
            }

            showErrorToast(message) {
                const toast = document.getElementById('errorToast');
                const errorToastMessage = document.getElementById('errorToastMessage');
                
                if (toast && errorToastMessage) {
                    errorToastMessage.textContent = message;
                    toast.classList.remove('hidden');
                    
                    setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 5000);
                }
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/admin/auth-admin.html';
            }
        }

        // Initialize the payment credentials manager
        const paymentManager = new PaymentCredentialsManager();
    </script>
</body>
</html>