<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Payment Management - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/public/css/admin.css" rel="stylesheet">
    <style>
        .payment-card {
            transition: transform 0.2s;
        }
        .payment-card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .amount-highlight {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .referral-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
        .action-buttons .btn {
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <!-- Admin Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-cog"></i> Admin Panel
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders">
                            <i class="fas fa-shopping-bag"></i> Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/referral-payments">
                            <i class="fas fa-dollar-sign"></i> Referral Payments
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-dollar-sign text-success"></i> Referral Payment Management</h2>
                        <p class="text-muted">Review and approve referral commission payments</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="loadPendingPayments()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <div>
                                <h4 class="mb-0" id="pendingCount">0</h4>
                                <small>Pending Payments</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-dollar-sign fa-2x"></i>
                            </div>
                            <div>
                                <h4 class="mb-0">$<span id="pendingAmount">0.00</span></h4>
                                <small>Total Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                            <div>
                                <h4 class="mb-0" id="approvedToday">0</h4>
                                <small>Approved Today</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                            <div>
                                <h4 class="mb-0">$<span id="monthlyTotal">0.00</span></h4>
                                <small>This Month</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading pending payments...</p>
        </div>

        <!-- Pending Payments -->
        <div id="paymentsContainer" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Pending Referral Payments
                    </h5>
                </div>
                <div class="card-body">
                    <div id="pendingPaymentsList">
                        <!-- Payments will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
            <h4>All Caught Up!</h4>
            <p class="text-muted">No pending referral payments at the moment.</p>
        </div>
    </div>

    <!-- Payment Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i> Review Referral Payment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="paymentDetails">
                        <!-- Payment details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="processPayment('reject')">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button type="button" class="btn btn-success" onclick="processPayment('approve')">
                        <i class="fas fa-check"></i> Approve & Pay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div class="modal fade" id="bulkActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-tasks"></i> Bulk Actions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Select an action for the selected payments:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="bulkApprove()">
                            <i class="fas fa-check"></i> Approve All Selected
                        </button>
                        <button class="btn btn-danger" onclick="bulkReject()">
                            <i class="fas fa-times"></i> Reject All Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../public/js/auth.js"></script>
    <script>
        let pendingPayments = [];
        let selectedPayments = new Set();
        let currentReviewPayment = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
            loadPendingPayments();
        });

        async function loadPendingPayments() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('paymentsContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';

                const response = await fetch('/api/referrals/admin/pending-payments', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    pendingPayments = data.pending_payments;
                    updateSummaryCards(data);
                    displayPendingPayments(data.pending_payments);
                } else {
                    throw new Error(data.error || 'Failed to load pending payments');
                }
            } catch (error) {
                console.error('Error loading pending payments:', error);
                showError('Failed to load pending payments: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateSummaryCards(data) {
            document.getElementById('pendingCount').textContent = data.pending_payments.length;
            document.getElementById('pendingAmount').textContent = data.total_amount.toFixed(2);
            
            // Calculate today's approvals and monthly total (mock data for now)
            document.getElementById('approvedToday').textContent = '0'; // Would come from API
            document.getElementById('monthlyTotal').textContent = '0.00'; // Would come from API
        }

        function displayPendingPayments(payments) {
            const container = document.getElementById('pendingPaymentsList');
            
            if (payments.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('paymentsContainer').style.display = 'block';

            const paymentsHtml = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                <i class="fas fa-square"></i> Clear Selection
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="openBulkActions()" disabled id="bulkActionsBtn">
                                <i class="fas fa-tasks"></i> Bulk Actions (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                </div>
                ${payments.map(payment => createPaymentCard(payment)).join('')}
            `;

            container.innerHTML = paymentsHtml;
        }

        function createPaymentCard(payment) {
            const requestedDate = new Date(payment.payment_requested_at).toLocaleDateString();
            const completedDate = new Date(payment.completed_at).toLocaleDateString();
            
            return `
                <div class="payment-card card mb-3" data-payment-id="${payment.id}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input payment-checkbox" type="checkbox" 
                                           value="${payment.id}" onchange="updateSelection()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="referral-info">
                                    <h6 class="mb-1">
                                        <i class="fas fa-user text-primary"></i>
                                        ${payment.referrer_name}
                                    </h6>
                                    <small class="text-muted">${payment.referrer_email}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-info status-badge">
                                            ${payment.bonus_type === 'product_share' ? 'Product Share' : 'General Referral'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div>
                                    <strong>Referred:</strong> ${payment.referee_name || 'N/A'}<br>
                                    <small class="text-muted">${payment.referee_email || ''}</small>
                                    ${payment.product_name ? `<br><strong>Product:</strong> ${payment.product_name}` : ''}
                                    ${payment.order_number ? `<br><strong>Order:</strong> ${payment.order_number}` : ''}
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="amount-highlight text-success">
                                    $${parseFloat(payment.bonus_earned).toFixed(2)}
                                </div>
                                <small class="text-muted">Commission</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <div>
                                    <small class="text-muted">Requested:</small><br>
                                    <strong>${requestedDate}</strong>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="reviewPayment(${payment.id})" title="Review Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateSelection() {
            selectedPayments.clear();
            document.querySelectorAll('.payment-checkbox:checked').forEach(checkbox => {
                selectedPayments.add(parseInt(checkbox.value));
            });
            
            document.getElementById('selectedCount').textContent = selectedPayments.size;
            document.getElementById('bulkActionsBtn').disabled = selectedPayments.size === 0;
        }

        function selectAll() {
            document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelection();
        }

        function clearSelection() {
            document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelection();
        }

        function reviewPayment(paymentId) {
            const payment = pendingPayments.find(p => p.id === paymentId);
            if (!payment) return;

            currentReviewPayment = payment;
            
            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user"></i> Referrer Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${payment.referrer_name}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${payment.referrer_email}</td></tr>
                            <tr><td><strong>Referral Code:</strong></td><td><code>${payment.referral_code}</code></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-user-plus"></i> Referee Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${payment.referee_name || 'N/A'}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${payment.referee_email || 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-shopping-bag"></i> Order Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Order Number:</strong></td><td>${payment.order_number || 'N/A'}</td></tr>
                            <tr><td><strong>Order Amount:</strong></td><td>$${parseFloat(payment.order_amount || 0).toFixed(2)}</td></tr>
                            <tr><td><strong>Product:</strong></td><td>${payment.product_name || 'N/A'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-dollar-sign"></i> Payment Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Commission:</strong></td><td class="text-success"><strong>$${parseFloat(payment.bonus_earned).toFixed(2)}</strong></td></tr>
                            <tr><td><strong>Type:</strong></td><td>${payment.bonus_type === 'product_share' ? 'Product Share' : 'General Referral'}</td></tr>
                            <tr><td><strong>Requested:</strong></td><td>${new Date(payment.payment_requested_at).toLocaleString()}</td></tr>
                            <tr><td><strong>Completed:</strong></td><td>${new Date(payment.completed_at).toLocaleString()}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Review Notes:</strong> Please verify that the referral was legitimate and the order was completed successfully before approving payment.
                </div>
            `;

            document.getElementById('paymentDetails').innerHTML = detailsHtml;
            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        }

        async function processPayment(action) {
            if (!currentReviewPayment) return;

            try {
                const response = await fetch('/api/referrals/admin/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        referral_id: currentReviewPayment.id,
                        action: action,
                        admin_notes: `Payment ${action}d by admin`
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Payment ${action}d successfully!`);
                    bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                    loadPendingPayments(); // Reload the list
                } else {
                    throw new Error(data.error || `Failed to ${action} payment`);
                }
            } catch (error) {
                console.error(`Error ${action}ing payment:`, error);
                showError(`Failed to ${action} payment: ` + error.message);
            }
        }

        function openBulkActions() {
            if (selectedPayments.size === 0) return;
            
            const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
            modal.show();
        }

        async function bulkApprove() {
            await processBulkAction('approve');
        }

        async function bulkReject() {
            await processBulkAction('reject');
        }

        async function processBulkAction(action) {
            if (selectedPayments.size === 0) return;

            try {
                const promises = Array.from(selectedPayments).map(paymentId => 
                    fetch('/api/referrals/admin/process-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            referral_id: paymentId,
                            action: action,
                            admin_notes: `Bulk ${action} by admin`
                        })
                    })
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                const successful = results.filter(r => r.success).length;
                const failed = results.length - successful;

                if (successful > 0) {
                    showSuccess(`${successful} payments ${action}d successfully!`);
                }
                if (failed > 0) {
                    showError(`${failed} payments failed to ${action}`);
                }

                bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
                clearSelection();
                loadPendingPayments(); // Reload the list

            } catch (error) {
                console.error(`Error in bulk ${action}:`, error);
                showError(`Failed to ${action} payments: ` + error.message);
            }
        }

        function checkAdminAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.role !== 'admin') {
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                window.location.href = '/admin/login';
                return;
            }
        }

        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            const bootstrapToast = new bootstrap.Toast(toast);
            bootstrapToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            const bootstrapToast = new bootstrap.Toast(toast);
            bootstrapToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/admin/login';
        }
    </script>
</body>
</html>