<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Credentials Management | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        :root {
            --primary-color: #080b3b;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid var(--accent-color);
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
            outline: none;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .credential-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .credential-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid var(--accent-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.success {
            background: #10b981;
        }
        
        .notification.info {
            background: #3b82f6;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="order-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="payment-credentials-management.html" class="nav-item active flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Credentials</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-check-circle"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Header -->
            <div class="glass-morphism p-6 border-b border-white/10">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Payment Credentials Management</h1>
                        <p class="text-white/70 mt-1">Manage mobile money and bank transfer payment credentials</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="save-all-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-save mr-2"></i>Save All Changes
                        </button>
                        <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6">
                <!-- Mobile Money Credentials -->
                <div class="glass-morphism rounded-xl p-6">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-mobile-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">Mobile Money Credentials</h2>
                            <p class="text-white/70">Configure mobile money payment accounts</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- MTN Mobile Money -->
                        <div class="credential-card rounded-lg p-4">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white font-bold text-xs">MTN</span>
                                </div>
                                <h3 class="text-lg font-semibold text-white">MTN Mobile Money</h3>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Phone Number</label>
                                    <input type="tel" id="mtn-phone" class="form-input w-full px-3 py-2 rounded-lg" placeholder="+250 788 123 456">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Name</label>
                                    <input type="text" id="mtn-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="African Deals Domain">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">USSD Code</label>
                                    <input type="text" id="mtn-code" class="form-input w-full px-3 py-2 rounded-lg" placeholder="*182*8*1#">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="mtn-enabled" class="mr-2">
                                    <label for="mtn-enabled" class="text-white/80 text-sm">Enable MTN Mobile Money</label>
                                </div>
                            </div>
                        </div>

                        <!-- Airtel Money -->
                        <div class="credential-card rounded-lg p-4">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white font-bold text-xs">AIR</span>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Airtel Money</h3>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Phone Number</label>
                                    <input type="tel" id="airtel-phone" class="form-input w-full px-3 py-2 rounded-lg" placeholder="+250 733 456 789">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Name</label>
                                    <input type="text" id="airtel-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="African Deals Domain">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">USSD Code</label>
                                    <input type="text" id="airtel-code" class="form-input w-full px-3 py-2 rounded-lg" placeholder="*500*2*1#">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="airtel-enabled" class="mr-2">
                                    <label for="airtel-enabled" class="text-white/80 text-sm">Enable Airtel Money</label>
                                </div>
                            </div>
                        </div>

                        <!-- Tigo Cash -->
                        <div class="credential-card rounded-lg p-4">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white font-bold text-xs">TIG</span>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Tigo Cash</h3>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Phone Number</label>
                                    <input type="tel" id="tigo-phone" class="form-input w-full px-3 py-2 rounded-lg" placeholder="+250 722 789 012">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Name</label>
                                    <input type="text" id="tigo-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="African Deals Domain">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">USSD Code</label>
                                    <input type="text" id="tigo-code" class="form-input w-full px-3 py-2 rounded-lg" placeholder="*505#">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="tigo-enabled" class="mr-2">
                                    <label for="tigo-enabled" class="text-white/80 text-sm">Enable Tigo Cash</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bank Transfer Credentials -->
                <div class="glass-morphism rounded-xl p-6">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-university text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">Bank Transfer Credentials</h2>
                            <p class="text-white/70">Configure bank account details for transfers</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Primary Bank Account -->
                        <div class="credential-card rounded-lg p-4">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-university text-white text-xs"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Primary Bank Account</h3>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Bank Name</label>
                                    <input type="text" id="primary-bank-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="Bank of Kigali">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Name</label>
                                    <input type="text" id="primary-account-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="African Deals Domain Ltd">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Number</label>
                                    <input type="text" id="primary-account-number" class="form-input w-full px-3 py-2 rounded-lg" placeholder="00123456789">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">SWIFT Code</label>
                                    <input type="text" id="primary-swift-code" class="form-input w-full px-3 py-2 rounded-lg" placeholder="BKGLRWRW">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Branch</label>
                                    <input type="text" id="primary-branch" class="form-input w-full px-3 py-2 rounded-lg" placeholder="Kigali Main Branch">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="primary-enabled" class="mr-2">
                                    <label for="primary-enabled" class="text-white/80 text-sm">Enable Primary Account</label>
                                </div>
                            </div>
                        </div>

                        <!-- Secondary Bank Account -->
                        <div class="credential-card rounded-lg p-4">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-university text-white text-xs"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white">Alternative Bank Account</h3>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Bank Name</label>
                                    <input type="text" id="secondary-bank-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="Equity Bank Rwanda">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Name</label>
                                    <input type="text" id="secondary-account-name" class="form-input w-full px-3 py-2 rounded-lg" placeholder="African Deals Domain Ltd">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Account Number</label>
                                    <input type="text" id="secondary-account-number" class="form-input w-full px-3 py-2 rounded-lg" placeholder="40012345678">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">SWIFT Code</label>
                                    <input type="text" id="secondary-swift-code" class="form-input w-full px-3 py-2 rounded-lg" placeholder="EQBLRWRW">
                                </div>
                                <div>
                                    <label class="block text-white/80 text-sm font-medium mb-1">Branch</label>
                                    <input type="text" id="secondary-branch" class="form-input w-full px-3 py-2 rounded-lg" placeholder="Kigali City Branch">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="secondary-enabled" class="mr-2">
                                    <label for="secondary-enabled" class="text-white/80 text-sm">Enable Alternative Account</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status and Actions -->
                <div class="glass-morphism rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-white">System Status</h3>
                            <p class="text-white/70 text-sm">Last updated: <span id="last-updated">Never</span></p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="test-credentials-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-vial mr-2"></i>Test Credentials
                            </button>
                            <button id="reset-defaults-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-undo mr-2"></i>Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Processing...</p>
        </div>
    </div>

    <script>
        class PaymentCredentialsManager {
            constructor() {
                this.credentials = {
                    mobile_money: {
                        mtn: { phone: '', account_name: '', ussd_code: '', enabled: false },
                        airtel: { phone: '', account_name: '', ussd_code: '', enabled: false },
                        tigo: { phone: '', account_name: '', ussd_code: '', enabled: false }
                    },
                    bank_transfer: {
                        primary: { bank_name: '', account_name: '', account_number: '', swift_code: '', branch: '', enabled: false },
                        secondary: { bank_name: '', account_name: '', account_number: '', swift_code: '', branch: '', enabled: false }
                    }
                };
                this.init();
            }

            async init() {
                try {
                    console.log('ðŸš€ Initializing Payment Credentials Manager...');
                    
                    // Check authentication
                    this.checkAuthentication();
                    
                    // Load current credentials
                    await this.loadCredentials();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    console.log('âœ… Payment Credentials Manager initialized successfully');
                } catch (error) {
                    console.error('âŒ Error initializing Payment Credentials Manager:', error);
                    this.showNotification('Failed to initialize payment credentials manager', 'error');
                }
            }

            checkAuthentication() {
                const token = localStorage.getItem('authToken');
                const userData = localStorage.getItem('userData');
                
                if (!token || !userData) {
                    window.location.href = '/auth/auth-admin.html';
                    return;
                }
                
                try {
                    const user = JSON.parse(userData);
                    if (user.role !== 'admin') {
                        window.location.href = '/auth/auth-admin.html';
                        return;
                    }
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    window.location.href = '/auth/auth-admin.html';
                }
            }

            async loadCredentials() {
                try {
                    console.log('ðŸ”„ Loading payment credentials...');
                    
                    const response = await fetch('/api/admin/payment-credentials', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken') || localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… Payment credentials loaded:', data);
                        
                        if (data.success && data.credentials) {
                            this.credentials = data.credentials;
                            this.populateForm();
                            this.updateLastUpdated(data.last_updated);
                        }
                    } else {
                        console.warn('âš ï¸ Failed to load payment credentials, using defaults');
                        this.populateForm(); // Load with default values
                    }
                } catch (error) {
                    console.error('âŒ Error loading payment credentials:', error);
                    this.showNotification('Failed to load payment credentials', 'error');
                }
            }

            populateForm() {
                // Mobile Money credentials
                const mobileCredentials = this.credentials.mobile_money;
                
                // MTN
                document.getElementById('mtn-phone').value = mobileCredentials.mtn.phone || '+250 788 123 456';
                document.getElementById('mtn-name').value = mobileCredentials.mtn.account_name || 'African Deals Domain';
                document.getElementById('mtn-code').value = mobileCredentials.mtn.ussd_code || '*182*8*1#';
                document.getElementById('mtn-enabled').checked = mobileCredentials.mtn.enabled || false;
                
                // Airtel
                document.getElementById('airtel-phone').value = mobileCredentials.airtel.phone || '+250 733 456 789';
                document.getElementById('airtel-name').value = mobileCredentials.airtel.account_name || 'African Deals Domain';
                document.getElementById('airtel-code').value = mobileCredentials.airtel.ussd_code || '*500*2*1#';
                document.getElementById('airtel-enabled').checked = mobileCredentials.airtel.enabled || false;
                
                // Tigo
                document.getElementById('tigo-phone').value = mobileCredentials.tigo.phone || '+250 722 789 012';
                document.getElementById('tigo-name').value = mobileCredentials.tigo.account_name || 'African Deals Domain';
                document.getElementById('tigo-code').value = mobileCredentials.tigo.ussd_code || '*505#';
                document.getElementById('tigo-enabled').checked = mobileCredentials.tigo.enabled || false;

                // Bank Transfer credentials
                const bankCredentials = this.credentials.bank_transfer;
                
                // Primary Bank
                document.getElementById('primary-bank-name').value = bankCredentials.primary.bank_name || 'Bank of Kigali';
                document.getElementById('primary-account-name').value = bankCredentials.primary.account_name || 'African Deals Domain Ltd';
                document.getElementById('primary-account-number').value = bankCredentials.primary.account_number || '00123456789';
                document.getElementById('primary-swift-code').value = bankCredentials.primary.swift_code || 'BKGLRWRW';
                document.getElementById('primary-branch').value = bankCredentials.primary.branch || 'Kigali Main Branch';
                document.getElementById('primary-enabled').checked = bankCredentials.primary.enabled || false;
                
                // Secondary Bank
                document.getElementById('secondary-bank-name').value = bankCredentials.secondary.bank_name || 'Equity Bank Rwanda';
                document.getElementById('secondary-account-name').value = bankCredentials.secondary.account_name || 'African Deals Domain Ltd';
                document.getElementById('secondary-account-number').value = bankCredentials.secondary.account_number || '40012345678';
                document.getElementById('secondary-swift-code').value = bankCredentials.secondary.swift_code || 'EQBLRWRW';
                document.getElementById('secondary-branch').value = bankCredentials.secondary.branch || 'Kigali City Branch';
                document.getElementById('secondary-enabled').checked = bankCredentials.secondary.enabled || false;
            }

            setupEventListeners() {
                // Save all changes
                document.getElementById('save-all-btn').addEventListener('click', () => {
                    this.saveCredentials();
                });

                // Refresh data
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.loadCredentials();
                });

                // Test credentials
                document.getElementById('test-credentials-btn').addEventListener('click', () => {
                    this.testCredentials();
                });

                // Reset to defaults
                document.getElementById('reset-defaults-btn').addEventListener('click', () => {
                    this.resetToDefaults();
                });
            }

            async saveCredentials() {
                try {
                    console.log('ðŸ’¾ Saving payment credentials...');
                    
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.remove('hidden');

                    // Collect form data
                    const credentials = {
                        mobile_money: {
                            mtn: {
                                phone: document.getElementById('mtn-phone').value.trim(),
                                account_name: document.getElementById('mtn-name').value.trim(),
                                ussd_code: document.getElementById('mtn-code').value.trim(),
                                enabled: document.getElementById('mtn-enabled').checked
                            },
                            airtel: {
                                phone: document.getElementById('airtel-phone').value.trim(),
                                account_name: document.getElementById('airtel-name').value.trim(),
                                ussd_code: document.getElementById('airtel-code').value.trim(),
                                enabled: document.getElementById('airtel-enabled').checked
                            },
                            tigo: {
                                phone: document.getElementById('tigo-phone').value.trim(),
                                account_name: document.getElementById('tigo-name').value.trim(),
                                ussd_code: document.getElementById('tigo-code').value.trim(),
                                enabled: document.getElementById('tigo-enabled').checked
                            }
                        },
                        bank_transfer: {
                            primary: {
                                bank_name: document.getElementById('primary-bank-name').value.trim(),
                                account_name: document.getElementById('primary-account-name').value.trim(),
                                account_number: document.getElementById('primary-account-number').value.trim(),
                                swift_code: document.getElementById('primary-swift-code').value.trim(),
                                branch: document.getElementById('primary-branch').value.trim(),
                                enabled: document.getElementById('primary-enabled').checked
                            },
                            secondary: {
                                bank_name: document.getElementById('secondary-bank-name').value.trim(),
                                account_name: document.getElementById('secondary-account-name').value.trim(),
                                account_number: document.getElementById('secondary-account-number').value.trim(),
                                swift_code: document.getElementById('secondary-swift-code').value.trim(),
                                branch: document.getElementById('secondary-branch').value.trim(),
                                enabled: document.getElementById('secondary-enabled').checked
                            }
                        }
                    };

                    const response = await fetch('/api/admin/payment-credentials', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken') || localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ credentials })
                    });

                    const data = await response.json();
                    loadingOverlay.classList.add('hidden');

                    if (response.ok && data.success) {
                        this.credentials = credentials;
                        this.updateLastUpdated();
                        this.showNotification('Payment credentials saved successfully!', 'success');
                        console.log('âœ… Payment credentials saved successfully');
                    } else {
                        throw new Error(data.message || 'Failed to save payment credentials');
                    }
                } catch (error) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    console.error('âŒ Error saving payment credentials:', error);
                    this.showNotification(error.message || 'Failed to save payment credentials', 'error');
                }
            }

            async testCredentials() {
                try {
                    console.log('ðŸ§ª Testing payment credentials...');
                    
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.remove('hidden');

                    const response = await fetch('/api/admin/payment-credentials/test', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken') || localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    loadingOverlay.classList.add('hidden');

                    if (response.ok && data.success) {
                        this.showNotification('Payment credentials test completed successfully!', 'success');
                        console.log('âœ… Payment credentials test results:', data.results);
                    } else {
                        throw new Error(data.message || 'Failed to test payment credentials');
                    }
                } catch (error) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    console.error('âŒ Error testing payment credentials:', error);
                    this.showNotification(error.message || 'Failed to test payment credentials', 'error');
                }
            }

            resetToDefaults() {
                if (confirm('Are you sure you want to reset all payment credentials to default values? This action cannot be undone.')) {
                    // Reset to default values
                    this.credentials = {
                        mobile_money: {
                            mtn: { phone: '+250 788 123 456', account_name: 'African Deals Domain', ussd_code: '*182*8*1#', enabled: true },
                            airtel: { phone: '+250 733 456 789', account_name: 'African Deals Domain', ussd_code: '*500*2*1#', enabled: true },
                            tigo: { phone: '+250 722 789 012', account_name: 'African Deals Domain', ussd_code: '*505#', enabled: true }
                        },
                        bank_transfer: {
                            primary: { bank_name: 'Bank of Kigali', account_name: 'African Deals Domain Ltd', account_number: '00123456789', swift_code: 'BKGLRWRW', branch: 'Kigali Main Branch', enabled: true },
                            secondary: { bank_name: 'Equity Bank Rwanda', account_name: 'African Deals Domain Ltd', account_number: '40012345678', swift_code: 'EQBLRWRW', branch: 'Kigali City Branch', enabled: true }
                        }
                    };
                    
                    this.populateForm();
                    this.showNotification('Payment credentials reset to default values', 'info');
                }
            }

            updateLastUpdated(timestamp) {
                const lastUpdatedElement = document.getElementById('last-updated');
                if (timestamp) {
                    lastUpdatedElement.textContent = new Date(timestamp).toLocaleString();
                } else {
                    lastUpdatedElement.textContent = new Date().toLocaleString();
                }
            }

            showNotification(message, type = 'info') {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notification => notification.remove());

                // Create new notification
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);

                // Hide notification after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 5000);
            }
        }

        // Initialize the Payment Credentials Manager when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new PaymentCredentialsManager();
        });
    </script>
</body>
</html>