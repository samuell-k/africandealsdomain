<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Dashboard | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            backdrop-filter: blur(10px);
        }
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #3b82f6;
            outline: none;
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .stat-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
    
        
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
    
    <!-- Main Content -->
    <div class="flex-1 p-8 overflow-auto">
        
  <!-- Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left text-xl"></i>
          </button>
          <h1 class="text-2xl font-bold text-gray-900">Location & Delivery Dashboard</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
            <span class="text-sm text-green-600">Live Monitoring</span>
          </div>
          <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Statistics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-users text-green-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="totalAgents">--</div>
            <div class="text-sm text-gray-600">Total Agents</div>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <i class="fas fa-motorcycle text-blue-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="activeAgents">--</div>
            <div class="text-sm text-gray-600">Active Agents</div>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
            <i class="fas fa-truck text-purple-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="activeDeliveries">--</div>
            <div class="text-sm text-gray-600">Active Deliveries</div>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
            <i class="fas fa-map-marked-alt text-orange-600 text-xl"></i>
          </div>
          <div class="ml-4">
            <div class="text-2xl font-bold text-gray-900" id="deliveryZones">--</div>
            <div class="text-sm text-gray-600">Delivery Zones</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Map -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in location-card">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Live Location Monitoring</h2>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <span class="text-sm text-gray-600">Available</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
              <span class="text-sm text-gray-600">Busy</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
              <span class="text-sm text-gray-600">Offline</span>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="toggleHeatmap()" id="heatmapBtn" class="text-blue-600 hover:text-blue-800 transition-colors" title="Toggle Heatmap">
              <i class="fas fa-fire text-lg"></i>
            </button>
            <button onclick="toggleZones()" id="zonesBtn" class="text-purple-600 hover:text-purple-800 transition-colors" title="Toggle Delivery Zones">
              <i class="fas fa-draw-polygon text-lg"></i>
            </button>
            <button onclick="centerMap()" class="text-green-600 hover:text-green-800 transition-colors" title="Center Map">
              <i class="fas fa-crosshairs text-lg"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div id="map" class="border border-gray-200 rounded-lg mb-4"></div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
        <div>
          <div class="text-lg font-bold text-green-600" id="onlineAgentsCount">0</div>
          <div class="text-sm text-gray-600">Online Now</div>
        </div>
        <div>
          <div class="text-lg font-bold text-blue-600" id="avgDeliveryTime">0 min</div>
          <div class="text-sm text-gray-600">Avg Delivery Time</div>
        </div>
        <div>
          <div class="text-lg font-bold text-purple-600" id="totalDistance">0 km</div>
          <div class="text-sm text-gray-600">Total Distance Today</div>
        </div>
        <div>
          <div class="text-lg font-bold text-orange-600" id="completedToday">0</div>
          <div class="text-sm text-gray-600">Completed Today</div>
        </div>
      </div>
    </div>

    <!-- Delivery Zones Management -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Create Delivery Zone -->
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Create Delivery Zone</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Zone Name</label>
            <input id="zoneName" type="text" placeholder="Enter zone name" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Base Price ($)</label>
              <input id="basePrice" type="number" step="0.01" placeholder="5.00" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Price per KM ($)</label>
              <input id="pricePerKm" type="number" step="0.01" placeholder="1.50" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
            </div>
          </div>
          
          <div class="space-y-2">
            <button onclick="startDrawing()" id="drawBtn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
              <i class="fas fa-draw-polygon mr-2"></i>Draw Zone on Map
            </button>
            <button onclick="saveZone()" id="saveZoneBtn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50" disabled>
              <i class="fas fa-save mr-2"></i>Save Zone
            </button>
          </div>
          
          <div id="zoneStatus" class="text-sm"></div>
        </div>
      </div>

      <!-- Existing Zones -->
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Delivery Zones</h2>
          <button onclick="refreshZones()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Refresh Zones">
            <i class="fas fa-sync-alt text-lg"></i>
          </button>
        </div>
        
        <div id="zonesList" class="space-y-3 max-h-96 overflow-y-auto">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-map text-3xl mb-2"></i>
            <p>Loading delivery zones...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Management -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in location-card">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Agent Management</h2>
        <div class="flex items-center space-x-2">
          <select id="agentFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="all">All Agents</option>
            <option value="available">Available</option>
            <option value="busy">Busy</option>
            <option value="offline">Offline</option>
          </select>
          <button onclick="refreshAgents()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Refresh Agents">
            <i class="fas fa-sync-alt text-lg"></i>
          </button>
        </div>
      </div>
      
      <div id="agentsList" class="space-y-4">
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-users text-3xl mb-2"></i>
          <p>Loading agents...</p>
        </div>
      </div>
    </div>

    <!-- Analytics -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">Location Analytics</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center">
          <div class="text-3xl font-bold text-blue-600" id="totalOrdersToday">0</div>
          <div class="text-sm text-gray-600">Orders Today</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600" id="avgDeliveryDistance">0 km</div>
          <div class="text-sm text-gray-600">Avg Distance</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-purple-600" id="totalRevenue">$0</div>
          <div class="text-sm text-gray-600">Revenue Today</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div id="notification-toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-green-500">
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-3"></i>
        <span id="notification-message">Success!</span>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Global variables
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const userId = userData.id;
    const authToken = localStorage.getItem('authToken');
    const apiBase = '${API_BASE_URL}/location';
    
    let map, drawControl, drawnItems, heatmapLayer;
    let agentMarkers = new Map();
    let deliveryZones = [];
    let currentDrawnZone = null;
    let socket = null;
    let showHeatmap = false;
    let showZones = true;

    // Check authentication
    if (!authToken || !userId || userData.role !== 'admin') {
      window.location.href = '/auth/auth-admin.html';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
      initializeSocket();
      loadStatistics();
      loadDeliveryZones();
      loadAgents();
      loadAnalytics();
      
      // Set up auto-refresh
      setInterval(refreshLiveData, 30000); // Refresh every 30 seconds
    });

    // --- MAP INITIALIZATION ---
    function initializeMap() {
      map = L.map('map').setView([-1.2921, 36.8219], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Initialize drawing controls
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      drawControl = new L.Control.Draw({
        edit: {
          featureGroup: drawnItems
        },
        draw: {
          polygon: true,
          rectangle: true,
          circle: false,
          marker: false,
          polyline: false,
          circlemarker: false
        }
      });

      // Drawing event handlers
      map.on('draw:created', function(e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        currentDrawnZone = layer.toGeoJSON();
        document.getElementById('saveZoneBtn').disabled = false;
        showNotification('Zone drawn! Now you can save it.', 'success');
      });

      map.on('draw:deleted', function(e) {
        currentDrawnZone = null;
        document.getElementById('saveZoneBtn').disabled = true;
      });
    }

    // --- SOCKET INITIALIZATION ---
    function initializeSocket() {
      socket = io();
      
      socket.on('connect', () => {
        console.log('Connected to admin monitoring');
        socket.emit('user:login', userData);
      });

      socket.on('agent-location-update', (data) => {
        updateAgentMarker(data.agentId, data.lat, data.lng);
      });

      socket.on('delivery_status_update', (data) => {
        refreshLiveData();
      });
    }

    // --- STATISTICS ---
    async function loadStatistics() {
      try {
        const [agentsResponse, deliveriesResponse] = await Promise.all([
          
                try {
                    const response = await fetch('${API_BASE_URL}/agents', { headers: { 'Authorization': `Bearer ${authToken}` } });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                },
          fetch('${API_BASE_URL}/orders?status=active', { headers: { 'Authorization': `Bearer ${authToken}` } })
        ]);

        if (agentsResponse.ok) {
          const agentsData = await agentsResponse.json();
          const agents = agentsData.agents || [];
          
          document.getElementById('totalAgents').textContent = agents.length;
          document.getElementById('activeAgents').textContent = agents.filter(a => a.status !== 'offline').length;
          document.getElementById('onlineAgentsCount').textContent = agents.filter(a => a.status === 'available').length;
        }

        if (deliveriesResponse.ok) {
          const deliveriesData = await deliveriesResponse.json();
          document.getElementById('activeDeliveries').textContent = deliveriesData.orders?.length || 0;
        }
      } catch (error) {
        console.error('Error loading statistics:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
      }
    }

    // --- AGENT MANAGEMENT ---
    async function loadAgents() {
      try {
        const response = await 
                try {
                    const response = await fetch(`${apiBase}/agents/active`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                };

        if (response.ok) {
          const agents = await response.json();
          displayAgents(agents);
          updateAgentMarkers(agents);
        }
      } catch (error) {
        console.error('Error loading agents:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
      }
    }

    function displayAgents(agents) {
      const container = document.getElementById('agentsList');
      const filter = document.getElementById('agentFilter').value;
      
      let filteredAgents = agents;
      if (filter !== 'all') {
        filteredAgents = agents.filter(agent => agent.status === filter);
      }

      if (filteredAgents.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-users text-3xl mb-2"></i>
            <p>No agents found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredAgents.map(agent => `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-gray-600 text-xl"></i>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">${agent.username}</h3>
                <p class="text-sm text-gray-600">Active Orders: ${agent.active_orders || 0}</p>
                <p class="text-xs text-gray-500">Last Update: ${new Date(agent.updated_at).toLocaleString()}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="px-3 py-1 rounded-full text-sm font-semibold ${getAgentStatusClass(agent.status)}">
                ${agent.status.charAt(0).toUpperCase() + agent.status.slice(1)}
              </div>
              <div class="flex items-center space-x-2 mt-2">
                <button onclick="centerOnAgent(${agent.lat}, ${agent.lng})" class="text-blue-500 hover:text-blue-700 transition-colors" title="Show on Map">
                  <i class="fas fa-map-marker-alt"></i>
                </button>
                <button onclick="viewAgentDetails(${agent.user_id})" class="text-green-500 hover:text-green-700 transition-colors" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateAgentMarkers(agents) {
      // Clear existing markers
      agentMarkers.forEach(marker => map.removeLayer(marker));
      agentMarkers.clear();

      // Add new markers
      agents.forEach(agent => {
        if (agent.lat && agent.lng) {
          const marker = L.marker([agent.lat, agent.lng], {
            icon: L.icon({
              iconUrl: getAgentIcon(agent.status),
              iconSize: [24, 24],
              iconAnchor: [12, 24]
            })
          }).addTo(map);

          marker.bindPopup(`
            <div class="text-center">
              <h3 class="font-semibold">${agent.username}</h3>
              <p class="text-sm">Status: ${agent.status}</p>
              <p class="text-sm">Orders: ${agent.active_orders || 0}</p>
            </div>
          `);

          agentMarkers.set(agent.user_id, marker);
        }
      });
    }

    function updateAgentMarker(agentId, lat, lng) {
      if (agentMarkers.has(agentId)) {
        agentMarkers.get(agentId).setLatLng([lat, lng]);
      }
    }

    function getAgentIcon(status) {
      const icons = {
        'available': 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        'busy': 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        'offline': 'https://cdn-icons-png.flaticon.com/512/684/684908.png'
      };
      return icons[status] || icons.offline;
    }

    function getAgentStatusClass(status) {
      const classes = {
        'available': 'bg-green-100 text-green-600',
        'busy': 'bg-yellow-100 text-yellow-600',
        'offline': 'bg-gray-100 text-gray-600'
      };
      return classes[status] || classes.offline;
    }

    function centerOnAgent(lat, lng) {
      map.setView([lat, lng], 15);
    }

    function viewAgentDetails(agentId) {
      // In real implementation, open agent details modal or page
      showNotification(`Viewing details for agent ${agentId}`, 'info');
    }

    // --- DELIVERY ZONES ---
    async function loadDeliveryZones() {
      try {
        const response = await 
                try {
                    const response = await fetch(`${apiBase}/zones`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                };

        if (response.ok) {
          deliveryZones = await response.json();
          displayDeliveryZones(deliveryZones);
          showZonesOnMap(deliveryZones);
          document.getElementById('deliveryZones').textContent = deliveryZones.length;
        }
      } catch (error) {
        console.error('Error loading delivery zones:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
      }
    }

    function displayDeliveryZones(zones) {
      const container = document.getElementById('zonesList');
      
      if (zones.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-map text-3xl mb-2"></i>
            <p>No delivery zones created yet</p>
          </div>
        `;
        return;
      }

      container.innerHTML = zones.map(zone => `
        <div class="border border-gray-200 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-gray-900">${zone.name}</h3>
              <p class="text-sm text-gray-600">Base: ${zone.base_price || 5.00} | Per KM: ${zone.price_per_km || 1.50}</p>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="showZoneOnMap('${zone.id}')" class="text-blue-500 hover:text-blue-700 transition-colors" title="Show on Map">
                <i class="fas fa-eye"></i>
              </button>
              <button onclick="editZone('${zone.id}')" class="text-green-500 hover:text-green-700 transition-colors" title="Edit Zone">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteZone('${zone.id}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete Zone">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showZonesOnMap(zones) {
      if (!showZones) return;

      zones.forEach(zone => {
        if (zone.geojson) {
          L.geoJSON(zone.geojson, {
            style: {
              color: '#3b82f6',
              weight: 2,
              opacity: 0.8,
              fillOpacity: 0.1
            }
          }).addTo(map).bindPopup(`
            <div class="text-center">
              <h3 class="font-semibold">${zone.name}</h3>
              <p class="text-sm">Base: ${zone.base_price}</p>
              <p class="text-sm">Per KM: ${zone.price_per_km}</p>
            </div>
          `);
        }
      });
    }

    function startDrawing() {
      if (!map.hasLayer(drawControl)) {
        map.addControl(drawControl);
      }
      showNotification('Click on the map to start drawing a delivery zone', 'info');
    }

    async function saveZone() {
      if (!currentDrawnZone) {
        showNotification('Please draw a zone first', 'error');
        return;
      }

      const name = document.getElementById('zoneName').value.trim();
      const basePrice = parseFloat(document.getElementById('basePrice').value) || 5.00;
      const pricePerKm = parseFloat(document.getElementById('pricePerKm').value) || 1.50;

      if (!name) {
        showNotification('Please enter a zone name', 'error');
        return;
      }

      try {
        const response = await fetch(`${apiBase}/zones`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${authToken}` 
          },
          body: JSON.stringify({ 
            name, 
            geojson: currentDrawnZone.geometry,
            base_price: basePrice,
            price_per_km: pricePerKm
          })
        });

        if (response.ok) {
          showNotification('Delivery zone saved successfully!', 'success');
          
          // Clear form
          document.getElementById('zoneName').value = '';
          document.getElementById('basePrice').value = '';
          document.getElementById('pricePerKm').value = '';
          document.getElementById('saveZoneBtn').disabled = true;
          
          // Clear drawn zone
          drawnItems.clearLayers();
          currentDrawnZone = null;
          
          // Reload zones
          loadDeliveryZones();
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to save zone', 'error');
        }
      } catch (error) {
        console.error('Error saving zone:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Failed to save zone', 'error');
      }
    }

    function showZoneOnMap(zoneId) {
      const zone = deliveryZones.find(z => z.id == zoneId);
      if (zone && zone.geojson) {
        const layer = L.geoJSON(zone.geojson);
        map.fitBounds(layer.getBounds());
      }
    }

    function editZone(zoneId) {
      showNotification(`Editing zone ${zoneId}`, 'info');
      // In real implementation, open edit modal
    }

    async function deleteZone(zoneId) {
      if (!confirm('Are you sure you want to delete this delivery zone?')) {
        return;
      }

      try {
        const response = await fetch(`${apiBase}/zones/${zoneId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          showNotification('Zone deleted successfully', 'success');
          loadDeliveryZones();
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to delete zone', 'error');
        }
      } catch (error) {
        console.error('Error deleting zone:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Failed to delete zone', 'error');
      }
    }

    // --- HEATMAP ---
    function toggleHeatmap() {
      showHeatmap = !showHeatmap;
      
      if (showHeatmap) {
        loadHeatmapData();
        document.getElementById('heatmapBtn').classList.add('text-red-600');
        document.getElementById('heatmapBtn').classList.remove('text-blue-600');
      } else {
        if (heatmapLayer) {
          map.removeLayer(heatmapLayer);
        }
        document.getElementById('heatmapBtn').classList.add('text-blue-600');
        document.getElementById('heatmapBtn').classList.remove('text-red-600');
      }
    }

    async function loadHeatmapData() {
      try {
        const response = await 
                try {
                    const response = await fetch(`${apiBase}/heatmap?timeframe=week`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                };

        if (response.ok) {
          const data = await response.json();
          const heatmapData = data.map(point => [point.lat, point.lng, point.weight]);
          
          if (heatmapLayer) {
            map.removeLayer(heatmapLayer);
          }
          
          heatmapLayer = L.heatLayer(heatmapData, {
            radius: 20,
            blur: 15,
            maxZoom: 17
          }).addTo(map);
        }
      } catch (error) {
        console.error('Error loading heatmap data:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
      }
    }

    function toggleZones() {
      showZones = !showZones;
      
      if (showZones) {
        showZonesOnMap(deliveryZones);
        document.getElementById('zonesBtn').classList.add('text-purple-600');
      } else {
        // Remove zone layers (would need to track them separately in real implementation)
        document.getElementById('zonesBtn').classList.remove('text-purple-600');
      }
    }

    // --- ANALYTICS ---
    async function loadAnalytics() {
      try {
        const response = await 
                try {
                    const response = await fetch(`${apiBase}/distance-analysis?timeframe=day`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                };

        if (response.ok) {
          const data = await response.json();
          
          // Calculate totals
          const totalOrders = data.reduce((sum, agent) => sum + agent.total_orders, 0);
          const totalDistance = data.reduce((sum, agent) => sum + (agent.total_gps_points * 0.1), 0); // Rough estimate
          const totalRevenue = data.reduce((sum, agent) => sum + agent.total_shipping_cost, 0);
          
          document.getElementById('totalOrdersToday').textContent = totalOrders;
          document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(1)} km`;
          document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)}`;
          
          if (totalOrders > 0) {
            document.getElementById('avgDeliveryDistance').textContent = `${(totalDistance / totalOrders).toFixed(1)} km`;
          }
        }
      } catch (error) {
        console.error('Error loading analytics:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
      }
    }

    // --- UTILITY FUNCTIONS ---
    function refreshData() {
      loadStatistics();
      loadAgents();
      loadDeliveryZones();
      loadAnalytics();
      showNotification('Data refreshed', 'success');
    }

    function refreshLiveData() {
      loadStatistics();
      loadAgents();
    }

    function refreshAgents() {
      loadAgents();
      showNotification('Agents refreshed', 'success');
    }

    function refreshZones() {
      loadDeliveryZones();
      showNotification('Zones refreshed', 'success');
    }

    function centerMap() {
      map.setView([-1.2921, 36.8219], 12);
    }

    // Filter change handler
    document.getElementById('agentFilter').addEventListener('change', function() {
      loadAgents();
    });

    function showNotification(message, type = 'success') {
      const toast = document.getElementById('notification-toast');
      const messageElement = document.getElementById('notification-message');
      
      messageElement.textContent = message;
      
      // Update colors based on type
      const toastDiv = toast.querySelector('div');
      if (type === 'error') {
        toastDiv.className = 'bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-red-500';
        toastDiv.querySelector('i').className = 'fas fa-exclamation-circle text-red-500 mr-3';
      } else if (type === 'info') {
        toastDiv.className = 'bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-blue-500';
        toastDiv.querySelector('i').className = 'fas fa-info-circle text-blue-500 mr-3';
      } else {
        toastDiv.className = 'bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-green-500';
        toastDiv.querySelector('i').className = 'fas fa-check-circle text-green-500 mr-3';
      }
      
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 5000);
    }

    function goBack() {
      window.history.back();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (socket) {
        socket.disconnect();
      }
    });
  
    // Error handling utilities
    function showError(message) {
        console.error('Error:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'error');
        } else {
            alert('Error: ' + message);
        }
    }

    function showSuccess(message) {
        console.log('Success:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'success');
        }
    }

    function showLoading(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-white/70">${message}</p>
                </div>
            `;
        }
    }
</script>

    </div>
</div>

<script>
// Unified Admin API Integration for location-dashboard.html
class AdminAPI {
    constructor() {
        this.baseUrl = '/api/admin';
        this.token = localStorage.getItem('adminToken');
    }
    
    async request(endpoint, options = {}) {
        const url = this.baseUrl + endpoint;
        const config = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + this.token,
                ...options.headers
            },
            ...options
        };
        
        try {
            showLoading(true);
            const response = await fetch(url, config);
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            showLoading(false);
            return data;
        } catch (error) {
            showLoading(false);
            showError('API Error: ' + error.message);
            throw error;
        }
    }
    
    // Page-specific methods
    
    async getData() {
        return await this.request('/data');
    }
}

// Initialize API
const adminAPI = new AdminAPI();

// Load data when page loads
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadPageData();
    } catch (error) {
        console.error('Failed to load page data:', error);
        showError('Failed to load data. Please refresh the page.');
    }
});

async function loadPageData() {
    // Implement page-specific data loading
    console.log('Loading data for location-dashboard.html...');
    
    
    // Generic data loading
    console.log('Loading data for location-dashboard.html...');
}

function refreshData() {
    loadPageData();
}
</script>
</body>
</html>