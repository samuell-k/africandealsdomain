<!DOCTYPE html>
<html lang="en" class="admin-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Management | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="admin-auth-check.js"></script>
    <script src="admin-utils.js"></script>
    <style>
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-item {
            transition: all 0.3s ease;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 3px solid #3b82f6;
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            backdrop-filter: blur(10px);
        }
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #3b82f6;
            outline: none;
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .stat-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="flex h-screen">
    
        
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6">
            <div class="text-white text-2xl font-bold mb-8">
                <i class="fas fa-shield-alt mr-2"></i>Admin Panel
            </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
            
            <nav class="space-y-2">
                <a href="dashboard.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
                <a href="manual-payment-approval.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-credit-card"></i>
                    <span>Payment Approval</span>
                </a>
                <a href="products.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-box"></i>
                    <span>Products</span>
                </a>
                <a href="orders.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="agents.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-user-tie"></i>
                    <span>Agents</span>
                </a>
                <a href="reports.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="settings.html" class="nav-item flex items-center space-x-3 p-3 rounded-lg text-white">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>
    
    <!-- Main Content -->
    <div class="flex-1 p-8 overflow-auto">
        
  
  <!-- Navigation preserved - each page has unique navigation -->

  
  <!-- Navigation preserved - each page has unique navigation -->

  
  
  
  <!-- Header Component -->
  <div id="admin-header"></div>

  <main class="pt-16 pb-8">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-4">
          <button onclick="history.back()" class="text-gray-600 hover:text-gray-800">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <h1 class="text-3xl font-bold text-gray-900">Grocery Management</h1>
        </div>
        <p class="text-gray-600">Manage local market products, orders, and delivery system</p>
      </div>

      <!-- System Status -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Total Products</p>
              <p id="totalProducts" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Active Orders</p>
              <p id="activeOrders" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Active Agents</p>
              <p id="activeAgents" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">System Status</p>
              <p id="systemStatus" class="text-2xl font-bold text-green-600">Active</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-white rounded-xl shadow-lg mb-8">
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-6">
            <button id="tab-orders" class="tab-btn py-4 px-1 border-b-2 border-green-500 text-green-600 font-medium" onclick="showNotification('Feature in development', 'info')">
              Orders
            /button>
            <button id="tab-products" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" onclick="showNotification('Feature in development', 'info')">
              Products
            /button>
            <button id="tab-agents" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" onclick="showNotification('Feature in development', 'info')">
              Agents
            /button>
            <button id="tab-settings" class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" onclick="showNotification('Feature in development', 'info')">
              Settings
            /button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
          <!-- Orders Tab -->
          <div id="orders-tab" class="tab-content">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-semibold text-gray-900">Grocery Orders</h3>
              <div class="flex gap-2">
                <select id="orderStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="preparing">Preparing</option>
                  <option value="ready_for_pickup">Ready for Pickup</option>
                  <option value="picked_up">Picked Up</option>
                  <option value="in_transit">In Transit</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancelled</option>
                </select>
                <button onclick="refreshOrders()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  Refresh
                </button>
              </div>
            </div>
            <div id="ordersList" class="space-y-4">
              <!-- Orders will be loaded here -->
            </div>
          </div>

          <!-- Products Tab -->
          <div id="products-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-semibold text-gray-900">Grocery Products</h3>
              <div class="flex gap-2">
                <select id="productCategoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">All Categories</option>
                </select>
                <button onclick="refreshProducts()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  Refresh
                </button>
              </div>
            </div>
            <div id="productsList" class="space-y-4">
              <!-- Products will be loaded here -->
            </div>
          </div>

          <!-- Agents Tab -->
          <div id="agents-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-lg font-semibold text-gray-900">Delivery Agents</h3>
              <button onclick="refreshAgents()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Refresh
              </button>
            </div>
            <div id="agentsList" class="space-y-4">
              <!-- Agents will be loaded here -->
            </div>
          </div>

          <!-- Settings Tab -->
          <div id="settings-tab" class="tab-content hidden">
            <div class="space-y-6">
              <h3 class="text-lg font-semibold text-gray-900">System Settings</h3>
              
              <!-- Feature Toggle -->
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-medium text-gray-900">Enable Grocery System</h4>
                    <p class="text-sm text-gray-600">Enable or disable the local market feature</p>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="groceryEnabled" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                  </label>
                </div>
              </div>

              <!-- Payment Methods -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-3">Payment Methods</h4>
                <div class="space-y-2">
                  <label class="flex items-center">
                    <input type="checkbox" id="momoPay" class="mr-2">
                    <span>Mobile Money (MoMo Pay)</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="paypal" class="mr-2">
                    <span>PayPal</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="crypto" class="mr-2">
                    <span>Cryptocurrency</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="cashOnDelivery" class="mr-2">
                    <span>Cash on Delivery</span>
                  </label>
                </div>
              </div>

              <!-- Delivery Settings -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-3">Delivery Settings</h4>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Base Delivery Fee (RWF)</label>
                    <input type="number" id="baseDeliveryFee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Per KM Rate (RWF)</label>
                    <input type="number" id="perKmRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Per KG Rate (RWF)</label>
                    <input type="number" id="perKgRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Packaging Fee (RWF)</label>
                    <input type="number" id="packagingFee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  </div>
                </div>
              </div>

              <button onclick="saveSettings()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                Save Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- GLOBAL STATE ---
    let currentTab = 'orders';
    let orders = [];
    let products = [];
    let agents = [];

    // --- TAB MANAGEMENT ---
    function setupTabs() {
      const tabs = ['orders', 'products', 'agents', 'settings'];
      
      tabs.forEach(tab => {
        const tabBtn = document.getElementById(`tab-${tab}`);
        const tabContent = document.getElementById(`${tab}-tab`);
        
        tabBtn.addEventListener('click', () => {
          // Hide all tabs
          tabs.forEach(t => {
            document.getElementById(`tab-${t}`).classList.remove('border-green-500', 'text-green-600');
            document.getElementById(`tab-${t}`).classList.add('border-transparent', 'text-gray-500');
            document.getElementById(`${t}-tab`).classList.add('hidden');
          });
          
          // Show selected tab
          tabBtn.classList.remove('border-transparent', 'text-gray-500');
          tabBtn.classList.add('border-green-500', 'text-green-600');
          tabContent.classList.remove('hidden');
          
          currentTab = tab;
          loadTabData(tab);
        });
      });
    }

    function loadTabData(tab) {
      switch(tab) {
        case 'orders':
          loadOrders();
          break;
        case 'products':
          loadProducts();
          break;
        case 'agents':
          loadAgents();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    }

    // --- LOAD ORDERS ---
    async function loadOrders() {
      try {
        const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/grocery-orders/admin', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                }}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          orders = data.orders;
          renderOrders();
          updateStats();
        }
      } catch (error) {
        console.error('Error loading orders:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Error loading orders', 'error');
      }
    }

    function renderOrders() {
      const container = document.getElementById('ordersList');
      const statusFilter = document.getElementById('orderStatusFilter').value;
      
      let filteredOrders = orders;
      if (statusFilter) {
        filteredOrders = orders.filter(order => order.status === statusFilter);
      }
      
      if (filteredOrders.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
        return;
      }
      
      container.innerHTML = filteredOrders.map(order => `
        <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-green-500">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-semibold text-gray-900">${order.order_number}</h4>
              <p class="text-sm text-gray-600">Buyer: ${order.buyer_name}</p>
              <p class="text-sm text-gray-600">Seller: ${order.seller_name}</p>
              <p class="text-sm text-gray-600">Total: RWF ${order.total_amount}</p>
            </div>
            <div class="text-right">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${
                order.status === 'delivered' ? 'bg-green-100 text-green-800' :
                order.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                'bg-yellow-100 text-yellow-800'
              }">${order.status.replace('_', ' ').toUpperCase()}</span>
              <p class="text-xs text-gray-500 mt-1">${new Date(order.order_date).toLocaleDateString()}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- LOAD PRODUCTS ---
    async function loadProducts() {
      try {
        const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/grocery/products?limit=50', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('authToken')}`, 'Content-Type': 'application/json' } });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                };
        const data = await response.json();
        
        if (data.success) {
          products = data.products;
          renderProducts();
        }
      } catch (error) {
        console.error('Error loading products:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Error loading products', 'error');
      }
    }

    function renderProducts() {
      const container = document.getElementById('productsList');
      
      if (products.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No products found</p>';
        return;
      }
      
      container.innerHTML = products.map(product => `
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center gap-4">
            <img src="${product.main_image ? `/uploads/${product.main_image}` : " loading="lazy"/public/images/placeholder.jpg'}" 
                 alt="${product.product_name}" class="w-16 h-16 object-cover rounded-lg">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-900">${product.product_name}</h4>
              <p class="text-sm text-gray-600">${product.category_name} • ${product.unit_type}</p>
              <p class="text-sm text-gray-600">RWF ${product.unit_price} per ${product.unit_type}</p>
            </div>
            <div class="text-right">
              <span class="text-sm text-gray-600">Stock: ${product.available_stock}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- LOAD AGENTS ---
    async function loadAgents() {
      try {
        const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/agents', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                }}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          agents = data.agents.filter(agent => agent.role === 'agent');
          renderAgents();
        }
      } catch (error) {
        console.error('Error loading agents:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Error loading agents', 'error');
      }
    }

    function renderAgents() {
      const container = document.getElementById('agentsList');
      
      if (agents.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No agents found</p>';
        return;
      }
      
      container.innerHTML = agents.map(agent => `
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center">
            <div>
              <h4 class="font-semibold text-gray-900">${agent.name}</h4>
              <p class="text-sm text-gray-600">${agent.email}</p>
              <p class="text-sm text-gray-600">${agent.city || 'Location not set'}</p>
            </div>
            <div class="text-right">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${
                agent.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
              }">${agent.is_active ? 'ACTIVE' : 'INACTIVE'}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- LOAD SETTINGS ---
    async function loadSettings() {
      try {
        const response = await 
                try {
                    const response = await fetch('${API_BASE_URL}/grocery/settings', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || localStorage.getItem('authToken')}`, 'Content-Type': 'application/json' } });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    // Continue with successful response
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API call failed:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
                    showNotification('Operation failed. Please try again.', 'error');
                    throw error;
                };
        const data = await response.json();
        
        if (data.success) {
          const settings = data.settings;
          
          // Update form fields
          document.getElementById('groceryEnabled').checked = settings.grocery_enabled === 'true';
          document.getElementById('momoPay').checked = settings.momo_pay_enabled === 'true';
          document.getElementById('paypal').checked = settings.paypal_enabled === 'true';
          document.getElementById('crypto').checked = settings.crypto_enabled === 'true';
          document.getElementById('cashOnDelivery').checked = settings.cash_on_delivery_enabled === 'true';
          
          document.getElementById('baseDeliveryFee').value = settings.base_delivery_fee || '500';
          document.getElementById('perKmRate').value = settings.per_km_rate || '100';
          document.getElementById('perKgRate').value = settings.per_kg_rate || '50';
          document.getElementById('packagingFee').value = settings.packaging_fee || '200';
        }
      } catch (error) {
        console.error('Error loading settings:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Error loading settings', 'error');
      }
    }

    // --- SAVE SETTINGS ---
    async function saveSettings() {
      try {
        const settings = {
          grocery_enabled: document.getElementById('groceryEnabled').checked.toString(),
          momo_pay_enabled: document.getElementById('momoPay').checked.toString(),
          paypal_enabled: document.getElementById('paypal').checked.toString(),
          crypto_enabled: document.getElementById('crypto').checked.toString(),
          cash_on_delivery_enabled: document.getElementById('cashOnDelivery').checked.toString(),
          base_delivery_fee: document.getElementById('baseDeliveryFee').value,
          per_km_rate: document.getElementById('perKmRate').value,
          per_kg_rate: document.getElementById('perKgRate').value,
          packaging_fee: document.getElementById('packagingFee').value
        };

        const response = await fetch('${API_BASE_URL}/grocery/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Settings saved successfully', 'success');
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error saving settings:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Error saving settings', 'error');
      }
    }

    // --- UPDATE STATS ---
    function updateStats() {
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('activeOrders').textContent = orders.filter(o => o.status !== 'delivered' && o.status !== 'cancelled').length;
      document.getElementById('activeAgents').textContent = agents.filter(a => a.is_active).length;
    }

    // --- REFRESH FUNCTIONS ---
    function refreshOrders() {
      loadOrders();
    }

    function refreshProducts() {
      loadProducts();
    }

    function refreshAgents() {
      loadAgents();
    }

    // --- SHOW NOTIFICATION ---
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // --- INITIALIZE ---
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/auth/auth-admin.html';
        return;
      }
      
      setupTabs();
      loadTabData('orders');
      
      // Setup filters
      document.getElementById('orderStatusFilter').addEventListener('change', renderOrders);
    });
  </script>

  <!-- Navigation utilities for this page -->
  <script>
    // Page-specific navigation setup
    document.addEventListener('DOMContentLoaded', function() {
      // Set page type and mode
      document.body.setAttribute('data-page-type', 'admin');
      
      
      // Switch to local market mode for this page
      if (window.navUtils) {
        localStorage.setItem('currentMode', 'local-market');
      }
      
      
      // Add navigation helpers to existing elements
      enhanceExistingNavigation();
      
      // Setup page-specific navigation
      setupPageNavigation();
    });
    
    function enhanceExistingNavigation() {
      // Add data-route attributes to links that don't have them
      const links = document.querySelectorAll('a[href]:not([data-route])');
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (href && !href.startsWith('http') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
          const route = getRouteForHref(href);
          if (route) {
            link.setAttribute('data-route', route);
          }
        }
      });
      
      // Add journey actions to buttons
      const buttons = document.querySelectorAll('button, .btn, [role="button"]');
      buttons.forEach(button => {
        const text = button.textContent.toLowerCase();
        
        if (text.includes('add') && text.includes('cart')) {
          button.setAttribute('data-journey-action', 'add-to-cart');
        } else if (text.includes('checkout')) {
          button.setAttribute('data-journey-action', 'proceed-checkout');
        } else if (text.includes('place') && text.includes('order')) {
          button.setAttribute('data-journey-action', 'complete-payment');
        } else if (text.includes('login') || text.includes('sign in')) {
          button.setAttribute('data-quick-nav', 'login');
        } else if (text.includes('logout') || text.includes('sign out')) {
          button.setAttribute('data-quick-nav', 'logout');
        }
      });
    }
    
    function setupPageNavigation() {
      // Page-specific navigation setup
      const pageType = 'admin';
      
      // Add mode indicators if they exist
      const modeIndicators = document.querySelectorAll('.mode-indicator');
      modeIndicators.forEach(indicator => {
        const currentMode = window.navUtils ? window.navUtils.getCurrentMode() : 'marketplace';
        indicator.className = `mode-indicator mode-${currentMode}`;
        indicator.textContent = currentMode === 'marketplace' ? 'Marketplace' : 'Local Market';
      });
      
      // Add quick navigation buttons if they exist
      const homeButtons = document.querySelectorAll('[data-nav="home"], .home-btn');
      homeButtons.forEach(btn => btn.setAttribute('data-quick-nav', 'home'));
      
      const backButtons = document.querySelectorAll('[data-nav="back"], .back-btn');
      backButtons.forEach(btn => btn.setAttribute('data-quick-nav', 'back'));
      
      const dashboardButtons = document.querySelectorAll('[data-nav="dashboard"], .dashboard-btn');
      dashboardButtons.forEach(btn => btn.setAttribute('data-quick-nav', 'dashboard'));
    }
    
    function getRouteForHref(href) {
      // Basic route mapping
      const routeMap = {
        '/': 'home',
        '/public/index.html': 'home',
        '/public/about.html': 'public.about',
        '/public/contact.html': 'public.contact',
        '/public/products.html': 'public.product-list',
        '/public/product-detail.html': 'public.product-detail',
        '/buyer/buyers-home.html': 'buyer.dashboard',
        '/buyer/cart.html': 'buyer.cart',
        '/buyer/checkout.html': 'buyer.checkout',
        '/buyer/orders.html': 'buyer.orders',
        '/seller/dashboard.html': 'seller.dashboard',
        '/seller/add-product.html': 'seller.add-product',
        '/agent/dashboard.html': 'agent.dashboard',
        '/admin/dashboard.html': 'admin.dashboard',
        '/auth/auth-buyer.html': 'auth.login',
        '/auth/auth-seller.html': 'auth.login-seller',
        '/auth/auth-agent.html': 'auth.login-agent',
        '/grocery/local-market-home.html': 'local-market.home',
        '/grocery/cart.html': 'local-market.cart'
      };
      
      return routeMap[href] || null;
    }
    
    // Wait for flexible navigation system to be ready
    window.addEventListener('flexibleNavigationReady', function() {
      console.log('✅ Flexible navigation ready on admin\grocery-management.html');
      
      // Start appropriate journey if needed
      
    });
  
    // Error handling utilities
    function showError(message) {
        console.error('Error:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'error');
        } else {
            alert('Error: ' + message);
        }
    }

    function showSuccess(message) {
        console.log('Success:', message);
        if (window.adminAuth && window.adminAuth.showNotification) {
            window.adminAuth.showNotification(message, 'success');
        }
    }

    function showLoading(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-white/70">${message}</p>
                </div>
            `;
        }
    }
</script>


    </div>
</div>

<script>
// Unified Admin API Integration for grocery-management.html
class AdminAPI {
    constructor() {
        this.baseUrl = '/api/admin';
        this.token = localStorage.getItem('adminToken');
    }
    
    async request(endpoint, options = {}) {
        const url = this.baseUrl + endpoint;
        const config = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + this.token,
                ...options.headers
            },
            ...options
        };
        
        try {
            showLoading(true);
            const response = await fetch(url, config);
            
            if (!response.ok) {
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            showLoading(false);
            return data;
        } catch (error) {
            showLoading(false);
            showError('API Error: ' + error.message);
            throw error;
        }
    }
    
    // Page-specific methods
    
    async getData() {
        return await this.request('/data');
    }
}

// Initialize API
const adminAPI = new AdminAPI();

// Load data when page loads
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await loadPageData();
    } catch (error) {
        console.error('Failed to load page data:', error);
        showError('Failed to load data. Please refresh the page.');
    }
});

async function loadPageData() {
    // Implement page-specific data loading
    console.log('Loading data for grocery-management.html...');
    
    
    // Generic data loading
    console.log('Loading data for grocery-management.html...');
}

function refreshData() {
    loadPageData();
}
</script>
</body>
</html> 