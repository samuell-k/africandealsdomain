<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Login | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .glass-morphism {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .admin-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }
    .floating {
      animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    .pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite alternate;
    }
    @keyframes pulse-glow {
      from { box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
      to { box-shadow: 0 0 30px rgba(102, 126, 234, 0.8); }
    }
    .form-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
  </style>
</head>
<body class="min-h-screen gradient-bg flex items-center justify-center p-4">
  <!-- Background Elements -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-20 left-20 w-32 h-32 bg-white/10 rounded-full floating"></div>
    <div class="absolute top-40 right-20 w-24 h-24 bg-white/10 rounded-full floating" style="animation-delay: -2s;"></div>
    <div class="absolute bottom-20 left-1/4 w-20 h-20 bg-white/10 rounded-full floating" style="animation-delay: -4s;"></div>
    <div class="absolute bottom-40 right-1/4 w-28 h-28 bg-white/10 rounded-full floating" style="animation-delay: -1s;"></div>
  </div>

  <!-- Main Container -->
  <div class="relative z-10 w-full max-w-md">
    <!-- Logo and Title -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 pulse-glow">
        <i class="fas fa-crown text-white text-3xl"></i>
      </div>
      <h1 class="text-3xl font-bold text-white mb-2">Admin Panel</h1>
      <p class="text-white/70">African Deals Domain</p>
    </div>

    <!-- Login Form -->
    <div class="glass-morphism rounded-2xl p-8 shadow-2xl">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-white mb-2">Welcome Back</h2>
        <p class="text-white/70">Sign in to access the admin dashboard</p>
      </div>

      <form id="admin-login-form" class="space-y-6" method="POST" action="#">
        <!-- Email Field -->
        <div>
          <label for="email" class="block text-sm font-semibold text-white mb-2">
            <i class="fas fa-envelope mr-2"></i>Email Address
          </label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" title="Please enter a valid email address" 
            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 form-input transition-all duration-300"
            placeholder="admin@africandeals.com"
          >
        </div>

        <!-- Password Field -->
        <div>
          <label for="password" class="block text-sm font-semibold text-white mb-2">
            <i class="fas fa-lock mr-2"></i>Password
          </label>
          <div class="relative">
            <input 
              type="password" 
              id="password" 
              name="password" 
              required pattern=".{8,}" title="Password must be at least 8 characters long" 
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 form-input transition-all duration-300 pr-12"
              placeholder="Enter your password"
            >
            <button 
              type="button" 
              id="toggle-password" 
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-white/70 hover:text-white transition"
             onclick="showNotification('Feature in development', 'info')">
              <i class="fas fa-eye" id="password-icon"></i>
            </button>
          </div>
        </div>

        <!-- Remember Me -->
        <div class="flex items-center justify-between">
          <label class="flex items-center text-white/70">
            <input type="checkbox" id="remember" class="mr-2 rounded">
            <span class="text-sm">Remember me</span>
          </label>
          <a href="/auth/forgot-password.html" class="text-blue-300 hover:text-blue-200 text-sm transition">Forgot password?</a>
        </div>

        <!-- Submit Button -->
        <button 
          type="submit" 
          id="login-btn"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:shadow-lg transition-all duration-300 transform hover:scale-105"
        >
          <span id="login-text">Sign In</span>
          <span id="login-loading" class="hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i>Signing in...
          </span>
        </button>
      </form>

      <!-- Security Notice -->
      <div class="mt-6 p-4 bg-yellow-500/20 rounded-lg border border-yellow-500/30">
        <div class="flex items-start">
          <i class="fas fa-shield-alt text-yellow-400 mt-1 mr-3"></i>
          <div>
            <h4 class="text-yellow-400 font-semibold text-sm">Security Notice</h4>
            <p class="text-yellow-300 text-xs mt-1">
              This is a restricted admin area. Unauthorized access attempts will be logged and reported.
            </p>
          </div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="mt-6 text-center">
        <p class="text-white/50 text-sm mb-3">Need help?</p>
        <div class="flex justify-center space-x-4 text-sm">
          <a href="/public/contact.html" class="text-blue-300 hover:text-blue-200 transition">Contact Support</a>
          <a href="/public/faq.html" class="text-blue-300 hover:text-blue-200 transition">FAQ</a>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8">
      <p class="text-white/50 text-sm">
        &copy; 2025 African Deals Domain. All rights reserved.
      </p>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notification-container" class="fixed top-4 right-4 z-50"></div>

  <script>
    // Check if already logged in
    const authToken = localStorage.getItem('adminToken') || localStorage.getItem('token') || localStorage.getItem('authToken');
    const userData = localStorage.getItem('user') || localStorage.getItem('userData') || localStorage.getItem('adminUser');

    if (authToken && userData) {
      try {
        const user = JSON.parse(userData);
        if (user && String(user.role).toLowerCase() === 'admin') {
          // Avoid redirect thrash: only redirect if not already on the target
          const params = new URLSearchParams(window.location.search);
          const redirect = params.get('redirect') || '/admin/dashboard.html';
          if (window.location.pathname + window.location.search !== redirect) {
            console.log('[AUTH] Already logged in as admin, redirecting to target');
            window.location.replace(redirect);
          }
        }
      } catch (error) {
        console.error('[AUTH] Error parsing user data:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        // Clear invalid data
        localStorage.removeItem('token');
        localStorage.removeItem('authToken');
        localStorage.removeItem('user');
        localStorage.removeItem('userData');
      }
    }

    // Toggle password visibility
    document.getElementById('toggle-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('password');
      const passwordIcon = document.getElementById('password-icon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        passwordIcon.className = 'fas fa-eye-slash';
      } else {
        passwordInput.type = 'password';
        passwordIcon.className = 'fas fa-eye';
      }
    });

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      let bgColor = 'bg-blue-500';
      let icon = 'ℹ️';
      
      if (type === 'success') {
        bgColor = 'bg-green-500';
        icon = '✅';
      } else if (type === 'error') {
        bgColor = 'bg-red-500';
        icon = '❌';
      } else if (type === 'warning') {
        bgColor = 'bg-yellow-500';
        icon = '⚠️';
      }
      
      notification.className = `px-4 py-3 rounded-lg text-white ${bgColor} shadow-lg flex items-center gap-2 mb-2 transform transition-all duration-300 translate-x-full`;
      notification.innerHTML = `<span>${icon}</span><span>${message}</span>`;
      
      const container = document.getElementById('notification-container');
      container.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 5000);
      
      // Also allow manual removal by clicking
      notification.addEventListener('click', () => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          notification.remove();
        }, 300);
      });
    }

    // Handle form submission
    document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      // Show loading state
      const loginBtn = document.getElementById('login-btn');
      const loginText = document.getElementById('login-text');
      const loginLoading = document.getElementById('login-loading');
      
      loginBtn.disabled = true;
      loginText.classList.add('hidden');
      loginLoading.classList.remove('hidden');
      
      try {
        console.log('[AUTH] Attempting admin login for:', email);
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            email,
            password
          })
        });
        
        console.log('[AUTH] Login response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Expected JSON response but got: ' + contentType);
        }
        
        const data = await response.json();
        console.log('[AUTH] Login response data:', { success: data.success, hasToken: !!data.token, userRole: data.user?.role });
        
        if (response.ok && data.token && data.user && data.user.role === 'admin') {
          // Store authentication data using consistent keys
          localStorage.setItem('token', data.token);
          localStorage.setItem('adminToken', data.token); // Store as adminToken for admin pages
          localStorage.setItem('user', JSON.stringify(data.user));
          localStorage.setItem('userRole', data.user.role);
          
          // Also store with old keys for backward compatibility
          localStorage.setItem('authToken', data.token);
          localStorage.setItem('userData', JSON.stringify(data.user));
          
          // Persist token expiry for scheduling silent refresh
          try {
            const parts = data.token.split('.');
            if (parts.length === 3) {
              const payload = JSON.parse(atob(parts[1]));
              if (payload && payload.exp) {
                const expIso = new Date(payload.exp * 1000).toISOString();
                localStorage.setItem('tokenExpiry', expIso);
              }
            }
          } catch (e) {
            console.warn('[AUTH] Could not decode JWT for expiry:', e);
          }
          
          if (remember) {
            localStorage.setItem('rememberMe', 'true');
          }
          
          console.log('[AUTH] Admin login successful:', data.user.name);
          showNotification('Login successful! Redirecting...', 'success');
          
          // Redirect to intended page or dashboard
          setTimeout(() => {
            const params = new URLSearchParams(window.location.search);
            const redirect = params.get('redirect');
            window.location.replace(redirect || '/admin/dashboard.html');
          }, 800);
          
        } else if (response.ok && data.user && data.user.role !== 'admin') {
          showNotification('Access denied. Admin privileges required.', 'error');
        } else {
          showNotification(data.error || data.message || 'Login failed. Please check your credentials.', 'error');
        }
        
      } catch (error) {
        console.error('Login error:', error);
                
                // Enhanced error reporting
                if (error) {
                    const errorDetails = {
                        message: error.message || 'Unknown error',
                        stack: error.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        error.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
        showNotification('Network error. Please try again.', 'error');
      } finally {
        // Reset button state
        loginBtn.disabled = false;
        loginText.classList.remove('hidden');
        loginLoading.classList.add('hidden');
      }
    });

    // Add some interactive effects
    document.addEventListener('DOMContentLoaded', function() {
      // Add focus effects to inputs
      const inputs = document.querySelectorAll('input');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          this.parentElement.classList.add('scale-105');
        });
        
        input.addEventListener('blur', function() {
          this.parentElement.classList.remove('scale-105');
        });
      });
      
      // Add hover effects to the form
      const form = document.getElementById('admin-login-form');
      form.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.02)';
      });
      
      form.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl+Enter to submit
      if (e.ctrlKey && e.key === 'Enter') {
        document.getElementById('admin-login-form').dispatchEvent(new Event('submit'));
      }
      
      // Escape to clear form
      if (e.key === 'Escape') {
        document.getElementById('admin-login-form').reset();
      }
    });
  </script>
</body>
</html> 