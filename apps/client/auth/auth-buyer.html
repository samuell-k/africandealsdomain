<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buyer Login | ADD Physical Products</title>
  <!-- Local Tailwind CSS (offline-ready) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fallback to CDN if local fails -->
  <script>
    // Check if local CSS loaded, if not load from CDN
    setTimeout(() => {
      const testEl = document.createElement('div');
      testEl.className = 'flex';
      document.body.appendChild(testEl);
      const isFlexLoaded = window.getComputedStyle(testEl).display === 'flex';
      document.body.removeChild(testEl);
      
      if (!isFlexLoaded) {
        console.log('Local CSS failed, loading CDN fallback');
        const link = document.createElement('script');
        link.href = '/public/css/tailwind.css'; 
        link.rel = 'stylesheet';
        document.head.appendChild(link);
      }
    }, 100);
  </script>
  <!-- Additional fallback styles -->
  <style>
    .min-h-screen { min-height: 100vh; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .bg-gray-50 { background-color: #f9fafb; }
    .w-full { width: 100%; }
    .max-w-4xl { max-width: 56rem; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .rounded-2xl { border-radius: 1rem; }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .overflow-hidden { overflow: hidden; }
    .bg-white { background-color: #ffffff; }
    .flex-col { flex-direction: column; }
    .p-8 { padding: 2rem; }
    .gap-6 { gap: 1.5rem; }
    .gap-4 { gap: 1rem; }
    .gap-2 { gap: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .text-2xl { font-size: 1.5rem; line-height: 2rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .font-extrabold { font-weight: 800; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .text-white { color: #ffffff; }
    .text-center { text-align: center; }
    .tracking-tight { letter-spacing: -0.025em; }
    .h-12 { height: 3rem; }
    .w-12 { width: 3rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    .flex-1 { flex: 1 1 0%; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .border-2 { border-width: 2px; }
    .border { border-width: 1px; }
    .rounded { border-radius: 0.25rem; }
    .rounded-tl-lg { border-top-left-radius: 0.5rem; }
    .rounded-tr-lg { border-top-right-radius: 0.5rem; }
    .cursor-pointer { cursor: pointer; }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-gray-50 { background-color: #f9fafb; }
    .text-gray-500 { color: #6b7280; }
    .border-gray-200 { border-color: #e5e7eb; }
    .focus\:ring-2:focus { box-shadow: 0 0 0 2px rgba(14, 32, 56, 0.5); }
    .focus\:ring-\[#0e2038\]:focus { box-shadow: 0 0 0 2px rgba(14, 32, 56, 0.5); }
    .outline-none { outline: none; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-4 { margin-top: 1rem; }
    .hover\:underline:hover { text-decoration: underline; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .inset-y-0 { top: 0; bottom: 0; }
    .right-0 { right: 0; }
    .pr-3 { padding-right: 0.75rem; }
    .pr-10 { padding-right: 2.5rem; }
    .h-5 { height: 1.25rem; }
    .w-5 { width: 1.25rem; }
    .ml-2 { margin-left: 0.5rem; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .opacity-25 { opacity: 0.25; }
    .opacity-75 { opacity: 0.75; }
    .fixed { position: fixed; }
    .top-4 { top: 1rem; }
    .right-4 { right: 1rem; }
    .z-50 { z-index: 50; }
    .bg-green-600 { background-color: #059669; }
    .bg-red-600 { background-color: #dc2626; }
    .hidden { display: none; }
  </style>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .brand { color: #0e2038; }
    .brand-bg { background: linear-gradient(120deg, #0e2038 0%, #23325c 100%); }
    .icon-bg { background: #f3f4f6; border-radius: 1rem; }
    @media (max-width: 900px) {
      .auth-cols { flex-direction: column; }
      .auth-left, .auth-right { width: 100% !important; min-width: 0; }
      .auth-left { border-radius: 1.5rem 1.5rem 0 0; }
      .auth-right { border-radius: 0 0 1.5rem 1.5rem; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gray-50">
  <main class="w-full max-w-4xl mx-auto flex auth-cols rounded-2xl shadow-lg overflow-hidden bg-white" style="min-height: 600px;">
    <!-- LEFT: Welcome, Illustration, Icon -->
    <section class="auth-left flex flex-col justify-center items-center p-8 gap-6" style="width:44%; min-width:320px; background:linear-gradient(135deg,#0e2038 0%,#1a2e4a 50%,#314b75 100%);">
      <div class="icon-bg p-4 mb-2 flex items-center justify-center" aria-label="Buyer Icon">
        <!-- Always-visible SVG icon fallback -->
        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" class="absolute z-0"><circle cx="32" cy="32" r="32" fill="#e5e9f2"/><path d="M20 48c0-8 6.268-14 14-14s14 6 14 14" stroke="#0e2038" stroke-width="2"/><rect x="16" y="24" width="32" height="20" rx="6" fill="#fff" stroke="#0e2038" stroke-width="2"/><rect x="26" y="32" width="12" height="6" rx="2" fill="#0e2038" opacity=".15"/></svg>
        <!-- Shopping Bag Icon (SVG fallback) -->
        <div class="w-28 h-28 flex items-center justify-center relative z-10">
          <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45" fill="#ffffff" opacity="0.1"/>
            <path d="M25 35h50l-5 35H30l-5-35z" fill="#ffffff" stroke="#ffffff" stroke-width="2"/>
            <path d="M35 35V25a15 15 0 0130 0v10" stroke="#ffffff" stroke-width="2" fill="none"/>
            <circle cx="40" cy="50" r="2" fill="#ffffff"/>
            <circle cx="60" cy="50" r="2" fill="#ffffff"/>
          </svg>
        </div>
      </div>
      <h2 class="text-2xl font-extrabold text-white mb-2 text-center">Welcome to ADD Physical Products!</h2>
      <p class="text-base text-center text-white">Your trusted African marketplace for quality products, unbeatable deals, and a seamless shopping experience. Sign in to access exclusive offers, track your orders, and connect with top sellers across the continent. We’re here to help you buy smarter, safer, and faster—every day.</p>
      <!-- 3D Illustration (simple SVG, not heavy) -->
      <svg width="120" height="80" viewBox="0 0 120 80" fill="none" class="mt-4" aria-hidden="true"><ellipse cx="60" cy="70" rx="50" ry="8" fill="#e5e9f2"/><rect x="35" y="30" width="50" height="30" rx="8" fill="#fff" stroke="#0e2038" stroke-width="2"/><rect x="50" y="40" width="20" height="10" rx="2" fill="#0e2038" opacity=".15"/></svg>
    </section>
    <!-- RIGHT: Form -->
    <section class="auth-right flex flex-col justify-center items-center p-8 gap-4" style="width:56%; min-width:320px; background:#fff;">
      <div class="flex items-center gap-2 mb-4">
        <img src="/public/images/logo.png" alt="ADD Physical Product Logo" class="h-12 w-12 rounded-xl shadow bg-white" onerror="this.style.display='none'" />
        <span class="font-extrabold text-xl tracking-tight brand">ADD Physical Products</span>
      </div>
      <div class="w-full max-w-sm">
        <div class="flex mb-4">
          <button id="buyer-signin-tab" class="flex-1 py-2 font-bold rounded-tl-lg border-b-2 border-[#0e2038] text-[#0e2038] bg-gray-100" onclick="showBuyerTab('signin')">Sign In</button>
          <button id="buyer-signup-tab" class="flex-1 py-2 font-bold rounded-tr-lg border-b-2 border-gray-200 text-gray-500 bg-gray-50" onclick="showBuyerTab('signup')">Sign Up</button>
        </div>
        <div id="buyer-signin-form">
          <h1 class="text-xl font-bold mb-2 brand">Buyer Sign In</h1>
          <div id="buyer-signin-error" class="text-red-600 text-sm mb-2" style="display:none;"></div>
          <form id="buyer-signin-ajax" class="flex flex-col gap-4" autocomplete="on" method="POST" action="#">
            <label for="email" class="brand font-semibold">Email</label>
            <input id="email" name="email" type="email" required class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none" />
            <label for="password" class="brand font-semibold">Password</label>
            <div class="relative">
              <input id="password" name="password" type="password" required pattern=".{8,}" title="Password must be at least 8 characters long" class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none pr-10" />
              <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="showNotification('Feature in development', 'info')">
                <svg id="eye-icon" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z' />
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' />
                </svg>
              </button>
            </div>
            <button id="buyer-signin-btn" type="submit" class="w-full py-2 rounded font-bold mt-2 flex items-center justify-center gap-2" style="background:linear-gradient(90deg,#0e2038 0%,#23325c 100%);color:#fff;">
              <span>Sign In</span>
              <svg id="buyer-signin-spinner" class="animate-spin h-5 w-5 text-white ml-2" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
            </button>
            <div class="mt-3 text-center">
              <a href="/auth/forgot-password.html" class="text-sm brand hover:underline">Forgot your password?</a>
            </div>
          </form>
        </div>
        <div id="buyer-signup-form" style="display:none;">
          <h1 class="text-xl font-bold mb-2 brand">Buyer Sign Up</h1>
          <div id="buyer-signup-error" class="text-red-600 text-sm mb-2" style="display:none;"></div>
          <form id="buyer-signup-ajax" class="flex flex-col gap-4" autocomplete="on" method="POST" action="#">
            <label for="name" class="brand font-semibold">Full Name</label>
            <input id="name" name="name" type="text" required pattern="[A-Za-z\s]{2,50}" title="Name must be 2-50 characters, letters and spaces only" class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none" />
            <label for="email-signup" class="brand font-semibold">Email</label>
            <input id="email-signup" name="email" type="email" required class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none" />
            <label for="password-signup" class="brand font-semibold">Password</label>
            <div class="relative">
              <input id="password-signup" name="password" type="password" required pattern=".{8,}" title="Password must be at least 8 characters long" class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none pr-10" />
              <button type="button" id="toggle-password-signup" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="showNotification('Feature in development', 'info')">
                <svg id="eye-icon-signup" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95M6.873 6.876A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.956 9.956 0 01-4.293 5.95M15 12a3 3 0 11-6 0 3 3 0 016 0z' />
                </svg>
              </button>
            </div>
            <label for="phone" class="brand font-semibold">Phone</label>
            <input id="phone" name="phone" type="tel" required pattern="[+]?[0-9]{10,15}" title="Please enter a valid phone number (10-15 digits)" class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none" />
            
            <!-- Referral Code Field (hidden by default) -->
            <div id="referral-code-section" style="display: none;">
              <label for="referral-code" class="brand font-semibold">Referral Code (Optional)</label>
              <input id="referral-code" name="referral_code" type="text" placeholder="Enter referral code if you have one" class="px-4 py-2 border border-[#0e2038] rounded focus:ring-2 focus:ring-[#0e2038] outline-none" />
              <p class="text-sm text-gray-600 mt-1">Get special bonuses by using a referral code!</p>
            </div>
            
            <button id="buyer-signup-btn" type="submit" class="w-full py-2 rounded font-bold mt-2 flex items-center justify-center gap-2" style="background:linear-gradient(90deg,#0e2038 0%,#23325c 100%);color:#fff;">
              <span>Sign Up</span>
              <svg id="buyer-signup-spinner" class="animate-spin h-5 w-5 text-white ml-2" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
            </button>
          </form>
        </div>
        <div class="mt-4 text-center">
          <a href="/" class="brand hover:underline">Back to Home</a>
        </div>
      </div>
      <script>
        function showBuyerTab(tab) {
          console.log('Switching to tab:', tab);
          
          // Show/hide forms with explicit display values
          const signinForm = document.getElementById('buyer-signin-form');
          const signupForm = document.getElementById('buyer-signup-form');
          
          if (tab === 'signin') {
            signinForm.style.display = 'block';
            signupForm.style.display = 'none';
          } else if (tab === 'signup') {
            signinForm.style.display = 'none';
            signupForm.style.display = 'block';
          }
          
          console.log('Sign in form display:', signinForm.style.display);
          console.log('Sign up form display:', signupForm.style.display);
          
          // Update tab styling
          const signinTab = document.getElementById('buyer-signin-tab');
          const signupTab = document.getElementById('buyer-signup-tab');
          
          // Reset all tab classes first
          signinTab.className = 'flex-1 py-2 font-bold rounded-tl-lg border-b-2';
          signupTab.className = 'flex-1 py-2 font-bold rounded-tr-lg border-b-2';
          
          if (tab === 'signin') {
            signinTab.className += ' border-[#0e2038] text-[#0e2038] bg-gray-100 tab-active';
            signupTab.className += ' border-gray-200 text-gray-500 bg-gray-50 tab-inactive';
          } else {
            signinTab.className += ' border-gray-200 text-gray-500 bg-gray-50 tab-inactive';
            signupTab.className += ' border-[#0e2038] text-[#0e2038] bg-gray-100 tab-active';
          }
        }
        
        // Initialize the page with sign in tab active
        document.addEventListener('DOMContentLoaded', function() {
          console.log('Page loaded, initializing tabs');
          showBuyerTab('signin');

          // Preserve referral redirect from query string
          const qp = new URLSearchParams(window.location.search);
          const ref = qp.get('ref');
          const pid = qp.get('id');
          const market = qp.get('market');
          if (ref && pid) {
            const origin = window.location.origin;
            const dest = market === 'local'
              ? `${origin}/grocery/local-market-product-detail.html?id=${pid}&ref=${ref}`
              : `${origin}/buyer/product-detail.html?id=${pid}&ref=${ref}`;
            localStorage.setItem('referral_redirect_url', dest);
            console.log('[AUTH] Stored referral redirect URL from query:', dest);
          }
          
          // Handle referral code detection
          handleReferralCodeDetection();
        });

        // --- REFERRAL CODE DETECTION LOGIC ---
        function handleReferralCodeDetection() {
          console.log('[REFERRAL] Checking for referral code...');
          
          // Check URL parameters for referral code
          const urlParams = new URLSearchParams(window.location.search);
          const referralCodeFromUrl = urlParams.get('ref');
          
          // Check localStorage for stored referral data
          const storedReferralData = localStorage.getItem('referral_data');
          let referralCodeFromStorage = null;
          
          if (storedReferralData) {
            try {
              const parsedData = JSON.parse(storedReferralData);
              referralCodeFromStorage = parsedData.referral_code;
            } catch (error) {
              console.error('[REFERRAL] Error parsing stored referral data:', error);
            }
          }
          
          const referralCode = referralCodeFromUrl || referralCodeFromStorage;
          const referralSection = document.getElementById('referral-code-section');
          const referralInput = document.getElementById('referral-code');
          
          if (referralCode) {
            // Auto-populate referral code and show section
            console.log('[REFERRAL] Referral code detected:', referralCode);
            referralInput.value = referralCode;
            referralSection.style.display = 'block';
            
            // Make the field readonly and show it's auto-detected
            referralInput.readOnly = true;
            referralInput.style.backgroundColor = '#f3f4f6';
            
            // Update the label to show it's auto-detected
            const label = referralSection.querySelector('label');
            label.textContent = 'Referral Code (Auto-detected)';
            
            // Update the help text
            const helpText = referralSection.querySelector('p');
            helpText.textContent = 'Great! You\'ll get special bonuses with this referral code.';
            helpText.style.color = '#059669'; // Green color
            
            console.log('[REFERRAL] Referral code auto-populated in registration form');
          } else {
            // No referral code, keep section hidden
            console.log('[REFERRAL] No referral code detected, keeping field hidden');
            referralSection.style.display = 'none';
          }
        }
      </script>
    </section>
  </main>
  <!-- Lottie player removed to prevent blocking -->
  <script src="/public/auth-check.js"></script>
  <script>
// Check if user is already authenticated and redirect to dashboard
document.addEventListener('DOMContentLoaded', function() {
  console.log('[AUTH-BUYER] Checking existing authentication...');
  
  const token = localStorage.getItem('authToken');
  const userData = localStorage.getItem('userData');
  
  if (token && userData) {
    try {
      const user = JSON.parse(userData);
      if (user.role === 'buyer') {
        console.log('[AUTH-BUYER] User already authenticated as buyer, redirecting to dashboard');
        showToast('Already logged in, redirecting...', 'success');
        setTimeout(() => {
          // Preserve referral redirect if set
          const storedRedirect = localStorage.getItem('referral_redirect_url');
          const redirectUrl = storedRedirect || (window.location.origin + '/buyer/buyers-home.html');
          if (storedRedirect) localStorage.removeItem('referral_redirect_url');
          window.location.replace(redirectUrl);
        }, 1000);
        return;
      }
    } catch (error) {
      console.log('[AUTH-BUYER] Invalid stored user data, clearing...');
      localStorage.removeItem('authToken');
      localStorage.removeItem('userData');
    }
  }
  
  console.log('[AUTH-BUYER] No valid authentication found, showing login form');
});
  </script>
  <script>
// AJAX Buyer Sign In
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('buyer-signin-ajax');
  if (!form) return;
  form.onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById('buyer-signin-btn');
    const spinner = document.getElementById('buyer-signin-spinner');
    const errorDiv = document.getElementById('buyer-signin-error');
    errorDiv.style.display = 'none';
    btn.disabled = true;
    spinner.style.display = '';
    btn.querySelector('span').textContent = 'Signing In...';
    const email = form.email.value.trim();
    const password = form.password.value;
    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, role: 'buyer' })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Login failed');
      btn.querySelector('span').textContent = 'Success! Redirecting...';
      console.log('[AUTH] Login success, redirecting to dashboard:', data.user.role);
      showToast('Login successful! Redirecting...', 'success');
      // Store token and user info in localStorage with verification
      localStorage.setItem('authToken', data.token);
      localStorage.setItem('userData', JSON.stringify(data.user));
      
      // Verify storage was successful
      const storedToken = localStorage.getItem('authToken');
      const storedUser = localStorage.getItem('userData');
      
      if (!storedToken || !storedUser) {
        throw new Error('Failed to store authentication data');
      }
      
      console.log('[AUTH] Authentication data stored successfully');
      console.log('[AUTH] Token stored:', !!storedToken);
      console.log('[AUTH] User data stored:', !!storedUser);
      
      // Set a flag to indicate fresh login (prevents routing conflicts)
      sessionStorage.setItem('freshLogin', 'true');
      sessionStorage.setItem('loginTimestamp', Date.now().toString());
      
      const origin = window.location.origin;
      // Prefer client-stored redirect (most accurate), then server-provided, then home
      let redirectUrl = localStorage.getItem('referral_redirect_url') || data.redirectUrl || (origin + '/buyer/buyers-home.html');
      // Normalize to absolute URL if needed
      if (redirectUrl && redirectUrl.startsWith('/')) redirectUrl = origin + redirectUrl;
      // Clear stored redirect if used
      localStorage.removeItem('referral_redirect_url');

      // Professional hard redirect with longer delay
      setTimeout(() => {
        try {
          console.log('[AUTH] Redirecting to:', redirectUrl);
          window.location.replace(redirectUrl);
        } catch (e) {
          console.error('[AUTH] Redirection error:', e);
                
                // Enhanced error reporting
                if (e) {
                    const errorDetails = {
                        message: e.message || 'Unknown error',
                        stack: e.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        e.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
          showToast('Redirection failed. Please contact support.', 'error');
        }
      }, 1200);
    } catch (err) {
      errorDiv.textContent = err.message;
      errorDiv.style.display = '';
      btn.disabled = false;
      spinner.style.display = 'none';
      btn.querySelector('span').textContent = 'Sign In';
    }
  };
});

// AJAX Buyer Sign Up
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('buyer-signup-ajax');
  if (!form) return;
  form.onsubmit = async function(e) {
    e.preventDefault();
    const btn = document.getElementById('buyer-signup-btn');
    const spinner = document.getElementById('buyer-signup-spinner');
    const errorDiv = document.getElementById('buyer-signup-error');
    errorDiv.style.display = 'none';
    btn.disabled = true;
    spinner.style.display = '';
    btn.querySelector('span').textContent = 'Signing Up...';
    const name = form.name.value.trim();
    const email = form.email.value.trim();
    const password = form.password.value;
    const phone = form.phone.value.trim();
    const referralCode = form.referral_code ? form.referral_code.value.trim() : null;
    
    console.log('[REFERRAL] Registration with referral code:', referralCode);
    
    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          name, 
          email, 
          password, 
          phone, 
          role: 'buyer',
          referral_code: referralCode || null
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Registration failed');
      btn.querySelector('span').textContent = 'Success! Redirecting...';
      console.log('[AUTH] Registration success, redirecting to dashboard:', data.user.role);
      showToast('Registration successful! Redirecting...', 'success');
      // Store token and user info in localStorage with verification
      localStorage.setItem('authToken', data.token);
      localStorage.setItem('userData', JSON.stringify(data.user));
      
      // Verify storage was successful
      const storedToken = localStorage.getItem('authToken');
      const storedUser = localStorage.getItem('userData');
      
      if (!storedToken || !storedUser) {
        throw new Error('Failed to store authentication data');
      }
      
      console.log('[AUTH] Registration data stored successfully');
      console.log('[AUTH] Token stored:', !!storedToken);
      console.log('[AUTH] User data stored:', !!storedUser);
      
      // Set a flag to indicate fresh login (prevents routing conflicts)
      sessionStorage.setItem('freshLogin', 'true');
      sessionStorage.setItem('loginTimestamp', Date.now().toString());
      
      const origin = window.location.origin;
      // Prefer client-stored redirect (most accurate), then server-provided, then home
      let redirectUrl = localStorage.getItem('referral_redirect_url') || data.redirectUrl || (origin + '/buyer/buyers-home.html');
      // Normalize to absolute URL if needed
      if (redirectUrl && redirectUrl.startsWith('/')) redirectUrl = origin + redirectUrl;
      // Clear stored redirect if used
      localStorage.removeItem('referral_redirect_url');

      // Direct redirect (consistent with login)
      setTimeout(() => {
        try {
          console.log('[AUTH] Redirecting after registration to:', redirectUrl);
          window.location.replace(redirectUrl);
        } catch (e) {
          console.error('[AUTH] Redirection error:', e);
                
                // Enhanced error reporting
                if (e) {
                    const errorDetails = {
                        message: e.message || 'Unknown error',
                        stack: e.stack,
                        timestamp: new Date().toISOString(),
                        url: window.location.href
                    };
                    
                    console.error('Detailed error information:', errorDetails);
                    
                    // Show user-friendly notification
                    showNotification(
                        e.message || 'An error occurred. Please try again.',
                        'error'
                    );
                }
          showToast('Redirection failed. Please contact support.', 'error');
        }
      }, 1200);
    } catch (err) {
      errorDiv.textContent = err.message;
      errorDiv.style.display = '';
      btn.disabled = false;
      spinner.style.display = 'none';
      btn.querySelector('span').textContent = 'Sign Up';
    }
  };
});

// Toast notification
function showToast(msg, type = 'error') {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.className = 'fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg text-white font-bold';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg text-white font-bold ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
  toast.style.display = '';
  setTimeout(() => { toast.style.display = 'none'; }, 3500);
}
// Password visibility toggle
document.addEventListener('DOMContentLoaded', function() {
  const pwInput = document.getElementById('password');
  const toggleBtn = document.getElementById('toggle-password');
  if (toggleBtn && pwInput) {
    toggleBtn.onclick = function() {
      pwInput.type = pwInput.type === 'password' ? 'text' : 'password';
      document.getElementById('eye-icon').innerHTML = pwInput.type === 'password'
        ? `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z' /><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' />`
        : `<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95M6.873 6.876A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.956 9.956 0 01-4.293 5.95M15 12a3 3 0 11-6 0 3 3 0 016 0z' />`;
    };
  }
});
  </script>

<script>
// Utility Functions for Enhanced Functionality
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-black' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Generic search handlers
function handleProductSearch(query) {
    console.log('Searching products:', query);
    if (query.length > 2) {
        // Implement product search logic
        showNotification('Searching for: ' + query, 'info');
    }
}

function handleSellerSearch(query) {
    console.log('Searching sellers:', query);
    if (query.length > 2) {
        showNotification('Searching sellers: ' + query, 'info');
    }
}

function handleAgentSearch(query) {
    console.log('Searching agents:', query);
    if (query.length > 2) {
        showNotification('Searching agents: ' + query, 'info');
    }
}

function handleOrderSearch(query) {
    console.log('Searching orders:', query);
    if (query.length > 2) {
        showNotification('Searching orders: ' + query, 'info');
    }
}

function handleUserSearch(query) {
    console.log('Searching users:', query);
    if (query.length > 2) {
        showNotification('Searching users: ' + query, 'info');
    }
}

// Generic form handlers
function handleSave() {
    showNotification('Save functionality will be implemented soon', 'info');
}

function handleEdit() {
    showNotification('Edit functionality will be implemented soon', 'info');
}

function handleDelete() {
    if (confirm('Are you sure you want to delete this item?')) {
        showNotification('Delete functionality will be implemented soon', 'info');
    }
}

function handleCancel() {
    if (confirm('Are you sure you want to cancel? Unsaved changes will be lost.')) {
        history.back();
    }
}
</script>
</body>
</html> 