<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buyer Dashboard | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="icon" href="/public/images/logo.png">
  <style>
    .brand-gradient { background: linear-gradient(90deg,#0e2038 0%,#23325c 100%); }
    .brand-text { color: #0e2038; }
    .brand-bg { background-color: #0e2038; }
    
    /* Ensure main content doesn't overlap with fixed header */
    main {
      margin-top: 80px !important;
      position: relative !important;
      z-index: 1 !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header id="main-header" class="glass bg-white/80 fixed top-0 left-0 w-full z-50 shadow-md border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-2 md:px-6 h-16 md:h-20 gap-2">
      <!-- Logo and Project Name -->
      <a href="/buyer/buyers-home.html" class="flex items-center gap-2">
        <img src="/public/images/logo.png" alt="ADD Logo" class="h-8 w-8 md:h-12 md:w-12 rounded-xl shadow" />
        <span class="font-extrabold text-lg md:text-2xl text-[#0e2038] tracking-tight">ADD Physical Product</span>
      </a>
      
      <!-- Large Search Bar -->
      <div class="flex-1 flex justify-center items-center mx-2">
        <div class="relative w-full max-w-3xl">
          <input id="search-input" type="text" data-i18n="search_placeholder" placeholder="What are you looking for?" class="w-full pl-12 pr-16 py-2 md:py-3 rounded-2xl border border-gray-300 focus:ring-2 focus:ring-blue-400 bg-white/80 shadow-md transition-all duration-300 text-base md:text-lg" autocomplete="off" />
          <span class="absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer" id="search-icon-left">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </span>
          <button id="search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-3 py-1 flex items-center gap-1 shadow transition focus:outline-none">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <span data-i18n="search">Search</span>
          </button>
        </div>
      </div>
      
      <!-- Right Controls -->
      <div class="flex items-center gap-2 md:gap-4">
        <!-- Cart Icon -->
        <a href="/buyer/cart.html" class="relative flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition group" title="Cart">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600 group-hover:scale-110 transition-transform duration-200" viewBox="0 0 24 24">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span data-cart-count class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1 py-0.5 shadow hidden animate-pulse">0</span>
        </a>
        
        <!-- Orders Icon -->
        <a href="/buyer/orders.html" class="flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition" title="Orders">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600" viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="14" rx="3"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </a>
        
        <!-- Order Confirmation Icon -->
        <a href="/buyer/order-confirmation.html" class="flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-green-50 transition" title="Order Confirmation">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-green-600" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>
        </a>
        
        <!-- Messages Icon -->
        <a href="/buyer/messages.html" class="relative flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition" title="Messages">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600" viewBox="0 0 24 24">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span id="messages-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1 py-0.5 shadow hidden">0</span>
        </a>
        
        <!-- Local Market Switch Button -->
        <a href="/grocery/local-market-home-signed.html" class="hidden md:flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105" title="Switch to Local Market Fast Delivery">
          <span class="text-lg">🛒</span>
          <span class="text-sm font-semibold">Local Market</span>
        </a>
        
        <!-- Mobile Local Market Switch -->
        <a href="/grocery/local-market-home-signed.html" class="md:hidden flex items-center justify-center h-10 w-10 bg-green-500 hover:bg-green-600 text-white rounded-full transition-all duration-300 shadow-lg" title="Switch to Local Market">
          <span class="text-lg">🛒</span>
        </a>
        
        <!-- Language/Currency Dropdown -->
        <div class="relative">
          <button id="money-btn" class="flex items-center gap-1 px-1 py-1 rounded-lg hover:bg-blue-50 transition text-xs md:text-sm font-semibold text-[#0e2038]">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-500" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="#f59e42">&#8377;</text></svg>
            <span id="money-label">EN | RWF</span>
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" class="ml-1 text-gray-400" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div id="money-dropdown" class="dropdown-menu absolute right-0 mt-2 min-w-[180px] bg-white rounded-xl shadow-lg z-50 hidden p-4">
            <div class="mb-2 font-bold text-blue-700 text-sm">Language & Currency</div>
            <div class="mb-2">
              <label class="block text-xs font-semibold mb-1">Language</label>
              <select id="lang-select" class="w-full border rounded px-2 py-1 text-xs">
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="rw">Kinyarwanda</option>
                <option value="sw">Swahili</option>
                <option value="ar">العربية</option>
                <option value="ha">Hausa</option>
                <option value="yo">Yoruba</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="block text-xs font-semibold mb-1">Currency</label>
              <select id="currency-select" class="w-full border rounded px-2 py-1 text-xs">
                <option value="RWF">RWF (Rwanda Franc)</option>
                <option value="KES">KES (Kenya Shilling)</option>
                <option value="NGN">NGN (Naira)</option>
                <option value="USD">USD (US Dollar)</option>
                <option value="EUR">EUR (Euro)</option>
              </select>
            </div>
            <button id="save-money" class="w-full bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition mt-2 text-xs" data-i18n="save">Save</button>
          </div>
        </div>
        
        <!-- Profile Dropdown -->
        <div class="relative">
          <button id="profile-btn" class="flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 8-4 8-4s8 0 8 4"/></svg>
          </button>
          <div id="profile-dropdown" class="dropdown-menu absolute right-0 mt-2 min-w-[180px] bg-white rounded-xl shadow-lg z-50 hidden p-4">
            <div class="mb-2 font-bold text-blue-700 text-sm" id="profile-greeting">Hello, <span id="profile-name">User</span></div>
            <a href="/buyer/orders.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Orders</a>
            <a href="/buyer/messages.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Messages</a>
            <a href="/buyer/wishlist.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Favourites</a>
            <a href="/buyer/profile.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Account</a>
            <button id="signout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 text-xs">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-7xl mx-auto w-full px-2 md:px-6 py-8">
    <!-- Welcome Section -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold brand-text mb-4"><span data-i18n="welcome">Welcome to ADD Physical Products</span></h1>
      <p class="text-lg text-gray-600 mb-6">Discover amazing products from trusted sellers</p>
    </div>

    <!-- Featured Products Section -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Featured Products</h2>
        <a href="/buyer/product-list.html" class="text-blue-600 hover:text-blue-700 font-semibold">View All Products →</a>
      </div>
      
      <!-- Products Grid -->
      <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Products will be loaded here -->
        <div class="animate-pulse">
          <div class="bg-gray-200 h-48 rounded-lg mb-4"></div>
          <div class="h-4 bg-gray-200 rounded mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-3/4"></div>
        </div>
      </div>
    </div>
  </main>

  <footer id="main-footer"></footer>
  
  <!-- Scripts -->
  <script>
    // Load shared components if available (optional)
    try {
      const script = document.createElement('script');
      script.src = '/buyer/shared-components.js';
      script.onerror = function() {
        console.log('[BUYER-HOME] Shared components not available, continuing without them');
      };
      document.head.appendChild(script);
    } catch (error) {
      console.log('[BUYER-HOME] Could not load shared components:', error);
    }
  </script>
  <script src="/socket.io/socket.io.js" onerror="console.log('Socket.IO not available')"></script>
  <script>
    // Buyer Authentication Check - SECURE BUYER ACCESS ONLY
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[BUYER-HOME] Initializing buyer dashboard...');
      
      // Check authentication with multiple fallback keys
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      const userData = localStorage.getItem('userData') || localStorage.getItem('user');
      
      if (!token || !userData) {
        console.log('[BUYER-HOME] No authentication found, redirecting to buyer login...');
        // Add a small delay to prevent flash
        setTimeout(() => {
          window.location.href = '/auth/auth-buyer.html';
        }, 100);
        return;
      }
      
      // Parse user data with error handling
      try {
        const user = JSON.parse(userData);
        console.log('[BUYER-HOME] User authenticated:', user.username || user.email);
        
        // Verify user role if available
        if (user.role && user.role !== 'buyer') {
          console.log('[BUYER-HOME] Invalid user role:', user.role);
          showToast('Invalid user role. Buyer access required.', 'error');
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 2000);
          return;
        }
        
        // Update profile greeting
        const profileName = document.getElementById('profile-name');
        if (profileName) {
          profileName.textContent = user.username || user.email || 'User';
        }
        
        // Initialize page functionality
        initializePage();
        
      } catch (error) {
        console.error('[BUYER-HOME] Error parsing user data:', error);
        showToast('Authentication error. Please login again.', 'error');
        setTimeout(() => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/auth/auth-buyer.html';
        }, 2000);
      }
    });

    // Initialize page functionality
    function initializePage() {
      setupDropdowns();
      setupSearch();
      loadProducts();
      updateCartBadge();
      setupLanguageAndCurrency();
    }

    // Setup dropdown functionality
    function setupDropdowns() {
      // Close all dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.relative')) {
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
          });
        }
      });

      // Profile dropdown
      const profileBtn = document.getElementById('profile-btn');
      const profileDropdown = document.getElementById('profile-dropdown');
      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          profileDropdown.classList.toggle('hidden');
          document.getElementById('money-dropdown').classList.add('hidden');
        });
      }

      // Money dropdown
      const moneyBtn = document.getElementById('money-btn');
      const moneyDropdown = document.getElementById('money-dropdown');
      if (moneyBtn && moneyDropdown) {
        moneyBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          moneyDropdown.classList.toggle('hidden');
          profileDropdown.classList.add('hidden');
        });
      }

      // Logout functionality
      const signoutBtn = document.getElementById('signout-btn');
      if (signoutBtn) {
        signoutBtn.addEventListener('click', function() {
          console.log('[BUYER-HOME] User logging out...');
          
          // Clear all possible authentication keys
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          localStorage.removeItem('cart');
          localStorage.removeItem('checkoutData');
          
          showToast('Logged out successfully', 'success');
          
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 1000);
        });
      }
    }

    // Setup search functionality
    function setupSearch() {
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-btn');
      
      if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
      }
      
      if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            performSearch();
          }
        });
      }
    }

    function performSearch() {
      const searchInput = document.getElementById('search-input');
      const query = searchInput.value.trim();
      if (query) {
        window.location.href = `/buyer/product-list.html?search=${encodeURIComponent(query)}`;
      }
    }

    // Load products from backend
    async function loadProducts() {
      try {
        console.log('[BUYER-HOME] Loading products...');
        const response = await fetch('/api/products?limit=8&sort=newest');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[BUYER-HOME] Products response:', data);
        
        if (data.success && data.products && data.products.length > 0) {
          renderProducts(data.products);
        } else {
          console.log('[BUYER-HOME] No products found, showing empty state');
          showEmptyState();
        }
      } catch (error) {
        console.error('[BUYER-HOME] Error loading products:', error);
        showEmptyState();
      }
    }

    function renderProducts(products) {
      const grid = document.getElementById('products-grid');
      if (!grid) return;

      if (products.length === 0) {
        showEmptyState();
        return;
      }

      grid.innerHTML = products.map(product => {
        // Handle different possible image field names from API
        const imageUrl = product.image_url || 
                        product.main_image || 
                        product.image || 
                        (product.main_image ? `/uploads/${product.main_image}` : null) ||
                        '/public/images/placeholder-product.jpg';
        
        // Always use buyer-facing final price from backend (already normalized)
        const shownPrice = parseFloat(product.price || product.discount_price || product.final_price || 0);
        // Platform commission = S - (S / 1.21)
        const platformCommission = shownPrice - (shownPrice / 1.21);
        const referralCommission = platformCommission * 0.15; // 15% of platform commission
        const formattedCommission = formatPrice(referralCommission);
        
        return `
          <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition group" data-product-id="${product.id}">
            <a href="/buyer/product-detail.html?id=${product.id}" class="block">
              <div class="aspect-square bg-gray-100 relative overflow-hidden">
                <img src="${imageUrl}" 
                     alt="${product.name}" 
                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                     onerror="this.src='/public/images/placeholder-product.jpg'">
              </div>
              <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">${product.name}</h3>
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description || 'No description available'}</p>
                <div class="flex items-center justify-between mb-2">
                  <span class="text-lg font-bold text-blue-600">
                    ${formatPrice(shownPrice)} ${product.currency || 'RWF'}
                  </span>
                  <button onclick="event.preventDefault(); event.stopPropagation(); addToCart(${product.id})" 
                          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm transition">
                    Add to Cart
                  </button>
                </div>
                <div class="product-actions flex items-center justify-between pt-2 border-t border-gray-100">
                  <button onclick="event.preventDefault(); event.stopPropagation(); openShareModal(${product.id})" 
                          class="share-button flex items-center gap-1 text-green-600 hover:text-green-700 text-xs font-medium transition">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                    </svg>
                    Share & Earn ${formattedCommission} ${product.currency || 'RWF'}
                  </button>
                  <span class="text-xs text-gray-500">Per sale</span>
                </div>
              </div>
            </a>
          </div>
        `;
      }).join('');
    }

    function showEmptyState() {
      const grid = document.getElementById('products-grid');
      if (!grid) return;
      
      grid.innerHTML = `
        <div class="col-span-full text-center py-12">
          <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-gray-400 mb-4" viewBox="0 0 24 24">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="9" cy="9" r="2"/>
            <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
          </svg>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">No products found</h3>
          <p class="text-gray-600">Check back later for new products</p>
        </div>
      `;
    }

    // Add to cart functionality - Backend API integration
    async function addToCart(productId) {
      try {
        console.log('[BUYER-HOME] Adding product to cart:', productId);
        
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          showToast('Please login to add items to cart', 'error');
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 1500);
          return;
        }

        const response = await fetch('/api/cart/add', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: productId,
            quantity: 1
          })
        });

        if (response.ok) {
          const data = await response.json();
          console.log('[BUYER-HOME] Add to cart response:', data);
          showToast('✅ Product added to cart!', 'success');
          
          // Track referral conversion for add to cart
          await trackReferralConversion('add_to_cart', productId, {
            cart_item_id: data.cartItemId,
            quantity: 1
          });
          
          await updateCartBadge(); // Update badge from backend
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('[BUYER-HOME] Add to cart failed:', response.status, errorData);
          showToast(`❌ ${errorData.error || errorData.message || 'Failed to add to cart'}`, 'error');
        }
      } catch (error) {
        console.error('[BUYER-HOME] Error adding to cart:', error);
        showToast('❌ Failed to add to cart. Please try again.', 'error');
      }
    }

    async function updateCartBadge() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          console.log('[BUYER-HOME] No token available for cart badge update');
          return;
        }

        const response = await fetch('/api/cart/count', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('[BUYER-HOME] Cart count response:', data);
          
          const totalItems = data.count || data.totalItems || 0;
          
          const badge = document.querySelector('[data-cart-count]');
          if (badge) {
            if (totalItems > 0) {
              badge.textContent = totalItems;
              badge.classList.remove('hidden');
            } else {
              badge.classList.add('hidden');
            }
          }
        } else {
          console.log('[BUYER-HOME] Cart count API returned:', response.status);
        }
      } catch (error) {
        console.error('[BUYER-HOME] Error updating cart badge:', error);
      }
    }

    function formatPrice(price) {
      // Format price with proper number formatting
      return new Intl.NumberFormat('en-US').format(parseFloat(price) || 0);
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white font-medium ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
      }`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Setup language and currency functionality
    function setupLanguageAndCurrency() {
      const saveMoneyBtn = document.getElementById('save-money');
      if (saveMoneyBtn) {
        saveMoneyBtn.addEventListener('click', function() {
          const langSelect = document.getElementById('lang-select');
          const currencySelect = document.getElementById('currency-select');
          
          if (langSelect && currencySelect) {
            const selectedLang = langSelect.value;
            const selectedCurrency = currencySelect.value;
            
            // Save preferences
            localStorage.setItem('selectedLanguage', selectedLang);
            localStorage.setItem('selectedCurrency', selectedCurrency);
            
            // Update display
            const moneyLabel = document.getElementById('money-label');
            if (moneyLabel) {
              moneyLabel.textContent = `${selectedLang.toUpperCase()} | ${selectedCurrency}`;
            }
            
            // Hide dropdown
            document.getElementById('money-dropdown').classList.add('hidden');
            
            showToast('Language and currency updated!', 'success');
          }
        });
      }
      
      // Load saved preferences
      const savedLang = localStorage.getItem('selectedLanguage') || 'en';
      const savedCurrency = localStorage.getItem('selectedCurrency') || 'RWF';
      
      const langSelect = document.getElementById('lang-select');
      const currencySelect = document.getElementById('currency-select');
      const moneyLabel = document.getElementById('money-label');
      
      if (langSelect) langSelect.value = savedLang;
      if (currencySelect) currencySelect.value = savedCurrency;
      if (moneyLabel) moneyLabel.textContent = `${savedLang.toUpperCase()} | ${savedCurrency}`;
    }

    // 🎯 PRODUCT SHARING FUNCTIONALITY
    async function openShareModal(productId) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) {
        showToast('Please login to share products', 'error');
        setTimeout(() => {
          window.location.href = '/auth/auth-buyer.html';
        }, 1500);
        return;
      }

      try {
        // Get product details
        const response = await fetch(`/api/products/${productId}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error('Product not found');
        }

        const product = data.product;
        
        // Calculate commission using buyer-facing price
        const shownPrice = parseFloat(product.price || product.discount_price || product.final_price || 0);
        // Platform commission = S - (S / 1.21)
        const platformCommission = shownPrice - (shownPrice / 1.21);
        const referralCommission = platformCommission * 0.15; // 15% of platform commission
        const formattedCommission = formatPrice(referralCommission);

        // Create and show modal
        const modal = createShareModal(product, formattedCommission);
        document.body.appendChild(modal);
        
        // Show modal (using Tailwind classes)
        setTimeout(() => {
          modal.classList.remove('opacity-0');
          modal.classList.add('opacity-100');
          modal.querySelector('.modal-content').classList.remove('scale-95');
          modal.querySelector('.modal-content').classList.add('scale-100');
        }, 10);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal);
          }
        });
        
      } catch (error) {
        console.error('Error opening share modal:', error);
        showToast('Failed to load product details', 'error');
      }
    }

    function createShareModal(product, commission) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';
      
      const imageUrl = product.image_url || 
                      product.main_image || 
                      product.image || 
                      (product.main_image ? `/uploads/${product.main_image}` : null) ||
                      '/public/images/placeholder-product.jpg';
      
      modal.innerHTML = `
        <div class="modal-content bg-white rounded-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Share & Earn</h3>
            <button onclick="closeModal(this.closest('.fixed'))" class="text-gray-400 hover:text-gray-600">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          
          <!-- Product Preview -->
          <div class="flex gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
            <img src="${imageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg">
            <div class="flex-1">
              <h4 class="font-semibold text-sm text-gray-900 line-clamp-2">${product.name}</h4>
              <p class="text-lg font-bold text-blue-600">${formatPrice(product.discount_price || product.price)} ${product.currency || 'RWF'}</p>
            </div>
          </div>
          
          <!-- Earning Info -->
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-2 mb-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
              </svg>
              <span class="font-semibold text-green-800">Earn ${commission} ${product.currency || 'RWF'}</span>
            </div>
            <p class="text-sm text-green-700">When someone registers and buys this product using your link!</p>
          </div>
          
          <!-- Share Platforms -->
          <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="shareToPlatform(${product.id}, 'whatsapp', this)" class="flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg transition">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.700"/>
              </svg>
              WhatsApp
            </button>
            <button onclick="shareToPlatform(${product.id}, 'facebook', this)" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              Facebook
            </button>
            <button onclick="shareToPlatform(${product.id}, 'twitter', this)" class="flex items-center justify-center gap-2 bg-blue-400 hover:bg-blue-500 text-white py-3 px-4 rounded-lg transition">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
              </svg>
              Twitter
            </button>
            <button onclick="shareToPlatform(${product.id}, 'copy_link', this)" class="flex items-center justify-center gap-2 bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg transition">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
              Copy Link
            </button>
          </div>
          
          <!-- Referral Link Display -->
          <div class="mb-4" id="referral-link-container" style="display: none;">
            <label class="block text-sm font-medium text-gray-700 mb-2">Your Referral Link:</label>
            <div class="flex gap-2">
              <input type="text" id="referral-link-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" readonly>
              <button onclick="copyReferralLink()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">
                Copy
              </button>
            </div>
          </div>
          
          <div class="text-center">
            <a href="/buyer/referrals" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
              View All Earnings →
            </a>
          </div>
        </div>
      `;
      
      return modal;
    }

    async function shareToPlatform(productId, platform, button) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) {
        showToast('Please login to share products', 'error');
        return;
      }

      let originalText = null;
      try {
        // Show loading
        if (button) {
          originalText = button.innerHTML;
          button.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
          button.disabled = true;
        }

        // Generate share link
        const response = await fetch('/api/referrals/share-product', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            product_id: productId,
            platform: platform
          })
        });

        const data = await response.json();
        
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'API route not found');
        }

        // Show referral link
        const linkContainer = document.getElementById('referral-link-container');
        const linkInput = document.getElementById('referral-link-input');
        if (linkInput && linkContainer) {
          linkInput.value = data.share_url;
          linkContainer.style.display = 'block';
        }

        // Open platform-specific share URL or copy link
        if (platform === 'copy_link') {
          copyToClipboard(data.share_url);
          showToast('Link copied to clipboard!', 'success');
        } else if (data.platform_url) {
          window.open(data.platform_url, '_blank', 'width=600,height=400');
        }

        // Restore button
        if (button && originalText !== null) {
          button.innerHTML = originalText;
          button.disabled = false;
        }

      } catch (error) {
        console.error('Share error:', error);
        showToast('Failed to generate share link: ' + error.message, 'error');
        
        // Restore button
        if (button && originalText !== null) {
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }
    }

    function closeModal(modal) {
      modal.classList.remove('opacity-100');
      modal.classList.add('opacity-0');
      modal.querySelector('.modal-content').classList.remove('scale-100');
      modal.querySelector('.modal-content').classList.add('scale-95');
      
      setTimeout(() => {
        modal.remove();
      }, 300);
    }

    function copyReferralLink() {
      const linkInput = document.getElementById('referral-link-input');
      if (linkInput && linkInput.value) {
        copyToClipboard(linkInput.value);
        showToast('Referral link copied!', 'success');
      }
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
      }
    }

    // Track referral clicks on page load
    function trackReferralClicks() {
      const urlParams = new URLSearchParams(window.location.search);
      const referralCode = urlParams.get('ref');
      
      if (referralCode) {
        // Track the click
        fetch('/api/referrals/track-click', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            referral_code: referralCode
          })
        }).catch(error => {
          console.error('Failed to track referral click:', error);
        });

        // Show referral banner if user is not logged in
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          showReferralBanner(referralCode);
        }
      }
    }

    function showReferralBanner(referralCode) {
      const banner = document.createElement('div');
      banner.className = 'fixed top-20 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-40 max-w-sm';
      banner.innerHTML = `
        <div class="flex items-start gap-3">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-white flex-shrink-0 mt-0.5" viewBox="0 0 24 24">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          <div>
            <h4 class="font-bold mb-1">Special Offer!</h4>
            <p class="text-sm mb-3">Register now using this referral link and get special bonuses!</p>
            <div class="flex gap-2">
              <a href="/auth/auth-buyer.html?ref=${referralCode}" class="bg-white text-green-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100 transition">
                Register Now
              </a>
              <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200 text-sm">
                ✕
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(banner);

      // Auto-hide after 10 seconds
      setTimeout(() => {
        if (banner.parentNode) {
          banner.remove();
        }
      }, 10000);
    }

    // --- REFERRAL TRACKING FUNCTIONS ---
    async function trackReferralConversion(action, productId, additionalData = {}) {
      try {
        const referralData = localStorage.getItem('referral_data');
        if (!referralData) {
          console.log('[REFERRAL] No referral data found for conversion tracking');
          return;
        }

        const parsedData = JSON.parse(referralData);
        console.log('[REFERRAL] Tracking conversion:', { action, productId, referralData: parsedData });

        // Update session status based on action
        let newStatus = 'clicked';
        if (action === 'add_to_cart') {
          newStatus = 'engaged'; // User is engaged with the product
        } else if (action === 'purchase') {
          newStatus = 'completed';
        }

        const response = await fetch('/api/referrals/session/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: parsedData.session_id,
            status: newStatus,
            action: action,
            product_id: productId,
            ...additionalData
          })
        });

        if (response.ok) {
          console.log('[REFERRAL] Conversion tracked successfully');
        } else {
          console.error('[REFERRAL] Failed to track conversion:', response.status);
        }

      } catch (error) {
        console.error('[REFERRAL] Error tracking conversion:', error);
      }
    }

    // Initialize referral tracking when page loads
    document.addEventListener('DOMContentLoaded', function() {
      trackReferralClicks();
    });
  </script>

  <!-- Load Floating Contact Component -->
  <script src="/buyer/floating-contact-component.js"></script>
</body>
</html> 