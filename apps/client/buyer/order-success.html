<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Minimal Navigation System -->
  <script src="/shared/universal-navigation.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Confirmed | ADD Physical Products</title>
  <link rel="icon" type="image/png" href="/public/images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="/shared/unified-router.js"></script>
  <script src="/shared/enhanced-navigation.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
    .success-animation { animation: successPulse 2s ease-in-out infinite; }
    @keyframes successPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 via-white to-blue-50 min-h-screen" data-page-type="buyer">
  
  <!-- Navigation preserved - each page has unique navigation -->

  
  <!-- Navigation preserved - each page has unique navigation -->

  
  
  
  <main class="pt-20 pb-8">
    <div class="max-w-4xl mx-auto px-4">
      
      <!-- Success Header -->
      <div class="text-center mb-12">
        <div class="success-animation inline-block mb-6">
          <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mx-auto shadow-lg">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
        </div>
        
        <h1 id="success-title" class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">üéâ Order Confirmed!</h1>
        <p id="success-subtitle" class="text-xl text-gray-600 mb-2">Thank you for your purchase</p>
        <p id="success-description" class="text-lg text-gray-500">Your order has been successfully placed and is being processed</p>
        
        <!-- Manual Payment Status -->
        <div id="manual-payment-status" class="hidden mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
          <div class="flex items-center text-orange-800">
            <i class="fas fa-clock mr-2"></i>
            <span class="font-medium">Payment Verification Pending</span>
          </div>
          <p class="text-orange-700 text-sm mt-2">
            Your payment screenshot has been received and is being verified by our admin team. 
            Your order will be confirmed within a few minutes once payment is approved.
          </p>
        </div>
      </div>

      <!-- Order Details -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Order Details</h2>
            <p class="text-gray-600">Order placed on <span id="order-date">-</span></p>
          </div>
          <div class="mt-4 md:mt-0">
            <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-medium">
              Order #<span id="order-number">-</span>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Items Ordered</h3>
          <div id="order-items" class="space-y-4">
            <!-- Items will be loaded here -->
          </div>
        </div>

        <!-- Order Summary -->
        <div class="border-t border-gray-200 pt-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Delivery Information -->
            <div>
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Delivery Information</h3>
              <div id="delivery-info" class="space-y-2 text-sm">
                <!-- Delivery info will be loaded here -->
              </div>
            </div>

            <!-- Payment Summary -->
            <div>
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Summary</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Subtotal</span>
                  <span id="summary-subtotal">$0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Shipping</span>
                  <span id="summary-shipping">$0.00</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Tax</span>
                  <span id="summary-tax">$0.00</span>
                </div>
                <div class="border-t border-gray-200 pt-2 mt-2">
                  <div class="flex justify-between font-semibold text-lg">
                    <span>Total</span>
                    <span id="summary-total">$0.00</span>
                  </div>
                </div>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                  <div class="flex items-center">
                    <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <span class="text-sm font-medium text-blue-800" id="payment-method">Payment Method</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Steps -->
      <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">What happens next?</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <h3 class="font-semibold text-gray-900 mb-2">Order Processing</h3>
            <p class="text-sm text-gray-600">We'll prepare your items and get them ready for shipment</p>
          </div>
          
          <div class="text-center">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0V6a2 2 0 012-2h4a2 2 0 012 2v1m-6 0h8m-9 0a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V8a1 1 0 00-1-1H7z"></path>
              </svg>
            </div>
            <h3 class="font-semibold text-gray-900 mb-2">Shipping</h3>
            <p class="text-sm text-gray-600">Your order will be shipped according to your selected delivery option</p>
          </div>
          
          <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"></path>
              </svg>
            </div>
            <h3 class="font-semibold text-gray-900 mb-2">Delivery</h3>
            <p class="text-sm text-gray-600">Receive your items at your specified delivery address</p>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/buyer/orders.html" d data-route="buyer.orders"ata-route="buyer.orders" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
          Track Your Order
        </a>
        
        <a href="/public/products.html" d data-route="buyer.products"ata-route="buyer.products" class="bg-white text-gray-700 px-8 py-4 rounded-xl font-semibold border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-50 transition-all duration-300 text-center">
          Continue Shopping
        </a>
        
        <button onclick="shareOrder()" class="bg-green-500 text-white px-8 py-4 rounded-xl font-semibold hover:bg-green-600 transition-all duration-300 text-center">
          Share Order
        </button>
      </div>

      <!-- Email Confirmation Notice -->
      <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-6 text-center">
        <div class="flex items-center justify-center mb-3">
          <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
          <h3 class="font-semibold text-blue-900">Email Confirmation Sent</h3>
        </div>
        <p class="text-blue-800">We've sent a confirmation email with your order details to <span id="customer-email" class="font-medium">your email address</span></p>
      </div>
    </div>
  </main>

  <script src="/shared/auth-utils.js"></script>
  <script>
    let orderData = null;

    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadOrderDetails();
    });

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/auth/auth-buyer.html';
        return;
      }
      
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.role !== 'buyer') {
        window.location.href = '/auth/access-denied.html';
        return;
      }
    }

    function loadOrderDetails() {
      // Check URL parameters for order status
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('orderId');
      const status = urlParams.get('status');
      
      // Handle manual payment status
      if (status === 'pending') {
        showManualPaymentStatus();
      }
      
      // Try to get order data from localStorage first
      const pendingOrder = localStorage.getItem('pendingOrder');
      if (pendingOrder) {
        try {
          orderData = JSON.parse(pendingOrder);
          displayOrderDetails(orderData);
          // Clear the pending order data
          localStorage.removeItem('pendingOrder');
          return;
        } catch (error) {
          console.error('Error parsing stored order data:', error);
        }
      }

      // If no stored data, try to fetch from API
      if (orderId) {
        fetchOrderDetails(orderId);
      } else {
        // Fallback: redirect to orders page
        showNotification('Order details not found', 'error');
        setTimeout(() => {
          window.location.href = '/buyer/orders.html';
        }, 3000);
      }
    }

    function showManualPaymentStatus() {
      // Update page content for manual payment
      document.getElementById('success-title').textContent = '‚è≥ Payment Verification Pending';
      document.getElementById('success-subtitle').textContent = 'Your order is being processed';
      document.getElementById('success-description').textContent = 'We have received your payment screenshot and are verifying it now';
      
      // Show manual payment status box
      document.getElementById('manual-payment-status').classList.remove('hidden');
      
      // Change success icon to pending
      const successIcon = document.querySelector('.success-animation .bg-green-500');
      if (successIcon) {
        successIcon.classList.remove('bg-green-500');
        successIcon.classList.add('bg-orange-500');
        successIcon.innerHTML = '<i class="fas fa-clock text-white text-2xl"></i>';
      }
    }

    async function fetchOrderDetails(orderId) {
      try {
        const response = await fetch(`/api/orders/${orderId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          orderData = await response.json();
          displayOrderDetails(orderData);
        } else {
          throw new Error('Failed to fetch order details');
        }
      } catch (error) {
        console.error('Error fetching order details:', error);
        showNotification('Failed to load order details', 'error');
        setTimeout(() => {
          window.location.href = '/buyer/orders.html';
        }, 3000);
      }
    }

    function displayOrderDetails(order) {
      // Order number and date
      document.getElementById('order-number').textContent = order.orderNumber || order.orderId || 'N/A';
      document.getElementById('order-date').textContent = new Date(order.createdAt || Date.now()).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Order items
      if (order.items && order.items.length > 0) {
        renderOrderItems(order.items);
      }

      // Delivery information
      if (order.deliveryInfo) {
        renderDeliveryInfo(order.deliveryInfo);
      }

      // Payment summary
      if (order.summary) {
        renderPaymentSummary(order.summary, order.paymentMethod);
      }

      // Customer email
      const customerEmail = order.deliveryInfo?.email || order.customerEmail || 'your email address';
      document.getElementById('customer-email').textContent = customerEmail;

      // Track referral conversion for completed purchase
      if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
          trackReferralConversion('purchase', item.productId || item.product_id, {
            order_id: order.orderNumber || order.orderId,
            order_value: item.price * item.quantity,
            quantity: item.quantity
          });
        });
      }

      // Clear stored order data after displaying
      localStorage.removeItem('lastOrder');
    }

    function renderOrderItems(items) {
      const container = document.getElementById('order-items');
      
      container.innerHTML = items.map(item => `
        <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
          <img src="${item.main_image || item.image || " loading="lazy"/public/images/placeholder.jpg'}" 
               alt="${item.name}" 
               class="w-16 h-16 object-cover rounded-lg">
          <div class="flex-1">
            <h4 class="font-medium text-gray-900">${item.name}</h4>
            <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
            <p class="text-sm text-gray-600">Price: ${item.currency || '$'} ${item.price}</p>
          </div>
          <div class="text-right">
            <p class="font-semibold text-gray-900">${item.currency || '$'} ${(item.price * item.quantity).toFixed(2)}</p>
          </div>
        </div>
      `).join('');
    }

    function renderDeliveryInfo(deliveryInfo) {
      const container = document.getElementById('delivery-info');
      
      container.innerHTML = `
        <div><span class="font-medium">Name:</span> ${deliveryInfo.fullName}</div>
        <div><span class="font-medium">Phone:</span> ${deliveryInfo.phone}</div>
        <div><span class="font-medium">Email:</span> ${deliveryInfo.email}</div>
        <div><span class="font-medium">Address:</span> ${deliveryInfo.address}</div>
        <div><span class="font-medium">City:</span> ${deliveryInfo.city}</div>
        <div><span class="font-medium">Country:</span> ${deliveryInfo.country}</div>
      `;
    }

    function renderPaymentSummary(summary, paymentMethod) {
      document.getElementById('summary-subtotal').textContent = `$${summary.subtotal.toFixed(2)}`;
      document.getElementById('summary-shipping').textContent = `$${summary.shipping.toFixed(2)}`;
      document.getElementById('summary-tax').textContent = `$${summary.tax.toFixed(2)}`;
      document.getElementById('summary-total').textContent = `$${summary.total.toFixed(2)}`;
      
      // Payment method
      const paymentMethods = {
        card: 'Credit/Debit Card',
        mobile: 'Mobile Money',
        cod: 'Cash on Delivery'
      };
      
      document.getElementById('payment-method').textContent = paymentMethods[paymentMethod] || paymentMethod || 'Not specified';
    }

    function shareOrder() {
      if (navigator.share && orderData) {
        navigator.share({
          title: 'My Order from ADD Physical Products',
          text: `I just placed an order (#${orderData.orderNumber || orderData.orderId}) on ADD Physical Products!`,
          url: window.location.href
        }).catch(console.error);
      } else {
        // Fallback: copy to clipboard
        const orderUrl = window.location.href;
        navigator.clipboard.writeText(orderUrl).then(() => {
          showNotification('Order link copied to clipboard!', 'success');
        }).catch(() => {
          showNotification('Unable to share order', 'error');
        });
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Auto-redirect after 30 seconds if user is inactive
    let redirectTimer = setTimeout(() => {
      if (confirm('Would you like to continue shopping or view your orders?')) {
        window.location.href = '/public/products.html';
      } else {
        window.location.href = '/buyer/orders.html';
      }
    }, 30000);

    // Clear timer on user interaction
    document.addEventListener('click', () => {
      clearTimeout(redirectTimer);
    });
  </script>

  <!-- Navigation utilities for this page -->
  <script>
    // Page-specific navigation setup
    document.addEventListener('DOMContentLoaded', function() {
      // Set page type and mode
      document.body.setAttribute('data-page-type', 'buyer');
      
      
      
      // Add navigation helpers to existing elements
      enhanceExistingNavigation();
      
      // Setup page-specific navigation
      setupPageNavigation();
    });
    
    function enhanceExistingNavigation() {
      // Add data-route attributes to links that don't have them
      const links = document.querySelectorAll('a[href]:not([data-route])');
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (href && !href.startsWith('http') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
          const route = getRouteForHref(href);
          if (route) {
            link.setAttribute('data-route', route);
          }
        }
      });
      
      // Add journey actions to buttons
      const buttons = document.querySelectorAll('button, .btn, [role="button"]');
      buttons.forEach(button => {
        const text = button.textContent.toLowerCase();
        
        if (text.includes('add') && text.includes('cart')) {
          button.setAttribute('data-journey-action', 'add-to-cart');
        } else if (text.includes('checkout')) {
          button.setAttribute('data-journey-action', 'proceed-checkout');
        } else if (text.includes('place') && text.includes('order')) {
          button.setAttribute('data-journey-action', 'complete-payment');
        } else if (text.includes('login') || text.includes('sign in')) {
          button.setAttribute('data-quick-nav', 'login');
        } else if (text.includes('logout') || text.includes('sign out')) {
          button.setAttribute('data-quick-nav', 'logout');
        }
      });
    }
    
    function setupPageNavigation() {
      // Page-specific navigation setup
      const pageType = 'buyer';
      
      // Add mode indicators if they exist
      const modeIndicators = document.querySelectorAll('.mode-indicator');
      modeIndicators.forEach(indicator => {
        const currentMode = window.navUtils ? window.navUtils.getCurrentMode() : 'marketplace';
        indicator.className = `mode-indicator mode-${currentMode}`;
        indicator.textContent = currentMode === 'marketplace' ? 'Marketplace' : 'Local Market';
      });
      
      // Add quick navigation buttons if they exist
      const homeButtons = document.querySelectorAll('[data-nav="home"], .home-btn');
      homeButtons.forEach(btn => btn.setAttribute('data-quick-nav', 'home'));
      
      const backButtons = document.querySelectorAll('[data-nav="back"], .back-btn');
      backButtons.forEach(btn => btn.setAttribute('data-quick-nav', 'back'));
      
      const dashboardButtons = document.querySelectorAll('[data-nav="dashboard"], .dashboard-btn');
      dashboardButtons.forEach(btn => btn.setAttribute('data-quick-nav', 'dashboard'));
    }
    
    function getRouteForHref(href) {
      // Basic route mapping
      const routeMap = {
        '/': 'home',
        '/public/index.html': 'home',
        '/public/about.html': 'public.about',
        '/public/contact.html': 'public.contact',
        '/public/products.html': 'public.product-list',
        '/public/product-detail.html': 'public.product-detail',
        '/buyer/buyers-home.html': 'buyer.dashboard',
        '/buyer/cart.html': 'buyer.cart',
        '/buyer/checkout.html': 'buyer.checkout',
        '/buyer/orders.html': 'buyer.orders',
        '/seller/dashboard.html': 'seller.dashboard',
        '/seller/add-product.html': 'seller.add-product',
        '/agent/dashboard.html': 'agent.dashboard',
        '/admin/dashboard.html': 'admin.dashboard',
        '/auth/auth-buyer.html': 'auth.login',
        '/auth/auth-seller.html': 'auth.login-seller',
        '/auth/auth-agent.html': 'auth.login-agent',
        '/grocery/local-market-home.html': 'local-market.home',
        '/grocery/cart.html': 'local-market.cart'
      };
      
      return routeMap[href] || null;
    }
    
    // Wait for flexible navigation system to be ready
    window.addEventListener('flexibleNavigationReady', function() {
      console.log('‚úÖ Flexible navigation ready on buyer\order-success.html');
      
      // Start appropriate journey if needed
      
    });

    // --- REFERRAL TRACKING FUNCTIONS ---
    async function trackReferralConversion(action, productId, additionalData = {}) {
      try {
        const referralData = localStorage.getItem('referral_data');
        if (!referralData) {
          console.log('[REFERRAL] No referral data found for conversion tracking');
          return;
        }

        const parsedData = JSON.parse(referralData);
        console.log('[REFERRAL] Tracking conversion:', { action, productId, referralData: parsedData });

        // Update session status based on action
        let newStatus = 'clicked';
        if (action === 'add_to_cart') {
          newStatus = 'engaged'; // User is engaged with the product
        } else if (action === 'purchase') {
          newStatus = 'completed'; // Purchase completed
        }

        const response = await fetch('/api/referrals/session/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: parsedData.session_id,
            status: newStatus,
            action: action,
            product_id: productId,
            ...additionalData
          })
        });

        if (response.ok) {
          console.log('[REFERRAL] Purchase conversion tracked successfully');
          
          // Clear referral data after successful purchase tracking
          if (action === 'purchase') {
            localStorage.removeItem('referral_data');
            console.log('[REFERRAL] Referral data cleared after purchase completion');
          }
        } else {
          console.error('[REFERRAL] Failed to track conversion:', response.status);
        }

      } catch (error) {
        console.error('[REFERRAL] Error tracking conversion:', error);
      }
    }
  </script>

</body>
</html>