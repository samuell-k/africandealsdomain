<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Payment | ADD Physical Products</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .payment-option {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .payment-option:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .payment-option.selected {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
      .mobile-stack { flex-direction: column !important; }
      .mobile-full { width: 100% !important; }
      .mobile-grid-1 { grid-template-columns: 1fr !important; }
      .mobile-text-sm { font-size: 0.875rem !important; }
      .mobile-p-4 { padding: 1rem !important; }
      
      .grid.grid-cols-1.lg\:grid-cols-3,
      .grid.grid-cols-3,
      .lg\:grid-cols-3 {
        grid-template-columns: 1fr !important;
      }
      
      .payment-option {
        margin-bottom: 1rem;
        padding: 1rem;
        font-size: 1rem;
      }
      
      .order-summary {
        position: static !important;
        margin-top: 2rem;
        width: 100% !important;
      }
      
      .checkout-form input,
      .checkout-form select,
      .checkout-form textarea {
        font-size: 16px !important; /* Prevent zoom on iOS */
        padding: 0.75rem !important;
      }
      
      .max-w-6xl {
        max-width: 100% !important;
        padding: 1rem !important;
      }
      
      .container {
        padding: 1rem !important;
      }
    }
    
    .success-animation {
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">
  
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center">
          <img src="/uploads/logo.png" alt="ADD Physical Products" class="h-8 w-auto">
          <span class="ml-2 text-xl font-bold text-gray-900">ADD Physical Products</span>
        </div>
        
        <!-- Navigation -->
        <nav class="hidden md:flex space-x-8">
          <a href="/buyer/buyers-home.html" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
          <a href="/buyer/products.html" class="text-gray-700 hover:text-blue-600 font-medium">Products</a>
          <a href="/buyer/orders.html" class="text-gray-700 hover:text-blue-600 font-medium">Orders</a>
          <a href="/buyer/cart.html" class="text-gray-700 hover:text-blue-600 font-medium">Cart</a>
        </nav>
        
        <!-- User Profile -->
        <div class="relative">
          <button id="profile-btn" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors">
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
              <i class="fas fa-user text-white text-sm"></i>
            </div>
            <span id="profile-name" class="font-medium">User</span>
            <i class="fas fa-chevron-down text-sm"></i>
          </button>
          
          <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden z-50">
            <a href="/buyer/buyers-home.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">
              <i class="fas fa-home mr-2"></i>Dashboard
            </a>
            <a href="/buyer/orders.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">
              <i class="fas fa-shopping-bag mr-2"></i>My Orders
            </a>
            <hr class="my-1">
            <button id="signout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">
              <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Progress Bar -->
  <div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-center space-x-8">
        <div class="flex items-center text-green-600">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
            <i class="fas fa-check"></i>
          </div>
          <span class="ml-2 font-medium">Cart</span>
        </div>
        <div class="w-16 h-1 bg-green-600 rounded"></div>
        <div class="flex items-center text-green-600">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
            <i class="fas fa-check"></i>
          </div>
          <span class="ml-2 font-medium">Delivery</span>
        </div>
        <div class="w-16 h-1 bg-green-600 rounded"></div>
        <div class="flex items-center text-blue-600">
          <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">3</div>
          <span class="ml-2 font-medium">Payment</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Payment Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Payment Form -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Order Summary -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-shopping-cart text-green-600 mr-3"></i>
            Order Summary
          </h2>
          <div id="order-summary" class="bg-gray-50 rounded-lg p-4 mb-4">
            <!-- Order summary will be loaded here -->
          </div>
          <button type="button" id="change-order" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
            <i class="fas fa-edit mr-1"></i>
            Change Order
          </button>
        </div>
        
        <!-- Contact Information -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-user text-blue-600 mr-3"></i>
            Contact Information
          </h2>
          
          <form id="payment-form" class="space-y-6 checkout-form">
            <!-- Personal Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                <input type="text" id="firstName" name="firstName" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              </div>
              <div>
                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              </div>
            </div>
            
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
              <input type="email" id="email" name="email" required 
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
            </div>
            
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
              <input type="tel" id="phone" name="phone" required 
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
            </div>
            
            <!-- Additional Notes -->
            <div>
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Order Notes (Optional)</label>
              <textarea id="notes" name="notes" rows="3" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        placeholder="Any special instructions for your order..."></textarea>
            </div>
          </form>
        </div>

        <!-- Payment Method -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-credit-card text-green-600 mr-3"></i>
            Payment Method
          </h2>
          
          <div class="space-y-4">
            <!-- Mobile Money (Default Payment Method) -->
            <div class="payment-option border-2 border-blue-200 rounded-lg p-4 selected" data-payment="mobile_money">
              <div class="flex items-center">
                <input type="radio" id="mobileMoney" name="paymentMethod" value="mobile_money" 
                       class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                <label for="mobileMoney" class="ml-3 flex-1 cursor-pointer">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <i class="fas fa-mobile-alt text-green-600 mr-2"></i>
                      <span class="font-medium text-gray-900">Mobile Money</span>
                    </div>
                    <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">Recommended</span>
                  </div>
                  <p class="text-sm text-gray-600 mt-1">Pay with MTN, Airtel, or other mobile money services</p>
                </label>
              </div>
            </div>
            
            <!-- Bank Transfer -->
            <div class="payment-option border-2 border-gray-200 rounded-lg p-4" data-payment="bank_transfer">
              <div class="flex items-center">
                <input type="radio" id="bankTransfer" name="paymentMethod" value="bank_transfer" 
                       class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                <label for="bankTransfer" class="ml-3 flex-1 cursor-pointer">
                  <div class="flex items-center">
                    <i class="fas fa-university text-purple-600 mr-2"></i>
                    <span class="font-medium text-gray-900">Bank Transfer</span>
                  </div>
                  <p class="text-sm text-gray-600 mt-1">Direct bank transfer to our account</p>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Payment Fields -->
          <div id="payment-fields" class="mt-6">
            <!-- Mobile Money Fields (Default) -->
            <div id="mobileMoneyFields" class="space-y-4">
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h4 class="font-semibold text-green-900 mb-3">üì± Mobile Money Payment Instructions</h4>
                <div class="text-sm text-green-800 space-y-2">
                  <p><strong>1. Choose your preferred mobile money provider and send payment:</strong></p>
                  
                  <!-- Mobile Money Options -->
                  <div id="mobile-money-options" class="space-y-3 mt-3">
                    <!-- MTN Mobile Money -->
                    <div class="bg-white border border-green-300 rounded-lg p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center mr-3">
                          <span class="text-white font-bold text-xs">MTN</span>
                        </div>
                        <h5 class="font-semibold text-gray-900">MTN Mobile Money</h5>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <p><strong>üì± Phone:</strong> <span id="mtn-phone" class="font-mono">+250 788 123 456</span></p>
                        <p><strong>üë§ Name:</strong> <span id="mtn-name">African Deals Domain</span></p>
                        <p><strong>üè∑Ô∏è Code:</strong> <span id="mtn-code" class="font-mono">*182*8*1#</span></p>
                        <p><strong>üí∞ Amount:</strong> <span class="payment-amount font-semibold">FRw 0</span></p>
                      </div>
                    </div>
                    
                    <!-- Airtel Money -->
                    <div class="bg-white border border-green-300 rounded-lg p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center mr-3">
                          <span class="text-white font-bold text-xs">AIR</span>
                        </div>
                        <h5 class="font-semibold text-gray-900">Airtel Money</h5>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <p><strong>üì± Phone:</strong> <span id="airtel-phone" class="font-mono">+250 733 456 789</span></p>
                        <p><strong>üë§ Name:</strong> <span id="airtel-name">African Deals Domain</span></p>
                        <p><strong>üè∑Ô∏è Code:</strong> <span id="airtel-code" class="font-mono">*500*2*1#</span></p>
                        <p><strong>üí∞ Amount:</strong> <span class="payment-amount font-semibold">FRw 0</span></p>
                      </div>
                    </div>
                    
                    <!-- Tigo Cash -->
                    <div class="bg-white border border-green-300 rounded-lg p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                          <span class="text-white font-bold text-xs">TIG</span>
                        </div>
                        <h5 class="font-semibold text-gray-900">Tigo Cash</h5>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <p><strong>üì± Phone:</strong> <span id="tigo-phone" class="font-mono">+250 722 789 012</span></p>
                        <p><strong>üë§ Name:</strong> <span id="tigo-name">African Deals Domain</span></p>
                        <p><strong>üè∑Ô∏è Code:</strong> <span id="tigo-code" class="font-mono">*505#</span></p>
                        <p><strong>üí∞ Amount:</strong> <span class="payment-amount font-semibold">FRw 0</span></p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mt-3 p-2 bg-green-100 rounded">
                    <p><strong>2. Take a screenshot</strong> of your payment confirmation</p>
                    <p><strong>3. Upload the screenshot</strong> below to verify your payment</p>
                  </div>
                </div>
              </div>
              
              <div>
                <label for="mobileNumber" class="block text-sm font-medium text-gray-700 mb-1">Your Mobile Number *</label>
                <input type="tel" id="mobileNumber" name="mobileNumber" placeholder="+250 788 123 456" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <div class="text-xs text-gray-500 mt-1">
                  The number you used to make the payment
                </div>
              </div>
              
              <div>
                <label for="mobileProvider" class="block text-sm font-medium text-gray-700 mb-1">Provider *</label>
                <select id="mobileProvider" name="mobileProvider" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                  <option value="">Select Provider</option>
                  <option value="mtn">MTN Mobile Money</option>
                  <option value="airtel">Airtel Money</option>
                  <option value="tigo">Tigo Cash</option>
                </select>
              </div>
              
              <div>
                <label for="paymentProof" class="block text-sm font-medium text-gray-700 mb-2">Upload Payment Screenshot *</label>
                <input type="file" id="paymentProof" accept="image/*" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <div class="text-xs text-gray-500 mt-1">
                  Upload screenshot showing successful payment
                </div>
              </div>
            </div>
            
            <!-- Bank Transfer Fields -->
            <div id="bankTransferFields" class="space-y-4 hidden">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-semibold text-blue-900 mb-3">üè¶ Bank Transfer Instructions</h4>
                <div class="text-sm text-blue-800 space-y-2">
                  <p><strong>1. Choose your preferred bank and transfer the payment:</strong></p>
                  
                  <!-- Bank Transfer Options -->
                  <div id="bank-transfer-options" class="space-y-3 mt-3">
                    <!-- Primary Bank Account -->
                    <div class="bg-white border border-blue-300 rounded-lg p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                          <i class="fas fa-university text-white text-xs"></i>
                        </div>
                        <h5 class="font-semibold text-gray-900">Primary Bank Account</h5>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <p><strong>üè¶ Bank:</strong> <span id="primary-bank-name">Bank of Kigali</span></p>
                        <p><strong>üë§ Account Name:</strong> <span id="primary-account-name">African Deals Domain Ltd</span></p>
                        <p><strong>üî¢ Account Number:</strong> <span id="primary-account-number" class="font-mono">00123456789</span></p>
                        <p><strong>üåê SWIFT Code:</strong> <span id="primary-swift-code" class="font-mono">BKGLRWRW</span></p>
                        <p><strong>üè¢ Branch:</strong> <span id="primary-branch">Kigali Main Branch</span></p>
                        <p><strong>üí∞ Amount:</strong> <span class="payment-amount font-semibold">FRw 0</span></p>
                      </div>
                    </div>
                    
                    <!-- Secondary Bank Account -->
                    <div class="bg-white border border-blue-300 rounded-lg p-3">
                      <div class="flex items-center mb-2">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                          <i class="fas fa-university text-white text-xs"></i>
                        </div>
                        <h5 class="font-semibold text-gray-900">Alternative Bank Account</h5>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <p><strong>üè¶ Bank:</strong> <span id="secondary-bank-name">Equity Bank Rwanda</span></p>
                        <p><strong>üë§ Account Name:</strong> <span id="secondary-account-name">African Deals Domain Ltd</span></p>
                        <p><strong>üî¢ Account Number:</strong> <span id="secondary-account-number" class="font-mono">40012345678</span></p>
                        <p><strong>üåê SWIFT Code:</strong> <span id="secondary-swift-code" class="font-mono">EQBLRWRW</span></p>
                        <p><strong>üè¢ Branch:</strong> <span id="secondary-branch">Kigali City Branch</span></p>
                        <p><strong>üí∞ Amount:</strong> <span class="payment-amount font-semibold">FRw 0</span></p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mt-3 p-2 bg-blue-100 rounded">
                    <p><strong>Reference:</strong> ADD-<span id="reference-code">ORDER</span></p>
                    <p><strong>2. Take a screenshot</strong> of your transfer confirmation</p>
                    <p><strong>3. Upload the screenshot</strong> below to verify your payment</p>
                  </div>
                </div>
              </div>
              
              <div>
                <label for="bankName" class="block text-sm font-medium text-gray-700 mb-1">Your Bank Name *</label>
                <input type="text" id="bankName" name="bankName" placeholder="Your bank name" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              </div>
              
              <div>
                <label for="transferProof" class="block text-sm font-medium text-gray-700 mb-2">Upload Transfer Receipt *</label>
                <input type="file" id="transferProof" accept="image/*" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <div class="text-xs text-gray-500 mt-1">
                  Upload receipt showing successful bank transfer
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Order Summary -->
      <div class="lg:col-span-1">
        <div class="glass-card rounded-2xl p-6 sticky top-20">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-receipt text-purple-600 mr-3"></i>
            Payment Summary
          </h2>
          
          <div id="order-items" class="space-y-3 mb-6">
            <!-- Order items will be loaded here -->
          </div>
          
          <div class="border-t pt-4 space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Subtotal:</span>
              <span id="subtotal" class="font-medium">FRw 0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Delivery Fee:</span>
              <span id="shipping" class="font-medium">FRw 0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Tax:</span>
              <span id="tax" class="font-medium">FRw 0</span>
            </div>
            <div id="free-shipping-notice" class="text-sm text-green-600 font-medium hidden">
              üéâ Free delivery applied!
            </div>
            <hr class="my-3">
            <div class="flex justify-between text-lg font-bold">
              <span>Total:</span>
              <span id="total" class="text-green-600">FRw 0</span>
            </div>
          </div>
          
          <button id="place-order-btn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white py-3 rounded-lg font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
            <i class="fas fa-shopping-cart mr-2"></i>
            Place Order
          </button>
          
          <div class="mt-4 flex justify-between text-center">
            <a href="/buyer/checkout.html" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
              <i class="fas fa-arrow-left mr-1"></i>Back to Checkout
            </a>
            <a href="/buyer/cart.html" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
              <i class="fas fa-shopping-cart mr-1"></i>View Cart
            </a>
          </div>
          
          <!-- Security Notice -->
          <div class="mt-6 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center text-green-700 text-sm">
              <i class="fas fa-shield-alt mr-2"></i>
              <span>Your payment is secured with 256-bit SSL encryption</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">Processing your order...</p>
      <p class="text-gray-500 text-sm mt-2">Please don't close this window</p>
    </div>
  </div>

  <script>
    class PaymentManager {
      constructor() {
        this.checkoutData = null;
        this.cartItems = [];
        this.userInfo = {};
        this.selectedPaymentMethod = 'mobile_money';
        this.subtotal = 0;
        this.deliveryFee = 0;
        this.tax = 0;
        this.total = 0;
        this.init();
      }

      async init() {
        try {
          console.log('üöÄ Initializing payment page...');
          
          // Check authentication
          this.checkAuthentication();
          
          // Load checkout data
          this.loadCheckoutData();
          
          // Load user information
          await this.loadUserInfo();
          
          // Setup event listeners
          this.setupEventListeners();
          
          // Setup profile dropdown
          this.setupProfileDropdown();
          
          // Render order summary
          this.renderOrderSummary();
          
          // Display order summary
          this.displayOrderSummary();
          
          // Initialize payment fields
          this.initializePaymentFields();
          
          console.log('‚úÖ Payment page initialized successfully');
        } catch (error) {
          console.error('‚ùå Error initializing payment page:', error);
          this.showNotification('Failed to load payment data', 'error');
        }
      }

      checkAuthentication() {
        const token = localStorage.getItem('authToken');
        const userData = localStorage.getItem('userData');
        
        if (!token || !userData) {
          window.location.href = '/auth/auth-buyer.html';
          return;
        }
        
        try {
          const user = JSON.parse(userData);
          const profileName = document.getElementById('profile-name');
          if (profileName) {
            profileName.textContent = user.username || 'User';
          }
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      }

      loadCheckoutData() {
        const checkoutData = localStorage.getItem('checkoutData');
        if (!checkoutData) {
          alert('Please select a delivery method first.');
          window.location.href = '/buyer/delivery-method-selection.html';
          return;
        }

        try {
          this.checkoutData = JSON.parse(checkoutData);
          console.log('üì¶ Checkout data loaded:', this.checkoutData);
          
          // Extract cart items
          this.cartItems = this.checkoutData.items || [];
          
          // Extract pricing information
          this.subtotal = this.checkoutData.subtotal || 0;
          this.deliveryFee = this.checkoutData.deliveryFee || 0;
          this.tax = this.checkoutData.tax || 0;
          this.total = this.checkoutData.total || 0;
          
          if (this.cartItems.length === 0) {
            alert('Your cart is empty. Please add items to your cart first.');
            window.location.href = '/buyer/products.html';
            return;
          }
        } catch (error) {
          console.error('Error loading checkout data:', error);
          window.location.href = '/buyer/delivery-method-selection.html';
        }
      }

      async loadUserInfo() {
        try {
          const token = localStorage.getItem('authToken');
          const response = await fetch('/api/auth/profile', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            this.userInfo = data.user || {};
            this.populateUserInfo();
          }
        } catch (error) {
          console.error('Error loading user info:', error);
        }
      }

      populateUserInfo() {
        if (this.userInfo.name) {
          const nameParts = this.userInfo.name.split(' ');
          document.getElementById('firstName').value = nameParts[0] || '';
          document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
        }
        if (this.userInfo.email) {
          document.getElementById('email').value = this.userInfo.email;
        }
        if (this.userInfo.phone) {
          document.getElementById('phone').value = this.userInfo.phone;
        }
      }

      displayOrderSummary() {
        const displayElement = document.getElementById('order-summary');
        
        // Get delivery method information
        const deliveryMethod = this.checkoutData.deliveryType || 'unknown';
        let deliveryInfo = '';
        
        if (deliveryMethod === 'pickup') {
          const pickupSite = this.checkoutData.pickupSite || {};
          deliveryInfo = `
            <div class="flex items-start space-x-3">
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-store text-green-600"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">Pickup Delivery</h3>
                <p class="text-sm text-gray-600 mt-1">Your order will be collected from a pickup location</p>
                <div class="mt-2 p-2 bg-blue-50 rounded-lg">
                  <p class="text-sm font-medium text-blue-900">Pickup Site:</p>
                  <p class="text-sm text-blue-700">${pickupSite.name || pickupSite.site_name || 'Default Location'}</p>
                  <p class="text-sm text-blue-600">${pickupSite.address || pickupSite.address_line1 || ''}</p>
                </div>
                <div class="mt-2 flex items-center space-x-4 text-sm">
                  <span class="text-green-600 font-semibold">
                    <i class="fas fa-check mr-1"></i>
                    FREE Delivery
                  </span>
                </div>
              </div>
            </div>
          `;
        } else if (deliveryMethod === 'home') {
          const address = this.checkoutData.deliveryAddress || {};
          deliveryInfo = `
            <div class="flex items-start space-x-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-home text-blue-600"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">Home Delivery</h3>
                <p class="text-sm text-gray-600 mt-1">Your order will be delivered to your home</p>
                <div class="mt-2 p-2 bg-blue-50 rounded-lg">
                  <p class="text-sm font-medium text-blue-900">Delivery Address:</p>
                  <p class="text-sm text-blue-700">
                    ${address.street || address.display_name || ''}<br>
                    ${address.city || ''}, ${address.state || ''}
                  </p>
                </div>
                <div class="mt-2 flex items-center space-x-4 text-sm">
                  <span class="text-blue-600 font-semibold">
                    <i class="fas fa-truck mr-1"></i>
                    Delivery Fee: ${this.deliveryFee === 0 ? 'FREE' : `FRw ${this.deliveryFee.toLocaleString()}`}
                  </span>
                </div>
              </div>
            </div>
          `;
        }
        
        // Display order summary
        displayElement.innerHTML = deliveryInfo;
      }

      renderOrderSummary() {
        const container = document.getElementById('order-items');
        
        if (!this.cartItems || this.cartItems.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">No items in cart</p>';
          return;
        }
        
        container.innerHTML = this.cartItems.map(item => `
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <img src="${item.main_image ? `/uploads/${item.main_image}` : '/uploads/logo.png'}" 
                 alt="${item.name}" 
                 class="w-12 h-12 object-cover rounded-lg"
                 onerror="this.src='/uploads/logo.png'">
            <div class="flex-1">
              <h4 class="font-medium text-gray-900 text-sm">${item.name}</h4>
              <p class="text-gray-600 text-xs">Qty: ${item.quantity}</p>
              <p class="text-gray-500 text-xs">FRw ${parseFloat(item.price).toLocaleString()} each</p>
            </div>
            <div class="text-right">
              <p class="font-semibold text-gray-900 text-sm">FRw ${(parseFloat(item.price) * parseInt(item.quantity)).toLocaleString()}</p>
            </div>
          </div>
        `).join('');
        
        this.updateOrderSummary();
      }

      updateOrderSummary() {
        document.getElementById('subtotal').textContent = `FRw ${this.subtotal.toLocaleString()}`;
        document.getElementById('shipping').textContent = this.deliveryFee === 0 ? 'FREE' : `FRw ${this.deliveryFee.toLocaleString()}`;
        document.getElementById('tax').textContent = `FRw ${this.tax.toLocaleString()}`;
        document.getElementById('total').textContent = `FRw ${this.total.toLocaleString()}`;
        
        // Show free shipping notice if applicable
        const freeShippingNotice = document.getElementById('free-shipping-notice');
        if (freeShippingNotice) {
          if (this.deliveryFee === 0) {
            freeShippingNotice.classList.remove('hidden');
          } else {
            freeShippingNotice.classList.add('hidden');
          }
        }
        
        // Update payment amounts across UI (new structure)
        const formattedAmount = `FRw ${this.total.toLocaleString()}`;
        document.querySelectorAll('.payment-amount').forEach(el => (el.textContent = formattedAmount));
        
        // Legacy fallbacks if these IDs exist in DOM
        const legacyPayment = document.getElementById('payment-amount');
        if (legacyPayment) legacyPayment.textContent = formattedAmount;
        const legacyBank = document.getElementById('bank-amount');
        if (legacyBank) legacyBank.textContent = formattedAmount;
      }

      setupEventListeners() {
        // Change order button
        document.getElementById('change-order').addEventListener('click', () => {
          if (confirm('Are you sure you want to change your order? This will take you back to the checkout page.')) {
            window.location.href = '/buyer/checkout.html';
          }
        });

        // Payment method selection
        const paymentOptions = document.querySelectorAll('.payment-option');
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
        
        paymentOptions.forEach(option => {
          option.addEventListener('click', () => {
            const radio = option.querySelector('input[type="radio"]');
            radio.checked = true;
            this.handlePaymentMethodChange(radio.value);
            this.updatePaymentOptionStyles();
          });
        });

        paymentRadios.forEach(radio => {
          radio.addEventListener('change', () => {
            this.handlePaymentMethodChange(radio.value);
            this.updatePaymentOptionStyles();
          });
        });

        // Place order button
        document.getElementById('place-order-btn').addEventListener('click', () => {
          this.placeOrder();
        });
      }

      updatePaymentOptionStyles() {
        const paymentOptions = document.querySelectorAll('.payment-option');
        paymentOptions.forEach(option => {
          const radio = option.querySelector('input[type="radio"]');
          if (radio.checked) {
            option.classList.add('selected');
          } else {
            option.classList.remove('selected');
          }
        });
      }

      async handlePaymentMethodChange(method) {
        console.log('üí≥ Payment method changed to:', method);
        this.selectedPaymentMethod = method;
        
        // Hide all payment fields
        document.getElementById('mobileMoneyFields').classList.add('hidden');
        document.getElementById('bankTransferFields').classList.add('hidden');
        
        // Show relevant fields
        switch (method) {
          case 'mobile_money':
            document.getElementById('mobileMoneyFields').classList.remove('hidden');
            // Update payment details
            this.updateMobileMoneyDetails();
            break;
            
          case 'bank_transfer':
            document.getElementById('bankTransferFields').classList.remove('hidden');
            // Update bank transfer details
            this.updateBankTransferDetails();
            break;
        }
      }
      
      updateMobileMoneyDetails() {
        // Update mobile money payment details with new structure
        const formattedAmount = `FRw ${this.total.toLocaleString()}`;
        
        // Update all payment amount displays
        const paymentAmountElements = document.querySelectorAll('.payment-amount');
        paymentAmountElements.forEach(element => {
          element.textContent = formattedAmount;
        });
        
        // Legacy support for old element IDs
        const legacyPaymentAmount = document.getElementById('payment-amount');
        if (legacyPaymentAmount) {
          legacyPaymentAmount.textContent = formattedAmount;
        }
      }
      
      updateBankTransferDetails() {
        // Update bank transfer payment details with new structure
        const formattedAmount = `FRw ${this.total.toLocaleString()}`;
        
        // Update all payment amount displays
        const paymentAmountElements = document.querySelectorAll('.payment-amount');
        paymentAmountElements.forEach(element => {
          element.textContent = formattedAmount;
        });
        
        // Legacy support for old element IDs
        const legacyBankAmount = document.getElementById('bank-amount');
        if (legacyBankAmount) {
          legacyBankAmount.textContent = formattedAmount;
        }
        
        // Generate a unique reference code based on timestamp
        const referenceCode = `${Date.now().toString().slice(-6)}`;
        const referenceElement = document.getElementById('reference-code');
        if (referenceElement) {
          referenceElement.textContent = referenceCode;
        }
      }

      async loadPaymentConfiguration() {
        try {
          console.log('üí≥ Loading payment configuration...');
          const token = localStorage.getItem('authToken');
          const response = await fetch('/api/payment-settings/public', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            console.log('üí≥ Payment configuration loaded:', data);
            return data.settings || this.getDefaultPaymentConfig();
          } else {
            console.log('üí≥ Failed to load payment configuration, using defaults');
            return this.getDefaultPaymentConfig();
          }
        } catch (error) {
          console.error('Error loading payment configuration:', error);
          return this.getDefaultPaymentConfig();
        }
      }
      
      getDefaultPaymentConfig() {
        // Default payment configuration
        return {
          mobile_money_enabled: true,
          bank_transfer_enabled: true,
          mobile_number: '+250 788 123 456',
          momo_code: 'ADD2024',
          bank_details: {
            bank_name: 'Bank of Kigali',
            account_name: 'African Deals Domain',
            account_number: '123456789',
            swift_code: 'BKGLRWRW'
          }
        };
      }

      async initializePaymentFields() {
        // Set mobile money as default payment method
        this.selectedPaymentMethod = 'mobile_money';
        
        // Hide mock placeholders first, then load real credentials from API
        this.hideMockPaymentSections();
        await this.loadPaymentCredentials();
        
        // Start background auto-refresh so admin changes reflect automatically
        this.startPaymentCredentialsAutoRefresh?.();
        
        // Initialize mobile money fields
        this.updateMobileMoneyDetails();
        
        // Initialize bank transfer fields
        this.updateBankTransferDetails();
        
        // Set mobile money radio button as checked
        const mobileRadio = document.getElementById('mobileMoney');
        if (mobileRadio) mobileRadio.checked = true;
        
        // Add selected class to mobile money option
        const mobileCard = document.querySelector('[data-payment="mobile_money"]');
        if (mobileCard) mobileCard.classList.add('selected');
      }

      async loadPaymentCredentials() {
        try {
          console.log('üîÑ Loading payment credentials...');
          
          const response = await fetch('/api/payment-credentials/public', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ Payment credentials loaded:', data);
            
            if (data.success && data.credentials) {
              this.updatePaymentCredentialsUI(data.credentials);
            }
          } else {
            console.warn('‚ö†Ô∏è Failed to load payment credentials, using defaults');
          }
        } catch (error) {
          console.error('‚ùå Error loading payment credentials:', error);
          // Continue with default credentials if API fails
        }
      }

      hideMockPaymentSections() {
        // Hide all mock sections until real credentials are loaded
        try {
          const mobileOptionCard = document.querySelector('[data-payment="mobile_money"]');
          const bankOptionCard = document.querySelector('[data-payment="bank_transfer"]');
          if (mobileOptionCard) mobileOptionCard.style.display = 'none';
          if (bankOptionCard) bankOptionCard.style.display = 'none';

          const mobileBlocks = document.querySelectorAll('#mobile-money-options > div');
          mobileBlocks.forEach(b => b.style.display = 'none');

          const bankBlocks = document.querySelectorAll('#bank-transfer-options > div');
          bankBlocks.forEach(b => b.style.display = 'none');

          const placeBtn = document.getElementById('place-order-btn');
          if (placeBtn) placeBtn.disabled = true;
        } catch (e) {
          // ignore
        }
      }

      startPaymentCredentialsAutoRefresh() {
        try {
          if (this._paymentCredsInterval) clearInterval(this._paymentCredsInterval);
          this._paymentCredsInterval = setInterval(async () => {
            try {
              const res = await fetch('/api/payment-credentials/public', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
              });
              if (!res.ok) return;
              const data = await res.json();
              if (data && data.success && data.credentials) {
                const prev = JSON.stringify(this.currentPaymentCredentials || {});
                const next = JSON.stringify(data.credentials || {});
                if (prev !== next) {
                  this.updatePaymentCredentialsUI(data.credentials);
                  this.showNotification('Payment options updated by admin. Display refreshed.', 'info');
                }
              }
            } catch (e) {
              // silently ignore periodic fetch errors
            }
          }, 60000); // refresh every 60 seconds
        } catch (e) {
          console.error('‚ùå Error starting payment credentials auto-refresh:', e);
        }
      }

      updatePaymentCredentialsUI(credentials) {
        // Cache current credentials
        this.currentPaymentCredentials = credentials || {};

        // Top-level payment option cards
        const mobileOptionCard = document.querySelector('[data-payment="mobile_money"]');
        const bankOptionCard = document.querySelector('[data-payment="bank_transfer"]');

        // --- Mobile Money ---
        const mobileCredentials = credentials.mobile_money || {};
        const mobileBlocks = document.querySelectorAll('#mobile-money-options > div');
        const mtnBlock = mobileBlocks[0];
        const airtelBlock = mobileBlocks[1];
        const tigoBlock = mobileBlocks[2];

        const hasMTN = !!mobileCredentials.mtn;
        const hasAirtel = !!mobileCredentials.airtel;
        const hasTigo = !!mobileCredentials.tigo;

        // Update details and visibility
        if (hasMTN) {
          const mtn = mobileCredentials.mtn;
          document.getElementById('mtn-phone').textContent = mtn.phone || '+250 788 123 456';
          document.getElementById('mtn-name').textContent = mtn.account_name || 'African Deals Domain';
          document.getElementById('mtn-code').textContent = mtn.ussd_code || '*182*8*1#';
        }
        if (hasAirtel) {
          const airtel = mobileCredentials.airtel;
          document.getElementById('airtel-phone').textContent = airtel.phone || '+250 733 456 789';
          document.getElementById('airtel-name').textContent = airtel.account_name || 'African Deals Domain';
          document.getElementById('airtel-code').textContent = airtel.ussd_code || '*500*2*1#';
        }
        if (hasTigo) {
          const tigo = mobileCredentials.tigo;
          document.getElementById('tigo-phone').textContent = tigo.phone || '+250 722 789 012';
          document.getElementById('tigo-name').textContent = tigo.account_name || 'African Deals Domain';
          document.getElementById('tigo-code').textContent = tigo.ussd_code || '*505#';
        }
        if (mtnBlock) mtnBlock.style.display = hasMTN ? '' : 'none';
        if (airtelBlock) airtelBlock.style.display = hasAirtel ? '' : 'none';
        if (tigoBlock) tigoBlock.style.display = hasTigo ? '' : 'none';

        // Rebuild provider select options to only include available providers
        const providerSelect = document.getElementById('mobileProvider');
        if (providerSelect) {
          const current = providerSelect.value;
          const options = [{ value: '', label: 'Select Provider' }];
          if (hasMTN) options.push({ value: 'mtn', label: 'MTN Mobile Money' });
          if (hasAirtel) options.push({ value: 'airtel', label: 'Airtel Money' });
          if (hasTigo) options.push({ value: 'tigo', label: 'Tigo Cash' });
          providerSelect.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
          // Restore current if still valid
          if (options.some(o => o.value === current)) providerSelect.value = current;
        }

        const hasAnyMobile = hasMTN || hasAirtel || hasTigo;
        if (mobileOptionCard) mobileOptionCard.style.display = hasAnyMobile ? '' : 'none';

        // --- Bank Transfer ---
        const bankCredentials = credentials.bank_transfer || {};
        const bankBlocks = document.querySelectorAll('#bank-transfer-options > div');
        const primaryBankBlock = bankBlocks[0];
        const secondaryBankBlock = bankBlocks[1];

        const hasPrimary = !!bankCredentials.primary;
        const hasSecondary = !!bankCredentials.secondary;

        if (hasPrimary) {
          const primary = bankCredentials.primary;
          document.getElementById('primary-bank-name').textContent = primary.bank_name || 'Bank of Kigali';
          document.getElementById('primary-account-name').textContent = primary.account_name || 'African Deals Domain Ltd';
          document.getElementById('primary-account-number').textContent = primary.account_number || '00123456789';
          document.getElementById('primary-swift-code').textContent = primary.swift_code || 'BKGLRWRW';
          document.getElementById('primary-branch').textContent = primary.branch || 'Kigali Main Branch';
        }
        if (hasSecondary) {
          const secondary = bankCredentials.secondary;
          document.getElementById('secondary-bank-name').textContent = secondary.bank_name || 'Equity Bank Rwanda';
          document.getElementById('secondary-account-name').textContent = secondary.account_name || 'African Deals Domain Ltd';
          document.getElementById('secondary-account-number').textContent = secondary.account_number || '40012345678';
          document.getElementById('secondary-swift-code').textContent = secondary.swift_code || 'EQBLRWRW';
          document.getElementById('secondary-branch').textContent = secondary.branch || 'Kigali City Branch';
        }
        if (primaryBankBlock) primaryBankBlock.style.display = hasPrimary ? '' : 'none';
        if (secondaryBankBlock) secondaryBankBlock.style.display = hasSecondary ? '' : 'none';

        const hasAnyBank = hasPrimary || hasSecondary;
        if (bankOptionCard) bankOptionCard.style.display = hasAnyBank ? '' : 'none';

        // --- Auto-switch if selected method becomes unavailable ---
        const mobileRadio = document.getElementById('mobileMoney');
        const bankRadio = document.getElementById('bankTransfer');
        const placeBtn = document.getElementById('place-order-btn');

        if (this.selectedPaymentMethod === 'mobile_money' && !hasAnyMobile) {
          if (hasAnyBank) {
            if (bankRadio) bankRadio.checked = true;
            if (mobileRadio) mobileRadio.checked = false;
            this.handlePaymentMethodChange('bank_transfer');
          }
        } else if (this.selectedPaymentMethod === 'bank_transfer' && !hasAnyBank) {
          if (hasAnyMobile) {
            if (mobileRadio) mobileRadio.checked = true;
            if (bankRadio) bankRadio.checked = false;
            this.handlePaymentMethodChange('mobile_money');
          }
        }

        // Disable placing order if no methods available
        const anyMethodAvailable = hasAnyMobile || hasAnyBank;
        if (placeBtn) placeBtn.disabled = !anyMethodAvailable;
        if (!anyMethodAvailable) {
          this.showNotification('Payment temporarily unavailable. Please try again later.', 'error');
        }
      }

      setupProfileDropdown() {
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const signoutBtn = document.getElementById('signout-btn');

        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', () => {
          profileDropdown.classList.add('hidden');
        });

        signoutBtn.addEventListener('click', () => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('checkoutData');
          window.location.href = '/auth/auth-buyer.html';
        });
      }

      async placeOrder() {
        if (!this.validateForm()) {
          return;
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        loadingOverlay.classList.remove('hidden');

        try {
          // Prepare order data with validation
          const formData = new FormData(document.getElementById('payment-form'));
          
          // Validate cart items
          if (!this.cartItems || this.cartItems.length === 0) {
            this.showNotification('No items in cart to order', 'error');
            loadingOverlay.classList.add('hidden');
            return;
          }
          
          // Validate delivery data
          if (!this.checkoutData || !this.checkoutData.deliveryType) {
            this.showNotification('Please select a delivery method first', 'error');
            loadingOverlay.classList.add('hidden');
            return;
          }
          
          // Normalize cart items robustly
          const parseNumber = (val) => {
            if (typeof val === 'number') return val;
            if (typeof val === 'string') {
              const cleaned = val.replace(/[^0-9.\-]/g, '');
              const num = parseFloat(cleaned);
              return isNaN(num) ? 0 : num;
            }
            return 0;
          };
          const getProductId = (it) => it.product_id || it.productId || (it.product && it.product.id) || it.id;
          const getQuantity = (it) => parseInt(it.quantity || it.qty || 1) || 1;
          const getUnitPrice = (it) => parseNumber(it.unit_price ?? it.unitPrice ?? it.sale_price ?? it.final_price ?? it.price);

          const invalidItems = [];
          const normalizedItems = (this.cartItems || []).map(item => {
            const productId = getProductId(item);
            const quantity = getQuantity(item);
            const price = getUnitPrice(item);
            if (!productId || quantity <= 0 || price <= 0) {
              invalidItems.push(item.name || item.product_name || `#${productId || 'unknown'}`);
            }
            return {
              product_id: productId,
              quantity: quantity,
              unit_price: price,
              total_price: price * quantity
            };
          }).filter(i => i.product_id && i.quantity > 0 && i.unit_price > 0);

          if (invalidItems.length > 0 || normalizedItems.length === 0) {
            this.showNotification(`Some items have invalid data: ${invalidItems.join(', ')}`, 'error');
            loadingOverlay.classList.add('hidden');
            return;
          }

          const orderData = {
            items: normalizedItems,
            shipping: {
              firstName: formData.get('firstName')?.trim() || '',
              lastName: formData.get('lastName')?.trim() || '',
              email: formData.get('email')?.trim() || '',
              phone: formData.get('phone')?.trim() || '',
              notes: formData.get('notes')?.trim() || ''
            },
            payment: {
              method: this.selectedPaymentMethod || 'mobile_money'
            },
            total: this.total || 0,
            delivery_method: this.checkoutData.deliveryType,
            pickup_site_id: this.checkoutData.pickupSiteId || null,
            delivery_address: this.checkoutData.deliveryAddress || null,
            marketplace_type: 'physical'
          };
          
          // Additional validation
          if (!orderData.shipping.firstName || !orderData.shipping.lastName || 
              !orderData.shipping.email || !orderData.shipping.phone) {
            this.showNotification('Please fill in all required contact information', 'error');
            loadingOverlay.classList.add('hidden');
            return;
          }
          
          console.log('üì¶ Prepared order data:', orderData);

          // Handle payment proof upload based on payment method
          let paymentProofFile;
          
          if (this.selectedPaymentMethod === 'mobile_money') {
            paymentProofFile = document.getElementById('paymentProof').files[0];
            if (!paymentProofFile) {
              this.showNotification('Please upload mobile money payment screenshot', 'error');
              loadingOverlay.classList.add('hidden');
              return;
            }
            
            // Add mobile money details to payment data
            orderData.payment.mobile_number = document.getElementById('mobileNumber').value.trim();
            orderData.payment.mobile_provider = document.getElementById('mobileProvider').value;
          } else if (this.selectedPaymentMethod === 'bank_transfer') {
            paymentProofFile = document.getElementById('transferProof').files[0];
            if (!paymentProofFile) {
              this.showNotification('Please upload bank transfer receipt', 'error');
              loadingOverlay.classList.add('hidden');
              return;
            }
            
            // Add bank transfer details to payment data
            orderData.payment.bank_name = document.getElementById('bankName').value.trim();
            orderData.payment.reference_code = document.getElementById('reference-code').textContent;
          }

          // Ensure we have a payment proof file ready (we will attach it to the payment-proof API AFTER order is created)
          if (!paymentProofFile) {
            this.showNotification('Please upload a payment proof image', 'error');
            loadingOverlay.classList.add('hidden');
            return;
          }

          // Create the order
          const token = localStorage.getItem('authToken');
          const userData = localStorage.getItem('userData');
          
          // Debug logging
          console.log('üîç Debug - Token exists:', !!token);
          console.log('üîç Debug - User data exists:', !!userData);
          if (userData) {
            try {
              const user = JSON.parse(userData);
              console.log('üîç Debug - User role:', user.role);
              console.log('üîç Debug - User ID:', user.id);
            } catch (e) {
              console.error('üîç Debug - Failed to parse user data:', e);
            }
          }
          
          const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(orderData)
          });

          if (response.ok) {
            const data = await response.json();
            this.showNotification('Order placed successfully!', 'success');

            // Upload payment proof tied to the newly created order
            try {
              const uploadFormData = new FormData();
              uploadFormData.append('screenshot', paymentProofFile); // server expects 'screenshot'
              uploadFormData.append('payment_method', this.selectedPaymentMethod);
              uploadFormData.append('sender_name', `${orderData.shipping.firstName} ${orderData.shipping.lastName}`.trim());
              if (this.selectedPaymentMethod === 'mobile_money') {
                const mobileNumber = orderData.payment.mobile_number || '';
                const txn = orderData.payment.reference_code || mobileNumber || `MM-${Date.now()}`;
                uploadFormData.append('sender_phone', mobileNumber);
                uploadFormData.append('transaction_id', txn);
              } else if (this.selectedPaymentMethod === 'bank_transfer') {
                const ref = orderData.payment.reference_code || `BT-${Date.now()}`;
                uploadFormData.append('sender_phone', orderData.shipping.phone || '');
                uploadFormData.append('transaction_id', ref);
                uploadFormData.append('amount', String(orderData.total || ''));
              }
              uploadFormData.append('order_id', data.order?.id || data.order_id || data.id);
              uploadFormData.append('order_number', data.order?.order_number || data.order_number || '');

              const proofRes = await fetch('/api/payment-proof', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` },
                body: uploadFormData
              });

              if (proofRes.ok) {
                this.showNotification('Payment proof submitted for admin approval.', 'success');

                // Also create a payment_approvals entry for admin dashboard visibility
                try {
                  const approvalForm = new FormData();
                  approvalForm.append('paymentProof', paymentProofFile); // expected field name
                  approvalForm.append('paymentMethod', this.selectedPaymentMethod);
                  approvalForm.append('orderId', data.order?.id || data.order_id || data.id);
                  const approvalRes = await fetch('/api/upload/payment-proof', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` },
                    body: approvalForm
                  });
                  if (!approvalRes.ok) {
                    const aerr = await approvalRes.json().catch(() => ({}));
                    console.warn('Secondary approval creation failed:', aerr);
                  }
                } catch (secErr) {
                  console.warn('Secondary approval creation error:', secErr);
                }
              } else {
                const err = await proofRes.json().catch(() => ({}));
                console.warn('Payment proof submit failed:', err);
                this.showNotification(err.error || 'Payment proof submit failed. Please upload from Orders page.', 'error');
              }
            } catch (e) {
              console.error('Payment proof submit error:', e);
              this.showNotification('Payment proof submit error. You can upload it later from Orders page.', 'error');
            }

            // Clear checkout data
            localStorage.removeItem('checkoutData');

            // Clear cart from backend and localStorage
            setTimeout(async () => {
              // Clear cart from backend
              await this.clearCart();
              
              // Clear cart from localStorage
              localStorage.removeItem('cart');
              
              // Show order success
              this.showOrderSuccess(data.order || { id: data.order_id });
            }, 2000);
          } else {
            const errorData = await response.json();
            console.error('üîç Debug - Order creation failed:', errorData);
            console.error('üîç Debug - Response status:', response.status);
            
            let errorMessage = 'Failed to place order. Please try again.';
            if (errorData.error) {
              // Handle specific error messages
              if (errorData.error.includes('Only buyers')) {
                errorMessage = 'Access denied. Please ensure you are logged in as a buyer or authorized agent.';
              } else if (errorData.error.includes('Invalid user account')) {
                errorMessage = 'Account verification failed. Please log in again.';
              } else if (errorData.error.includes('payment')) {
                errorMessage = 'Payment information is invalid. Please check your payment details.';
              } else if (errorData.error.includes('delivery')) {
                errorMessage = 'Delivery information is invalid. Please select a valid delivery method.';
              } else {
                errorMessage = errorData.error;
              }
            }
            
            this.showNotification(errorMessage, 'error');
            
            // If authentication error, redirect to login
            if (response.status === 401 || response.status === 403) {
              setTimeout(() => {
                localStorage.clear();
                window.location.href = '/auth/auth-buyer.html';
              }, 3000);
            }
          }
        } catch (error) {
          console.error('Error placing order:', error);
          this.showNotification('Failed to place order. Please try again.', 'error');
        } finally {
          loadingOverlay.classList.add('hidden');
        }
      }

      validateForm() {
        const requiredFields = ['firstName', 'lastName', 'email', 'phone'];
        let isValid = true;

        requiredFields.forEach(field => {
          const element = document.getElementById(field);
          if (!element.value.trim()) {
            element.classList.add('border-red-500');
            isValid = false;
          } else {
            element.classList.remove('border-red-500');
          }
        });

        // Validate payment method selection
        if (!this.selectedPaymentMethod) {
          this.showNotification('Please select a payment method', 'error');
          return false;
        }

        // Validate payment method specific fields
        if (this.selectedPaymentMethod === 'mobile_money') {
          // Validate mobile money fields
          const mobileNumber = document.getElementById('mobileNumber');
          const mobileProvider = document.getElementById('mobileProvider');
          const paymentProof = document.getElementById('paymentProof');
          
          if (!mobileNumber.value.trim()) {
            mobileNumber.classList.add('border-red-500');
            isValid = false;
          } else {
            mobileNumber.classList.remove('border-red-500');
          }
          
          if (!mobileProvider.value) {
            mobileProvider.classList.add('border-red-500');
            isValid = false;
          } else {
            mobileProvider.classList.remove('border-red-500');
          }
          
          if (!paymentProof.files[0]) {
            paymentProof.classList.add('border-red-500');
            this.showNotification('Please upload your mobile money payment screenshot', 'error');
            return false;
          } else {
            paymentProof.classList.remove('border-red-500');
          }
        } else if (this.selectedPaymentMethod === 'bank_transfer') {
          // Validate bank transfer fields
          const bankName = document.getElementById('bankName');
          const transferProof = document.getElementById('transferProof');
          
          if (!bankName.value.trim()) {
            bankName.classList.add('border-red-500');
            isValid = false;
          } else {
            bankName.classList.remove('border-red-500');
          }
          
          if (!transferProof.files[0]) {
            transferProof.classList.add('border-red-500');
            this.showNotification('Please upload your bank transfer receipt', 'error');
            return false;
          } else {
            transferProof.classList.remove('border-red-500');
          }
        }

        if (!isValid) {
          this.showNotification('Please fill in all required fields', 'error');
        }

        return isValid;
      }

      async clearCart() {
        try {
          const token = localStorage.getItem('authToken');
          await fetch('/api/cart/clear', {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          console.log('‚úÖ Cart cleared successfully');
        } catch (error) {
          console.error('Error clearing cart:', error);
          // Don't block the flow if cart clearing fails
        }
      }

      showOrderSuccess(order) {
        // Hide loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) loadingOverlay.classList.add('hidden');
        
        // Replace the entire payment content with success message
        const mainContent = document.querySelector('.max-w-6xl.mx-auto');
        if (mainContent) {
          mainContent.innerHTML = `
            <div class="text-center py-12">
              <div class="success-animation">
                <div class="text-6xl mb-6">üéâ</div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Order Placed Successfully!</h1>
                <p class="text-xl text-gray-600 mb-8">Thank you for your purchase</p>
                
                <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 max-w-2xl mx-auto">
                  <h2 class="text-xl font-semibold text-gray-900 mb-6">Order Details</h2>
                  <div class="space-y-3 text-left">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Order Number:</span>
                      <span class="font-semibold">#${order.order_number}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Total Amount:</span>
                      <span class="font-semibold text-green-600">${this.formatCurrency(order.total_amount)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Status:</span>
                      <span class="font-semibold text-blue-600">${order.status}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Payment Status:</span>
                      <span class="font-semibold text-orange-600">${order.payment_status || 'Processing'}</span>
                    </div>
                  </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 max-w-2xl mx-auto">
                  <h3 class="font-semibold text-blue-900 mb-3">üìß What's Next?</h3>
                  <div class="text-blue-800 text-sm space-y-2 text-left">
                    <p>‚Ä¢ You'll receive an order confirmation email shortly</p>
                    <p>‚Ä¢ Track your order status in your orders page</p>
                    <p>‚Ä¢ Our team will process your payment and notify you</p>
                    <p>‚Ä¢ Delivery will begin once payment is confirmed</p>
                  </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                  <a href="/buyer/orders.html" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                    Track Order
                  </a>
                  <a href="/buyer/buyers-home.html" class="bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-300 px-8 py-3 rounded-xl font-semibold transition-all duration-300">
                    Continue Shopping
                  </a>
                </div>
              </div>
            </div>
            
            <style>
              .success-animation {
                animation: slideInUp 0.8s ease-out;
              }
              
              @keyframes slideInUp {
                from {
                  transform: translateY(30px);
                  opacity: 0;
                }
                to {
                  transform: translateY(0);
                  opacity: 1;
                }
              }
            </style>
          `;
        }
      }

      formatCurrency(amount) {
        const currency = localStorage.getItem('selectedCurrency') || 'RWF';
        const currencySymbol = {
          'USD': '$',
          'RWF': 'FRw',
          'EUR': '‚Ç¨',
          'CNY': '¬•',
          'KES': 'Ksh',
          'NGN': '‚Ç¶'
        }[currency] || 'FRw';
        
        return `${currencySymbol} ${parseFloat(amount || 0).toLocaleString()}`;
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium shadow-lg transform transition-all duration-300 ${
          type === 'success' ? 'bg-green-500' : 
          type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 100);

        // Remove after 5 seconds
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 5000);
      }
    }

    // Initialize the payment manager when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new PaymentManager();
    });
  </script>
</body>
</html>