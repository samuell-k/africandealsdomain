<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product List | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <style>
    .brand-gradient { background: linear-gradient(90deg,#0e2038 0%,#23325c 100%); }
    .brand-text { color: #0e2038; }
    .brand-bg { background-color: #0e2038; }
    
    /* Ensure main content doesn't overlap with fixed header */
    main {
      margin-top: 80px !important;
      position: relative !important;
      z-index: 1 !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header id="main-header" class="glass bg-white/80 fixed top-0 left-0 w-full z-50 shadow-md border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-2 md:px-6 h-16 md:h-20 gap-2">
      <!-- Logo and Project Name -->
      <a href="/buyer/buyers-home.html" class="flex items-center gap-2">
        <img src="/public/images/logo.png" alt="ADD Logo" class="h-8 w-8 md:h-12 md:w-12 rounded-xl shadow" />
        <span class="font-extrabold text-lg md:text-2xl text-[#0e2038] tracking-tight">ADD Physical Product</span>
      </a>
      
      <!-- Large Search Bar -->
      <div class="flex-1 flex justify-center items-center mx-2">
        <div class="relative w-full max-w-3xl">
          <input id="header-search-input" type="text" placeholder="What are you looking for?" class="w-full pl-12 pr-16 py-2 md:py-3 rounded-2xl border border-gray-300 focus:ring-2 focus:ring-blue-400 bg-white/80 shadow-md transition-all duration-300 text-base md:text-lg" autocomplete="off" />
          <span class="absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </span>
          <button id="header-search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-3 py-1 flex items-center gap-1 shadow transition focus:outline-none">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <span>Search</span>
          </button>
        </div>
      </div>
      
      <!-- Right Controls -->
      <div class="flex items-center gap-2 md:gap-4">
        <!-- Cart Icon -->
        <a href="/buyer/cart.html" class="relative flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition group" title="Cart">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600 group-hover:scale-110 transition-transform duration-200" viewBox="0 0 24 24">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span data-cart-count class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1 py-0.5 shadow hidden animate-pulse">0</span>
        </a>
        
        <!-- Profile Dropdown -->
        <div class="relative">
          <button id="profile-btn" class="flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 8-4 8-4s8 0 8 4"/></svg>
          </button>
          <div id="profile-dropdown" class="dropdown-menu absolute right-0 mt-2 min-w-[180px] bg-white rounded-xl shadow-lg z-50 hidden p-4">
            <div class="mb-2 font-bold text-blue-700 text-sm">Hello, <span id="profile-name">User</span></div>
            <a href="/buyer/orders.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Orders</a>
            <a href="/buyer/messages.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Messages</a>
            <a href="/buyer/wishlist.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Favourites</a>
            <a href="/buyer/profile.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Account</a>
            <button id="signout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 text-xs">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <script>
    // Load shared components if available (optional)
    try {
      const script = document.createElement('script');
      script.src = '/buyer/shared-components.js';
      script.onerror = function() {
        console.log('[PRODUCT-LIST] Shared components not available, continuing without them');
      };
      document.head.appendChild(script);
    } catch (error) {
      console.log('[PRODUCT-LIST] Could not load shared components:', error);
    }
  </script>

  <main class="pt-16 pb-8">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Products</h1>
        <p class="text-gray-600">Discover amazing products from trusted sellers</p>
      </div>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Category Sidebar -->
        <div class="lg:w-1/4">
          <div class="bg-white rounded-xl shadow-lg p-6 sticky top-20">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600" viewBox="0 0 24 24">
                <path d="M3 3h18v18H3z"/>
                <path d="M3 9h18"/>
                <path d="M9 21V9"/>
              </svg>
              Categories
            </h2>
            
            <div id="category-tree" class="space-y-2">
              <!-- Categories will be loaded here -->
              <div class="animate-pulse">
                <div class="h-4 bg-gray-200 rounded mb-2"></div>
                <div class="h-4 bg-gray-200 rounded mb-2"></div>
                <div class="h-4 bg-gray-200 rounded"></div>
              </div>
            </div>

            <!-- Search Filter -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="font-semibold text-gray-900 mb-3">Search</h3>
              <div class="relative">
                <input type="text" id="search-input" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Search products...">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" 
                     class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 24 24">
                  <circle cx="11" cy="11" r="8"/>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
              </div>
            </div>

            <!-- Price Filter -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="font-semibold text-gray-900 mb-3">Price Range</h3>
              <div class="space-y-3">
                <div>
                  <label class="text-sm text-gray-600">Min Price</label>
                  <input type="number" id="min-price" min="0" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div>
                  <label class="text-sm text-gray-600">Max Price</label>
                  <input type="number" id="max-price" min="0" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
              </div>
            </div>

            <!-- Clear Filters -->
            <button id="clear-filters" class="w-full mt-6 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
              Clear All Filters
            </button>
          </div>
        </div>

        <!-- Product Grid -->
        <div class="lg:w-3/4">
          <!-- Filters Bar -->
          <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div class="flex items-center gap-4">
                <span class="text-sm text-gray-600">Showing <span id="product-count">0</span> products</span>
                <div id="active-filters" class="flex flex-wrap gap-2">
                  <!-- Active filters will be shown here -->
                </div>
              </div>
              
              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Sort by:</label>
                <select id="sort-select" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                  <option value="newest">Newest</option>
                  <option value="price-low">Price: Low to High</option>
                  <option value="price-high">Price: High to Low</option>
                  <option value="name">Name: A to Z</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Products Grid -->
          <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Products will be loaded here -->
            <div class="animate-pulse">
              <div class="bg-gray-200 h-48 rounded-lg mb-3"></div>
              <div class="h-4 bg-gray-200 rounded mb-2"></div>
              <div class="h-4 bg-gray-200 rounded w-2/3"></div>
            </div>
            <div class="animate-pulse">
              <div class="bg-gray-200 h-48 rounded-lg mb-3"></div>
              <div class="h-4 bg-gray-200 rounded mb-2"></div>
              <div class="h-4 bg-gray-200 rounded w-2/3"></div>
            </div>
            <div class="animate-pulse">
              <div class="bg-gray-200 h-48 rounded-lg mb-3"></div>
              <div class="h-4 bg-gray-200 rounded mb-2"></div>
              <div class="h-4 bg-gray-200 rounded w-2/3"></div>
            </div>
          </div>

          <!-- Load More Button -->
          <div class="text-center mt-8">
            <button id="load-more" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium hidden">
              Load More Products
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- REFERRAL SHARE HELPERS (lightweight) ---
    function showToast(message, type = 'info') {
      const el = document.createElement('div');
      el.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white ${
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2500);
    }

    async function openShareModal(productId) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) {
        showToast('Please login to share products', 'error');
        setTimeout(() => (window.location.href = '/auth/auth-buyer.html'), 1200);
        return;
      }

      // Fetch product for preview and price (to compute commission shown inside modal)
      let product;
      try {
        const r = await fetch(`/api/products/${productId}`);
        const j = await r.json();
        if (!j.success) throw new Error('Product not found');
        product = j.product;
      } catch (e) {
        showToast('Failed to load product', 'error');
        return;
      }

      const price = parseFloat(product.discount_price || product.price || 0);
      // Platform commission is the 21% added over base: S - (S / 1.21)
      const platformCommission = price - (price / 1.21);
      const commission = (platformCommission * 0.15).toFixed(2);
      const imageUrl = product.main_image ? `/uploads/${product.main_image}` : '/public/images/logo.png';

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';
      modal.innerHTML = `
        <div class='modal-content bg-white rounded-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300'>
          <div class='flex justify-between items-center mb-4'>
            <h3 class='text-lg font-bold'>Share & Earn</h3>
            <button onclick="(function(m){m.classList.add('opacity-0');m.querySelector('.modal-content').classList.add('scale-95');setTimeout(()=>m.remove(),250)})(this.closest('.fixed'))" class='text-gray-400 hover:text-gray-600'>✕</button>
          </div>
          <div class='flex gap-3 mb-4 p-3 bg-gray-50 rounded-lg'>
            <img src='${imageUrl}' class='w-16 h-16 object-cover rounded-lg'/>
            <div class='flex-1'>
              <div class='font-semibold text-sm line-clamp-2'>${product.name}</div>
              <div class='text-blue-600 font-bold'>${(product.currency||'RWF')} ${(price).toFixed(2)}</div>
            </div>
          </div>
          <div class='bg-green-50 border border-green-200 rounded-lg p-3 mb-4 text-sm'>
            Earn <span class='font-bold text-green-700'>${(product.currency||'RWF')} ${commission}</span> when this product is purchased via your link.
          </div>
          <div class='grid grid-cols-2 gap-2 mb-3'>
            <button class='bg-green-600 hover:bg-green-700 text-white py-2 rounded' onclick='shareToPlatform(${product.id},"whatsapp",this)'>WhatsApp</button>
            <button class='bg-blue-600 hover:bg-blue-700 text-white py-2 rounded' onclick='shareToPlatform(${product.id},"facebook",this)'>Facebook</button>
            <button class='bg-sky-500 hover:bg-sky-600 text-white py-2 rounded' onclick='shareToPlatform(${product.id},"twitter",this)'>Twitter</button>
            <button class='bg-gray-600 hover:bg-gray-700 text-white py-2 rounded' onclick='shareToPlatform(${product.id},"copy_link",this)'>Copy Link</button>
          </div>
          <div id='ref-link-wrap' class='hidden'>
            <label class='text-xs text-gray-600'>Your referral link</label>
            <div class='flex gap-2 mt-1'>
              <input id='ref-link' class='flex-1 px-2 py-2 border rounded text-sm' readonly>
              <button class='px-3 py-2 bg-blue-600 text-white rounded text-sm' onclick='copyRefLink()'>Copy</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modal);
      setTimeout(() => { modal.classList.remove('opacity-0'); modal.classList.add('opacity-100'); modal.querySelector('.modal-content').classList.remove('scale-95'); modal.querySelector('.modal-content').classList.add('scale-100'); }, 10);
    }

    async function shareToPlatform(productId, platform, btn){
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      const original = btn.textContent;
      btn.textContent = 'Generating...'; btn.disabled = true;
      try {
        const r = await fetch('/api/referrals/share-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ product_id: productId, platform })
        });
        const j = await r.json();
        if(!j.success) throw new Error(j.error||'Failed');
        document.getElementById('ref-link-wrap').classList.remove('hidden');
        const input = document.getElementById('ref-link');
        input.value = j.share_url;
        if(platform==='copy_link'){
          await navigator.clipboard.writeText(j.share_url);
          showToast('Link copied!', 'success');
        } else {
          window.open(j.platform_url, '_blank', 'width=600,height=480');
        }
      } catch(e){
        showToast(e.message, 'error');
      } finally {
        btn.textContent = original; btn.disabled = false;
      }
    }

    function copyRefLink(){
      const input = document.getElementById('ref-link');
      if(input && input.value){ navigator.clipboard.writeText(input.value); showToast('Copied!', 'success'); }
    }

    // Track referral click if present on list page
    (function(){
      const url = new URL(window.location.href);
      const ref = url.searchParams.get('ref');
      if(ref){ fetch('/api/referrals/track-click',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ referral_code: ref })}); }
    })();

    // --- GLOBAL STATE ---
    let products = [];
    let categories = [];
    let currentFilters = {
      category_id: null,
      search: '',
      min_price: null,
      max_price: null,
      sort: 'newest'
    };
    let currentPage = 1;
    let hasMoreProducts = true;
    
    // Currency and Country Management
    let currencyRates = {};
    let selectedCurrency = localStorage.getItem('selectedCurrency') || 'RWF';
    let selectedCountry = localStorage.getItem('selectedCountry') || 'Rwanda';
    let countries = [];

    // Header is now embedded directly in the HTML

    // --- FETCH CATEGORIES ---
    async function fetchCategories() {
      try {
        console.log('[PRODUCT-LIST] Fetching categories...');
        
        const res = await fetch('/api/categories/active');
        console.log('[PRODUCT-LIST] Categories API response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('[PRODUCT-LIST] Categories API response:', data);
        
        if (data.success && data.categories) {
          categories = data.categories;
          console.log('[PRODUCT-LIST] Loaded', categories.length, 'categories');
          renderCategoryTree();
        } else {
          console.error('[PRODUCT-LIST] Categories API returned unsuccessful response:', data);
          renderCategoryError();
        }
      } catch (error) {
        console.error('[PRODUCT-LIST] Error fetching categories:', error);
        renderCategoryError();
      }
    }
    
    function renderCategoryError() {
      const container = document.getElementById('category-tree');
      container.innerHTML = `
        <div class="text-center py-4">
          <p class="text-sm text-gray-500">Unable to load categories</p>
          <button onclick="fetchCategories()" class="text-xs text-blue-600 hover:text-blue-800 mt-1">
            Try again
          </button>
        </div>
      `;
    }

    function renderCategoryTree() {
      const container = document.getElementById('category-tree');
      container.innerHTML = '';
      
      categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'space-y-1';
        
        // Main category button
        const mainCategory = document.createElement('button');
        mainCategory.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors flex items-center justify-between';
        mainCategory.innerHTML = `
          <span class="font-medium text-gray-900">${category.name}</span>
          <span class="text-xs text-gray-500">${category.product_count || 0}</span>
        `;
        
        mainCategory.onclick = () => filterByCategory(category.id);
        categoryDiv.appendChild(mainCategory);
        
        container.appendChild(categoryDiv);
      });
    }

    // --- FETCH PRODUCTS ---
    async function fetchProducts(resetPage = true) {
      try {
        if (resetPage) {
          currentPage = 1;
          hasMoreProducts = true;
          // Show loading state
          document.getElementById('products-grid').innerHTML = `
            <div class="col-span-full flex justify-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
          `;
        }
        
        const params = new URLSearchParams({
          page: currentPage,
          limit: 12
        });
        
        if (currentFilters.category_id) {
          params.append('category_id', currentFilters.category_id);
        }
        
        if (currentFilters.search) {
          params.append('search', currentFilters.search);
        }
        
        if (currentFilters.min_price) {
          params.append('min_price', currentFilters.min_price);
        }
        
        if (currentFilters.max_price) {
          params.append('max_price', currentFilters.max_price);
        }
        
        if (currentFilters.sort) {
          params.append('sort', currentFilters.sort);
        }
        
        console.log('[PRODUCT-LIST] Fetching products with params:', params.toString());
        
        const res = await fetch(`/api/products?${params}`);
        console.log('[PRODUCT-LIST] Products API response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('[PRODUCT-LIST] Products API response:', data);
        
        if (data.success) {
          if (resetPage) {
            products = data.products || [];
          } else {
            products = [...products, ...(data.products || [])];
          }
          
          hasMoreProducts = (data.products || []).length === 12;
          console.log('[PRODUCT-LIST] Loaded', (data.products || []).length, 'products, hasMore:', hasMoreProducts);
          
          renderProducts();
          updateProductCount();
          updateLoadMoreButton();
        } else {
          console.error('[PRODUCT-LIST] API returned unsuccessful response:', data);
          showError(data.error || 'Failed to load products');
        }
      } catch (error) {
        console.error('[PRODUCT-LIST] Error fetching products:', error);
        
        let errorMessage = 'Failed to load products. ';
        if (error.message.includes('404')) {
          errorMessage += 'Products not found.';
        } else if (error.message.includes('500')) {
          errorMessage += 'Server error. Please try again later.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage += 'Network error. Please check your connection.';
        } else {
          errorMessage += 'Please try again.';
        }
        
        showError(errorMessage);
      }
    }

    function renderProducts() {
      const grid = document.getElementById('products-grid');
      
      if (products.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-gray-400 mb-4" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="M21 15l-5-5L5 21"/>
            </svg>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No products found</h3>
            <p class="text-gray-600">Try adjusting your filters or search terms</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = products.map(product => {
        // Handle price and currency with proper fallbacks
        const currency = product.currency || 'RWF';
        const price = parseFloat(product.price || 0);
        const discountPrice = parseFloat(product.discount_price || 0);
        
        // Determine display price and discount percentage
        const hasDiscount = discountPrice && discountPrice < price;
        const displayPrice = hasDiscount ? discountPrice : price;
        const discountPercent = hasDiscount ? Math.round(((price - discountPrice) / price) * 100) : 0;

        // Calculate referral commission using correct formula: S - (S / 1.21)
        const platformCommission = displayPrice - (displayPrice / 1.21);
        const referralCommission = platformCommission * 0.15;
        
        // Handle image URL
        let imageUrl = '/public/images/logo.png';
        if (product.main_image) {
          imageUrl = product.main_image.startsWith('http') ? product.main_image : `/uploads/${product.main_image}`;
        }
        
        // Handle stock display
        const stock = product.stock_quantity || product.stock || 0;
        const stockText = stock > 0 ? `Stock: ${stock}` : 'Out of Stock';
        const stockClass = stock > 0 ? 'text-gray-500' : 'text-red-500';
        
        return `
          <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow cursor-pointer" onclick="viewProduct(${product.id})">
            <div class="relative">
              <img src="${imageUrl}" 
                   alt="${product.name || 'Product'}" 
                   class="w-full h-48 object-cover"
                   onerror="this.src='/public/images/logo.png'">
              ${hasDiscount ? `
                <div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                  ${discountPercent}% OFF
                </div>
              ` : ''}
              ${stock === 0 ? `
                <div class="absolute top-2 left-2 bg-gray-800 text-white text-xs px-2 py-1 rounded-full">
                  Out of Stock
                </div>
              ` : ''}
            </div>
            
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2" title="${product.name || 'Product'}">${product.name || 'Product'}</h3>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description || 'No description available'}</p>
              
              <div class="flex items-center justify-between mb-3">
                <div class="flex flex-col">
                  <span class="text-lg font-bold text-gray-900 product-price" 
                        data-original-price="${displayPrice}" 
                        data-currency="${currency}">
                    ${currency} ${displayPrice.toLocaleString()}
                  </span>
                  ${hasDiscount ? `
                    <span class="text-sm text-gray-500 line-through product-original-price" 
                          data-original-price="${price}" 
                          data-currency="${currency}">
                      ${currency} ${price.toLocaleString()}
                    </span>
                  ` : ''}
                </div>
                <div class="text-right">
                  <div class="text-xs text-gray-500">MOQ: ${product.moq || 1}</div>
                  ${product.condition ? `<div class="text-xs text-blue-600">${product.condition}</div>` : ''}
                </div>
              </div>
              
              <div class="flex items-center justify-between text-xs mb-3">
                <span class="text-gray-600">${product.category_name || 'Uncategorized'}</span>
                <span class="${stockClass}">${stockText}</span>
              </div>
              
              <!-- Seller Information -->
              <div class="flex items-center gap-2 mb-3 text-xs text-gray-600">
                <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                  <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </div>
                <span class="font-medium">${product.seller_name || 'Verified Seller'}</span>
                <span class="text-green-600">✓ Verified</span>
              </div>
              
              <div class="flex gap-2">
                <button onclick="event.stopPropagation(); viewProduct(${product.id})" 
                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                  View Details
                </button>
                <button onclick="event.stopPropagation(); addToCart(${product.id})" 
                        class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
                        ${stock === 0 ? 'disabled class="px-3 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed text-sm"' : ''}>
                  ${stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                </button>
              </div>
              
              <div class="mt-3 flex items-center justify-between">
                <button onclick="event.stopPropagation(); openShareModal(${product.id})" 
                        class="share-button flex items-center gap-1 text-green-600 hover:text-green-700 text-xs font-medium transition">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                  </svg>
                  Share & Earn ${currency} ${(referralCommission).toFixed(2)}
                </button>
                <span class="text-xs text-gray-500">Per sale</span>
              </div>
              
              <div class="mt-2">
                <button onclick="event.stopPropagation(); contactSeller(${product.seller_id})" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm text-gray-700">
                  Contact Seller
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // --- FILTER FUNCTIONS ---
    function filterByCategory(categoryId) {
      currentFilters.category_id = categoryId;
      fetchProducts(true);
      updateActiveFilters();
    }

    function updateActiveFilters() {
      const container = document.getElementById('active-filters');
      container.innerHTML = '';
      
      if (currentFilters.category_id) {
        const category = findCategoryById(currentFilters.category_id);
        if (category) {
          const filterTag = document.createElement('span');
          filterTag.className = 'inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full';
          filterTag.innerHTML = `
            ${category.name}
            <button onclick="removeFilter('category')" class="hover:text-blue-600">×</button>
          `;
          container.appendChild(filterTag);
        }
      }
      
      if (currentFilters.search) {
        const filterTag = document.createElement('span');
        filterTag.className = 'inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full';
        filterTag.innerHTML = `
          Search: "${currentFilters.search}"
          <button onclick="removeFilter('search')" class="hover:text-green-600">×</button>
        `;
        container.appendChild(filterTag);
      }
    }

    function removeFilter(type) {
      switch (type) {
        case 'category':
          currentFilters.category_id = null;
          break;
        case 'search':
          currentFilters.search = '';
          document.getElementById('search-input').value = '';
          break;
      }
      fetchProducts(true);
      updateActiveFilters();
    }

    function findCategoryById(id) {
      for (const category of categories) {
        if (category.id == id) return category;
        if (category.children) {
          for (const subCategory of category.children) {
            if (subCategory.id == id) return subCategory;
          }
        }
      }
      return null;
    }

    function updateProductCount() {
      document.getElementById('product-count').textContent = products.length;
    }

    function updateLoadMoreButton() {
      const loadMoreBtn = document.getElementById('load-more');
      if (hasMoreProducts) {
        loadMoreBtn.classList.remove('hidden');
      } else {
        loadMoreBtn.classList.add('hidden');
      }
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[PRODUCT-LIST] Initializing product list page...');
      
      // Check authentication with multiple fallback keys
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      const userData = localStorage.getItem('userData') || localStorage.getItem('user');
      
      if (!token || !userData) {
        console.log('[PRODUCT-LIST] No authentication found, redirecting to buyer login...');
        setTimeout(() => {
          window.location.href = '/auth/auth-buyer.html';
        }, 100);
        return;
      }
      
      // Parse user data with error handling
      try {
        const user = JSON.parse(userData);
        console.log('[PRODUCT-LIST] User authenticated:', user.username || user.email);
        
        // Verify user role if available
        if (user.role && user.role !== 'buyer') {
          console.log('[PRODUCT-LIST] Invalid user role:', user.role);
          showNotification('Invalid user role. Buyer access required.', 'error');
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 2000);
          return;
        }
        
        // Update profile greeting
        const profileName = document.getElementById('profile-name');
        if (profileName) {
          profileName.textContent = user.username || user.email || 'User';
        }
      } catch (error) {
        console.error('[PRODUCT-LIST] Error parsing user data:', error);
        showNotification('Authentication error. Please login again.', 'error');
        setTimeout(() => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/auth/auth-buyer.html';
        }, 2000);
        return;
      }
      
      // Initialize page functionality
      handleUrlParameters();
      setupDropdowns();
      setupHeaderSearch();
      fetchCategories();
      fetchProducts();
      fetchCurrencyRates();
      updateCartCount();
      
      // Search input
      let searchTimeout;
      document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentFilters.search = this.value;
          fetchProducts(true);
          updateActiveFilters();
        }, 500);
      });
      
      // Enter key handler for search input to redirect to search results
      document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const query = this.value.trim();
          if (query) {
            // Redirect to search results page with query parameter
            window.location.href = `/public/search-results.html?q=${encodeURIComponent(query)}`;
          }
        }
      });
      
      // Price filters
      document.getElementById('min-price').addEventListener('change', function() {
        currentFilters.min_price = this.value || null;
        fetchProducts(true);
      });
      
      document.getElementById('max-price').addEventListener('change', function() {
        currentFilters.max_price = this.value || null;
        fetchProducts(true);
      });
      
      // Sort select
      document.getElementById('sort-select').addEventListener('change', function() {
        currentFilters.sort = this.value;
        fetchProducts(true);
      });
      
      // Clear filters
      document.getElementById('clear-filters').addEventListener('click', function() {
        currentFilters = {
          category_id: null,
          search: '',
          min_price: null,
          max_price: null,
          sort: 'newest'
        };
        
        document.getElementById('search-input').value = '';
        document.getElementById('min-price').value = '';
        document.getElementById('max-price').value = '';
        document.getElementById('sort-select').value = 'newest';
        
        fetchProducts(true);
        updateActiveFilters();
      });
      
      // Load more
      document.getElementById('load-more').addEventListener('click', function() {
        currentPage++;
        fetchProducts(false);
      });
    });

    // --- CURRENCY CONVERSION FUNCTIONS ---
    async function fetchCurrencyRates() {
      try {
        const response = await fetch('https://v6.exchangerate-api.com/v6/c5f524e323378439dad2a43f/latest/USD');
        const data = await response.json();
        if (data && data.result === 'success') {
          currencyRates = data.conversion_rates;
          localStorage.setItem('currencyRates', JSON.stringify(currencyRates));
          updateCurrencyDisplay();
        }
      } catch (error) {
        console.error('Error fetching currency rates:', error);
        // Fallback rates
        currencyRates = { USD: 1, RWF: 1200, EUR: 0.9, KES: 130, NGN: 1500 };
        updateCurrencyDisplay();
      }
    }

    function updateCurrencyDisplay() {
      const currencySymbols = { USD: '$', RWF: 'FRw', EUR: '€', KES: 'Ksh', NGN: '₦' };
      const symbol = currencySymbols[selectedCurrency] || selectedCurrency;
      
      // Update all product prices
      document.querySelectorAll('.product-price').forEach(element => {
        const originalPrice = parseFloat(element.dataset.originalPrice);
        const originalCurrency = element.dataset.currency;
        
        if (originalCurrency === selectedCurrency) {
          element.textContent = `${symbol}${originalPrice.toFixed(2)}`;
        } else {
          // Convert currency
          const usdRate = currencyRates[originalCurrency] || 1;
          const targetRate = currencyRates[selectedCurrency] || 1;
          const convertedPrice = (originalPrice / usdRate) * targetRate;
          element.textContent = `${symbol}${convertedPrice.toFixed(2)}`;
        }
      });

      // Update original prices (for discounted items)
      document.querySelectorAll('.product-original-price').forEach(element => {
        const originalPrice = parseFloat(element.dataset.originalPrice);
        const originalCurrency = element.dataset.currency;
        
        if (originalCurrency === selectedCurrency) {
          element.textContent = `${symbol}${originalPrice.toFixed(2)}`;
        } else {
          // Convert currency
          const usdRate = currencyRates[originalCurrency] || 1;
          const targetRate = currencyRates[selectedCurrency] || 1;
          const convertedPrice = (originalPrice / usdRate) * targetRate;
          element.textContent = `${symbol}${convertedPrice.toFixed(2)}`;
        }
      });
    }

    // --- UTILITY FUNCTIONS ---
    function viewProduct(productId) {
      window.location.href = `/buyer/product-detail.html?id=${productId}`;
    }

    async function contactSeller(sellerId) {
      try {
        console.log('[PRODUCT-LIST] Contacting seller:', sellerId);
        
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          showNotification('Please sign in to contact sellers', 'error');
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 1500);
          return;
        }
        
        // Get current product info for the message
        const product = products.find(p => p.seller_id === sellerId);
        if (!product) {
          showNotification('Product information not found', 'error');
          return;
        }
        
        // Create a message to the seller
        const response = await fetch('/api/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            recipient_id: sellerId,
            subject: `Inquiry about ${product.name}`,
            content: `Hi, I'm interested in your product "${product.name}". Could you please provide more information about availability, pricing, and shipping options?`,
            product_id: product.id
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('[PRODUCT-LIST] Message sent response:', data);
          showNotification('Message sent to seller!', 'success');
          // Redirect to messages page to see the conversation
          setTimeout(() => {
            window.location.href = `/buyer/messages.html`;
          }, 1500);
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('[PRODUCT-LIST] Message send failed:', response.status, errorData);
          showNotification(errorData.error || errorData.message || 'Failed to send message', 'error');
        }
      } catch (error) {
        console.error('[PRODUCT-LIST] Error contacting seller:', error);
        showNotification('Failed to contact seller. Please try again.', 'error');
      }
    }

    async function addToCart(productId) {
      try {
        console.log('[PRODUCT-LIST] Adding product to cart:', productId);
        
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          showNotification('Please sign in to add items to cart', 'error');
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 1500);
          return;
        }
        
        const response = await fetch('/api/cart/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            productId: productId,
            quantity: 1
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('[PRODUCT-LIST] Add to cart response:', data);
          showNotification('✅ Product added to cart!', 'success');
          
          // Track referral conversion for add to cart
          await trackReferralConversion('add_to_cart', productId, {
            cart_item_id: data.cartItemId,
            quantity: 1
          });
          
          // Update cart count in header if it exists
          await updateCartCount();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('[PRODUCT-LIST] Add to cart failed:', response.status, errorData);
          showNotification(`❌ ${errorData.error || errorData.message || 'Failed to add to cart'}`, 'error');
        }
      } catch (error) {
        console.error('[PRODUCT-LIST] Error adding to cart:', error);
        showNotification('❌ Failed to add to cart. Please try again.', 'error');
      }
    }

    // Duplicate functions removed - using enhanced versions above

    // Setup dropdown functionality
    // --- MISSING FUNCTIONS ---
    
    // Fetch currency rates (placeholder function)
    async function fetchCurrencyRates() {
      try {
        console.log('[PRODUCT-LIST] Currency rates functionality not implemented yet');
        // This would fetch currency conversion rates from an API
        // For now, we'll use default rates
        currencyRates = {
          'USD': 1,
          'RWF': 1000,
          'EUR': 0.85,
          'KES': 110,
          'NGN': 410
        };
      } catch (error) {
        console.error('[PRODUCT-LIST] Error fetching currency rates:', error);
      }
    }

    // Update cart count badge
    async function updateCartCount() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          console.log('[PRODUCT-LIST] No token available for cart count update');
          return;
        }

        const response = await fetch('/api/cart/count', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('[PRODUCT-LIST] Cart count response:', data);
          
          const totalItems = data.count || data.totalItems || 0;
          
          const badge = document.querySelector('[data-cart-count]');
          if (badge) {
            if (totalItems > 0) {
              badge.textContent = totalItems;
              badge.classList.remove('hidden');
            } else {
              badge.classList.add('hidden');
            }
          }
        } else {
          console.log('[PRODUCT-LIST] Cart count API returned:', response.status);
        }
      } catch (error) {
        console.error('[PRODUCT-LIST] Error updating cart count:', error);
      }
    }

    // Show notification function
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function setupDropdowns() {
      const profileBtn = document.getElementById('profile-btn');
      const profileDropdown = document.getElementById('profile-dropdown');
      
      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          profileDropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
          profileDropdown.classList.add('hidden');
        });
        
        // Prevent dropdown from closing when clicking inside
        profileDropdown.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
      
      // Setup signout functionality
      const signoutBtn = document.getElementById('signout-btn');
      if (signoutBtn) {
        signoutBtn.addEventListener('click', function() {
          console.log('[PRODUCT-LIST] User logging out...');
          
          // Clear all possible authentication keys
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          localStorage.removeItem('cart');
          localStorage.removeItem('checkoutData');
          
          showNotification('Logged out successfully', 'success');
          
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 1000);
        });
      }
    }

    // Setup header search functionality
    function setupHeaderSearch() {
      const headerSearchInput = document.getElementById('header-search-input');
      const headerSearchBtn = document.getElementById('header-search-btn');
      
      if (headerSearchInput && headerSearchBtn) {
        // Search button click
        headerSearchBtn.addEventListener('click', function() {
          const query = headerSearchInput.value.trim();
          if (query) {
            currentFilters.search = query;
            document.getElementById('search-input').value = query;
            fetchProducts(true);
            updateActiveFilters();
          }
        });
        
        // Enter key in header search
        headerSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
              currentFilters.search = query;
              document.getElementById('search-input').value = query;
              fetchProducts(true);
              updateActiveFilters();
            }
          }
        });
      }
    }

    // Show error function
    function showError(message) {
      const grid = document.getElementById('products-grid');
      grid.innerHTML = `
        <div class="col-span-full text-center py-12">
          <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-red-400 mb-4" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Products</h3>
          <p class="text-gray-600 mb-4">${message}</p>
          <button onclick="fetchProducts(true)" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Try Again
          </button>
        </div>
      `;
    }

    // Handle URL parameters on page load
    function handleUrlParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Handle search parameter
      const searchQuery = urlParams.get('search');
      if (searchQuery) {
        currentFilters.search = searchQuery;
        document.getElementById('search-input').value = searchQuery;
        document.getElementById('header-search-input').value = searchQuery;
      }
      
      // Handle category parameter
      const categoryId = urlParams.get('category_id');
      if (categoryId) {
        currentFilters.category_id = parseInt(categoryId);
      }
      
      // Handle sort parameter
      const sort = urlParams.get('sort');
      if (sort) {
        currentFilters.sort = sort;
        document.getElementById('sort-select').value = sort;
      }
    }

    // --- REFERRAL TRACKING FUNCTIONS ---
    async function trackReferralConversion(action, productId, additionalData = {}) {
      try {
        const referralData = localStorage.getItem('referral_data');
        if (!referralData) {
          console.log('[REFERRAL] No referral data found for conversion tracking');
          return;
        }

        const parsedData = JSON.parse(referralData);
        console.log('[REFERRAL] Tracking conversion:', { action, productId, referralData: parsedData });

        // Update session status based on action
        let newStatus = 'clicked';
        if (action === 'add_to_cart') {
          newStatus = 'engaged'; // User is engaged with the product
        } else if (action === 'purchase') {
          newStatus = 'completed';
        }

        const response = await fetch('/api/referrals/session/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: parsedData.session_id,
            status: newStatus,
            action: action,
            product_id: productId,
            ...additionalData
          })
        });

        if (response.ok) {
          console.log('[REFERRAL] Conversion tracked successfully');
        } else {
          console.error('[REFERRAL] Failed to track conversion:', response.status);
        }

      } catch (error) {
        console.error('[REFERRAL] Error tracking conversion:', error);
      }
    }
  </script>

  <!-- Load Floating Contact Component -->
  <script src="/buyer/floating-contact-component.js"></script>
</body>
</html> 