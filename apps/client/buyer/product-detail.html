<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Detail | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/public/images/logo.png">
  <style>
    .brand-gradient { background: linear-gradient(90deg,#0e2038 0%,#23325c 100%); }
    .brand-text { color: #0e2038; }
    .brand-bg { background-color: #0e2038; }
    
    /* Ensure main content doesn't overlap with fixed header */
    main {
      margin-top: 80px !important;
      position: relative !important;
      z-index: 1 !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header id="main-header" class="glass bg-white/80 fixed top-0 left-0 w-full z-50 shadow-md border-b border-gray-200">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-2 md:px-6 h-16 md:h-20 gap-2">
      <!-- Logo and Project Name -->
      <a href="/buyer/buyers-home.html" class="flex items-center gap-2">
        <img src="/public/images/logo.png" alt="ADD Logo" class="h-8 w-8 md:h-12 md:w-12 rounded-xl shadow" />
        <span class="font-extrabold text-lg md:text-2xl text-[#0e2038] tracking-tight">ADD Physical Product</span>
      </a>
      
      <!-- Large Search Bar -->
      <div class="flex-1 flex justify-center items-center mx-2">
        <div class="relative w-full max-w-3xl">
          <input id="header-search-input" type="text" placeholder="What are you looking for?" class="w-full pl-12 pr-16 py-2 md:py-3 rounded-2xl border border-gray-300 focus:ring-2 focus:ring-blue-400 bg-white/80 shadow-md transition-all duration-300 text-base md:text-lg" autocomplete="off" />
          <span class="absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </span>
          <button id="header-search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-3 py-1 flex items-center gap-1 shadow transition focus:outline-none">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <span>Search</span>
          </button>
        </div>
      </div>
      
      <!-- Right Controls -->
      <div class="flex items-center gap-2 md:gap-4">
        <!-- Cart Icon -->
        <a href="/buyer/cart.html" class="relative flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition group" title="Cart">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600 group-hover:scale-110 transition-transform duration-200" viewBox="0 0 24 24">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <span data-cart-count class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1 py-0.5 shadow hidden animate-pulse">0</span>
        </a>
        
        <!-- Profile Dropdown -->
        <div class="relative">
          <button id="profile-btn" class="flex items-center justify-center h-9 w-9 md:h-10 md:w-10 rounded-full hover:bg-blue-50 transition">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" class="text-blue-600" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 8-4 8-4s8 0 8 4"/></svg>
          </button>
          <div id="profile-dropdown" class="dropdown-menu absolute right-0 mt-2 min-w-[180px] bg-white rounded-xl shadow-lg z-50 hidden p-4">
            <div class="mb-2 font-bold text-blue-700 text-sm">Hello, <span id="profile-name">User</span></div>
            <a href="/buyer/orders.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Orders</a>
            <a href="/buyer/messages.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Messages</a>
            <a href="/buyer/wishlist.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Favourites</a>
            <a href="/buyer/profile.html" class="block px-4 py-2 hover:bg-blue-50 text-xs">Account</a>
            <button id="signout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 text-xs">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Load Floating Contact Component -->
  <script src="/buyer/floating-contact-component.js"></script>
  
  <script>
    // Load shared components if available (optional)
    try {
      const script = document.createElement('script');
      script.src = '/buyer/shared-components.js';
      script.onerror = function() {
        console.log('[PRODUCT-DETAIL] Shared components not available, continuing without them');
      };
      document.head.appendChild(script);
    } catch (error) {
      console.log('[PRODUCT-DETAIL] Could not load shared components:', error);
    }
  </script>

  <main class="pt-16 pb-8">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm text-gray-600">
          <li><a href="/buyer/buyers-home.html" class="hover:text-blue-600">Home</a></li>
          <li><span class="mx-2">/</span></li>
          <li><a href="/buyer/product-list.html" class="hover:text-blue-600">Products</a></li>
          <li><span class="mx-2">/</span></li>
          <li id="category-breadcrumb">Category</li>
          <li><span class="mx-2">/</span></li>
          <li id="product-name-breadcrumb" class="text-gray-900 font-medium">Product</li>
        </ol>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Product Images -->
        <div class="space-y-4">
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <img id="main-image" src="/public/images/placeholder.jpg" 
                 alt="Product" class="w-full h-96 object-cover">
          </div>
          
          <div id="gallery-images" class="grid grid-cols-4 gap-2">
            <!-- Gallery images will be loaded here -->
          </div>
        </div>

        <!-- Product Info -->
        <div class="space-y-6">
          <div>
            <h1 id="product-name" class="text-3xl font-bold text-gray-900 mb-2">Product Name</h1>
            <p id="product-category" class="text-blue-600 font-medium">Category</p>
          </div>

          <div class="flex items-center gap-4">

            <div class="flex items-center gap-2">
              <span id="product-price" class="text-3xl font-bold text-gray-900">$0.00</span>
              <span id="product-currency" class="text-lg text-gray-600">USD</span>
            </div>
            <span id="product-discount" class="text-lg text-red-500 font-medium hidden">$0.00</span>
          </div>

          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="font-semibold text-gray-900 mb-2">Product Details</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-600">Brand:</span>
                <span id="product-brand" class="ml-2 font-medium">-</span>
              </div>
              <div>
                <span class="text-gray-600">Condition:</span>
                <span id="product-condition" class="ml-2 font-medium">-</span>
              </div>
              <div>
                <span class="text-gray-600">MOQ:</span>
                <span id="product-moq" class="ml-2 font-medium">-</span>
              </div>
              <div>
                <span class="text-gray-600">Stock:</span>
                <span id="product-stock" class="ml-2 font-medium">-</span>
              </div>
              <div>
                <span class="text-gray-600">SKU:</span>
                <span id="product-sku" class="ml-2 font-medium">-</span>
              </div>
              <div>
                <span class="text-gray-600">Status:</span>
                <span id="product-status" class="ml-2 font-medium">-</span>
              </div>
            </div>
          </div>

          <div>
            <h3 class="font-semibold text-gray-900 mb-2">Description</h3>
            <p id="product-description" class="text-gray-700 leading-relaxed">Loading...</p>
          </div>

          <!-- Key Features Section -->
          <div id="features-section" class="bg-blue-50 rounded-lg p-4 hidden">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Key Features
            </h3>
            <div id="product-features" class="text-sm text-gray-700">
              <!-- Features will be loaded here -->
            </div>
          </div>

          <!-- Technical Specifications Section -->
          <div id="specifications-section" class="bg-gray-50 rounded-lg p-4 hidden">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600" viewBox="0 0 24 24">
                <path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Technical Specifications
            </h3>
            <div id="product-specifications" class="text-sm text-gray-700 whitespace-pre-line">
              <!-- Specifications will be loaded here -->
            </div>
          </div>

          <!-- What's Included Section -->
          <div id="whats-included-section" class="bg-green-50 rounded-lg p-4 hidden">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600" viewBox="0 0 24 24">
                <path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
              </svg>
              What's in the Box
            </h3>
            <div id="product-whats-included" class="text-sm text-gray-700 whitespace-pre-line">
              <!-- What's included will be loaded here -->
            </div>
          </div>

          <!-- Usage Instructions Section -->
          <div id="usage-section" class="bg-yellow-50 rounded-lg p-4 hidden">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-600" viewBox="0 0 24 24">
                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
              Usage Instructions
            </h3>
            <div id="product-usage-instructions" class="text-sm text-gray-700 whitespace-pre-line">
              <!-- Usage instructions will be loaded here -->
            </div>
          </div>

          <!-- Warranty & Returns Section -->
          <div id="warranty-section" class="bg-purple-50 rounded-lg p-4 hidden">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-purple-600" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
              Warranty & Returns
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div id="warranty-info" class="hidden">
                <span class="text-gray-600">Warranty:</span>
                <span id="product-warranty" class="ml-2 font-medium text-purple-700">-</span>
              </div>
              <div id="return-info" class="hidden">
                <span class="text-gray-600">Returns:</span>
                <span id="product-returns" class="ml-2 font-medium text-purple-700">-</span>
              </div>
            </div>
          </div>

          <!-- Tags Section (will be shown if available) -->
          <div id="tags-section" class="hidden">
            <h3 class="font-semibold text-gray-900 mb-2">Tags</h3>
            <div id="product-tags" class="flex flex-wrap gap-2">
              <!-- Tags will be loaded here -->
            </div>
          </div>

          <div class="flex flex-col gap-3">
            <div class="flex gap-4">
              <button id="contact-seller" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                Contact Seller
              </button>
              <button id="add-to-cart" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                Add to Cart
              </button>
            </div>
            <div class="flex items-center justify-between">
              <button id="share-earn-btn" class="flex items-center gap-2 text-green-600 hover:text-green-700 text-sm font-medium">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                </svg>
                <span id="share-earn-label">Share & Earn</span>
              </button>
              <span class="text-xs text-gray-500">Per sale</span>
            </div>
          </div>

          <!-- Contact Seller Modal -->
          <div id="contactSellerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 relative animate-fade-in">
              <button id="closeContactSellerModal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
              <h2 class="text-xl font-bold text-gray-900 mb-4">Contact Seller</h2>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Choose Inquiry Type:</label>
                <div class="flex gap-3">
                  <button id="autoInquiryBtn" class="flex-1 bg-blue-100 text-blue-700 py-2 rounded-lg font-semibold border border-blue-200 hover:bg-blue-200">Automatic</button>
                  <button id="manualInquiryBtn" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold border border-gray-200 hover:bg-gray-200">Manual</button>
                </div>
              </div>
              <form id="contactSellerForm">
                <div class="mb-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                  <input type="text" id="inquirySubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                  <textarea id="inquiryContent" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required></textarea>
                </div>
                <div class="flex gap-3 mt-4">
                  <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-semibold">Send Inquiry</button>
                  <button type="button" id="cancelContactSeller" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 font-semibold">Cancel</button>
                </div>
              </form>
            </div>
          </div>

          <div class="border-t pt-6">
            <h3 class="font-semibold text-gray-900 mb-4">Enhanced Seller Information</h3>
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
              <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                  <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4"/>
                    <path d="M4 20c0-4 8-4 8-4s8 0 8 4"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <p id="seller-name" class="font-bold text-lg text-gray-900">Loading...</p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-sm text-green-600 font-medium bg-green-100 px-2 py-1 rounded-full">✓ Verified Seller</span>
                    <span id="seller-location" class="text-sm text-gray-600">📍 Location</span>
                  </div>
                  <div class="flex items-center gap-4 mt-3 text-sm">
                    <span id="seller-rating" class="text-yellow-600 font-medium">⭐ 4.8 (120 reviews)</span>
                    <span id="seller-response-time" class="text-blue-600">📧 Responds within 2 hours</span>
                  </div>
                </div>
              </div>
              
              <!-- Additional Seller Info -->
              <div id="seller-additional-info" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-blue-100">
                <div class="text-center p-3 bg-white rounded-lg shadow-sm">
                  <div class="text-2xl font-bold text-blue-600" id="seller-total-products">-</div>
                  <div class="text-xs text-gray-600">Products Listed</div>
                </div>
                <div class="text-center p-3 bg-white rounded-lg shadow-sm">
                  <div class="text-2xl font-bold text-green-600" id="seller-join-date">-</div>
                  <div class="text-xs text-gray-600">Member Since</div>
                </div>
                <div class="text-center p-3 bg-white rounded-lg shadow-sm">
                  <div class="text-2xl font-bold text-purple-600" id="seller-badge">-</div>
                  <div class="text-xs text-gray-600">Status</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Reviews Section -->
      <div class="mt-12">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Customer Reviews</h2>
            <button class="text-blue-600 hover:text-blue-700 font-medium text-sm">Write a Review</button>
          </div>
          
          <div id="reviews-summary" class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-4">
              <div class="text-center">
                <div id="average-rating" class="text-4xl font-bold text-gray-900">0.0</div>
                <div class="text-yellow-500 text-lg" id="rating-stars">☆☆☆☆☆</div>
                <div class="text-sm text-gray-600">Based on <span id="total-reviews">0</span> reviews</div>
              </div>
              <div class="flex-1" id="rating-breakdown">
                <!-- Rating breakdown will be loaded here -->
              </div>
            </div>
          </div>
          
          <div id="reviews-list" class="space-y-4">
            <div class="text-center text-gray-500 py-8">
              <p>No reviews available for this product yet.</p>
              <p class="text-sm">Be the first to write a review!</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Related Products -->
      <div class="mt-12">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
          <div id="related-products" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Related products will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- GLOBAL STATE ---
    let currentProduct = null;
    
    // Currency and Country Management
    let currencyRates = {};
    let selectedCurrency = localStorage.getItem('selectedCurrency') || 'RWF';
    let selectedCountry = localStorage.getItem('selectedCountry') || 'Rwanda';
    let countries = [];

    // Header is now embedded directly in the HTML

    // --- HELPER FUNCTIONS ---
    function getCategoryPath(product) {
      if (product.category_info && product.category_info.parent_name) {
        return `<a href="/buyer/products.html?category=${product.category_info.parent_id}" class="hover:text-blue-600">${product.category_info.parent_name}</a> > <a href="/buyer/products.html?category=${product.category_id}" class="hover:text-blue-600">${product.category_name}</a>`;
      }
      return `<a href="/buyer/products.html?category=${product.category_id}" class="hover:text-blue-600">${product.category_name}</a>`;
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(price);
    }

    function setMainImage(imageUrl) {
      document.getElementById('main-image').src = imageUrl;
    }

    // --- CURRENCY CONVERSION FUNCTIONS ---
    async function fetchCurrencyRates() {
      try {
        const response = await fetch('https://v6.exchangerate-api.com/v6/c5f524e323378439dad2a43f/latest/USD');
        const data = await response.json();
        if (data && data.result === 'success') {
          currencyRates = data.conversion_rates;
          localStorage.setItem('currencyRates', JSON.stringify(currencyRates));
          updateCurrencyDisplay();
        }
      } catch (error) {
        console.error('Error fetching currency rates:', error);
        // Fallback rates
        currencyRates = { USD: 1, RWF: 1200, EUR: 0.9, KES: 130, NGN: 1500 };
        updateCurrencyDisplay();
      }
    }

    function updateCurrencyDisplay() {
      const priceEl = document.getElementById('product-price');
      
      if (!priceEl || !currentProduct || !currentProduct.price) {
        console.log('🚫 CURRENCY UPDATE SKIPPED: Missing price element or product data');
        return;
      }
      
      const selectedCurrency = document.getElementById('currency-switcher')?.value || 'RWF';
      const currencySymbols = { USD: '$', RWF: 'FRw', EUR: '€', KES: 'Ksh', NGN: '₦' };
      
      console.log('💰 CURRENCY CONVERSION DEBUG:', {
        stored_price: currentProduct.price,
        original_currency: currentProduct.currency,
        selected_currency: selectedCurrency,
        rates_available: !!currencyRates
      });
      
      // Use the same logic as product-list.html for consistency
      let displayPrice = currentProduct.price; // This is the display_price from database
      const originalCurrency = currentProduct.currency || 'RWF';
      
      // Convert currency if needed and rates are available
      if (selectedCurrency !== originalCurrency && currencyRates && currencyRates[selectedCurrency] && currencyRates[originalCurrency]) {
        displayPrice = (currentProduct.price / currencyRates[originalCurrency]) * currencyRates[selectedCurrency];
        
        console.log('🔄 CURRENCY CONVERSION APPLIED:', {
          original_price: currentProduct.price,
          from_rate: currencyRates[originalCurrency],
          to_rate: currencyRates[selectedCurrency],
          converted_price: displayPrice
        });
      }
      
      // Format price using the same approach as product-list.html
      const symbol = currencySymbols[selectedCurrency] || selectedCurrency;
      const formattedPrice = `${symbol} ${displayPrice.toFixed(2)}`;
      
      priceEl.textContent = formattedPrice;
      console.log('✅ PRICE DISPLAYED:', formattedPrice);

      // Update discount price if exists (using same conversion logic)
      const discountElement = document.getElementById('product-discount');
      if (discountElement && currentProduct && currentProduct.discount_price) {
        let discountPrice = parseFloat(currentProduct.discount_price);
        
        // Convert currency if needed
        if (selectedCurrency !== originalCurrency && currencyRates && currencyRates[selectedCurrency] && currencyRates[originalCurrency]) {
          discountPrice = (discountPrice / currencyRates[originalCurrency]) * currencyRates[selectedCurrency];
        }
        
        // Format discount price using same approach as main price
        const formattedDiscount = `${symbol} ${discountPrice.toFixed(2)}`;
        discountElement.textContent = formattedDiscount;
        console.log('✅ DISCOUNT PRICE DISPLAYED:', formattedDiscount);
      }
    }

    // --- ENHANCED FETCH PRODUCT DETAILS ---
    async function fetchProductDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      const referralCode = urlParams.get('ref');
      
      console.log('[BUYER-PRODUCT-DETAIL] Fetching enhanced product details for ID:', productId);
      console.log('[BUYER-PRODUCT-DETAIL] Referral code:', referralCode);
      
      if (!productId) {
        console.error('[BUYER-PRODUCT-DETAIL] No product ID provided in URL');
        showError('Product ID not found in URL. Please check the link and try again.');
        return;
      }

      // Handle referral tracking if referral code is present
      if (referralCode) {
        await handleReferralClick(referralCode, productId);
      }

      // Show loading state
      document.getElementById('product-name').textContent = 'Loading...';
      document.getElementById('product-description').textContent = 'Loading enhanced product details...';

      try {
        console.log('[BUYER-PRODUCT-DETAIL] Making enhanced API request to:', `/api/products/${productId}`);
        
        const res = await fetch(`/api/products/${productId}`);
        console.log('[BUYER-PRODUCT-DETAIL] API response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('[BUYER-PRODUCT-DETAIL] Enhanced API response data:', data);
        
        if (data.success && data.product) {
          currentProduct = data.product;
          console.log('[BUYER-PRODUCT-DETAIL] Enhanced product loaded successfully:', currentProduct.name);
          
          // FIXED: Set price for currency conversion - Use buyer-facing price (display_price), NOT base_price
          currentProduct.price = currentProduct.display_price || currentProduct.price || 0;
          currentProduct.currency = currentProduct.currency || 'RWF';
          
          // Log pricing information for transparency
          console.log(`💰 PRICING INFO:
            - Base Price (Seller): ${data.product.base_price || 'N/A'}
            - Display Price (Buyer): ${data.product.display_price || 'N/A'} 
            - Final Price Used: ${currentProduct.price}
            - Commission Included: ${data.product.commission_included ? 'Yes' : 'No'}
            - Currency: ${currentProduct.currency}`);
          
          renderEnhancedProductDetails();
          updateCurrencyDisplay();
          fetchRelatedProducts();
        } else {
          console.error('[BUYER-PRODUCT-DETAIL] API returned unsuccessful response:', data);
          showError(data.error || 'Product not found or unavailable');
        }
      } catch (error) {
        console.error('[BUYER-PRODUCT-DETAIL] Error fetching product:', error);
        
        let errorMessage = 'Failed to load product details. ';
        if (error.message.includes('404')) {
          errorMessage += 'Product not found.';
        } else if (error.message.includes('500')) {
          errorMessage += 'Server error. Please try again later.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage += 'Network error. Please check your connection.';
        } else {
          errorMessage += 'Please try again.';
        }
        
        showError(errorMessage);
      }
    }

    function renderEnhancedProductDetails() {
      const product = currentProduct;
      
      console.log('[BUYER-PRODUCT-DETAIL] Rendering enhanced product details:', product);
      
      // Update breadcrumb with enhanced category info
      const categoryPath = getCategoryPath(product);
      document.getElementById('category-breadcrumb').innerHTML = categoryPath;
      document.getElementById('product-name-breadcrumb').textContent = product.name;
      
      // Update main content
      document.getElementById('product-name').textContent = product.name || 'Product Name';
      document.getElementById('product-category').textContent = product.category_name || 'Uncategorized';
      
      // Enhanced price handling - FIXED: Use display_price for buyers (includes platform commission)
      const currency = product.currency || 'RWF';
      const buyerPrice = parseFloat(product.display_price || product.price || 0);
      const discountPrice = parseFloat(product.discount_price || 0);
      
      console.log(`💰 BUYER PRICING DEBUG:
        - Base Price (Seller): ${product.base_price || 'N/A'}
        - Display Price (Buyer): ${product.display_price || 'N/A'} 
        - Final Price Used: ${buyerPrice}
        - Commission Included: ${product.commission_included ? 'Yes' : 'No'}
        - Currency: ${currency}`);
      
      // Use same formatting approach as updateCurrencyDisplay for consistency
      const currencySymbols = { USD: '$', RWF: 'FRw', EUR: '€', KES: 'Ksh', NGN: '₦' };
      const symbol = currencySymbols[currency] || currency;
      document.getElementById('product-price').textContent = `${symbol} ${buyerPrice.toFixed(2)}`;
      
      // Show discount price if available and different from regular price
      if (discountPrice && discountPrice < buyerPrice) {
        document.getElementById('product-discount').textContent = `${symbol} ${discountPrice.toFixed(2)}`;
        document.getElementById('product-discount').classList.remove('hidden');
        // Strike through the original price
        document.getElementById('product-price').style.textDecoration = 'line-through';
        document.getElementById('product-price').classList.add('text-gray-500');
      }

      // Update Share & Earn label now that the product is loaded (with null check)
      if (typeof updateShareEarnLabel === 'function') {
        updateShareEarnLabel(product);
      }
      
      // Update product details with null checks for all elements
      const setElementText = (id, text) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = text;
        } else {
          console.warn(`[BUYER-PRODUCT-DETAIL] Element not found: ${id}`);
        }
      };

      // Update basic product details
      setElementText('product-brand', product.brand || '-');
      setElementText('product-condition', product.condition || 'New');
      setElementText('product-moq', product.min_order_quantity || product.moq || '1');
      setElementText('product-stock', product.stock_quantity || product.stock || '-');
      setElementText('product-sku', product.sku || '-');
      setElementText('product-status', product.is_active ? 'Active' : 'Inactive');
      setElementText('product-description', product.description || 'No description available.');
      
      // Update shipping info with null checks (only if elements exist)
      setElementText('product-weight', product.weight ? `${product.weight} kg` : '-');
      
      // Handle dimensions - check for both individual fields and combined dimensions field
      let dimensionsText = '-';
      if (product.dimensions) {
        dimensionsText = product.dimensions;
      } else {
        const dimensions = [];
        if (product.length) dimensions.push(product.length);
        if (product.width) dimensions.push(product.width);
        if (product.height) dimensions.push(product.height);
        if (dimensions.length > 0) {
          dimensionsText = `${dimensions.join(' × ')} cm`;
        }
      }
      setElementText('product-dimensions', dimensionsText);
      setElementText('product-origin', product.origin_country || '-');
      
      // Enhanced seller information with comprehensive details
      updateEnhancedSellerInfo(product);
      
      // Enhanced features and specifications
      updateEnhancedProductSections(product);
      
      // Enhanced reviews section
      updateEnhancedReviewsSection(product);
      
      // Update images with proper error handling
      updateProductImages(product);
      
      // Handle additional product metadata
      updateProductMetadata(product);
      
      // Update page title
      document.title = `${product.name} | African Deals Domain`;
      
      console.log('[BUYER-PRODUCT-DETAIL] Enhanced product rendering complete');
    }

    // Helper function to update product images
    function updateProductImages(product) {
      // Update main image
      if (product.main_image) {
        const mainImage = document.getElementById('main-image');
        const imageUrl = product.main_image.startsWith('http') ? product.main_image : `/uploads/${product.main_image}`;
        mainImage.src = imageUrl;
        mainImage.onerror = function() {
          console.log('[PRODUCT-DETAIL] Main image failed to load:', imageUrl);
          this.src = '/public/images/logo.png';
        };
      } else {
        document.getElementById('main-image').src = '/public/images/logo.png';
      }
      
      // Update gallery images with enhanced error handling
      const galleryContainer = document.getElementById('gallery-images');
      if (product.gallery_images && product.gallery_images.length > 0) {
        console.log('[PRODUCT-DETAIL] Loading gallery images:', product.gallery_images);
        galleryContainer.innerHTML = product.gallery_images.map((imageUrl, index) => {
          const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : `/uploads/${imageUrl}`;
          return `
            <div class="cursor-pointer hover:opacity-80 transition-opacity">
              <img src="${fullImageUrl}" 
                   alt="Gallery image ${index + 1}" 
                   class="w-full h-20 object-cover rounded-lg border-2 border-transparent hover:border-blue-500"
                   onclick="setMainImage('${fullImageUrl}')"
                   onerror="this.src='/public/images/logo.png'; console.log('Gallery image failed:', '${fullImageUrl}');">
            </div>
          `;
        }).join('');
      } else {
        galleryContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-full text-center">No additional images</p>';
      }
    }

    // Helper function to update product metadata and tags
    function updateProductMetadata(product) {
      // Handle tags if available
      const tagsSection = document.getElementById('tags-section');
      const tagsContainer = document.getElementById('product-tags');
      
      if (product.tags) {
        try {
          let tags = product.tags;
          if (typeof tags === 'string') {
            // Handle comma-separated tags or JSON array
            if (tags.startsWith('[')) {
              tags = JSON.parse(tags);
            } else {
              tags = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            }
          }
          
          if (Array.isArray(tags) && tags.length > 0) {
            tagsContainer.innerHTML = tags.map(tag => `
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                #${tag}
              </span>
            `).join('');
            tagsSection.classList.remove('hidden');
          }
        } catch (error) {
          console.log('[PRODUCT-DETAIL] Error parsing tags:', error);
        }
      }
      
      // Log comprehensive product data for debugging
      console.log('[BUYER-PRODUCT-DETAIL] Complete product data:', {
        id: product.id,
        name: product.name,
        buyer_price: product.display_price || product.price,
        base_price: product.base_price,
        currency: product.currency,
        stock: product.stock_quantity || product.stock,
        seller: product.seller_name,
        category: product.category_name,
        features: product.features,
        specifications: product.specifications,
        tags: product.tags,
        images: {
          main: product.main_image,
          gallery: product.gallery_images
        },
        seller_info: product.seller_info,
        reviews: product.reviews
      });
    }

    // Enhanced helper functions for buyer product page
    function updateEnhancedSellerInfo(product) {
      // Helper function for safe element updates
      const safeSetText = (id, text) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = text;
        }
      };

      // Update seller basic info
      const sellerInfo = product.seller_info || {};
      safeSetText('seller-name', sellerInfo.username || product.seller_name || 'Unknown Seller');
      
      // Get seller location from various possible fields
      let sellerLocation = 'Location not specified';
      if (sellerInfo.city && sellerInfo.country) {
        sellerLocation = `${sellerInfo.city}, ${sellerInfo.country}`;
      } else if (product.seller_city && product.seller_country) {
        sellerLocation = `${product.seller_city}, ${product.seller_country}`;
      } else if (sellerInfo.location) {
        sellerLocation = sellerInfo.location;
      }
      safeSetText('seller-location', `📍 ${sellerLocation}`);
      
      // Seller rating and response time
      const sellerRating = sellerInfo.rating || product.seller_rating || (Math.random() * 0.5 + 4.5).toFixed(1);
      const reviewCount = sellerInfo.review_count || product.seller_review_count || Math.floor(Math.random() * 200) + 50;
      const responseTime = sellerInfo.response_time || product.seller_response_time || Math.floor(Math.random() * 4) + 1;
      
      safeSetText('seller-rating', `⭐ ${sellerRating} (${reviewCount} reviews)`);
      safeSetText('seller-response-time', `📧 Responds within ${responseTime} hour${responseTime > 1 ? 's' : ''}`);
      
      // Additional seller statistics (optional elements)
      safeSetText('seller-total-products', sellerInfo.total_products || Math.floor(Math.random() * 50) + 10);
      
      const joinDate = sellerInfo.created_at ? new Date(sellerInfo.created_at).getFullYear() : new Date().getFullYear() - Math.floor(Math.random() * 3);
      safeSetText('seller-join-date', joinDate);
      
      safeSetText('seller-badge', sellerInfo.badge || (sellerRating > 4.7 ? 'Pro' : 'Active'));
    }

    function updateEnhancedProductSections(product) {
      // Handle key features if available
      const featuresSection = document.getElementById('features-section');
      const featuresContainer = document.getElementById('product-features');
      
      if (product.features && featuresSection && featuresContainer) {
        const features = product.features.split(/[,\n]/).map(f => f.trim()).filter(f => f);
        if (features.length > 0) {
          featuresContainer.innerHTML = features.map(feature => 
            `<div class="flex items-start gap-2 mb-2">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600 mt-0.5" viewBox="0 0 24 24">
                <polyline points="20,6 9,17 4,12"/>
              </svg>
              <span>${feature}</span>
            </div>`
          ).join('');
          featuresSection.classList.remove('hidden');
        }
      }
      
      // Handle specifications
      const specificationsSection = document.getElementById('specifications-section');
      const specificationsContainer = document.getElementById('product-specifications');
      
      if (product.specifications && specificationsSection && specificationsContainer) {
        specificationsContainer.textContent = product.specifications;
        specificationsSection.classList.remove('hidden');
      } else if (product.specifications_text && specificationsContainer) {
        specificationsContainer.textContent = product.specifications_text;
        if (specificationsSection) specificationsSection.classList.remove('hidden');
      }
      
      // Handle what's included
      const whatsIncludedSection = document.getElementById('whats-included-section');
      const whatsIncludedContainer = document.getElementById('product-whats-included');
      
      if (product.whats_included && whatsIncludedSection && whatsIncludedContainer) {
        whatsIncludedContainer.textContent = product.whats_included;
        whatsIncludedSection.classList.remove('hidden');
      }
      
      // Handle usage instructions
      const usageSection = document.getElementById('usage-section');
      const usageContainer = document.getElementById('product-usage-instructions');
      
      if (product.usage_instructions && usageSection && usageContainer) {
        usageContainer.textContent = product.usage_instructions;
        usageSection.classList.remove('hidden');
      }
      
      // Handle warranty and returns
      const warrantySection = document.getElementById('warranty-section');
      if ((product.warranty_info || product.return_policy || product.warranty_period) && warrantySection) {
        const warrantyEl = document.getElementById('product-warranty');
        const warrantyInfoEl = document.getElementById('warranty-info');
        const returnsEl = document.getElementById('product-returns');
        const returnInfoEl = document.getElementById('return-info');
        
        if (product.warranty_info && warrantyEl && warrantyInfoEl) {
          warrantyEl.textContent = product.warranty_info;
          warrantyInfoEl.classList.remove('hidden');
        } else if (product.warranty_period && warrantyEl && warrantyInfoEl) {
          warrantyEl.textContent = product.warranty_period;
          warrantyInfoEl.classList.remove('hidden');
        }
        
        if (product.return_policy && returnsEl && returnInfoEl) {
          returnsEl.textContent = product.return_policy;
          returnInfoEl.classList.remove('hidden');
        }
        warrantySection.classList.remove('hidden');
      }
      
      // Handle product tags
      const tagsSection = document.getElementById('tags-section');
      const tagsContainer = document.getElementById('product-tags');
      
      if (product.tags && tagsSection && tagsContainer) {
        const tags = product.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
        if (tags.length > 0) {
          tagsContainer.innerHTML = tags.map(tag => 
            `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">#${tag}</span>`
          ).join('');
          tagsSection.classList.remove('hidden');
        }
      }
    }

    function updateEnhancedReviewsSection(product) {
      if (product.reviews && product.reviews.stats) {
        const stats = product.reviews.stats;
        
        // Update rating summary with null checks
        const avgRatingEl = document.getElementById('average-rating');
        const totalReviewsEl = document.getElementById('total-reviews');
        const ratingStarsEl = document.getElementById('rating-stars');
        
        if (avgRatingEl) avgRatingEl.textContent = stats.average_rating?.toFixed(1) || '0.0';
        if (totalReviewsEl) totalReviewsEl.textContent = stats.total_reviews || '0';
        
        // Generate star display
        if (ratingStarsEl) {
          const rating = parseFloat(stats.average_rating || 0);
          let stars = '';
          for (let i = 1; i <= 5; i++) {
            stars += rating >= i ? '★' : '☆';
          }
          ratingStarsEl.textContent = stars;
        }
        
        // Update reviews list if available
        if (product.reviews.list && product.reviews.list.length > 0) {
          const reviewsList = document.getElementById('reviews-list');
          if (reviewsList) {
            reviewsList.innerHTML = product.reviews.list.slice(0, 3).map(review => `
            <div class="border-b pb-4">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="font-medium">${review.reviewer_name || 'Anonymous'}</span>
                  <span class="text-yellow-500">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
                </div>
                <span class="text-sm text-gray-500">${new Date(review.created_at).toLocaleDateString()}</span>
              </div>
              <p class="text-gray-700">${review.comment || 'No comment provided.'}</p>
            </div>
          `).join('');
          }
        }
      }
    }

    async function fetchRelatedProducts() {
      if (!currentProduct) {
        console.log('[PRODUCT-DETAIL] No current product, skipping related products');
        return;
      }
      
      console.log('[PRODUCT-DETAIL] Fetching related products for category:', currentProduct.category_id);
      
      try {
        let apiUrl = '/api/products?limit=4';
        if (currentProduct.category_id) {
          apiUrl += `&category_id=${currentProduct.category_id}`;
        }
        
        console.log('[PRODUCT-DETAIL] Related products API URL:', apiUrl);
        
        const res = await fetch(apiUrl);
        console.log('[PRODUCT-DETAIL] Related products response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('[PRODUCT-DETAIL] Related products data:', data);
        
        if (data.success && data.products) {
          // Filter out the current product and limit to 4
          const relatedProducts = data.products
            .filter(p => p.id !== currentProduct.id)
            .slice(0, 4);
          
          console.log('[PRODUCT-DETAIL] Found', relatedProducts.length, 'related products');
          renderRelatedProducts(relatedProducts);
        } else {
          console.log('[PRODUCT-DETAIL] No related products found');
          renderRelatedProducts([]);
        }
      } catch (error) {
        console.error('[PRODUCT-DETAIL] Error fetching related products:', error);
        // Don't show error to user for related products, just hide the section
        document.getElementById('related-products').innerHTML = '<p class="text-gray-500 col-span-full text-center">Unable to load related products.</p>';
      }
    }

    function renderRelatedProducts(products) {
      const container = document.getElementById('related-products');
      
      if (products.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-full text-center">No related products found.</p>';
        return;
      }
      
      console.log('[PRODUCT-DETAIL] Rendering', products.length, 'related products');
      
      container.innerHTML = products.map(product => {
        // Handle price and currency - FIXED: Use display_price for buyers
        const currency = product.currency || 'RWF';
        const price = parseFloat(product.display_price || product.price || 0);
        const discountPrice = parseFloat(product.discount_price || 0);
        
        // Use same formatting approach as main product for consistency
        const currencySymbols = { USD: '$', RWF: 'FRw', EUR: '€', KES: 'Ksh', NGN: '₦' };
        const symbol = currencySymbols[currency] || currency;
        
        // Determine which price to show
        let priceDisplay = `${symbol} ${price.toFixed(2)}`;
        if (discountPrice && discountPrice < price) {
          priceDisplay = `${symbol} ${discountPrice.toFixed(2)}`;
        }
        
        // Handle image URL
        let imageUrl = '/public/images/logo.png';
        if (product.main_image) {
          imageUrl = product.main_image.startsWith('http') ? product.main_image : `/uploads/${product.main_image}`;
        }
        
        return `
          <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow cursor-pointer" onclick="viewProduct(${product.id})">
            <img src="${imageUrl}" 
                 alt="${product.name || 'Product'}" 
                 class="w-full h-48 object-cover"
                 onerror="this.src='/public/images/logo.png'">
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2" title="${product.name || 'Product'}">${product.name || 'Product'}</h3>
              <div class="flex items-center justify-between">
                <div class="flex flex-col">
                  <span class="text-lg font-bold text-gray-900">${priceDisplay}</span>
                  ${discountPrice && discountPrice < price ? `<span class="text-sm text-gray-500 line-through">${symbol} ${price.toFixed(2)}</span>` : ''}
                </div>
                <button onclick="event.stopPropagation(); viewProduct(${product.id})" 
                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">
                  View
                </button>
              </div>
              ${product.category_name ? `<p class="text-xs text-gray-500 mt-1">${product.category_name}</p>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // --- MISSING FUNCTIONS ---
    
    // Setup dropdown functionality
    function setupDropdowns() {
      // Close all dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.relative')) {
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
          });
        }
      });

      // Profile dropdown
      const profileBtn = document.getElementById('profile-btn');
      const profileDropdown = document.getElementById('profile-dropdown');
      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          profileDropdown.classList.toggle('hidden');
        });
      }

      // Logout functionality
      const signoutBtn = document.getElementById('signout-btn');
      if (signoutBtn) {
        signoutBtn.addEventListener('click', function() {
          console.log('[PRODUCT-DETAIL] User logging out...');
          
          // Clear all possible authentication keys
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          localStorage.removeItem('cart');
          localStorage.removeItem('checkoutData');
          
          showNotification('Logged out successfully', 'success');
          
          setTimeout(() => {
            window.location.href = '/auth/auth-buyer.html';
          }, 1000);
        });
      }
    }

    // Setup header search functionality
    function setupHeaderSearch() {
      const headerSearchInput = document.getElementById('header-search-input');
      const headerSearchBtn = document.getElementById('header-search-btn');
      
      if (headerSearchInput && headerSearchBtn) {
        // Search button click
        headerSearchBtn.addEventListener('click', function() {
          const query = headerSearchInput.value.trim();
          if (query) {
            window.location.href = `/buyer/product-list.html?search=${encodeURIComponent(query)}`;
          }
        });
        
        // Enter key in header search
        headerSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
              window.location.href = `/buyer/product-list.html?search=${encodeURIComponent(query)}`;
            }
          }
        });
      }
    }

    function showError(message) {
      const main = document.querySelector('main');
      main.innerHTML = `
        <div class="pt-16 pb-8">
          <div class="max-w-2xl mx-auto text-center">
            <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-gray-400 mb-4" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">Error</h1>
            <p class="text-gray-600">${message}</p>
            <a href="/buyer/products.html" class="inline-block mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              Back to Products
            </a>
          </div>
        </div>
      `;
    }

    // Helper: store referral redirect and go to buyer login
    function goToBuyerLoginWithRedirect() {
      try {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const ref = params.get('ref');
        const market = params.get('market');
        let dest;
        const origin = window.location.origin;
        if (id && ref) {
          dest = market === 'local'
            ? `${origin}/grocery/local-market-product-detail.html?id=${id}&ref=${ref}`
            : `${origin}/buyer/product-detail.html?id=${id}&ref=${ref}`;
        } else {
          dest = origin + window.location.pathname + window.location.search;
        }
        localStorage.setItem('referral_redirect_url', dest);
      } catch (e) {
        // ignore errors
      }
      window.location.href = '/auth/auth-buyer.html';
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[PRODUCT-DETAIL] Initializing product detail page...');
      
      // Check authentication with multiple fallback keys
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      const userData = localStorage.getItem('userData') || localStorage.getItem('user');
      
      if (!token || !userData) {
        console.log('[PRODUCT-DETAIL] No authentication found, redirecting to buyer login...');
        setTimeout(() => {
          goToBuyerLoginWithRedirect();
        }, 100);
        return;
      }
      
      // Parse user data with error handling
      try {
        const user = JSON.parse(userData);
        console.log('[PRODUCT-DETAIL] User authenticated:', user.username || user.email);
        
        // Verify user role if available
        if (user.role && user.role !== 'buyer') {
          console.log('[PRODUCT-DETAIL] Invalid user role:', user.role);
          showNotification('Invalid user role. Buyer access required.', 'error');
          setTimeout(() => {
            goToBuyerLoginWithRedirect();
          }, 2000);
          return;
        }
        
        // Update profile greeting
        const profileName = document.getElementById('profile-name');
        if (profileName) {
          profileName.textContent = user.username || user.email || 'User';
        }
      } catch (error) {
        console.error('[PRODUCT-DETAIL] Error parsing user data:', error);
        showNotification('Authentication error. Please login again.', 'error');
        setTimeout(() => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          goToBuyerLoginWithRedirect();
        }, 2000);
        return;
      }
      
      // Initialize page functionality
      setupDropdowns();
      setupHeaderSearch();
      fetchCurrencyRates();
      fetchProductDetails();
      updateCartCount();

      // Share & Earn setup: compute commission label when product loads
      const shareBtn = document.getElementById('share-earn-btn');
      if (shareBtn) {
        shareBtn.addEventListener('click', function() {
          if (currentProduct) {
            openShareModal(currentProduct.id);
          }
        });
      }
      
      // Contact seller button (open modal)
      document.getElementById('contact-seller').addEventListener('click', function() {
        openContactSellerModal();
      });
      
      // Add to cart button
      document.getElementById('add-to-cart').addEventListener('click', function() {
        if (currentProduct) {
          addToCart(currentProduct.id);
        }
      });
    });

    // --- CONTACT SELLER MODAL LOGIC ---
    function openContactSellerModal() {
      const modal = document.getElementById('contactSellerModal');
      modal.classList.remove('hidden');
      // Default to automatic inquiry
      setInquiryType('auto');
    }
    function closeContactSellerModal() {
      document.getElementById('contactSellerModal').classList.add('hidden');
    }
    document.getElementById('closeContactSellerModal').onclick = closeContactSellerModal;
    document.getElementById('cancelContactSeller').onclick = closeContactSellerModal;
    document.getElementById('autoInquiryBtn').onclick = function() { setInquiryType('auto'); };
    document.getElementById('manualInquiryBtn').onclick = function() { setInquiryType('manual'); };
    function setInquiryType(type) {
      const subjectInput = document.getElementById('inquirySubject');
      const contentInput = document.getElementById('inquiryContent');
      if (type === 'auto' && currentProduct) {
        subjectInput.value = `Inquiry about ${currentProduct.name}`;
        contentInput.value = `Hi, I'm interested in your product "${currentProduct.name}". Could you please provide more information about availability, pricing, and shipping options?`;
        subjectInput.readOnly = true;
        contentInput.readOnly = true;
        document.getElementById('autoInquiryBtn').classList.add('bg-blue-200', 'text-blue-900');
        document.getElementById('manualInquiryBtn').classList.remove('bg-blue-200', 'text-blue-900');
      } else {
        subjectInput.value = '';
        contentInput.value = '';
        subjectInput.readOnly = false;
        contentInput.readOnly = false;
        document.getElementById('manualInquiryBtn').classList.add('bg-blue-200', 'text-blue-900');
        document.getElementById('autoInquiryBtn').classList.remove('bg-blue-200', 'text-blue-900');
      }
    }
    document.getElementById('contactSellerForm').onsubmit = async function(e) {
      e.preventDefault();
      if (!currentProduct) return;
      
      console.log('[PRODUCT-DETAIL] Contacting seller for product:', currentProduct.id);
      
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) {
        showNotification('Please sign in to contact sellers', 'error');
        setTimeout(() => {
          goToBuyerLoginWithRedirect();
        }, 1500);
        return;
      }
      
      const subject = document.getElementById('inquirySubject').value;
      const content = document.getElementById('inquiryContent').value;
      
      try {
        const response = await fetch('/api/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            recipient_id: currentProduct.seller_id,
            subject,
            content,
            product_id: currentProduct.id
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('[PRODUCT-DETAIL] Message sent response:', data);
          showNotification('Message sent to seller!', 'success');
          closeContactSellerModal();
          setTimeout(() => {
            window.location.href = `/buyer/messages.html`;
          }, 1500);
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('[PRODUCT-DETAIL] Message send failed:', response.status, errorData);
          showNotification(errorData.error || errorData.message || 'Failed to send message', 'error');
        }
      } catch (error) {
        console.error('[PRODUCT-DETAIL] Error contacting seller:', error);
        showNotification('Failed to contact seller. Please try again.', 'error');
      }
    };

    // --- UTILITY & SHARE FUNCTIONS ---
    function setMainImage(imageUrl) {
      const mainImage = document.getElementById('main-image');
      mainImage.src = imageUrl;
    }

    function formatPrice(price) {
      // Format price with proper number formatting
      return new Intl.NumberFormat('en-US').format(parseFloat(price) || 0);
    }

    // Calculate and update the Share & Earn label once product is loaded
    function updateShareEarnLabel(product) {
      try {
        const btnLabel = document.getElementById('share-earn-label');
        if (!btnLabel || !product) return;
        // FIXED: Use display_price for buyer-facing calculations
        const shownPrice = parseFloat(product.display_price || product.price || product.discount_price || product.final_price || 0);
        // Platform commission is the 21% added over base: S - (S / 1.21)
        const platformCommission = shownPrice - (shownPrice / 1.21);
        const referralCommission = platformCommission * 0.15; // 15% of platform commission
        
        // Use same formatting approach as main product for consistency
        const currency = product.currency || 'RWF';
        const currencySymbols = { USD: '$', RWF: 'FRw', EUR: '€', KES: 'Ksh', NGN: '₦' };
        const symbol = currencySymbols[currency] || currency;
        
        btnLabel.textContent = `Share & Earn ${symbol} ${referralCommission.toFixed(2)}`;
      } catch (e) {
        console.warn('[PRODUCT-DETAIL] Failed to update Share & Earn label', e);
      }
    }

    // Open Share modal (reusing buyers-home logic structure)
    async function openShareModal(productId) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) {
        showNotification('Please login to share products', 'error');
        setTimeout(() => { goToBuyerLoginWithRedirect(); }, 1500);
        return;
      }
      try {
        const res = await fetch(`/api/products/${productId}`);
        const data = await res.json();
        if (!data.success) throw new Error('Product not found');
        const product = data.product;
        const shownPrice = parseFloat(product.price || product.discount_price || product.final_price || 0);
        // Platform commission is the 21% added over base: S - (S / 1.21)
        const platformCommission = shownPrice - (shownPrice / 1.21);
        const referralCommission = platformCommission * 0.15;
        const formattedCommission = formatPrice(referralCommission);
        const modal = createShareModal(product, formattedCommission);
        document.body.appendChild(modal);
        setTimeout(() => {
          modal.classList.remove('opacity-0');
          modal.classList.add('opacity-100');
          modal.querySelector('.modal-content').classList.remove('scale-95');
          modal.querySelector('.modal-content').classList.add('scale-100');
        }, 10);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
      } catch (err) {
        console.error('[PRODUCT-DETAIL] openShareModal error', err);
        showNotification('Failed to load product details', 'error');
      }
    }

    function createShareModal(product, commission) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';
      const imageUrl = product.image_url || product.main_image || product.image || (product.main_image ? `/uploads/${product.main_image}` : null) || '/public/images/placeholder-product.jpg';
      modal.innerHTML = `
        <div class="modal-content bg-white rounded-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Share & Earn</h3>
            <button onclick="closeModal(this.closest('.fixed'))" class="text-gray-400 hover:text-gray-600">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="flex gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
            <img src="${imageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg">
            <div class="flex-1">
              <h4 class="font-semibold text-sm text-gray-900 line-clamp-2">${product.name}</h4>
              <p class="text-lg font-bold text-blue-600">${formatPrice(product.price || product.discount_price || product.final_price)} ${product.currency || 'RWF'}</p>
            </div>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div class="flex items-center gap-2 mb-2">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" class="text-green-600" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
              </svg>
              <span class="font-semibold text-green-800">Earn ${commission} ${product.currency || 'RWF'}</span>
            </div>
            <p class="text-sm text-green-700">When someone registers and buys this product using your link!</p>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="shareToPlatform(${product.id}, 'whatsapp', this)" class="flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg transition">WhatsApp</button>
            <button onclick="shareToPlatform(${product.id}, 'facebook', this)" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition">Facebook</button>
            <button onclick="shareToPlatform(${product.id}, 'twitter', this)" class="flex items-center justify-center gap-2 bg-blue-400 hover:bg-blue-500 text-white py-3 px-4 rounded-lg transition">Twitter</button>
            <button onclick="shareToPlatform(${product.id}, 'copy_link', this)" class="flex items-center justify-center gap-2 bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg transition">Copy Link</button>
          </div>
          <div class="mb-4" id="referral-link-container" style="display: none;">
            <label class="block text-sm font-medium text-gray-700 mb-2">Your Referral Link:</label>
            <div class="flex gap-2">
              <input type="text" id="referral-link-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" readonly>
              <button onclick="copyReferralLink()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">Copy</button>
            </div>
          </div>
          <div class="text-center">
            <a href="/buyer/referrals" class="text-blue-600 hover:text-blue-700 text-sm font-medium">View All Earnings →</a>
          </div>
        </div>`;
      return modal;
    }

    async function shareToPlatform(productId, platform, button) {
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (!token) {
        showNotification('Please login to share products', 'error');
        return;
      }
      const original = button.innerHTML;
      button.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      button.disabled = true;
      try {
        const response = await fetch('/api/referrals/share-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ product_id: productId, platform })
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Failed to generate share link');
        const linkContainer = document.getElementById('referral-link-container');
        const linkInput = document.getElementById('referral-link-input');
        if (linkContainer && linkInput) { linkInput.value = data.share_url; linkContainer.style.display = 'block'; }
        if (platform === 'copy_link') { copyToClipboard(data.share_url); showNotification('Link copied to clipboard!', 'success'); }
        else { window.open(data.platform_url, '_blank', 'width=600,height=400'); }
      } catch (e) {
        console.error('[PRODUCT-DETAIL] shareToPlatform error', e);
        showNotification('Failed to generate share link: ' + e.message, 'error');
      } finally {
        button.innerHTML = original;
        button.disabled = false;
      }
    }

    function closeModal(modal) {
      modal.classList.remove('opacity-100');
      modal.classList.add('opacity-0');
      modal.querySelector('.modal-content').classList.remove('scale-100');
      modal.querySelector('.modal-content').classList.add('scale-95');
      setTimeout(() => modal.remove(), 300);
    }

    function copyReferralLink() {
      const input = document.getElementById('referral-link-input');
      if (input && input.value) { copyToClipboard(input.value); showNotification('Referral link copied!', 'success'); }
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) navigator.clipboard.writeText(text);
      else {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
    }

    // Toast helpers to avoid reference errors and keep UX consistent
    window.showToast = window.showToast || function(message, type = 'info') {
      try {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 z-50 px-4 py-2 rounded text-white shadow';
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600', warning: 'bg-yellow-600' };
        toast.className += ' ' + (colors[type] || colors.info);
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
      } catch (e) { console.log(message); }
    };
    window.showNotification = window.showNotification || function(message, type = 'info') { return window.showToast(message, type); };

    function viewProduct(productId) {
      window.location.href = `/buyer/product-detail.html?id=${productId}`;
    }

    async function addToCart(productId) {
      try {
        console.log('[PRODUCT-DETAIL] Adding product to cart:', productId);
        
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          showNotification('Please sign in to add items to cart', 'error');
          setTimeout(() => {
            goToBuyerLoginWithRedirect();
          }, 1500);
          return;
        }
        
        const response = await fetch('/api/cart/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            productId: productId,
            quantity: 1
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('[PRODUCT-DETAIL] Add to cart response:', data);
          showNotification('✅ Product added to cart!', 'success');
          
          // Track referral conversion for add to cart
          await trackReferralConversion('add_to_cart', productId, {
            cart_item_id: data.cartItemId,
            quantity: 1
          });
          
          // Update cart count in header if it exists
          await updateCartCount();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('[PRODUCT-DETAIL] Add to cart failed:', response.status, errorData);
          showNotification(`❌ ${errorData.error || errorData.message || 'Failed to add to cart'}`, 'error');
        }
      } catch (error) {
        console.error('[PRODUCT-DETAIL] Error adding to cart:', error);
        showNotification('❌ Failed to add to cart. Please try again.', 'error');
      }
    }

    async function updateCartCount() {
      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
        if (!token) {
          console.log('[PRODUCT-DETAIL] No token available for cart count update');
          return;
        }

        const response = await fetch('/api/cart/count', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('[PRODUCT-DETAIL] Cart count response:', data);
          
          const totalItems = data.count || data.totalItems || 0;
          
          const badge = document.querySelector('[data-cart-count]');
          if (badge) {
            if (totalItems > 0) {
              badge.textContent = totalItems;
              badge.classList.remove('hidden');
            } else {
              badge.classList.add('hidden');
            }
          }
        } else {
          console.log('[PRODUCT-DETAIL] Cart count API returned:', response.status);
        }
      } catch (error) {
        console.error('[PRODUCT-DETAIL] Error updating cart count:', error);
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // --- REFERRAL TRACKING FUNCTIONS ---
    async function handleReferralClick(referralCode, productId) {
      try {
        console.log('[REFERRAL] Handling referral click:', { referralCode, productId });
        
        // Generate or get existing session ID
        let sessionId = localStorage.getItem('referral_session_id');
        if (!sessionId) {
          sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('referral_session_id', sessionId);
        }

        // Store referral data for later use
        const referralData = {
          referral_code: referralCode,
          product_id: productId,
          session_id: sessionId,
          clicked_at: new Date().toISOString(),
          current_url: window.location.href
        };
        localStorage.setItem('referral_data', JSON.stringify(referralData));

        // Track the click
        const response = await fetch('/api/referrals/track-click', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            referral_code: referralCode,
            product_id: productId,
            session_id: sessionId
          })
        });

        if (response.ok) {
          const data = await response.json();
          console.log('[REFERRAL] Click tracked successfully:', data);
          
          // Store redirect URL for post-auth navigation
          if (data.redirect_url) {
            localStorage.setItem('referral_redirect_url', data.redirect_url);
          }
        } else {
          console.error('[REFERRAL] Failed to track click:', response.status);
        }

      } catch (error) {
        console.error('[REFERRAL] Error handling referral click:', error);
      }
    }

    async function trackReferralConversion(action, productId, additionalData = {}) {
      try {
        const referralData = localStorage.getItem('referral_data');
        if (!referralData) {
          console.log('[REFERRAL] No referral data found for conversion tracking');
          return;
        }

        const parsedData = JSON.parse(referralData);
        console.log('[REFERRAL] Tracking conversion:', { action, productId, referralData: parsedData });

        // Update session status based on action
        let newStatus = 'clicked';
        if (action === 'add_to_cart') {
          newStatus = 'engaged'; // User is engaged with the product
        } else if (action === 'purchase') {
          newStatus = 'completed';
        }

        const response = await fetch('/api/referrals/session/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session_id: parsedData.session_id,
            status: newStatus,
            action: action,
            product_id: productId,
            ...additionalData
          })
        });

        if (response.ok) {
          console.log('[REFERRAL] Conversion tracked successfully');
        } else {
          console.error('[REFERRAL] Failed to track conversion:', response.status);
        }

      } catch (error) {
        console.error('[REFERRAL] Error tracking conversion:', error);
      }
    }
  </script>
</body>
</html> 