<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | ADD Physical Products</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .payment-option {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .payment-option:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .payment-option.selected {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  </style>

    <style>
      /* Enhanced Mobile Responsiveness for Consolidated Checkout */
      @media (max-width: 768px) {
        .mobile-stack { flex-direction: column !important; }
        .mobile-full { width: 100% !important; }
        .mobile-grid-1 { grid-template-columns: 1fr !important; }
        .mobile-text-sm { font-size: 0.875rem !important; }
        .mobile-p-4 { padding: 1rem !important; }
        
        .grid.grid-cols-1.lg\:grid-cols-3,
        .grid.grid-cols-3,
        .lg\:grid-cols-3 {
          grid-template-columns: 1fr !important;
        }
        
        .payment-option {
          margin-bottom: 1rem;
          padding: 1rem;
          font-size: 1rem;
        }
        
        .order-summary {
          position: static !important;
          margin-top: 2rem;
          width: 100% !important;
        }
        
        .checkout-form input,
        .checkout-form select,
        .checkout-form textarea {
          font-size: 16px !important; /* Prevent zoom on iOS */
          padding: 0.75rem !important;
        }
        
        .max-w-6xl {
          max-width: 100% !important;
          padding: 1rem !important;
        }
        
        .container {
          padding: 1rem !important;
        }
        
        /* Success page mobile optimization */
        .success-animation h1 {
          font-size: 1.875rem !important; /* 30px */
        }
        
        .success-animation .bg-white {
          margin: 1rem 0 !important;
          padding: 1.5rem !important;
        }
      }
      
      .success-animation {
        animation: fadeInUp 0.6s ease-out;
      }
      
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">
  
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- Logo -->
        <div class="flex items-center">
          <img src="/uploads/logo.png" alt="ADD Physical Products" class="h-8 w-auto">
          <span class="ml-2 text-xl font-bold text-gray-900">ADD Physical Products</span>
        </div>
        
        <!-- Navigation -->
        <nav class="hidden md:flex space-x-8">
          <a href="/buyer/buyers-home.html" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
          <a href="/buyer/products.html" class="text-gray-700 hover:text-blue-600 font-medium">Products</a>
          <a href="/buyer/orders.html" class="text-gray-700 hover:text-blue-600 font-medium">Orders</a>
          <a href="/buyer/cart.html" class="text-gray-700 hover:text-blue-600 font-medium">Cart</a>
        </nav>
        
        <!-- User Profile -->
        <div class="relative">
          <button id="profile-btn" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors">
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
              <i class="fas fa-user text-white text-sm"></i>
            </div>
            <span id="profile-name" class="font-medium">User</span>
            <i class="fas fa-chevron-down text-sm"></i>
          </button>
          
          <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden z-50">
            <a href="/buyer/buyers-home.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">
              <i class="fas fa-home mr-2"></i>Dashboard
            </a>
            <a href="/buyer/orders.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">
              <i class="fas fa-shopping-bag mr-2"></i>My Orders
            </a>
            <hr class="my-1">
            <button id="signout-btn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50">
              <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Progress Bar -->
  <div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-center space-x-8">
        <div class="flex items-center text-green-600">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
            <i class="fas fa-check"></i>
          </div>
          <span class="ml-2 font-medium">Cart</span>
        </div>
        <div class="w-16 h-1 bg-green-600 rounded"></div>
        <div class="flex items-center text-green-600">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
            <i class="fas fa-check"></i>
          </div>
          <span class="ml-2 font-medium">Delivery</span>
        </div>
        <div class="w-16 h-1 bg-green-600 rounded"></div>
        <div class="flex items-center text-blue-600">
          <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">3</div>
          <span class="ml-2 font-medium">Checkout</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Checkout Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Checkout Form -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Delivery Method Summary -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-truck text-green-600 mr-3"></i>
            FREE Home Delivery
          </h2>
          <div id="delivery-method-display" class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-4 border border-green-200">
            <!-- Delivery method details will be loaded here -->
          </div>
          <!-- Hide change delivery method button since home delivery is the only option -->
          <div class="text-center text-sm text-gray-500">
            <i class="fas fa-gift mr-1 text-green-500"></i>
            FREE home delivery included with all orders - no additional charges
          </div>
        </div>
        
        <!-- Checkout Information -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
            Checkout Information
          </h2>
          
          <div class="space-y-4">
            <p class="text-gray-700">
              Review your order details and delivery method. When you're ready, click "Continue to Payment" to proceed.
            </p>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="font-semibold text-blue-900 mb-2">Next Steps:</h4>
              <ol class="text-sm text-blue-800 space-y-2 ml-5 list-decimal">
                <li>Review your order details</li>
                <li>Click "Continue to Payment" to proceed</li>
                <li>Enter your contact information</li>
                <li>Complete payment</li>
                <li>Receive order confirmation</li>
              </ol>
            </div>
            
            <form id="checkout-form" class="hidden">
              <!-- Hidden form to maintain compatibility with existing code -->
            </form>
          </div>
        </div>
      </div>

      <!-- Right Column - Order Summary -->
      <div class="lg:col-span-1">
        <div class="glass-card rounded-2xl p-6 sticky top-20">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-receipt text-purple-600 mr-3"></i>
            Order Summary
          </h2>
          
          <div id="order-items" class="space-y-3 mb-6">
            <!-- Order items will be loaded here -->
          </div>
          
          <div class="border-t pt-4 space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Subtotal:</span>
              <span id="subtotal" class="font-medium">FRw 0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Delivery Fee:</span>
              <span id="shipping" class="font-medium">FRw 0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Tax:</span>
              <span id="tax" class="font-medium">FRw 0</span>
            </div>
            <div id="free-shipping-notice" class="text-sm text-green-600 font-medium hidden">
              üéâ Free delivery applied!
            </div>
            <hr class="my-3">
            <div class="flex justify-between text-lg font-bold">
              <span>Total:</span>
              <span id="total" class="text-green-600">FRw 0</span>
            </div>
          </div>
          
          <button id="place-order-btn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white py-3 rounded-lg font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
            <i class="fas fa-credit-card mr-2"></i>
            Continue to Payment
          </button>
          
          <div class="mt-4 flex justify-between text-center">
            <a href="/buyer/cart.html" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
              <i class="fas fa-arrow-left mr-1"></i>Back to Cart
            </a>
            <a href="/buyer/delivery-method-selection.html" class="text-blue-600 hover:text-blue-700 text-sm font-medium transition-colors">
              <i class="fas fa-truck mr-1"></i>Change Delivery
            </a>
          </div>
          
          <!-- Security Notice -->
          <div class="mt-6 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center text-green-700 text-sm">
              <i class="fas fa-shield-alt mr-2"></i>
              <span>Your payment is secured with 256-bit SSL encryption</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
      </div>
    </div>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">Processing your order...</p>
      <p class="text-gray-500 text-sm mt-2">Please don't close this window</p>
    </div>
  </div>

  <script>
    class CheckoutManager {
      constructor() {
        this.deliveryData = null;
        this.cartItems = [];
        this.userInfo = {};
        this.selectedPaymentMethod = null;
        this.subtotal = 0;
        this.deliveryFee = 0;
        this.tax = 0;
        this.total = 0;
        this.init();
      }

      async init() {
        try {
          console.log('üöÄ Initializing checkout...');
          
          // Check authentication
          this.checkAuthentication();
          
          // Load delivery method data from delivery selection
          this.loadDeliveryData();
          
          // Load real cart data from backend
          await this.loadCartData();
          
          // Load user information
          await this.loadUserInfo();
          
          // Calculate order totals
          this.calculateOrderTotals();
          
          // Setup event listeners
          this.setupEventListeners();
          
          // Setup profile dropdown
          this.setupProfileDropdown();
          
          // Render order summary
          this.renderOrderSummary();
          
          // Display delivery method
          this.displayDeliveryMethod();
          
          // Initialize payment fields
          this.initializePaymentFields();
          
          console.log('‚úÖ Checkout initialized successfully');
        } catch (error) {
          console.error('‚ùå Error initializing checkout:', error);
          this.showNotification('Failed to load checkout data', 'error');
        }
      }
      
      async initializePaymentFields() {
        // Set mobile money as default payment method
        this.selectedPaymentMethod = 'mobile_money';
        
        // Initialize mobile money fields
        this.updateMobileMoneyDetails();
        
        // Initialize bank transfer fields
        this.updateBankTransferDetails();
        
        // Set mobile money radio button as checked
        document.getElementById('mobileMoney').checked = true;
        
        // Add selected class to mobile money option
        document.querySelector('[data-payment="mobile_money"]').classList.add('selected');
      }

      checkAuthentication() {
        const token = localStorage.getItem('authToken');
        const userData = localStorage.getItem('userData');
        
        if (!token || !userData) {
          window.location.href = '/auth/auth-buyer.html';
          return;
        }
        
        try {
          const user = JSON.parse(userData);
          const profileName = document.getElementById('profile-name');
          if (profileName) {
            profileName.textContent = user.username || 'User';
          }
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      }

      loadDeliveryData() {
        const checkoutData = localStorage.getItem('checkoutData');
        if (!checkoutData) {
          alert('Please select a delivery method first.');
          window.location.href = '/buyer/delivery-method-selection.html';
          return;
        }

        try {
          this.checkoutData = JSON.parse(checkoutData);
          console.log('üì¶ Checkout data loaded:', this.checkoutData);
          
          // Extract delivery information
          this.deliveryData = {
            method: this.checkoutData.deliveryType,
            calculation: this.checkoutData.calculation,
            pickupSiteId: this.checkoutData.pickupSiteId,
            deliveryAddress: this.checkoutData.deliveryAddress
          };
          
          console.log('üöö Delivery data extracted:', this.deliveryData);
        } catch (error) {
          console.error('Error loading checkout data:', error);
          window.location.href = '/buyer/delivery-method-selection.html';
        }
      }

      async loadCartData() {
        try {
          // Use cart data from checkout data (already loaded from delivery selection)
          if (this.checkoutData && this.checkoutData.items) {
            this.cartItems = this.checkoutData.items;
            console.log('üõí Cart data loaded from checkout data:', this.cartItems);
            
            if (this.cartItems.length === 0) {
              alert('Your cart is empty. Please add items to your cart first.');
              window.location.href = '/buyer/products.html';
              return;
            }
            return;
          }

          // Fallback: Load from backend if not available in checkout data
          const token = localStorage.getItem('authToken');
          const response = await fetch('/api/cart', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            this.cartItems = data.items || [];
            console.log('üõí Cart data loaded from backend:', this.cartItems);
            
            if (this.cartItems.length === 0) {
              alert('Your cart is empty. Please add items to your cart first.');
              window.location.href = '/buyer/products.html';
              return;
            }
          } else {
            throw new Error('Failed to load cart data');
          }
        } catch (error) {
          console.error('Error loading cart data:', error);
          alert('Failed to load cart data. Please try again.');
          window.location.href = '/buyer/cart.html';
        }
      }

      calculateOrderTotals() {
        if (!this.cartItems || this.cartItems.length === 0) {
          return;
        }

        // Use subtotal from checkout data if available, otherwise calculate
        if (this.checkoutData && this.checkoutData.subtotal) {
          this.subtotal = this.checkoutData.subtotal;
        } else {
          this.subtotal = this.cartItems.reduce((total, item) => {
            return total + (parseFloat(item.price) * parseInt(item.quantity));
          }, 0);
        }

        // Get delivery fee and tax from delivery calculation
        if (this.checkoutData && this.checkoutData.calculation) {
          this.deliveryFee = this.checkoutData.calculation.deliveryFee || 0;
          this.tax = this.checkoutData.calculation.taxAmount || 0;
          this.total = this.checkoutData.calculation.total || (this.subtotal + this.deliveryFee + this.tax);
        } else {
          // Fallback calculation
          this.deliveryFee = this.deliveryData?.deliveryFee || 0;
          this.tax = 0;
          this.total = this.subtotal + this.deliveryFee + this.tax;
        }

        console.log('üí∞ Order totals calculated:', {
          subtotal: this.subtotal,
          deliveryFee: this.deliveryFee,
          tax: this.tax,
          total: this.total
        });
      }

      async loadUserInfo() {
        try {
          const token = localStorage.getItem('authToken');
          const response = await fetch('/api/auth/profile', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            this.userInfo = data.user || {};
            this.populateUserInfo();
          }
        } catch (error) {
          console.error('Error loading user info:', error);
        }
      }

      populateUserInfo() {
        if (this.userInfo.name) {
          const nameParts = this.userInfo.name.split(' ');
          document.getElementById('firstName').value = nameParts[0] || '';
          document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
        }
        if (this.userInfo.email) {
          document.getElementById('email').value = this.userInfo.email;
        }
        if (this.userInfo.phone) {
          document.getElementById('phone').value = this.userInfo.phone;
        }
      }

      displayDeliveryMethod() {
        const displayElement = document.getElementById('delivery-method-display');
        
        if (this.deliveryData.method === 'pickup') {
          displayElement.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-store text-green-600"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">Pickup Delivery</h3>
                <p class="text-sm text-gray-600 mt-1">Your order will be collected from a pickup location</p>
                <div class="mt-2 p-2 bg-blue-50 rounded-lg">
                  <p class="text-sm font-medium text-blue-900">Pickup Site:</p>
                  <p class="text-sm text-blue-700">${this.deliveryData.pickupSite?.name || 'Default Location'}</p>
                  <p class="text-sm text-blue-600">${this.deliveryData.pickupSite?.address_line1 || ''}</p>
                </div>
                <div class="mt-2 flex items-center space-x-4 text-sm">
                  <span class="text-green-600 font-semibold">
                    <i class="fas fa-check mr-1"></i>
                    FREE Delivery
                  </span>
                </div>
              </div>
            </div>
          `;
        } else if (this.deliveryData.method === 'home') {
          const address = this.deliveryData.deliveryAddress;
          displayElement.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-home text-blue-600"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">Home Delivery</h3>
                <p class="text-sm text-gray-600 mt-1">Your order will be delivered to your home</p>
                <div class="mt-2 p-2 bg-blue-50 rounded-lg">
                  <p class="text-sm font-medium text-blue-900">Delivery Address:</p>
                  <p class="text-sm text-blue-700">
                    ${address.street || address.display_name}<br>
                    ${address.city || ''}, ${address.state || ''}
                  </p>
                </div>
                <div class="mt-2 flex items-center space-x-4 text-sm">
                  <span class="text-green-600 font-semibold">
                    <i class="fas fa-gift mr-1"></i>
                    FREE Delivery Included!
                  </span>
                </div>
              </div>
            </div>
          `;
        }
      }

      renderOrderSummary() {
        const container = document.getElementById('order-items');
        
        if (!this.cartItems || this.cartItems.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">No items in cart</p>';
          return;
        }
        
        container.innerHTML = this.cartItems.map(item => `
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
            <img src="${item.main_image ? `/uploads/${item.main_image}` : '/uploads/logo.png'}" 
                 alt="${item.name}" 
                 class="w-12 h-12 object-cover rounded-lg"
                 onerror="this.src='/uploads/logo.png'">
            <div class="flex-1">
              <h4 class="font-medium text-gray-900 text-sm">${item.name}</h4>
              <p class="text-gray-600 text-xs">Qty: ${item.quantity}</p>
              <p class="text-gray-500 text-xs">FRw ${parseFloat(item.price).toLocaleString()} each</p>
            </div>
            <div class="text-right">
              <p class="font-semibold text-gray-900 text-sm">FRw ${(parseFloat(item.price) * parseInt(item.quantity)).toLocaleString()}</p>
            </div>
          </div>
        `).join('');
        
        this.updateOrderSummary();
      }

      updateOrderSummary() {
        document.getElementById('subtotal').textContent = `FRw ${this.subtotal.toLocaleString()}`;
        document.getElementById('shipping').textContent = this.deliveryFee === 0 ? 'FREE' : `FRw ${this.deliveryFee.toLocaleString()}`;
        document.getElementById('tax').textContent = `FRw ${this.tax.toLocaleString()}`;
        document.getElementById('total').textContent = `FRw ${this.total.toLocaleString()}`;
        
        // Show free shipping notice if applicable
        const freeShippingNotice = document.getElementById('free-shipping-notice');
        if (this.deliveryFee === 0) {
          freeShippingNotice.classList.remove('hidden');
        } else {
          freeShippingNotice.classList.add('hidden');
        }
        
        // Update escrow amount if visible
        const escrowAmount = document.getElementById('escrow-amount');
        if (escrowAmount) {
          escrowAmount.textContent = `FRw ${this.total.toLocaleString()}`;
        }
      }

      setupEventListeners() {
        // Change delivery method (only if the button exists)
        const changeDeliveryBtn = document.getElementById('change-delivery-method');
        if (changeDeliveryBtn) {
          changeDeliveryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to change your delivery method? This will take you back to the delivery selection page.')) {
              window.location.href = '/buyer/delivery-method-selection.html';
            }
          });
        }

        // Payment method selection
        const paymentOptions = document.querySelectorAll('.payment-option');
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
        
        if (paymentOptions && paymentOptions.length) {
          paymentOptions.forEach(option => {
            option.addEventListener('click', () => {
              const radio = option.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                this.handlePaymentMethodChange(radio.value);
                this.updatePaymentOptionStyles();
              }
            });
          });
        }

        if (paymentRadios && paymentRadios.length) {
          paymentRadios.forEach(radio => {
            radio.addEventListener('change', () => {
              this.handlePaymentMethodChange(radio.value);
              this.updatePaymentOptionStyles();
            });
          });
        }

        // Place order button (guard if missing)
        const placeOrderBtn = document.getElementById('place-order-btn');
        if (placeOrderBtn) {
          placeOrderBtn.addEventListener('click', () => {
            this.placeOrder();
          });
        }
      }

      updatePaymentOptionStyles() {
        const paymentOptions = document.querySelectorAll('.payment-option');
        paymentOptions.forEach(option => {
          const radio = option.querySelector('input[type="radio"]');
          if (radio.checked) {
            option.classList.add('selected');
          } else {
            option.classList.remove('selected');
          }
        });
      }

      async handlePaymentMethodChange(method) {
        console.log('üí≥ Payment method changed to:', method);
        this.selectedPaymentMethod = method;
        
        // Hide all payment fields
        document.getElementById('mobileMoneyFields').classList.add('hidden');
        document.getElementById('bankTransferFields').classList.add('hidden');
        
        // Show relevant fields
        switch (method) {
          case 'mobile_money':
            document.getElementById('mobileMoneyFields').classList.remove('hidden');
            // Update payment details
            this.updateMobileMoneyDetails();
            break;
            
          case 'bank_transfer':
            document.getElementById('bankTransferFields').classList.remove('hidden');
            // Update bank transfer details
            this.updateBankTransferDetails();
            break;
        }
      }
      
      updateMobileMoneyDetails() {
        // Update mobile money payment details
        document.getElementById('mobile-number').textContent = '+250 788 123 456';
        document.getElementById('momo-code').textContent = 'ADD2024';
        document.getElementById('payment-amount').textContent = `FRw ${this.total.toLocaleString()}`;
      }
      
      updateBankTransferDetails() {
        // Update bank transfer payment details
        document.getElementById('bank-amount').textContent = `FRw ${this.total.toLocaleString()}`;
        // Generate a unique reference code based on timestamp
        const referenceCode = `${Date.now().toString().slice(-6)}`;
        document.getElementById('reference-code').textContent = referenceCode;
      }

      async loadPaymentConfiguration() {
        try {
          console.log('üí≥ Loading payment configuration...');
          const token = localStorage.getItem('authToken');
          const response = await fetch('/api/payment-settings/public', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            console.log('üí≥ Payment configuration loaded:', data);
            return data.settings || this.getDefaultPaymentConfig();
          } else {
            console.log('üí≥ Failed to load payment configuration, using defaults');
            return this.getDefaultPaymentConfig();
          }
        } catch (error) {
          console.error('Error loading payment configuration:', error);
          return this.getDefaultPaymentConfig();
        }
      }
      
      getDefaultPaymentConfig() {
        // Default payment configuration
        return {
          mobile_money_enabled: true,
          bank_transfer_enabled: true,
          mobile_number: '+250 788 910639',
          momo_code: 'comminng soon',
          bank_details: {
            bank_name: 'Umwalimu SACCO',
            account_name: 'NSHIMIYIMANA Dieudonne',
            account_number: '178299',
            swift_code: 'BKGLRWRW'
          }
        };
      }

      setupProfileDropdown() {
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const signoutBtn = document.getElementById('signout-btn');

        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', () => {
          profileDropdown.classList.add('hidden');
        });

        signoutBtn.addEventListener('click', () => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userData');
          localStorage.removeItem('checkoutData');
          window.location.href = '/auth/auth-buyer.html';
        });
      }

      async placeOrder() {
        // This method now redirects to payment-mobile.html instead of placing an order
        
        try {
          // Validate cart items
          if (!this.cartItems || this.cartItems.length === 0) {
            this.showNotification('No items in cart to order', 'error');
            return;
          }
          
          // Validate delivery data
          if (!this.deliveryData || !this.deliveryData.method) {
            this.showNotification('Please select a delivery method first', 'error');
            return;
          }
          
          console.log('üöÄ Proceeding to payment page...');
          
          // Store checkout data in localStorage for payment-mobile.html to use
          const checkoutData = {
            items: this.cartItems,
            subtotal: this.subtotal,
            deliveryFee: this.deliveryFee,
            tax: this.tax,
            total: this.total,
            deliveryType: this.deliveryData.method,
            pickupSiteId: this.deliveryData.pickupSiteId,
            pickupSite: this.deliveryData.pickupSite,
            deliveryAddress: this.deliveryData.deliveryAddress,
            timestamp: new Date().toISOString()
          };
          
          console.log('üíæ Storing checkout data for payment page:', checkoutData);
          localStorage.setItem('checkoutData', JSON.stringify(checkoutData));
          
          // Show loading overlay
          const loadingOverlay = document.getElementById('loading-overlay');
          loadingOverlay.classList.remove('hidden');
          
          // Redirect to payment-mobile.html after a short delay
          setTimeout(() => {
            window.location.href = '/buyer/payment-mobile.html';
          }, 1000);
        } catch (error) {
          console.error('‚ùå Error proceeding to payment:', error);
          this.showNotification('Failed to proceed to payment. Please try again.', 'error');
        }
      }

      validateForm() {
        // Simplified validation since we're just redirecting to payment-mobile.html
        
        // Validate delivery data
        if (!this.deliveryData || !this.deliveryData.method) {
          this.showNotification('Please select a delivery method first', 'error');
          return false;
        }
        
        // Validate cart items
        if (!this.cartItems || this.cartItems.length === 0) {
          this.showNotification('No items in cart to order', 'error');
          return false;
        }
        
        return true;
      }

      async clearCart() {
        try {
          const token = localStorage.getItem('authToken');
          await fetch('/api/cart/clear', {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          console.log('‚úÖ Cart cleared successfully');
        } catch (error) {
          console.error('Error clearing cart:', error);
          // Don't block the flow if cart clearing fails
        }
      }

      showOrderSuccess(order) {
        // Hide loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) loadingOverlay.classList.add('hidden');
        
        // Replace the entire checkout content with success message
        const mainContent = document.querySelector('.max-w-6xl.mx-auto');
        if (mainContent) {
          mainContent.innerHTML = `
            <div class="text-center py-12">
              <div class="success-animation">
                <div class="text-6xl mb-6">üéâ</div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Order Placed Successfully!</h1>
                <p class="text-xl text-gray-600 mb-8">Thank you for your purchase</p>
                
                <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 max-w-2xl mx-auto">
                  <h2 class="text-xl font-semibold text-gray-900 mb-6">Order Details</h2>
                  <div class="space-y-3 text-left">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Order Number:</span>
                      <span class="font-semibold">#${order.order_number}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Total Amount:</span>
                      <span class="font-semibold text-green-600">${this.formatCurrency(order.total_amount)}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Status:</span>
                      <span class="font-semibold text-blue-600">${order.status}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Payment Status:</span>
                      <span class="font-semibold text-orange-600">${order.payment_status || 'Processing'}</span>
                    </div>
                  </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 max-w-2xl mx-auto">
                  <h3 class="font-semibold text-blue-900 mb-3">üìß What's Next?</h3>
                  <div class="text-blue-800 text-sm space-y-2 text-left">
                    <p>‚Ä¢ You'll receive an order confirmation email shortly</p>
                    <p>‚Ä¢ Track your order status in your orders page</p>
                    <p>‚Ä¢ Our team will process your payment and notify you</p>
                    <p>‚Ä¢ Delivery will begin once payment is confirmed</p>
                  </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                  <a href="/buyer/orders.html" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                    Track Order
                  </a>
                  <a href="/buyer/buyers-home.html" class="bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-300 px-8 py-3 rounded-xl font-semibold transition-all duration-300">
                    Continue Shopping
                  </a>
                </div>
              </div>
            </div>
            
            <style>
              .success-animation {
                animation: slideInUp 0.8s ease-out;
              }
              
              @keyframes slideInUp {
                from {
                  transform: translateY(30px);
                  opacity: 0;
                }
                to {
                  transform: translateY(0);
                  opacity: 1;
                }
              }
            </style>
          `;
        }
      }

      formatCurrency(amount) {
        const currency = localStorage.getItem('selectedCurrency') || 'RWF';
        const currencySymbol = {
          'USD': '$',
          'RWF': 'FRw',
          'EUR': '‚Ç¨',
          'CNY': '¬•',
          'KES': 'Ksh',
          'NGN': '‚Ç¶'
        }[currency] || 'FRw';
        
        return `${currencySymbol} ${parseFloat(amount || 0).toLocaleString()}`;
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium shadow-lg transform transition-all duration-300 ${
          type === 'success' ? 'bg-green-500' : 
          type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 100);

        // Remove after 5 seconds
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 5000);
      }
    }

    // Initialize the checkout manager when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new CheckoutManager();
    });
  </script>
</body>
</html>
     