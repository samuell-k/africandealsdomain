<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order | ADD Physical Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/public/images/logo.png">
    <style>
        /* Custom Styles */
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .tracking-timeline {
            position: relative;
        }
        
        .tracking-timeline::before {
            content: '';
            position: absolute;
            left: 2rem;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #10b981, #3b82f6, #8b5cf6, #f59e0b);
            border-radius: 2px;
        }
        
        .tracking-step {
            position: relative;
            padding-left: 5rem;
            margin-bottom: 3rem;
        }
        
        .tracking-step:last-child {
            margin-bottom: 0;
        }
        
        .tracking-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid;
            transition: all 0.3s ease;
        }
        
        .tracking-icon.completed {
            background: #10b981;
            border-color: #059669;
            color: white;
            animation: completedPulse 2s ease-in-out;
        }
        
        .tracking-icon.current {
            background: #f59e0b;
            border-color: #d97706;
            color: white;
            animation: currentPulse 2s infinite;
        }
        
        .tracking-icon.pending {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #9ca3af;
        }
        
        @keyframes completedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes currentPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.8s ease-out;
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-badge {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .status-badge:hover::before {
            left: 100%;
        }
        
        .map-container {
            background: #f9fafb;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
            min-height: 300px;
        }
        
        .map-placeholder {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .delivery-info-card {
            transition: all 0.3s ease;
        }
        
        .delivery-info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        
        .eta-countdown {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            color: white;
        }
        
        .countdown-item {
            display: inline-block;
            margin: 0 0.5rem;
            text-align: center;
        }
        
        .countdown-number {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            line-height: 1;
        }
        
        .countdown-label {
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
    <script src="/shared/auth-utils.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Navigation Header -->
    <nav class="card border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-4">
                    <a href="/public/index.html" class="flex items-center space-x-3 group">
                        <img src="/public/images/logo.png" alt="ADD" class="h-10 w-10 rounded-xl shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">ADD Physical Products</h1>
                            <p class="text-xs text-gray-600">Order Tracking</p>
                        </div>
                    </a>
                </div>
                
                <!-- Breadcrumb -->
                <div class="hidden md:flex items-center space-x-2 text-gray-600">
                    <a href="/buyer/dashboard.html" class="hover:text-gray-800 transition-colors">Dashboard</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <a href="/buyer/orders.html" class="hover:text-gray-800 transition-colors">Orders</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-gray-800">Track Order</span>
                </div>
                
                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 transition-colors">
                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-sm"></i>
                            </div>
                            <span id="user-name" class="hidden md:block">Loading...</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-48 card rounded-lg shadow-lg hidden">
                            <div class="py-2">
                                <a href="/buyer/profile.html" class="block px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-user-circle mr-2"></i>Profile
                                </a>
                                <a href="/buyer/settings.html" class="block px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-cog mr-2"></i>Settings
                                </a>
                                <hr class="my-2 border-gray-200">
                                <button onclick="logout()" class="w-full text-left px-4 py-2 text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-6">
        <div class="max-w-6xl mx-auto">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Loading tracking information...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center py-12 hidden">
                <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Tracking Information Not Available</h3>
                <p class="text-gray-600 mb-6">We couldn't find tracking information for this order.</p>
                <div class="flex justify-center space-x-4">
                    <a href="/buyer/orders.html" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Orders
                    </a>
                    <button onclick="loadTrackingInfo()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>Retry
                    </button>
                </div>
            </div>

            <!-- Tracking Content -->
            <div id="tracking-content" class="hidden">
                <!-- Order Header -->
                <div class="card rounded-xl p-6 mb-8 fade-in">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-4">
                                <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    <i class="fas fa-arrow-left text-xl"></i>
                                </button>
                                <div>
                                    <h1 id="order-title" class="text-2xl font-bold text-gray-900">Tracking Order #</h1>
                                    <p id="order-date" class="text-gray-600">Placed on</p>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap items-center gap-3">
                                <span id="order-status-badge" class="status-badge px-4 py-2 rounded-full text-sm font-medium">
                                    <!-- Status will be inserted here -->
                                </span>
                                <span id="tracking-number" class="bg-gray-100 px-4 py-2 rounded-full text-sm font-mono text-gray-800">
                                    <!-- Tracking number will be inserted here -->
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-3 mt-6 lg:mt-0">
                            <button onclick="refreshTracking()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                            <button onclick="shareTracking()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-colors">
                                <i class="fas fa-share mr-2"></i>Share
                            </button>
                            <button onclick="viewOrderDetails()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                                <i class="fas fa-eye mr-2"></i>Order Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delivery Progress Overview -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Progress Circle -->
                    <div class="card rounded-xl p-6 text-center fade-in">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Delivery Progress</h3>
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            <svg class="progress-ring w-32 h-32" viewBox="0 0 120 120">
                                <circle class="progress-ring-circle" stroke="#e5e7eb" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                                <circle id="progress-circle" class="progress-ring-circle" stroke="#10b981" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" 
                                        stroke-dasharray="326.73" stroke-dashoffset="326.73"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center">
                                    <div id="progress-percentage" class="text-2xl font-bold text-gray-900">0%</div>
                                    <div class="text-gray-600 text-xs">Complete</div>
                                </div>
                            </div>
                        </div>
                        <p id="progress-status" class="text-gray-600 text-sm">Preparing your order</p>
                    </div>

                    <!-- ETA Countdown -->
                    <div class="card rounded-xl p-6 fade-in">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Estimated Delivery</h3>
                        <div id="eta-info" class="text-center">
                            <div id="eta-date" class="text-xl font-bold text-gray-900 mb-2">--</div>
                            <div id="eta-countdown" class="eta-countdown">
                                <div class="countdown-item">
                                    <span id="days" class="countdown-number">0</span>
                                    <span class="countdown-label">Days</span>
                                </div>
                                <div class="countdown-item">
                                    <span id="hours" class="countdown-number">0</span>
                                    <span class="countdown-label">Hours</span>
                                </div>
                                <div class="countdown-item">
                                    <span id="minutes" class="countdown-number">0</span>
                                    <span class="countdown-label">Minutes</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Location -->
                    <div class="card rounded-xl p-6 fade-in">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Location</h3>
                        <div id="current-location" class="text-center">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-map-marker-alt text-blue-500 text-2xl"></i>
                            </div>
                            <div id="location-name" class="text-gray-900 font-semibold mb-1">--</div>
                            <div id="location-time" class="text-gray-600 text-sm">--</div>
                        </div>
                    </div>
                </div>

                <!-- Main Tracking Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Tracking Timeline -->
                    <div class="card rounded-xl p-6 slide-in-left">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Tracking Timeline</h2>
                        <div id="tracking-timeline" class="tracking-timeline">
                            <!-- Timeline steps will be loaded here -->
                        </div>
                    </div>

                    <!-- Delivery Map & Info -->
                    <div class="space-y-6">
                        <!-- Map -->
                        <div class="card rounded-xl p-6 fade-in">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Delivery Route</h2>
                            <div id="delivery-map" class="map-container">
                                <div class="map-placeholder h-64">
                                    <div class="text-center">
                                        <i class="fas fa-map text-4xl mb-2"></i>
                                        <p>Interactive map coming soon</p>
                                        <p class="text-sm opacity-75">Track your package in real-time</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Information -->
                        <div class="card rounded-xl p-6 fade-in">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Delivery Information</h2>
                            <div id="delivery-info" class="space-y-4">
                                <!-- Delivery info will be loaded here -->
                            </div>
                        </div>

                        <!-- Contact Delivery Agent -->
                        <div class="card rounded-xl p-6 fade-in">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Need Help?</h2>
                            <div class="space-y-3">
                                <button onclick="contactDeliveryAgent()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg transition-colors">
                                    <i class="fas fa-phone mr-2"></i>Contact Delivery Agent
                                </button>
                                <button onclick="reportDeliveryIssue()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg transition-colors">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Report Issue
                                </button>
                                <button onclick="rescheduleDelivery()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg transition-colors">
                                    <i class="fas fa-calendar-alt mr-2"></i>Reschedule Delivery
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items Summary -->
                <div class="card rounded-xl p-6 mt-8 fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">Items in this Order</h2>
                    <div id="order-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Order items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toast notifications will appear here -->
    </div>

    <script>
        // Global variables
        let currentOrder = null;
        let orderId = null;
        let trackingInterval = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            loadTrackingInfo();
        });

        function initializePage() {
            // Check authentication
            if (!isAuthenticated()) {
                window.location.href = '/public/login.html';
                return;
            }

            // Get order ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            orderId = urlParams.get('order') || urlParams.get('id');
            
            if (!orderId) {
                showError();
                return;
            }

            // Load user info
            loadUserInfo();
            
            // Start auto-refresh for active orders
            startAutoRefresh();
        }

        function setupEventListeners() {
            // User menu toggle
            document.getElementById('user-menu-button').addEventListener('click', function() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.toggle('hidden');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                const userMenu = document.getElementById('user-menu-button');
                const dropdown = document.getElementById('user-dropdown');
                
                if (!userMenu.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Handle page visibility change for auto-refresh
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopAutoRefresh();
                } else {
                    startAutoRefresh();
                }
            });
        }

        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('user-name').textContent = userData.user.first_name || 'User';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        async function loadTrackingInfo() {
            try {
                console.log('Loading tracking info for order ID:', orderId);
                showLoading();
                
                const token = localStorage.getItem('authToken');
                console.log('Using token:', token ? 'Token present' : 'No token');
                
                const response = await fetch(`/api/orders/${orderId}/tracking`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Tracking response status:', response.status);

                if (!response.ok) {
                    console.log('Tracking endpoint failed, trying regular order details...');
                    // Fallback to regular order details if tracking endpoint doesn't exist
                    const orderResponse = await fetch(`/api/orders/${orderId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Order response status:', orderResponse.status);
                    
                    if (!orderResponse.ok) {
                        const errorData = await orderResponse.json().catch(() => ({ error: 'Unknown error' }));
                        console.error('Order API Error:', errorData);
                        throw new Error(errorData.error || 'Order not found');
                    }
                    
                    const orderData = await orderResponse.json();
                    console.log('Order data received:', orderData);
                    
                    if (!orderData.success || !orderData.order) {
                        throw new Error('Invalid response format');
                    }
                    
                    currentOrder = orderData.order;
                    renderTrackingInfo();
                    return;
                }

                const trackingData = await response.json();
                console.log('Tracking data received:', trackingData);
                currentOrder = trackingData.order;
                renderTrackingInfo(trackingData.tracking);
                
            } catch (error) {
                console.error('Error loading tracking info:', error);
                showError();
            } finally {
                hideLoading();
            }
        }

        function renderTrackingInfo(trackingData = null) {
            if (!currentOrder) return;

            // Update header
            document.getElementById('order-title').textContent = `Tracking Order #${currentOrder.order_number}`;
            document.getElementById('order-date').textContent = `Placed on ${formatDate(currentOrder.created_at)}`;
            
            // Update status badge
            const statusBadge = document.getElementById('order-status-badge');
            statusBadge.textContent = formatStatus(currentOrder.status);
            statusBadge.className = `status-badge px-4 py-2 rounded-full text-sm font-medium ${getStatusBadgeClass(currentOrder.status)}`;
            
            // Update tracking number
            const trackingNumber = document.getElementById('tracking-number');
            if (currentOrder.tracking_number) {
                trackingNumber.textContent = `Tracking: ${currentOrder.tracking_number}`;
                trackingNumber.classList.remove('hidden');
            } else {
                trackingNumber.classList.add('hidden');
            }

            // Render sections
            renderProgressOverview();
            renderTrackingTimeline(trackingData);
            renderDeliveryInfo();
            renderOrderItems();
            
            // Show content
            document.getElementById('tracking-content').classList.remove('hidden');
        }

        function renderProgressOverview() {
            const status = currentOrder.status.toLowerCase();
            const steps = ['pending', 'confirmed', 'shipped', 'delivered'];
            const currentStepIndex = steps.indexOf(status);
            const progressPercentage = currentStepIndex >= 0 ? ((currentStepIndex + 1) / steps.length) * 100 : 0;
            
            // Update progress circle
            const progressCircle = document.getElementById('progress-circle');
            const circumference = 2 * Math.PI * 52; // radius = 52
            const offset = circumference - (progressPercentage / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            
            document.getElementById('progress-percentage').textContent = `${Math.round(progressPercentage)}%`;
            
            // Update progress status
            const statusMessages = {
                'pending': 'Preparing your order',
                'confirmed': 'Order confirmed and processing',
                'shipped': 'Package is on the way',
                'delivered': 'Order delivered successfully'
            };
            document.getElementById('progress-status').textContent = statusMessages[status] || 'Processing order';
            
            // Update ETA
            renderETA();
            
            // Update current location
            renderCurrentLocation();
        }

        function renderETA() {
            const etaDate = currentOrder.estimated_delivery || calculateETA();
            const etaDateElement = document.getElementById('eta-date');
            
            if (etaDate) {
                const eta = new Date(etaDate);
                etaDateElement.textContent = eta.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Start countdown
                startCountdown(eta);
            } else {
                etaDateElement.textContent = 'Calculating...';
                document.getElementById('eta-countdown').style.display = 'none';
            }
        }

        function calculateETA() {
            // Simple ETA calculation based on order status
            const now = new Date();
            const status = currentOrder.status.toLowerCase();
            
            switch (status) {
                case 'pending':
                    return new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000); // 5 days
                case 'confirmed':
                    return new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000); // 3 days
                case 'shipped':
                    return new Date(now.getTime() + 1 * 24 * 60 * 60 * 1000); // 1 day
                default:
                    return null;
            }
        }

        function startCountdown(targetDate) {
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = targetDate.getTime() - now;
                
                if (distance < 0) {
                    document.getElementById('eta-countdown').innerHTML = '<div class="text-green-500">Delivered!</div>';
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('days').textContent = days;
                document.getElementById('hours').textContent = hours;
                document.getElementById('minutes').textContent = minutes;
            }
            
            updateCountdown();
            setInterval(updateCountdown, 60000); // Update every minute
        }

        function renderCurrentLocation() {
            const status = currentOrder.status.toLowerCase();
            const locationName = document.getElementById('location-name');
            const locationTime = document.getElementById('location-time');
            
            // Mock location data based on status
            const locations = {
                'pending': { name: 'Warehouse', time: 'Order being prepared' },
                'confirmed': { name: 'Processing Center', time: 'Ready for shipment' },
                'shipped': { name: 'In Transit', time: 'On delivery route' },
                'delivered': { name: 'Delivered', time: 'Package delivered' }
            };
            
            const location = locations[status] || { name: 'Unknown', time: 'Location updating...' };
            locationName.textContent = location.name;
            locationTime.textContent = location.time;
        }

        function renderTrackingTimeline(trackingData) {
            const container = document.getElementById('tracking-timeline');
            
            // Use actual tracking history if available
            if (currentOrder.tracking_history && currentOrder.tracking_history.length > 0) {
                // Sort tracking history by date (oldest first for timeline)
                const sortedHistory = [...currentOrder.tracking_history].sort((a, b) => 
                    new Date(a.created_at) - new Date(b.created_at)
                );
                
                container.innerHTML = sortedHistory.map((event, index) => {
                    const isLatest = index === sortedHistory.length - 1;
                    return `
                        <div class="tracking-step">
                            <div class="tracking-icon ${isLatest ? 'current' : 'completed'}">
                                <i class="${getTrackingIcon(event.status)} text-xl"></i>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-gray-900 font-semibold">${formatTrackingStatus(event.status)}</h4>
                                    <span class="text-gray-500 text-sm">${formatDate(event.created_at)}</span>
                                </div>
                                <p class="text-gray-600 text-sm">${event.notes || 'Status updated'}</p>
                                ${event.location ? `<p class="text-gray-500 text-xs mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                return;
            }
            
            // Default timeline based on order status
            const defaultTimeline = [
                {
                    title: 'Order Placed',
                    description: 'Your order has been successfully placed and is being processed',
                    timestamp: currentOrder.created_at,
                    status: 'completed',
                    icon: 'fas fa-shopping-cart'
                },
                {
                    title: 'Order Confirmed',
                    description: 'Order confirmed and payment verified',
                    timestamp: currentOrder.confirmed_at,
                    status: ['confirmed', 'shipped', 'delivered'].includes(currentOrder.status.toLowerCase()) ? 'completed' : 'pending',
                    icon: 'fas fa-check-circle'
                },
                {
                    title: 'Package Shipped',
                    description: 'Your package has been shipped and is on its way',
                    timestamp: currentOrder.shipped_at,
                    status: ['shipped', 'delivered'].includes(currentOrder.status.toLowerCase()) ? 'completed' : 
                            currentOrder.status.toLowerCase() === 'confirmed' ? 'current' : 'pending',
                    icon: 'fas fa-shipping-fast'
                },
                {
                    title: 'Out for Delivery',
                    description: 'Package is out for delivery and will arrive soon',
                    timestamp: null,
                    status: currentOrder.status.toLowerCase() === 'delivered' ? 'completed' : 
                            currentOrder.status.toLowerCase() === 'shipped' ? 'current' : 'pending',
                    icon: 'fas fa-truck'
                },
                {
                    title: 'Delivered',
                    description: 'Package has been delivered successfully',
                    timestamp: currentOrder.delivered_at,
                    status: currentOrder.status.toLowerCase() === 'delivered' ? 'completed' : 'pending',
                    icon: 'fas fa-box-open'
                }
            ];
            
            const timeline = trackingData?.events || defaultTimeline;
            
            container.innerHTML = timeline.map((event, index) => `
                <div class="tracking-step">
                    <div class="tracking-icon ${event.status}">
                        <i class="${event.icon} text-xl"></i>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-gray-900 font-semibold">${event.title}</h4>
                            ${event.timestamp ? `<span class="text-gray-500 text-sm">${formatDate(event.timestamp)}</span>` : ''}
                        </div>
                        <p class="text-gray-600 text-sm">${event.description}</p>
                        ${event.location ? `<p class="text-gray-500 text-xs mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${event.location}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderDeliveryInfo() {
            const container = document.getElementById('delivery-info');
            
            // Handle shipping address - could be JSON or string
            let shippingAddress = 'No address provided';
            if (currentOrder.shipping_address) {
                if (typeof currentOrder.shipping_address === 'object') {
                    shippingAddress = `${currentOrder.shipping_address.street || ''}, ${currentOrder.shipping_address.city || ''}, ${currentOrder.shipping_address.state || ''} ${currentOrder.shipping_address.zip || ''}`.replace(/^,\s*|,\s*$/g, '');
                } else {
                    shippingAddress = currentOrder.shipping_address;
                }
            }
            
            container.innerHTML = `
                <div class="delivery-info-card bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-3 mb-3">
                        <i class="fas fa-map-marker-alt text-blue-500"></i>
                        <div>
                            <p class="text-gray-500 text-sm uppercase tracking-wide">Delivery Address</p>
                            <p class="text-gray-900">${shippingAddress}</p>
                        </div>
                    </div>
                </div>
                
                ${currentOrder.buyer_phone || currentOrder.phone ? `
                    <div class="delivery-info-card bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-phone text-green-500"></i>
                            <div>
                                <p class="text-gray-500 text-sm uppercase tracking-wide">Contact Phone</p>
                                <p class="text-gray-900">${currentOrder.buyer_phone || currentOrder.phone}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${currentOrder.pickup_site_name ? `
                    <div class="delivery-info-card bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-store text-orange-500"></i>
                            <div>
                                <p class="text-gray-500 text-sm uppercase tracking-wide">Pickup Site</p>
                                <p class="text-gray-900">${currentOrder.pickup_site_name}</p>
                                ${currentOrder.pickup_site_address ? `<p class="text-gray-600 text-sm">${currentOrder.pickup_site_address}</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${currentOrder.delivery_instructions ? `
                    <div class="delivery-info-card bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-sticky-note text-yellow-500"></i>
                            <div>
                                <p class="text-gray-500 text-sm uppercase tracking-wide">Delivery Instructions</p>
                                <p class="text-gray-900">${currentOrder.delivery_instructions}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="delivery-info-card bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-clock text-purple-500"></i>
                        <div>
                            <p class="text-gray-500 text-sm uppercase tracking-wide">Delivery Window</p>
                            <p class="text-gray-900">9:00 AM - 6:00 PM</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOrderItems() {
            const container = document.getElementById('order-items');
            
            if (!currentOrder.items || currentOrder.items.length === 0) {
                container.innerHTML = '<p class="text-gray-600 col-span-full text-center">No items found</p>';
                return;
            }
            
            container.innerHTML = currentOrder.items.map(item => `
                <div class="bg-gray-50 rounded-lg p-4 flex items-center space-x-3">
                    <img src="${item.product_image || item.image_url || '/public/images/placeholder.png'}" 
                         alt="${item.product_name}" 
                         class="w-16 h-16 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="text-gray-900 font-medium text-sm">${item.product_name}</h4>
                        <p class="text-gray-600 text-xs">Qty: ${item.quantity}</p>
                        <p class="text-gray-600 text-xs">${formatCurrency(item.price)} each</p>
                    </div>
                </div>
            `).join('');
        }

        // Action Functions
        function refreshTracking() {
            loadTrackingInfo();
            showToast('Tracking information refreshed', 'success');
        }

        function shareTracking() {
            if (navigator.share) {
                navigator.share({
                    title: `Track Order #${currentOrder.order_number}`,
                    text: `Track my order from ADD Physical Products`,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast('Tracking link copied to clipboard', 'success');
            }
        }

        function viewOrderDetails() {
            window.location.href = `/buyer/order-details.html?order=${orderId}`;
        }

        function contactDeliveryAgent() {
            showToast('Connecting you with delivery agent...', 'info');
        }

        function reportDeliveryIssue() {
            showToast('Opening issue report form...', 'info');
        }

        function rescheduleDelivery() {
            showToast('Opening delivery reschedule form...', 'info');
        }

        function goBack() {
            window.history.back();
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            // Only auto-refresh for active orders
            if (currentOrder && ['pending', 'confirmed', 'shipped'].includes(currentOrder.status.toLowerCase())) {
                trackingInterval = setInterval(() => {
                    loadTrackingInfo();
                }, 30000); // Refresh every 30 seconds
            }
        }

        function stopAutoRefresh() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
        }

        // Utility Functions
        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('tracking-content').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-state').classList.add('hidden');
        }

        function showError() {
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('tracking-content').classList.add('hidden');
        }

        function getStatusBadgeClass(status) {
            const statusClasses = {
                'pending': 'bg-yellow-500 text-yellow-100',
                'confirmed': 'bg-blue-500 text-blue-100',
                'shipped': 'bg-purple-500 text-purple-100',
                'delivered': 'bg-green-500 text-green-100',
                'cancelled': 'bg-red-500 text-red-100'
            };
            return statusClasses[status.toLowerCase()] || 'bg-gray-500 text-gray-100';
        }

        function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1).toLowerCase();
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-RW', {
                style: 'currency',
                currency: 'RWF',
                minimumFractionDigits: 0
            }).format(parseFloat(amount)).replace('RWF', 'FRW');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 fade-in`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-4 text-white/80 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            window.location.href = '/public/login.html';
        }

        function isAuthenticated() {
            return localStorage.getItem('authToken') !== null;
        }

        // Helper functions for tracking
        function getTrackingIcon(status) {
            const iconMap = {
                'pending': 'fa-clock',
                'confirmed': 'fa-check-circle',
                'processing': 'fa-cog',
                'shipped': 'fa-shipping-fast',
                'out_for_delivery': 'fa-truck',
                'delivered': 'fa-box-open',
                'cancelled': 'fa-times-circle',
                'payment_proof_submitted': 'fa-receipt',
                'payment_approved': 'fa-credit-card',
                'payment_rejected': 'fa-exclamation-triangle'
            };
            return iconMap[status] || 'fa-info-circle';
        }

        function formatTrackingStatus(status) {
            const statusMap = {
                'pending': 'Order Pending',
                'confirmed': 'Order Confirmed',
                'processing': 'Processing',
                'shipped': 'Shipped',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled',
                'payment_proof_submitted': 'Payment Proof Submitted',
                'payment_approved': 'Payment Approved',
                'payment_rejected': 'Payment Rejected'
            };
            return statusMap[status] || status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>