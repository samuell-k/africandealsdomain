<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Delivery Locations & Live Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    #map, #trackMap { height: 400px; }
    .leaflet-container { border-radius: 0.75rem; }
    .location-card {
      transition: all 0.3s ease;
    }
    .location-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.6s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .location-type-home { border-left: 4px solid #10b981; }
    .location-type-work { border-left: 4px solid #3b82f6; }
    .location-type-custom { border-left: 4px solid #8b5cf6; }
    .location-type-current { border-left: 4px solid #f59e0b; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 transition-colors">
            <i class="fas fa-arrow-left text-xl"></i>
          </button>
          <h1 class="text-2xl font-bold text-gray-900">My Locations & Tracking</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="locationStatus" class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
            <span class="text-sm text-gray-600">Location Off</span>
          </div>
          <button onclick="toggleLiveTracking()" id="liveTrackingBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-location-arrow mr-2"></i>Enable Live Tracking
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Location Management -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Location Picker -->
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Set Your Location</h2>
          <div class="flex items-center space-x-2">
            <button onclick="getCurrentLocation()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Get Current Location">
              <i class="fas fa-crosshairs text-lg"></i>
            </button>
            <button onclick="clearMap()" class="text-gray-600 hover:text-gray-800 transition-colors" title="Clear Map">
              <i class="fas fa-eraser text-lg"></i>
            </button>
          </div>
        </div>
        
        <div class="space-y-4">
          <div class="flex flex-col sm:flex-row gap-2">
            <input id="addressInput" type="text" placeholder="Search address or place..." 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
            <button onclick="useGPS()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
              <i class="fas fa-location-arrow mr-2"></i>Use GPS
            </button>
          </div>
          
          <div id="map" class="border border-gray-200 rounded-lg"></div>
          
          <div class="grid grid-cols-2 gap-2">
            <button onclick="saveLocation('home')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
              <i class="fas fa-home mr-2"></i>Save as Home
            </button>
            <button onclick="saveLocation('work')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
              <i class="fas fa-briefcase mr-2"></i>Save as Work
            </button>
          </div>
          
          <div class="flex gap-2">
            <input id="customLabel" type="text" placeholder="Custom label (e.g., Gym, Friend's House)" 
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
            <button onclick="saveLocation('custom')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
              <i class="fas fa-plus mr-2"></i>Save Custom
            </button>
          </div>
          
          <div id="saveStatus" class="text-sm"></div>
        </div>
      </div>

      <!-- Saved Locations -->
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Saved Locations</h2>
          <button onclick="refreshLocations()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Refresh Locations">
            <i class="fas fa-sync-alt text-lg"></i>
          </button>
        </div>
        
        <div id="savedLocations" class="space-y-3">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-map-marker-alt text-3xl mb-2"></i>
            <p>Loading your saved locations...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Order Tracking -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in location-card">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Live Delivery Tracking</h2>
        <div class="flex items-center space-x-2">
          <div id="trackingStatus" class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
            <span class="text-sm text-gray-600">No Active Tracking</span>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Tracking Controls -->
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Track Order</label>
            <div class="flex gap-2">
              <input id="orderIdInput" type="number" placeholder="Order ID" 
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              <button onclick="startTracking()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          
          <div id="orderInfo" class="hidden">
            <h3 class="font-semibold text-gray-900 mb-2">Order Details</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Status:</span>
                <span id="orderStatus" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Agent:</span>
                <span id="agentName" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Distance:</span>
                <span id="agentDistance" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">ETA:</span>
                <span id="estimatedTime" class="font-medium"></span>
              </div>
            </div>
          </div>
          
          <div id="trackingControls" class="hidden space-y-2">
            <button onclick="centerOnAgent()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
              <i class="fas fa-crosshairs mr-2"></i>Center on Agent
            </button>
            <button onclick="showRoute()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
              <i class="fas fa-route mr-2"></i>Show Route
            </button>
            <button onclick="stopTracking()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
              <i class="fas fa-stop mr-2"></i>Stop Tracking
            </button>
          </div>
        </div>
        
        <!-- Map -->
        <div class="lg:col-span-2">
          <div id="trackMap" class="border border-gray-200 rounded-lg"></div>
          <div id="trackingInfo" class="mt-4 text-sm text-gray-600"></div>
        </div>
      </div>
    </div>

    <!-- Delivery Price Calculator -->
    <div class="bg-white rounded-xl shadow-lg p-6 mt-8 fade-in location-card">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Delivery Price Calculator</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">From (Seller Location)</label>
            <input id="sellerAddress" type="text" placeholder="Enter seller address" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">To (Your Location)</label>
            <select id="buyerLocationSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select saved location</option>
            </select>
          </div>
          
          <button onclick="calculateDeliveryPrice()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-calculator mr-2"></i>Calculate Price
          </button>
        </div>
        
        <div id="priceResult" class="hidden">
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="font-semibold text-gray-900 mb-3">Delivery Estimate</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Distance:</span>
                <span id="deliveryDistance" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Base Price:</span>
                <span id="basePrice" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Distance Fee:</span>
                <span id="distanceFee" class="font-medium"></span>
              </div>
              <hr class="my-2">
              <div class="flex justify-between font-semibold">
                <span>Total Price:</span>
                <span id="totalPrice" class="text-blue-600"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Est. Time:</span>
                <span id="deliveryTime" class="font-medium"></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Available Agents:</span>
                <span id="availableAgents" class="font-medium"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div id="notification-toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-green-500">
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-3"></i>
        <span id="notification-message">Success!</span>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch/dist/bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // --- CONFIG ---
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const userId = userData.id;
    const authToken = localStorage.getItem('authToken');
    const apiBase = '/api/location';
    
    // Check authentication
    if (!authToken || !userId || userData.role !== 'buyer') {
      window.location.href = '/auth/auth-buyer.html';
    }

    // Global variables
    let map, marker, selectedLatLng;
    let trackMap, buyerMarker, agentMarker, sellerMarker, routeLine, trackSocket;
    let isLiveTrackingEnabled = false;
    let locationWatchId = null;
    let savedLocations = {};
    let currentTrackingOrderId = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
      loadSavedLocations();
      initializeSocket();
    });

    // --- MAP INITIALIZATION ---
    function initializeMap() {
      // Main location picker map
      map = L.map('map'); // Don't set view yet
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Try to get current location on load
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            setMarker(lat, lng, 'Your Current Location');
            map.setView([lat, lng], 15);
          },
          error => {
            console.log('Could not get initial location, defaulting to Kigali:', error);
            // Default to Kigali, Rwanda
            setMarker(-1.9441, 30.0619, 'Kigali, Rwanda');
            map.setView([-1.9441, 30.0619], 13);
          }
        );
      }

      // Geocoder for address search
      const search = new window.GeoSearch.GeoSearchControl({
        provider: new window.GeoSearch.OpenStreetMapProvider(),
        style: 'bar',
        autoComplete: true,
        showMarker: false,
        retainZoomLevel: false,
      });
      map.addControl(search);

      // Map event listeners
      map.on('geosearch/showlocation', function(e) {
        setMarker(e.location.y, e.location.x);
        document.getElementById('addressInput').value = e.location.label;
      });

      map.on('click', function(e) {
        setMarker(e.latlng.lat, e.latlng.lng);
      });

      // Initialize tracking map
      trackMap = L.map('trackMap').setView([-1.2921, 36.8219], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(trackMap);
    }

    // --- LOCATION MANAGEMENT ---
    function setMarker(lat, lng, address = null) {
      selectedLatLng = { lat, lng, address };
      if (marker) map.removeLayer(marker);
      
      marker = L.marker([lat, lng], { 
        draggable: true,
        icon: L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map);
      
      marker.on('dragend', function(e) {
        const pos = marker.getLatLng();
        selectedLatLng = { lat: pos.lat, lng: pos.lng };
      });

      if (address) {
        marker.bindPopup(address).openPopup();
      }
    }

    function getCurrentLocation() {
      if (!navigator.geolocation) {
        showNotification('Geolocation not supported by this browser', 'error');
        return;
      }

      showNotification('Getting your location...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          setMarker(lat, lng, 'Your Current Location');
          map.setView([lat, lng], 15);
          showNotification('Location found!', 'success');
        },
        error => {
          console.error('Geolocation error:', error);
          showNotification('Failed to get your location: ' + error.message, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }

    function useGPS() {
      getCurrentLocation();
    }

    function clearMap() {
      if (marker) {
        map.removeLayer(marker);
        marker = null;
        selectedLatLng = null;
      }
      document.getElementById('addressInput').value = '';
    }

    // --- SAVE LOCATIONS ---
    async function saveLocation(type) {
      if (!selectedLatLng) {
        showNotification('Please select a location on the map first', 'error');
        return;
      }

      let label = '';
      let address = selectedLatLng.address || document.getElementById('addressInput').value;
      
      if (type === 'custom') {
        label = document.getElementById('customLabel').value.trim();
        if (!label) {
          showNotification('Please enter a label for custom location', 'error');
          return;
        }
      }

      try {
        const response = await fetch(`${apiBase}/users/${userId}/location`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${authToken}` 
          },
          body: JSON.stringify({ 
            type, 
            lat: selectedLatLng.lat, 
            lng: selectedLatLng.lng, 
            label,
            address
          })
        });

        if (response.ok) {
          showNotification(`Location saved as ${type === 'custom' ? label : type}!`, 'success');
          loadSavedLocations();
          if (type === 'custom') {
            document.getElementById('customLabel').value = '';
          }
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to save location', 'error');
        }
      } catch (error) {
        console.error('Error saving location:', error);
        showNotification('Failed to save location', 'error');
      }
    }

    // --- LOAD SAVED LOCATIONS ---
    async function loadSavedLocations() {
      try {
        const response = await fetch(`${apiBase}/users/${userId}`, { 
          headers: { 'Authorization': `Bearer ${authToken}` } 
        });

        if (response.ok) {
          const data = await response.json();
          savedLocations = data;
          displaySavedLocations(data);
          populateLocationSelect(data);
        } else {
          console.error('Failed to load saved locations');
          document.getElementById('savedLocations').innerHTML = `
            <div class="text-center py-8 text-red-500">
              <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
              <p>Failed to load saved locations</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading saved locations:', error);
        document.getElementById('savedLocations').innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
            <p>Error loading saved locations</p>
          </div>
        `;
      }
    }

    function displaySavedLocations(data) {
      const container = document.getElementById('savedLocations');
      let html = '';

      // Current location
      if (data.current) {
        html += createLocationCard('current', 'Current Location', data.current, 'fas fa-location-arrow', '#f59e0b');
      }

      // Home location
      if (data.home) {
        html += createLocationCard('home', 'Home', data.home, 'fas fa-home', '#10b981');
      }

      // Work location
      if (data.work) {
        html += createLocationCard('work', 'Work', data.work, 'fas fa-briefcase', '#3b82f6');
      }

      // Custom locations
      if (data.custom && data.custom.length > 0) {
        data.custom.forEach(location => {
          html += createLocationCard('custom', location.label, location, 'fas fa-map-marker-alt', '#8b5cf6', location.label);
        });
      }

      if (!html) {
        html = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-map-marker-alt text-3xl mb-2"></i>
            <p>No saved locations yet</p>
            <p class="text-sm">Use the map to save your favorite locations</p>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function createLocationCard(type, title, location, icon, color, customLabel = null) {
      const deleteBtn = type === 'custom' ? 
        `<button onclick="deleteLocation('${customLabel}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete Location">
          <i class="fas fa-trash text-sm"></i>
        </button>` : '';

      return `
        <div class="location-card location-type-${type} bg-white border rounded-lg p-4 hover:shadow-md transition-all">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: ${color}20;">
                <i class="${icon}" style="color: ${color};"></i>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">${title}</h3>
                <p class="text-sm text-gray-600">${location.address || `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`}</p>
                ${location.updated_at ? `<p class="text-xs text-gray-400">Updated: ${new Date(location.updated_at).toLocaleDateString()}</p>` : ''}
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="showLocationOnMap(${location.lat}, ${location.lng}, '${title}')" class="text-blue-500 hover:text-blue-700 transition-colors" title="Show on Map">
                <i class="fas fa-eye text-sm"></i>
              </button>
              <button onclick="useAsDeliveryLocation(${location.lat}, ${location.lng}, '${title}')" class="text-green-500 hover:text-green-700 transition-colors" title="Use for Delivery">
                <i class="fas fa-truck text-sm"></i>
              </button>
              ${deleteBtn}
            </div>
          </div>
        </div>
      `;
    }

    function populateLocationSelect(data) {
      const select = document.getElementById('buyerLocationSelect');
      select.innerHTML = '<option value="">Select saved location</option>';

      if (data.home) {
        select.innerHTML += `<option value="home" data-lat="${data.home.lat}" data-lng="${data.home.lng}">üè† Home</option>`;
      }
      if (data.work) {
        select.innerHTML += `<option value="work" data-lat="${data.work.lat}" data-lng="${data.work.lng}">üíº Work</option>`;
      }
      if (data.custom && data.custom.length > 0) {
        data.custom.forEach(location => {
          select.innerHTML += `<option value="custom-${location.label}" data-lat="${location.lat}" data-lng="${location.lng}">üìç ${location.label}</option>`;
        });
      }
    }

    function showLocationOnMap(lat, lng, title) {
      setMarker(lat, lng, title);
      map.setView([lat, lng], 15);
    }

    function useAsDeliveryLocation(lat, lng, title) {
      const select = document.getElementById('buyerLocationSelect');
      // Find and select the matching option
      for (let option of select.options) {
        if (option.dataset.lat == lat && option.dataset.lng == lng) {
          select.value = option.value;
          break;
        }
      }
      showNotification(`Selected ${title} for delivery`, 'success');
    }

    async function deleteLocation(label) {
      if (!confirm(`Are you sure you want to delete the location "${label}"?`)) {
        return;
      }

      try {
        const response = await fetch(`${apiBase}/users/${userId}/location/${encodeURIComponent(label)}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
          showNotification('Location deleted successfully', 'success');
          loadSavedLocations();
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to delete location', 'error');
        }
      } catch (error) {
        console.error('Error deleting location:', error);
        showNotification('Failed to delete location', 'error');
      }
    }

    function refreshLocations() {
      loadSavedLocations();
      showNotification('Locations refreshed', 'success');
    }

    // --- LIVE TRACKING ---
    function toggleLiveTracking() {
      if (isLiveTrackingEnabled) {
        stopLiveTracking();
      } else {
        startLiveTracking();
      }
    }

    function startLiveTracking() {
      if (!navigator.geolocation) {
        showNotification('Geolocation not supported', 'error');
        return;
      }

      locationWatchId = navigator.geolocation.watchPosition(
        position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          // Update location on server
          updateLocationOnServer(lat, lng);
          
          // Update UI
          updateLocationStatus(true);
        },
        error => {
          console.error('Location tracking error:', error);
          showNotification('Location tracking error: ' + error.message, 'error');
          stopLiveTracking();
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );

      isLiveTrackingEnabled = true;
      updateLocationStatus(true);
      showNotification('Live tracking enabled', 'success');
    }

    function stopLiveTracking() {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
      }
      
      isLiveTrackingEnabled = false;
      updateLocationStatus(false);
      showNotification('Live tracking disabled', 'info');
    }

    function updateLocationStatus(isActive) {
      const statusDiv = document.getElementById('locationStatus');
      const btn = document.getElementById('liveTrackingBtn');
      
      if (isActive) {
        statusDiv.innerHTML = `
          <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
          <span class="text-sm text-green-600">Location Active</span>
        `;
        btn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i>Disable Live Tracking';
        btn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors';
      } else {
        statusDiv.innerHTML = `
          <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
          <span class="text-sm text-gray-600">Location Off</span>
        `;
        btn.innerHTML = '<i class="fas fa-location-arrow mr-2"></i>Enable Live Tracking';
        btn.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors';
      }
    }

    async function updateLocationOnServer(lat, lng) {
      try {
        await fetch(`${apiBase}/update`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${authToken}` 
          },
          body: JSON.stringify({ lat, lng })
        });
      } catch (error) {
        console.error('Error updating location on server:', error);
      }
    }

    // --- ORDER TRACKING ---
    function initializeSocket() {
      trackSocket = io();
      
      trackSocket.on('connect', () => {
        console.log('Connected to tracking server');
      });

      trackSocket.on('agent-location-update', (data) => {
        if (data.agentId && currentTrackingOrderId && agentMarker) {
          updateAgentMarker(data.lat, data.lng);
          updateTrackingInfo();
        }
      });
    }

    async function startTracking() {
      const orderId = document.getElementById('orderIdInput').value;
      if (!orderId) {
        showNotification('Please enter an order ID', 'error');
        return;
      }

      try {
        const response = await fetch(`${apiBase}/orders/${orderId}/locations`, { 
          headers: { 'Authorization': `Bearer ${authToken}` } 
        });

        if (response.ok) {
          const data = await response.json();
          displayOrderTracking(data, orderId);
          currentTrackingOrderId = orderId;
        } else {
          const error = await response.json();
          showNotification(error.error || 'Order not found', 'error');
        }
      } catch (error) {
        console.error('Error loading order tracking:', error);
        showNotification('Failed to load order tracking', 'error');
      }
    }

    function displayOrderTracking(data, orderId) {
      // Clear existing markers
      if (buyerMarker) trackMap.removeLayer(buyerMarker);
      if (agentMarker) trackMap.removeLayer(agentMarker);
      if (sellerMarker) trackMap.removeLayer(sellerMarker);
      if (routeLine) trackMap.removeLayer(routeLine);

      const markers = [];

      // Add buyer marker
      if (data.buyer && (data.buyer.current || data.buyer.home)) {
        const buyerLoc = data.buyer.current || data.buyer.home;
        buyerMarker = L.marker([buyerLoc.lat, buyerLoc.lng], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190406.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(trackMap).bindPopup('Your Location');
        markers.push(buyerMarker);
      }

      // Add agent marker
      if (data.agent) {
        agentMarker = L.marker([data.agent.lat, data.agent.lng], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(trackMap).bindPopup('Delivery Agent');
        markers.push(agentMarker);
      }

      // Add seller marker
      if (data.seller && (data.seller.current || data.seller.business)) {
        const sellerLoc = data.seller.current || data.seller.business;
        sellerMarker = L.marker([sellerLoc.lat, sellerLoc.lng], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(trackMap).bindPopup('Seller Location');
        markers.push(sellerMarker);
      }

      // Draw route if we have all locations
      if (buyerMarker && agentMarker && sellerMarker) {
        const routePoints = [
          sellerMarker.getLatLng(),
          agentMarker.getLatLng(),
          buyerMarker.getLatLng()
        ];
        
        routeLine = L.polyline(routePoints, { 
          color: '#3b82f6', 
          weight: 4, 
          opacity: 0.7 
        }).addTo(trackMap);
        
        markers.push(routeLine);
      }

      // Fit map to show all markers
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        trackMap.fitBounds(group.getBounds().pad(0.1));
      }

      // Show order info
      document.getElementById('orderInfo').classList.remove('hidden');
      document.getElementById('trackingControls').classList.remove('hidden');
      document.getElementById('orderStatus').textContent = data.order.status;
      
      updateTrackingInfo();
      updateTrackingStatus(true);
    }

    function updateAgentMarker(lat, lng) {
      if (agentMarker) {
        agentMarker.setLatLng([lat, lng]);
        
        // Update route if exists
        if (routeLine && buyerMarker && sellerMarker) {
          const routePoints = [
            sellerMarker.getLatLng(),
            [lat, lng],
            buyerMarker.getLatLng()
          ];
          routeLine.setLatLngs(routePoints);
        }
      }
    }

    function updateTrackingInfo() {
      if (agentMarker && buyerMarker) {
        const distance = trackMap.distance(agentMarker.getLatLng(), buyerMarker.getLatLng()) / 1000;
        const eta = Math.ceil(distance / 30 * 60); // Assuming 30 km/h average speed
        
        document.getElementById('agentDistance').textContent = `${distance.toFixed(2)} km`;
        document.getElementById('estimatedTime').textContent = `${eta} minutes`;
        document.getElementById('trackingInfo').textContent = `Agent is ${distance.toFixed(2)} km away. ETA: ${eta} minutes`;
      }
    }

    function updateTrackingStatus(isActive) {
      const statusDiv = document.getElementById('trackingStatus');
      
      if (isActive) {
        statusDiv.innerHTML = `
          <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
          <span class="text-sm text-green-600">Tracking Active</span>
        `;
      } else {
        statusDiv.innerHTML = `
          <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
          <span class="text-sm text-gray-600">No Active Tracking</span>
        `;
      }
    }

    function centerOnAgent() {
      if (agentMarker) {
        trackMap.setView(agentMarker.getLatLng(), 15);
        agentMarker.openPopup();
      }
    }

    function showRoute() {
      if (routeLine) {
        trackMap.fitBounds(routeLine.getBounds().pad(0.1));
      }
    }

    function stopTracking() {
      // Clear markers and route
      if (buyerMarker) trackMap.removeLayer(buyerMarker);
      if (agentMarker) trackMap.removeLayer(agentMarker);
      if (sellerMarker) trackMap.removeLayer(sellerMarker);
      if (routeLine) trackMap.removeLayer(routeLine);
      
      // Reset UI
      document.getElementById('orderInfo').classList.add('hidden');
      document.getElementById('trackingControls').classList.add('hidden');
      document.getElementById('orderIdInput').value = '';
      document.getElementById('trackingInfo').textContent = '';
      
      currentTrackingOrderId = null;
      updateTrackingStatus(false);
      
      showNotification('Tracking stopped', 'info');
    }

    // --- DELIVERY PRICE CALCULATOR ---
    async function calculateDeliveryPrice() {
      const sellerAddress = document.getElementById('sellerAddress').value.trim();
      const buyerLocationSelect = document.getElementById('buyerLocationSelect');
      const selectedOption = buyerLocationSelect.options[buyerLocationSelect.selectedIndex];
      
      if (!sellerAddress) {
        showNotification('Please enter seller address', 'error');
        return;
      }
      
      if (!selectedOption.dataset.lat) {
        showNotification('Please select your delivery location', 'error');
        return;
      }

      try {
        // First geocode the seller address
        const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(sellerAddress)}`);
        const geocodeData = await geocodeResponse.json();
        
        if (geocodeData.length === 0) {
          showNotification('Seller address not found', 'error');
          return;
        }

        const sellerLat = parseFloat(geocodeData[0].lat);
        const sellerLng = parseFloat(geocodeData[0].lon);
        const buyerLat = parseFloat(selectedOption.dataset.lat);
        const buyerLng = parseFloat(selectedOption.dataset.lng);

        // Calculate delivery price
        const response = await fetch(`${apiBase}/calculate-delivery-price`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${authToken}` 
          },
          body: JSON.stringify({
            buyer_lat: buyerLat,
            buyer_lng: buyerLng,
            seller_lat: sellerLat,
            seller_lng: sellerLng
          })
        });

        if (response.ok) {
          const data = await response.json();
          displayPriceResult(data);
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to calculate price', 'error');
        }
      } catch (error) {
        console.error('Error calculating delivery price:', error);
        showNotification('Failed to calculate delivery price', 'error');
      }
    }

    function displayPriceResult(data) {
      document.getElementById('priceResult').classList.remove('hidden');
      document.getElementById('deliveryDistance').textContent = `${data.distance} km`;
      document.getElementById('basePrice').textContent = `$${data.base_price}`;
      document.getElementById('distanceFee').textContent = `$${(data.delivery_price - data.base_price).toFixed(2)}`;
      document.getElementById('totalPrice').textContent = `$${data.delivery_price}`;
      document.getElementById('deliveryTime').textContent = `${data.estimated_time} minutes`;
      document.getElementById('availableAgents').textContent = data.available_agents;
    }

    // --- UTILITY FUNCTIONS ---
    function showNotification(message, type = 'success') {
      const toast = document.getElementById('notification-toast');
      const messageElement = document.getElementById('notification-message');
      
      messageElement.textContent = message;
      
      // Update colors based on type
      const toastDiv = toast.querySelector('div');
      if (type === 'error') {
        toastDiv.className = 'bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-red-500';
        toastDiv.querySelector('i').className = 'fas fa-exclamation-circle text-red-500 mr-3';
      } else if (type === 'info') {
        toastDiv.className = 'bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-blue-500';
        toastDiv.querySelector('i').className = 'fas fa-info-circle text-blue-500 mr-3';
      } else {
        toastDiv.className = 'bg-white text-gray-800 px-6 py-4 rounded-lg shadow-lg border-l-4 border-green-500';
        toastDiv.querySelector('i').className = 'fas fa-check-circle text-green-500 mr-3';
      }
      
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 5000);
    }

    function goBack() {
      window.history.back();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopLiveTracking();
      if (trackSocket) {
        trackSocket.disconnect();
      }
    });
  </script>
</body>
</html>